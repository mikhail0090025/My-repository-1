define(["OK/utils/dom","OK/utils/utils","OK/entitySuggest/AbstractEntitySuggest","OK/LogSeen","OK/utils/throttle"],function(h,d,c,g,f){var b=2;var a="uslider_i";function e(){}e.prototype.changeState=function(i){this.hook.classList.toggle("__empty",i);};e.prototype.logSlidesSeen=function(n,m){var l=this.slider.getElementsByClassName("js-entity-item");if(l&&l.length>0){var k=[];for(var j=n;j<n+m&&l[j];j++){var o=parseInt(l[j].getAttribute("data-entity-id"),10)||null;if(o!==null){k.push(o);}}if(k.length>0){this.seenParams.data.user_ids=k.join(",");g.logSuccess(this.seenParams.type,JSON.stringify(this.seenParams.data));}}};e.prototype.logSlidesIfInViewPort=function(){try{if(d.isElementInViewport(this.slider)){this.logSlidesSeen(this.sliderOffset,parseInt(this.slider.getAttribute("data-visibleSlides"),10)||0);this.removeLogSeenOnWindowScrollListeners();}}catch(i){}};e.prototype.removeLogSeenOnWindowScrollListeners=function(){window.removeEventListener("scroll",this.logSeenOnWinowScroll);window.removeEventListener("keydown",this.logSeenOnWinowScroll);};e.prototype.activate=function(j){this.marker=j.getAttribute("data-slider-marker")||null;this.loadActivityId=j.getAttribute("data-load-aid")||"Feed_PossibleFriends_LoadFriendChunk";this.sliderOffset=0;this.lastRemovedEntityIndex=null;this.hook=j;this.slider=h.firstByClass(j,"uslider");this.entitySuggest=h.firstByClass(j,"js-entity-suggest");this.type=this.entitySuggest.getAttribute("data-type");this.entitySuggestInstance=null;this.suggestFriendsPortlets=c.prototype.getPortlets(this.type);this.mode=this.entitySuggest.getAttribute("data-mode");this.userId=this.entitySuggest.getAttribute("data-user-id");this.isLargeCard=this.entitySuggest.getAttribute("data-large-card")==="true";var k=j.getAttribute("data-seen-params");if(k){try{this.seenParams=JSON.parse(k);}catch(i){this.seenParams=null;}}this.getNewSliderItems=function(l){if(this.seenParams){this.logSeenOnSlide(l);}if(this.suggestFriendsPortlets&&this.entitySuggest){this.entitySuggestId=parseInt(this.entitySuggest.getAttribute("data-entity-suggest-id"),10);this.entitySuggestInstance=this.suggestFriendsPortlets[this.entitySuggestId];}if(this.entitySuggestInstance&&this.marker&&((l.detail.totalSlides-l.detail.offset)<(l.detail.visibleSlides+b))){d.ajax({url:c.urlConfig[this.type],data:{"st.modes":this.mode,list:Object.keys(c.prototype.getCommonEntities(this.type)).join(";"),slideSequence:true,"st._aid":this.loadActivityId,marker:this.marker,largeCard:this.isLargeCard,"st.fid":this.userId}}).done(function(m,r,q){var p=m.split(OK.navigation.SPLITER);var o="";this.marker=q.getResponseHeader("marker");p.forEach(function(s){if(s){o=o+'<div class="'+a+'">'+s+"</div>";}});this.entitySuggestInstance.append(o);var n=!l.detail.totalSlides&&!m;this.changeState(n);}.bind(this));}if(!this.marker&&!l.detail.totalSlides){this.changeState(true);}}.bind(this);this.changeSliderItemsCount=function(n){if(n.detail.type==="remove"){var l=h.byClass(this.slider,a);this.lastRemovedEntityIndex=n.detail.index;if(this.lastRemovedEntityIndex!==undefined){h.remove(l[this.lastRemovedEntityIndex]);this.slider.dispatchEvent(new CustomEvent("uSliderUpdateCount",{detail:{type:"remove"}}));}else{this.lastRemovedEntityIndex=null;}}if(n.detail.type==="append"){this.slider.dispatchEvent(new CustomEvent("uSliderUpdateCount",{detail:{type:"append"}}));}if(n.detail.type==="replace"){if(this.seenParams){var m=parseInt(this.slider.getAttribute("data-visibleSlides"),10)||0;if(this.sliderOffset<=n.detail.index&&this.sliderOffset+m-1>=n.detail.index){this.logSlidesSeen(n.detail.index,1);}}}}.bind(this);if(this.seenParams){this.logSeenOnWinowScroll=f(150,function(l){if(!l.isTrigger){this.logSlidesIfInViewPort();}}.bind(this));this.logSeenOnSlide=function(o){if((o.detail.action==="slide")||((o.detail.action==="remove")&&(this.sliderOffset<=this.lastRemovedEntityIndex&&this.sliderOffset+o.detail.visibleSlides>=this.lastRemovedEntityIndex))){var n=o.detail.offset-this.sliderOffset;if(n===0){if(this.lastRemovedEntityIndex!==null){this.logSlidesSeen(this.lastRemovedEntityIndex,1);this.lastRemovedEntityIndex=null;}}else{var m=Math.abs(n);var l=this.sliderOffset+n;this.sliderOffset=o.detail.offset;this.logSlidesSeen(l,m);}}}.bind(this);window.addEventListener("scroll",this.logSeenOnWinowScroll);window.addEventListener("keydown",this.logSeenOnWinowScroll);this.logSlidesIfInViewPort();}this.slider.addEventListener("uSliderAction",this.getNewSliderItems);this.entitySuggest.addEventListener("entitySuggestUpdateCount",this.changeSliderItemsCount);};e.prototype.deactivate=function(){if(this.seenParams){this.removeLogSeenOnWindowScrollListeners();}this.slider.removeEventListener("uSliderAction",this.getNewSliderItems);this.entitySuggest.removeEventListener("entitySuggestUpdateCount",this.changeSliderItemsCount);};return e;});