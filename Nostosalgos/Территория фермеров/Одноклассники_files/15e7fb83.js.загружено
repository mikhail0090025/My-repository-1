(function(a,c,b){OK.loader.use(["jQuery"],function(){var m=$(),p=$(),f=$(),o=$(),k=0,y=0,v=$.Deferred(),g=$.Deferred();var u="photo-layer_fullScreen";function j(){try{A();}catch(B){OK.logger.error("photo.fs","toggle");}}function l(){OK.logger.error("photo.fs","fail");}function A(D){if(!OK.photoLayer.isActive()){n();return;}var B=D===undefined?c.fullscreenElement||c.mozFullScreenElement||c.webkitFullscreenElement:D,F=c.body,C=(F.className||"").split(" "),E=C.indexOf(u);m.toggleClass("__disabled_adaptive2",B).toggleClass("__adaptive2",!B);if(B){if(E<0){C.push(u);F.className=C.join(" ");a.OK.photoLayer.visualizePhoto();}a.OK.logger.success("photo.fs","resp_on");}else{if(E>=0){C.splice(E,1);F.className=C.join(" ");a.OK.photoLayer.visualizePhoto();}a.OK.logger.success("photo.fs","resp_off");}m.scroll();return B;}function i(B){var C=c.documentElement;var D=B?c.addEventListener:c.removeEventListener;if(C.requestFullscreen){D.call(c,"fullscreenchange",j);D.call(c,"fullscreenerror",l);return true;}else{if(C.mozRequestFullScreen){D.call(c,"mozfullscreenchange",j);D.call(c,"mozfullscreenerror",l);return true;}else{if(C.webkitRequestFullscreen){D.call(c,"webkitfullscreenchange",j);D.call(c,"webkitfullscreenerror",l);return true;}}}return false;}function q(){return i(true);}function n(){return i(false);}function w(){var B=c.documentElement;if(B.requestFullscreen){B.requestFullscreen();}else{if(B.mozRequestFullScreen){B.mozRequestFullScreen();}else{if(B.webkitRequestFullscreen){B.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}}}function s(){if(c.webkitCancelFullScreen&&window.event==null){return;}if(c.fullscreenElement||c.webkitFullscreenElement||c.mozFullScreenElement||c.msFullscreenElement){if(c.exitFullscreen){c.exitFullscreen();}else{if(c.cancelFullScreen){c.cancelFullScreen();}else{if(c.mozCancelFullScreen){c.mozCancelFullScreen();}else{if(c.webkitCancelFullScreen){c.webkitCancelFullScreen();}}}}}}function x(D){var C=$(this),E=C.attr("data-id"),B=C.attr("data-type");if(E&&B){require(["OK/DiscussionManager","jquery"],function(F,G){F.forEachOpened(E,B,function(){function I(J){G(this.element).animate({scrollTop:this.element.scrollTop+J},"500");}var H=this;this.element.each(function(){var J=H.scrollController;if(J.hasMore()){J.loadLast().done(function(){H.scrollController.scrollToBottomFancy(I);});}else{J.scrollToBottomFancy(I);}});this.form.focus();});});}D.preventDefault();}var h,z,r,e=true,d,t;a.OK.util.extend(a.OK.photoLayer,{isActive:function(){return h;},init:function(C){d=true;g=$.Deferred();m=$(C);p=$(".photo-layer_bottom",m);f=$("#photo-layer_photo");$(a).bind("resize.photoLayer",function(){f.each(function(){a.OK.photoLayer.centerLayer(this,o.get(0),k,y);});});if(!h){OK.loader.use("OKCustomJs",function(){require(["OK/PhotoLayer"],function(F){OK.Layers.register("layer_photo",function(){OK.photoLayer.onClose(true);},null,false,F.keyboardHandler);if(OK.Layers.onLayerShown){OK.Layers.onLayerShown();}});});}if(e){m.on("click",".js-scrollToComments",x).on("click",".arw__prev, .arw__next",function(){d=true;if(a.OK.photoLayer.hideElements){m.addClass("__no-controls");}}).on("click",".js-photoLayerClose",function(F){F.preventDefault();OK.photoLayer.close(true);}).on("click",function(F){if(!F.originalEvent.isReactEvent){OK.photoLayer.close(true);}}).on("click",".photo-layer_cnt",function(F){if(!F.originalEvent.isReactEvent){F.stopPropagation();}}).on("mouseover",".photo-layer_right_half",function(){$(".arw__next",m).addClass("__hover");}).on("mouseout",".photo-layer_right_half",function(){$(".arw__next",m).removeClass("__hover");}).on("mouseover",".photo-layer_img_w .photo-layer_klass_w",function E(){var G=$(this),F=this.getBoundingClientRect();function H(J){var I=J.clientX,K=J.clientY;if(I>F.right||I<F.left||K<F.top||K>F.bottom){$(document).off("mousemove",H);G.removeClass("__hover");}}$(document).on("mousemove",H);$(this).addClass("__hover");});var B=$(".photo-layer_close",m);$(".modal_overlay",m).hover(function(){B.addClass("__hover");},function(){B.removeClass("__hover");});}e=false;var D=q();if(!D&&!r){c.documentElement.className=(c.documentElement.className||"")+" nofs";}r=true;h=true;v.resolve();},close:function(B){OK.loader.use(["OKCustomJs"],function(){OK.Layers.remove("layer_photo");});OK.photoLayer.onClose(B);},onClose:function(C){if(e){return;}if(a.OK.photoLayer.isLogPrematureClose&&d){a.OK.logging.logger.success("photo","prematureClose");}d=false;e=true;a.OK.photoLayer.isFirst=true;a.OK.photoLayer.minHeight=480;a.OK.photoLayer.timeDiff=undefined;f.css("min-height","");function B(){m.addClass("invisible").removeClass("__active __ready");$(".modal_overlay",m).off("hover");m.off("click");s();a.OK.hookModel.setHookContent("PhotoLayerLB","");a.OK.hookModel.setHookContent("PhotoLayerRB","");a.OK.hookModel.setHookContent("PhotoLayerFooterRB","");a.OK.hookModel.setHookContent("PhotoLayerPreviewRB","");a.OK.hookModel.setHookContent("PhotoLayerRightColumnRB","");a.OK.photoLayer.destroyFastNavigation();$(a).off("resize.photoLayer");z=false;h=false;a.OK.photoLayer.minHeight=520;OK.loader.use("OKCustomJs",function(){if(OK.Layers.onLayerHidden){OK.Layers.onLayerHidden();}if(C){OK.Layers.pop();}else{OK.Layers.clear();}});}if($("#RefreshMTLayerOnClose").length>0){setTimeout(function(){require(["OK/MediaLayer"],function(D){D.refreshLayerBody(B);});},50);}else{B();}return false;},onPhotoShown:function(E,C){E=E||false;d=false;a.OK.photoLayer.isRotated=false;if(a.OK.photoLayer.isLogTimeDiff){var B=new Date().getTime();if(a.OK.photoLayer.timeDiff!==undefined){var D=B-a.OK.photoLayer.timeDiff;a.OK.logging.logger.durationScalar("photo","timeDiff",D);a.OK.photoLayer.timeDiff=B;}else{a.OK.photoLayer.timeDiff=B;}}v.done(function(){var F;o=$("#__plpcte_target");m.toggleClass("__unavailable",E);if(!o||o.length==0){a.OK.photoLayer.isGif=true;F=$(".gif",f);o=$(".gif_video",F);k=parseInt(F.attr("data-width"));y=parseInt(F.attr("data-height"));}else{a.OK.photoLayer.isGif=false;k=parseInt(o.attr("data-nfs-width"));y=parseInt(o.attr("data-nfs-height"));}g.resolve(o.get(0));a.OK.photoLayer.centerLayer(f.get(0),o.get(0),k,y);if(C){g.done(C);}f.toggleClass("__animated",!a.OK.photoLayer.isFirst);m.removeClass("__more");if(a.OK.photoLayer.hideElements){var G=0;f.off("mousemove").on("mousemove",function(){if(++G===7){m.removeClass("__no-controls");f.off("mousemove");}});}});},footerRendered:function(){g.done(function(B){var D=100;if(B){requestAnimationFrame(function(){f.each(function(){a.OK.photoLayer.centerLayer(this,B,k,y+D);});}.bind(this));}var C=$(".arw_cnt.__next");if(OK.scrollBar.width){C.css("max-width",parseInt(C.css("max-width"),10)-OK.scrollBar.width);}m.addClass("__ready");a.OK.photoLayer.isFirst=false;});},toggleFullScreen:function(){var B=c.fullscreenElement||c.mozFullScreenElement||c.webkitFullscreenElement;if(B){a.OK.logger.success("photo.fs","req_off");s();}else{a.OK.logger.success("photo.fs","req_on");w();}},exitFullScreen:function(){if(h){a.OK.logger.success("photo.fs","req_exit");s();}},visualizePhoto:function(I){var J=c.body,F=(J.className||"").split(" ")||[],G=F.indexOf(u)>=0,D=c.getElementById("__plpcte_target");if(D===null){return;}var H=D.getAttribute(G?"data-fs-src":"data-nfs-src");if(H==null||H.length==0){a.OK.logger.error("photo.fs","no_trg_src");return;}var E=(G?"true":"false"),C=(D.fsData=D.fsData||{}),B=C["data-mode-fs"];if(B!==b&&E==B){a.OK.logger.success("photo.fs","vis_skip");return;}if(G){D.style.maxHeight="";D.style.maxWidth="";}C["data-mode-fs"]=E;if(D.src!=H){D.src=H;}if(I!=null&&I.logViews){a.OK.logger.success("photo.fs","vis_"+(G?"full":"wnd"));}},hideFullScreenButton:function(){$(".photo-layer_fullscreen_btn",m).addClass("__disabled");},toggleFullScreenButton:function(){$(".photo-layer_fullscreen_btn",m).toggleClass("__disabled",false);}});});})(window,document);