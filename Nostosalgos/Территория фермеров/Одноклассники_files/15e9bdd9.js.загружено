define(["PTS/webpush","OK/logger","OK/utils/utils","OK/uuid","OK/utils/vanilla"],function(K,w,L,d,x){var G="webpush-device-id",t="webpush-endpoint",z="notification_enabled_messenger";var q="DEFAULT",A="DENIED",o="GRANTED",N="SUBSCRIBED",y="UNSUBSCRIBED";var h="/web-api/webpush/sync";var c=null;var j=false;var k=null;function n(){return"PushManager" in window&&"serviceWorker" in navigator&&window.Notification&&"localStorage" in window;}function E(){return n()&&j;}function l(P){if(!n()){return;}j=P.getAttribute("data-service-worker-is-enabled")==="true";c=P.getAttribute("data-application-server-key");k=P.getAttribute("data-server-status");var O=P.getAttribute("data-message-notifications-enabled")==="true";var Q=P.getAttribute("data-extended-settings-enabled")==="true";if(Q&&k===N){I(O);}v("webpush-activated");if(!j){u("Service worker is disabled");g()["catch"](u);return;}e().then(function(R){if(R===N){u("Subscription is active");return C().then(function(S){if(k!==N||H()!==S.endpoint){u("Subscription has been changed");w.success("webpush.subscription-changed");J(N,S);}});}if(R===o){if(k!==R){J(R);}return;}u("Permission has been revoked");m();I(false);w.success("webpush.subscription-revoked");if(k!==R){return J(R);}},u);}function b(){}function i(O){O=O||"unknown";if(!E()){return Promise.reject("Module is disabled");}return e().then(function(P){if(P===A){throw new Error("User revoked permissions");}if(P===N){return P;}return a().then(s).then(F).then(function(Q){if(O!=="messages"){I(true);B();}w.success("webpush."+O+".subscribe");return J(N,Q,O,true);},function(){w.error("webpush."+O+".subscribe");});});}function g(O){O=O||"unknown";u("Unsubscribe from notifications");if(!n()){return Promise.reject("Push API is not supported");}return C().then(function(P){if(P!==null){P.unsubscribe().then(u);}if(O!=="messages"){I(false);}w.success("webpush."+O+".unsubscribe");m();return J(y,P,O,true);},function(P){w.error("webpush."+O+".unsubscribe");u(P);throw P;});}function e(){if(!Notification){return Promise.resolve(A);}if(Notification.permission==="denied"){return Promise.resolve(A);}if(Notification.permission==="default"){return Promise.resolve(q);}return C().then(function(O){return O?N:o;});}function a(){if(Notification){if(Notification.permission==="default"){return new Promise(function(P,O){Notification.requestPermission(function(Q){if(Q==="granted"){w.success("webpush.request.granted");P(o);}else{w.success("webpush.request.denied");O(A);}});});}else{if(Notification.permission==="granted"){return Promise.resolve(o);}}}return Promise.reject(A);}function s(){u("Register service worker");return navigator.serviceWorker.register(swPath).then(function(O){if(O.installing){u("Service worker installing. scope = "+O.scope);}else{if(O.waiting){u("Service worker installed");}else{if(O.active){u("Service worker active");}}}if(!(O.showNotification)){w.error("webpush.support.showNotifications");throw new Error("Notifications aren't supported on service workers.");}if(Notification.permission==="denied"){w.error("webpush.denied");throw new Error("The user has blocked notifications.");}if(!("PushManager" in window)){w.error("webpush.support.pushManager");throw new Error("Push messaging isn't supported");}return navigator.serviceWorker.ready;});}function F(O){u("Subscribe to notifications");return O.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:L.urlBase64ToUint8Array(c)});}function C(){var O=navigator.serviceWorker.getRegistration();if(O){return O.then(function(P){return P&&P.pushManager?P.pushManager.getSubscription():null;});}return Promise.resolve();}function J(P,Q,O,S){u("Sync subscription");var R={status:P,place:O||"unknown",userAction:S};if(Q){R.subscription={deviceId:f(),endpoint:Q.endpoint,auth:p(Q,"auth"),p256dh:p(Q,"p256dh")};}return x.ajax({method:"POST",url:h,headers:{"Content-Type":"application/json"},data:JSON.stringify(R)}).then(function(){if(Q){D(Q.endpoint);}return P;});}function H(){return r(t);}function D(O){M(t,O);}function m(){v(t);}function I(O){M(z,O?"1":"0");}function p(P,O){return btoa(String.fromCharCode.apply(null,new Uint8Array(P.getKey(O))));}function f(){var O=r(G);if(!O){O=d.generate();M(G,O);}return O;}function r(P,O){if(!localStorage){return null;}try{return localStorage.getItem(P);}catch(Q){w.error("webpush.localStorage-get-"+(Q.name||""+Q));return O;}}function M(O,P){if(!localStorage){return;}try{localStorage.setItem(O,P);}catch(Q){w.error("webpush.localStorage-set-"+(Q.name||""+Q));}}function v(O){if(!localStorage){return;}try{localStorage.removeItem(O);}catch(P){w.error("webpush.localStorage-remove-"+(P.name||""+P));}}function u(){if(OK.fn.isDebug()){if(arguments[0] instanceof Error){console.error.apply(console,arguments);}else{var O=Array.prototype.slice.apply(arguments);O.unshift("[webpush]");console.log.apply(console,O);}}}function B(){if(!Notification){return;}var R=K["notification.enabled.title"],P=K["notification.enabled.body"],Q=OK.cnst.staticUrl+"res/i/html5_notif_icon.png",O="messenger-enabled";return new Notification(R,{body:P,icon:Q,tag:O});}return{STATUS_DEFAULT:q,STATUS_GRANTED:o,STATUS_DENIED:A,STATUS_SUBSCRIBED:N,STATUS_UNSUBSCRIBED:y,isSupported:n,isEnabled:E,activate:l,deactivate:b,subscribe:i,unsubscribe:g,getStatus:e};});