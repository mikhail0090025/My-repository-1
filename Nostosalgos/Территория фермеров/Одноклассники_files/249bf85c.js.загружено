define(["OK/logger","OK/utils/dom","OK/ViewportTracker"],function(i,d,b){var h={standard:"standard",hover:"hover"};function e(t,o,l){var p=[],n,q,r,k,m;for(n=0;n<t;n++){q=-Math.round(n*l);r=q+"px 0";if(!o[n]){p.push(r);}else{k=o[n];for(m=0;m<k;m++){p.push(r);}}}return p;}function a(j,k){j.style.backgroundImage="url("+k+")";}function f(k){var j=getComputedStyle(k).width;if(j){return parseFloat(j.replace("px",""));}return k.clientWidth||0;}function g(j){return new Promise(function(l,k){var m=new Image();m.onload=l;m.onerror=k;m.src=j;});}function c(){this.isPaused=true;this.lastFrameTime=0;this.frameID=0;this.bgPos=0;this.lastPos=0;this.active=0;}c.prototype={activate:function(m){var k=this,l=m.getAttribute("data-framerepeats"),j=l?JSON.parse(l):{};k.element=m;k.mode=m.getAttribute("data-mode")||h.standard;k.width=f(m);k.fps=parseInt(m.getAttribute("data-fps"),10)||24;k.replayDelay=parseInt(m.getAttribute("data-replaydelay"),10)||0;k.frameDuration=(1000/this.fps)+1;k.bindedRender=this.render.bind(this);k.previewImage=this.element.style.backgroundImage;k.spriteImage=m.getAttribute("data-image");return g(k.spriteImage).then(function(q){var n=q.target,p=m.getAttribute("data-frames");if(p==="auto"){p=Math.round(n.width/k.width);}else{p=parseInt(p,10)||60;}k.frames=e(p,j,k.width);if(k.mode===h.hover){var o=d.parent(k.element,"js-hover-container");if(o&&o!==document){o.addEventListener("mouseover",k);o.addEventListener("mouseout",k);k.hoverElement=o;}}else{b.add(k.element,function(r){if(r){k.play();}else{k.pause();}});}},function(n){i.clob("error",k.spriteImage,"prefetch","sprite");throw n;});},setSpriteImage:function(){a(this.element,this.spriteImage);},setPreviewImage:function(){a(this.element,this.previewImage);},deactivate:function(){this.stop();if(this.hoverElement){this.hoverElement.removeEventListener("mouseover",this);this.hoverElement.removeEventListener("mouseout",this);}if(this.mode!==h.hover){b.remove(this.element);}},handleEvent:function(j){if(j.type==="mouseout"){this.pause();}else{if(j.type==="mouseover"){this.play();}}},play:function(){this.setSpriteImage();if(!this.frameID){this.isPaused=false;this.frameID=requestAnimationFrame(this.bindedRender);}},pause:function(){if(!this.isPaused){cancelAnimationFrame(this.frameID);this.frameID=0;this.lastFrameTime=0;this.isPaused=true;}},stop:function(){this.pause();this.setPreviewImage();this.active=0;},render:function(){this.frameID=requestAnimationFrame(this.bindedRender);var j=Date.now();if(this.fps<60&&this.lastFrameTime&&this.lastFrameTime+this.frameDuration>j){return;}this.lastFrameTime=j;this.tick();this.bgPos=this.frames[this.active];if(this.bgPos!==this.lastPos){this.element.style.backgroundPosition=this.lastPos=this.bgPos;}},tick:function(){this.active++;if(this.active>=this.frames.length){var k=this.replayDelay,j=this;if(k!==0){this.pause();setTimeout(function(){j.play();},k);}this.active=0;}}};return c;});