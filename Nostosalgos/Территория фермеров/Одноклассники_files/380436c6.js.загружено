define("OK/DiscussionManager",["jquery"],function(b){var c={};return{add:function(d){var f=d.getId();if(!d&&!f){return;}if(!c[f]){c[f]=[];}for(var e=0;e<c[f].length;e++){if(c[f][e]==d){return;}}c[f].push(d);},remove:function(e){var f=e.getId();if(!e&&!f){return;}var d=c[f].indexOf(e);d>-1&&c[f].splice(d,1);},processUpdate:function(d){var g=d["tlb.act"];if(g==="news"&&d.refId==="newsFetch"){var f=d.respCO,e=d.respNK;if(f){b.each(f,function(n,l){var k=c[n],m=l.dNCC;if(m>0){a(k,m);}else{var j=l.dntfCs;if(j){a(k,500);}}for(var h=0;k&&h<k.length;h++){if(l.dntfECs){b.each(l.dntfECs,function(){k[h].updateComment(this["cId"]);});}}});}if(e){b.each(e,function(h,j){var i=c[h];i&&b.each(i,function(){var k=this;b.each(j,function(){var l=k.list.findComment(this["cId"]);if(l){l.updateKlass();}});});});}}},deleteComment:function(d,g,e){var f=c[d];if(f){b.each(f,function(){this.deleteComment(g,e);});}},restoreComment:function(d){var e=c[d];if(e){b.each(e,function(){this.restoreComment();});}},markAsRead:function(d){var e=c[d];if(e){b.each(e,function(){this.markAsRead();});}},forEachOpened:function(d,g,e){var f=c[g+"_"+d];if(f&&e){b.each(f,function(){e.call(this);});}}};function a(g,h){var f=g?g.length:0;if(f<1){return;}var e=g[0].refresh(h);if(e){for(var d=0;d<f;d++){g[d].processNewComments(e);}}}});define("OK/discussions/ScrollController",["jquery","OK/utils/throttle","OK/utils/utils"],function(e,d,b){function a(f){this.element.scrollTop=this.element.scrollTop+f;}var c=function(f,h,g){f=OK.util.extend({stickyContainer:e()},f);this.element=f.scrollingContainer;this.$element=e(this.element);this.loaderId=h;this.stickyContainer=f.stickyContainer;this.scrollingFn=g||a;};c.prototype={getLoader:function(){return OK.hookModel.getHookById(this.loaderId);},hasMore:function(){return this.getLoader()!=null&&this.getLoader().hasMore();},hasLess:function(){return this.getLoader()!=null&&this.getLoader().hasLess();},scroll:function(h,g){var f=g||this.scrollingFn;f.call(this,h);},scrollToBottom:function(f,h){if(f){this.scroll(f.getBoundingClientRect().bottom-this.visibleBottomOfContainer(this),h);}else{var g=this.element;if(g){this.scroll(g.scrollHeight,h);}}},scrollToTop:function(g){var f=this.element;if(f){g=g||a;this.scroll(-f.scrollTop,g);}},scrollToBottomFancy:function(g){var f=this.element;if(f){this.scroll(f.scrollHeight,g);}},scrollToTopOf:function(g){var h=this.element;if(!this.isVisible(g)&&h){var i=h.getBoundingClientRect();var f=g.getBoundingClientRect();this.scroll(Math.max(f.top-i.top,0));this.trigger();}},hasScroll:function(){var f=this.element;if(f){return f.scrollHeight>f.offsetHeight;}},isScrolledToBottom:function(g){var f=this.element;if(f){g=g||0;return f.scrollTop+g>=(f.scrollHeight-f.offsetHeight);}},getScrollTop:function(){return this.element&&this.element.scrollTop;},setScrollTop:function(g){var f=this.element;if(f){f.scrollTop=g;}},scrollTo:function(f,h){h=h||0;var g=this.element;if(g){this.scroll(f.getBoundingClientRect().bottom-g.getBoundingClientRect().top+h);}},scrollToCenter:function(i,n){n=n||a;var h=this.element;if(h){var f=h.getBoundingClientRect(),m=i.getBoundingClientRect(),j=f.bottom-f.top,g=f.top+j/2,k=(m.bottom-m.top),l=m.top+k/2;if(k>j){this.scroll(m.top-g+j/3,n);}else{this.scroll(l-g,n);}}},isVisible:function(g){var h=this.element;if(!g||!h){return false;}var i=h.getBoundingClientRect();var f=g.getBoundingClientRect();return f.top>=i.top&&f.bottom<=this.visibleBottomOfContainer(this);},isVisibleBottomOf:function(f){return f.getBoundingClientRect().bottom<=this.visibleBottomOfContainer(this);},isVisibleBottomOfElFromTop:function(g){var h=this.element;if(h){var f=g.getBoundingClientRect();var i=h.getBoundingClientRect();var j=Math.min(f.top-i.top,0);return j>=0||Math.abs(j)<=g.offsetHeight;}},loadLast:function(){var f=this;return this.getLoader().loadLast().done(function(){f.scrollToBottom();});},loadMore:function(){var f=this;return this.getLoader().loadMore().done(function(){f.scrollToBottom();});},load:function(f){if(this.getLoader()){return this.getLoader().loadByUrl(f);}else{return b.ajax({url:f});}},trigger:function(){this.$element.trigger("scroll");},addListener:function(g,f){if(f){this.$element.on("scroll."+f,g);}else{this.$element.on("scroll",g);}return this;},removeListener:function(f){this.$element.off("scroll",f);return this;},removeListeners:function(f){this.$element.off("scroll."+f);},makeVisible:function(g){var h=this.element;if(!this.isVisible(g)&&h){var i=h.getBoundingClientRect();var f=g.getBoundingClientRect();var j=Math.min(f.top-i.top,0)+Math.max(f.bottom-this.visibleBottomOfContainer(this),0);this.scroll(j);}},isScrollable:function(){var f=this.element;if(f){return f.scrollHeight>f.clientHeight;}},visibleBottomOfContainer:function(f){var g=f.element;if(g){return g.getBoundingClientRect().bottom-f.stickyContainer.height();}},scrollTop:function(g){var f=this.element;if(f){f.scrollTop=g;}}};return c;});define("OK/textarea",["jquery"],function(c){var f={className:"autosizejs",append:"",callback:false,onBeforeResize:c.noop,resizeDelay:10},h='<textarea tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>',b='<div tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>',a=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],e,d=c(h).data("autosize",true)[0],g=c(b).data("autosize",true);d.style.lineHeight="99px";if(c(d).css("lineHeight")==="99px"){a.push("lineHeight");}d.style.lineHeight="";g[0].style.lineHeight="99px";if(g.css("lineHeight")==="99px"){a.push("lineHeight");}g[0].style.lineHeight="";c.fn.autosize=function(i){var j=0;try{if(!this.length){return this;}i=c.extend({},f,i||{});j=1;if(d&&d.parentNode!==document.body){c(document.body).append(d);c(document.body).append(g);}j=2;return this.each(function(){var p=this,o=c(p),v,x,n=0,w=c.isFunction(i.callback),q={height:p.style.height,overflow:p.style.overflow,overflowY:p.style.overflowY,wordWrap:p.style.wordWrap,resize:p.style.resize},s,l=o.width();j=3;if(o.data("autosize")){return;}o.data("autosize",true);j=4;if(o.css("box-sizing")==="border-box"||o.css("-moz-box-sizing")==="border-box"||o.css("-webkit-box-sizing")==="border-box"){n=o.outerHeight()-o.height();}j=5;x=Math.max(parseInt(o.css("minHeight"),10)-n||0,o.height());j=6;o.css({overflow:"hidden",overflowY:"hidden",wordWrap:"break-word",resize:(o.css("resize")==="none"||o.css("resize")==="vertical")?"none":"horizontal"});j=7;function r(){var z,y;j=8;if("getComputedStyle" in window){z=window.getComputedStyle(p);y=p.getBoundingClientRect().width;j=9;c.each(["paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"],function(A,B){y-=parseInt(z[B],10);});j=10;d.style.width=g[0].style.width=y+"px";}else{j=11;d.style.width=g[0].style.width=Math.max(o.width(),0)+"px";}}function u(){var z={};j=12;e=p;d.className=i.className;v=parseInt(o.css("maxHeight"),10);j=13;c.each(a,function(B,C){z[C]=o.css(C);});j=14;c(d).css(z);g.css(z);j=15;r();if(window.chrome){j=16;var y=p.style.width;j=17;p.style.width="0px";j=18;var A=p.offsetWidth;p.style.width=y;}}function t(){j=19;var y,B,A=p.contentEditable==="true";j=20;if(e!==p){u();j=21;}else{r();j=22;}B=parseInt(p.style.height,10);j=23;var z;if(A){g.html(o.html()+i.append);j=24;z=g[0];j=25;}else{d.value=p.value+i.append;j=26;z=d;j=27;}z.style.overflowY=p.style.overflowY;j=28;z.scrollTop=0;j=29;z.scrollTop=90000;y=z.scrollTop;j=30;if(v&&y>v){p.style.overflowY="scroll";j=31;y=v;j=32;}else{p.style.overflowY="hidden";j=33;if(y<x){y=x;}}j=34;y+=n;j=35;if(B!==y){i.onBeforeResize.call(p,y);j=36;p.style.height=y+"px";j=37;if(w){i.callback.call(p,p);j=38;}}}function m(){j=39;clearTimeout(s);j=40;s=setTimeout(function(){j=41;var y=o.width();j=42;if(y!==l){l=y;j=43;t();}},parseInt(i.resizeDelay,10));}j=48;o.on("input.autosize",t);if(i.resizeDelay!==false){j=49;c(window).on("resize.autosize",m);}o.on("autosize.resize",t);j=50;o.on("autosize.resizeIncludeStyle",function(){j=51;e=null;j=52;t();});o.on("autosize.destroy",function(){j=53;e=null;j=54;clearTimeout(s);j=55;c(window).off("resize",m);j=56;o.off("autosize").off(".autosize").css(q).removeData("autosize");});j=57;t();});}catch(k){OK.logging.logger.success("messagesLayer","e.autosize_"+j);}};c.fn.persistant=function(j){var i="localStorage" in window&&window.localStorage!==null;if(!this.length||!i){return c(this);}var l=c("<div/>"),k={idKey:"data-id",afterInit:c.noop,valueGetAdapter:function(m){return m?this.html():this.val();},valueSetAdapter:function(m,n){m?this.html(l.text(n).html().replace(/\n/g,"<br>")):this.val(n);}};j=c.extend({},k,j||{});return this.each(function(){var q=this,p=c(this),r=q.contentEditable==="true",m=j.valueGetAdapter.call(p,r),o=p.attr(j.idKey)||p.attr("id"),s=o?localStorage.getItem(o):null,n;if(!m&&s){j.valueSetAdapter.call(p,r,s);j.afterInit.call(this,s);}p.on("reset.persistant",function(){localStorage.removeItem(o);});p.on("textchange",function(){n&&clearTimeout(n);n=setTimeout(function(){var t=j.valueGetAdapter.call(p,r);if(t.length===0||/^[<br>\s\t\n\r]+$/.test(t)){localStorage.removeItem(o);}else{if(o&&t){localStorage.setItem(o,t);}}},200);});});};return{activate:function(i){c(i).autosize();}};});define("OK/discussions/NewCommentsLabel",["jquery"],function(d){var c="click.label";var a=function(f,e,g){this.discussion=e;this.form=g;this.element=f;this.$element=d(f);this.icon=d(".tico_img",this.element);this.text=d(".text",this.element);this.newCommentsMessage=null;this.comentAddedMessage=null;this.t=0;};a.prototype={showAsNew:function(e){this.newCommentsMessage=this.text.data("textnew");this.refresh(e);return this;},show:function(f){var e=this;this.comentAddedMessage=this.text.data("text");this.refresh(f);this.t=setTimeout(function(){clearTimeout(e.t);e.refresh(f);},4000);return this;},refresh:function(g){var e=this;if(g){this.$element.off(c).one(c,function(){e.hide().discussion.showLatest(g);});}if(this.comentAddedMessage||this.newCommentsMessage){var f=function(){if(!e.discussion.scrollController.hasMore()){e.hide();e.discussion.scrollController.removeListener(f);}};this.discussion.scrollController.addListener(f);}if(this.comentAddedMessage){this.text.html(this.comentAddedMessage);this.icon.removeClass("ic_arrow-d-w").addClass("ic_ok-w");b(this.$element);this.comentAddedMessage=null;}else{if(this.newCommentsMessage){this.text.html(this.newCommentsMessage);this.icon.removeClass("ic_ok-w").addClass("ic_arrow-d-w");b(this.$element);this.newCommentsMessage=null;}else{this.hide();}}},hide:function(){this.$element.addClass("__hidden").removeClass("__active");return this;}};function b(e){e.removeClass("__hidden").addClass("__active");}return a;});define("OK/CurrentUserCfg",["OK/utils/utils"],function(c){var a=c.deferred(),g=c.deferred(),d={},f,e;var b={getUrlPattern:function(){return f;},getUserId:function(){return e;},ohViaSheet:function(){return d.ohvs;}};return{activate:function(h){a.resolve(h);},applyConfig:function(h){a.promise.then(function(){d=h;if(h["share.urlPattern"]){f=new RegExp(h["share.urlPattern"]);}if(h.uid){e=h.uid;}g.resolve();});},whenReady:function(h){g.promise.then(function(){h(b);});}};});define("OK/LinkDetector",["OK/CurrentUserCfg"],function(a){function c(d,e){return{url:d[0],substr:e};}function b(){}b.prototype.parse=function(e,d){return new Promise(function(f){a.whenReady(function(j){var p=[];if(e&&e.trim().length!==0){var n=e.split(/\s+/);for(var l=0;l<n.length;l++){var h=n[l];var m=j.getUrlPattern();var k=m.exec(h),g=k!=null&&k[0]===h;if(g){if(d){var o=e.charAt(e.length-1);if(o==" "||o=="\n"||o==="\xA0"){p.push(c(k,h));}}else{p.push(c(k,h));}}}}f(p);});});};return b;});define("OK/discussions/LinkAttachController",["jquery","OK/utils/utils","OK/AttachPicker"],function(g,j,d){var e={maxLinks:1,isSmall:false};function a(m,l){this.settings=g.extend({},e,l);this.attachPickerId=m;this.queue={};this.processed={};this.removed={};this.linksProcessed=0;this.onAttachRemoved=c.bind(this);d.subscribe(m,"remove",this.onAttachRemoved);if(this.attachPickerId){var k=this,n=d.getFiles(this.attachPickerId);g.each(n,function(q,r){var o=r.linkPreviewViewState;if(o){var p=o.sourceUrl;if(p){h(k,p,r.type,r.id);}}});}}a.prototype.process=function(k,l){return b(this,l);};a.prototype.destroy=function(){d.unsubscribe(self.attachPickerId,"remove",this.onAttachRemoved);};a.prototype.reset=function(){this.queue={};this.processed={};this.removed={};this.linksProcessed=0;};a.prototype.getAttachedLinks=function(){return Object.keys(this.processed);};function f(l,m){var k=false;if(l.processed[m]){return true;}g.each(l.processed,function(n){k=k||n.indexOf(m)===0;});return k;}function i(k,m){var l=m.url;return !k.queue[l]&&!f(k,l)&&!k.removed[l];}function b(l,n){var m=n.url,k=g.Deferred();var p=i(l,n);k.notify(p);if(p){var o=j.ajax({url:"/dk?cmd=AttachLinkPreview",data:{linkUrl:m,sm:l.settings.isSmall?"on":"off"}});l.queue[m]=o;o.done(function(r){var v=false;if(r){r=JSON.parse(r);var s=r.error;if(!s&&l.queue[m]===this){var u=r.id,q=r.type;if(q){var t=q==="TOPIC";if(!t||l.linksProcessed<l.settings.maxLinks){OK.logging.logger.success("discussions.linkAttached",q);d.add(l.attachPickerId,[r],true);h(l,m,q,u);v=true;}}}}k.resolve(v);});o.always(function(){delete l.queue[m];});o.fail(function(){OK.logging.logger.success("discussions.linkPreviewFailed");k.reject(p);});k.fail(function(){l.processed[m]={failed:true};});}return k;}function c(m,l,n){var k=this;g.each(k.processed,function(o,p){n=parseInt(n,10);if(p.type===l&&(isNaN(n)||p.objectId===n)){l==="TOPIC"&&(--k.linksProcessed);k.removed[o]=true;delete k.processed[o];}});}function h(k,l,m,n){k.processed[l]={type:m,objectId:parseInt(n,10)};m==="TOPIC"&&(++k.linksProcessed);}return a;});define("OK/StickerSuggester",["require","OK/utils/utils","OK/utils/dom","OK/logger"],function(d){var b=d("OK/utils/utils"),g=d("OK/utils/dom"),c=d("OK/logger"),h="__active",e="StickerSuggester",a="propertychange.stSug change.stSug click.stSug keyup.stSug input.stSug paste.stSug";var f=function(j,l){this.element=l;this.textarea=j.textarea;this.lastQuery="";this.isClearOnStickerSend=l.getAttribute("data-clear-on-send")==="true";var i=this,n=l.getAttribute("data-replace-images")==="true",m,k;i.textarea.on(a,function(){clearTimeout(k);k=setTimeout(function(){if(document.activeElement===i.textarea.get(0)){m=j.getValue(n).trim();if(m){if(i.lastQuery!=m){i.sendRequest(m);}else{if(i.lastContent){i.show();}}}else{i.clear("");}}else{i.hide();}},100);});};f.prototype={sendRequest:function(j){var i=this;b.ajax({url:"/dk?cmd=SuggestStickers",data:{"st.q":j}}).fail(function(){c.error(e,"ajax");}).done(function(k){if(k){i.lastQuery=j;i.lastContent=k;OK.hookModel.setHookContent("StickerSuggestCnt",k);i.show();c.success(e,"show",j);}else{i.clear(j);}});},isEmojiMenuVisible:function(){var j=this.textarea.data("emojiarea"),i=j&&j.menu;return i&&i.visible;},clear:function(i){this.hide();this.lastQuery=i;this.lastContent="";},hide:function(){this.element.classList.remove(h);},show:function(){if(this.isEmojiMenuVisible()){return;}this.element.classList.add(h);},destroy:function(){this.hide();this.textarea.off(a);}};return f;});define("OK/utils/scrollHelper",["jquery"],function(a){return{scrollToVisible:function(g,d){var j=a(d);var i=a(g);var e=i.offset().top;var h=i.scrollTop();var c=i.height();var b=e+c;var f=j.height();var k=j.offset().top;if(k+f>b){i.scrollTop(h+k+f-e-c+5);}else{if(k<e){i.scrollTop(h+k-e-5);}}},scrollInLoadMoreDataPosition:function(d){var b=a(d);var c=d.scrollHeight-b.scrollTop()-b.height();return c<=200;},isScrollingVisible:function(d){var b=d.offsetHeight||0;var c=d.scrollHeight||0;return c>b;}};});define("OK/suggest/suggestImpl",["jquery","OK/utils/scrollHelper"],function(b,a){return function(ap,J,ac){var ar={selectOnReload:false,correctSelection:true,minSearchQueryLength:0,getMaxItemsInSuggest:function(){return 5;},getMaxSelectedFriends:function(){return 5;},getMarkFriendDisabledMsg:function(){return"";},getSearchQuery:function(){return"";},onItemsChanged:function(){},onItemClicked:function(aB){},onSelectedItemChanged:function(aB){},onLoadingChanged:function(aB){},onSearchProgressChanged:function(aB){},onSearchInputChanged:function(){}};J=b.extend(J,b.extend(ar,J));var m=J.elementId;var at="mm_"+m,q="mo_"+m,F="mc_"+m;var N=J.selectOnReload;var aw=J.correctSelection;var ao=J.customCls||"";var ag=J.suggestElId||m;var ak=J.messageElId||m+"_msg";var ad=J.itemsElId||m+"_itms";var X=J.loadingElId||m+"_loading";function j(aB){return m+"_"+aB;}var Y=true;var c=J.getMaxItemsInSuggest()<=0;var C;var I;var aA;var U=false;var af;var w;var L;var aj;var D=[];var s=[];var ai=-1;var T=false;var ab;var am;function ae(){if(0<=ai&&ai<D.length){return ap.getItemById(D[ai]);}return null;}function Z(){if(am){return am;}am=b("#"+ag);if(am.length>0){if(c){var aC;var aB=function(){if(Y&&!aA&&aj&&a.scrollInLoadMoreDataPosition(am[0])){l(L);}};am.scroll(function(){if(aC){clearTimeout(aC);}aC=setTimeout(aB,300);});}}else{am=null;}return am;}function z(){if(c){if(Y&&!aA&&aj){var aB=Z();if(aB&&!a.isScrollingVisible(aB[0])){l(L);}}}}function W(aK,aE,aD){var aI=ai>=0&&ai<D.length?D[ai]:-1;Z();L=aK;aj=aD;if(D.length==aE.length||!c&&D.length>=J.getMaxItemsInSuggest()&&aE.length>=J.getMaxItemsInSuggest()){if(aE.length===0&&D.length===0){return false;}var aB={};var aJ;var aG=0;for(aJ=0;aJ<aE.length;aJ++){aB[aE[aJ]]=true;if(!c){if(!s[aE[aJ]]){aG++;}if(aG>=J.getMaxItemsInSuggest()){break;}}}var aC;var aH=0;for(aJ=0;aJ<D.length;aJ++){if(!aB[D[aJ]]){aC=true;break;}if(!c){if(!s[D[aJ]]){aH++;}if(aH>=J.getMaxItemsInSuggest()){break;}}}if(!c&&(aH!=aG||aH>=J.getMaxItemsInSuggest())){aC=true;}aJ=null;if(!aC){return false;}}ai=-1;T=true;var aF=D.length>0&&aE.length===0;p(aE);aF=aF||D.length>0;al(aI,false);V();if(aF){J.onItemsChanged();}return aF;}function p(aC){var aE="";var aG=0;D=[];var aF=0;for(var aD=0;aD<aC.length;aD++){var aI=aC[aD];var aL=ap.getItemById(aI);if(!aL){continue;}if(!c){if(!s[aI]){aF++;}if(aF>J.getMaxItemsInSuggest()){break;}}var aJ=v(aI,aG++,aL);var aH=document.createElement("div");aH.appendChild(aJ);aE+=aH.innerHTML;D.push(aI);}if(c){var aB=document.createElement("div");aB.appendChild(t());aE+=aB.innerHTML;}var aK=b("#"+ad);if(!J.mention||aK.html()!==aE){aK.html(aE);}}function H(){var aC=0;for(var aB=0;aB<D.length;aB++){if(!s[D[aB]]){aC++;}}return aC;}function av(aH,aC){Z();aj=aC;var aE;var aB=D.length;var aD=b("#"+ad);var aG=H();var aK;if(c){aK=b("#"+X);}for(var aF=0;aF<aH.length;aF++){var aI=aH[aF];var aL=ap.getItemById(aI);if(!aL){continue;}if(!c){if(!s[aI]){aG++;}if(aG>J.getMaxItemsInSuggest()){break;}}var aJ=v(aI,aB++,aL);if(c&&aK){aK.parent().remove();aK=null;}aD.append(aJ);D.push(aI);aE=true;}if(c&&aE){aD.append(t());}al(null,true);V();if(aE){J.onItemsChanged();}}function t(){var aB=document.createElement("li");aB.className="suggest_li "+(aA?"":" invisible");if(!J.disableLoadingProgress){aB.innerHTML='<div id="'+X+'" class="loader-controls in-progress"><div class="link-show-more_loading"><span class="fetching-hor">***</span></div></div>';}return aB;}function v(aE,aC,aD){aD.visible=!s[aE];var aB=document.createElement("li");aB.className="suggest_li"+(aD.visible?"":" invisible");aB.innerHTML=ac.createItemElement(aD);aB.setAttribute("id",j(aE));aB.setAttribute("onmousemove","OK.il.f(event,'"+at+"', "+aC+");");aB.setAttribute("onmouseover","OK.il.f(event,'"+q+"', "+aC+");");aB.setAttribute("onclick","OK.il.f(event,'"+F+"', "+aC+");");return aB;}function S(aD,aC){var aB=b("#"+j(aD));if(aB.length===0){return false;}aB.toggleClass("invisible",!aC);}function ax(aD){var aB=b("#"+j(aD));if(aB.length===0){return false;}var aC=!s[aD];S(aD,aC);return true;}function k(aE,aB){var aC=ap.getItemById(aE);var aD=b("#"+j(aE));ac.setItemSelected(aC,aD,aB);}function aa(aB){var aD=D[aB];var aC=ap.getItemById(aD);return aC.disabled;}function M(aB){return s[D[aB]];}function K(aB){return !M(aB)&&!aa(aB);}var az={id:at,handlerId:"h"+this.id,handle:function(aC,aB){if(C){return;}T=false;}};var P={id:q,handlerId:"h"+this.id,handle:function(aC,aB){if(C||I){return;}if(0<=aB&&aB<D.length){if(ai!==aB&&K(aB)){T=false;R(aB);}}}};var ay={id:F,handlerId:"h"+this.id,handle:function(aC,aB){if(C){return;}if(0<=aB&&aB<D.length&&K(aB)){T=false;R(aB);var aE=aC.target;var aD;while(aE!=null&&!aE.getAttribute("id")){aD=aE.getAttribute("data-action");if(aD){break;}aE=aE.parentNode;}J.onItemClicked(ap.getItemById(D[aB]),aD);}}};OK.il.ah(az);OK.il.ah(P);OK.il.ah(ay);function E(){OK.il.rh(az);OK.il.rh(P);OK.il.rh(ay);}function al(aF,aE){if(D.length===0){if(ai!==-1){R(-1);}return;}if(!aw){if(!aE){R(-1);}return;}if(N&&aF&&aF!=-1){for(var aC=0;aC<D.length;aC++){if(aF==D[aC]){if(K(aC)){R(aC);}return;}}return;}if(ai===-1){for(var aC=0;aC<D.length;aC++){if(K(aC)){R(aC);break;}}return;}if(M(ai)){for(var aB=ai+1;aB<D.length;aB++){if(K(aB)){R(aB);return;}}for(var aD=ai-1;aD>=0;aD--){if(K(aD)){R(aD);return;}}R(-1);}}function i(){if(D.length===0){return;}if(ai===-1){return;}for(var aB=ai-1;aB>=0;aB--){if(K(aB)){T=true;R(aB);break;}}}function au(){if(D.length===0){return;}for(var aB=ai+1;aB<D.length;aB++){if(K(aB)){T=true;R(aB);break;}}}function d(aC){for(var aB=0;aB<D.length;aB++){if(D[aB]==aC){if(K(aB)){T=true;R(aB);}break;}}}function R(aD){if((typeof aD)==="string"){aD=+aD;}var aE=ai!==aD;if(ai>=0&&ai<D.length){var aB=D[ai];if(aB){if(!aE){k(aB,!C);return;}k(aB,false);}}ai=-1;if(aD>=0&&aD<D.length){var aF=D[aD];var aC=!aF;if(aC||!K(aD)){return;}k(aF,!C);ai=aD;J.onSelectedItemChanged(ap.getItemById(aF));if(aE){V();}}}function V(){if(c&&T){var aC;if(ai>=0&&ai<D.length){aC=ai;}else{if(ai==-1){aC=0;}else{return;}}var aB=D[aC];if(aB){var aE=b("#"+j(aB));if(aE.length>0){var aD=Z();a.scrollToVisible(aD[0],aE[0]);}}}}var B=-1;var e=1;var O=2;var an=3;var u=4;var h=5;var n=function(aD,aH){var aC;var aB;ab=aD;var aF=aD.query;var aE=aD.itemIds;var aI=aD.hasMore;if(aF===L){av(aH,aI);aB=O;}else{if(aF==J.getSearchQuery()||aF.toString()==J.getSearchQuery().toString()){var aG=W(aF,aE,aI);aB=aG?an:u;}else{aC=true;aB=h;}}ah(false,true,aF,aB,aD);if(!aC){z();}};var o=function(aB,aC){w=aB;ah(false,false,aC,B);};function l(aC){ah(true,true,aC,e);aC=aC||J.getSearchQuery();var aB;if(J.getMaxItemsInSuggest()>0){aB=J.getMaxItemsInSuggest()+J.getMaxSelectedFriends();}else{aB=0;}ap.search(aC,aB,n,o);}function y(){var aB=L;L=null;l(aB);}function A(aB){if(Y!=aB){Y=aB;x();}}function ah(aF,aE,aD,aB,aC){if(aA!=aF){aA=aF;x();g();J.onLoadingChanged(aA,aE,aD,aB,aC);}}function f(aB){if(C!=aB){C=aB;x();}}function Q(aB){if(I!=aB){I=aB;}}function r(aB){if(U!=aB){U=aB;x();}}function G(aB){if(af!=aB){af=aB;aq();}}function x(){var aB=b("#"+ag);aB.toggleClass("__active",Y);aB.toggleClass("__disabled",C||aA);aB.toggleClass("__message",U);}function g(){if(!c||J.disableLoadingProgress){return;}var aC=b("#"+X);if(aC.length==0){return;}aC.toggleClass("invisible",!aA);if(aA){var aB=Z();if(aB){}}}function aq(){b("#"+ak).html(af);}return{createHtml:function(){return'<div id="'+ag+'" class="suggest'+(Y?" __active":"")+(c?" __scroll":"")+(C||aA?" __disabled":"")+(ao?" "+ao:"")+(U?" __message":"")+'"><div id="'+ak+'" class="suggest_tx">'+(af?af:"")+'</div><ul id="'+ad+'" class="suggest_ul"></ul></div>';},resetSelection:function(){var aC=Z();if(aC){aC.scrollTop(0);for(var aB=0;aB<D.length;aB++){if(K(aB)){R(aB);break;}}}},isVisible:function(){return !!Y;},setVisible:function(aB){A(aB);},setDisabled:function(aB){f(aB);},setMouseOverDisabled:Q,isMessageVisible:function(){return !!U;},setMessageVisible:function(aB){r(aB);},setMessage:function(aB){G(aB);},search:function(aB){l(aB||J.getSearchQuery());},isSearchDisabled:function(){return !!w;},getDisplayQuery:function(){return L;},hasVisibleItems:function(){for(var aB=0;aB<D.length;aB++){if(!s[D[aB]]){return true;}}return false;},hasHiddenItems:function(){for(var aB=0;aB<D.length;aB++){if(s[D[aB]]){return true;}}return false;},setHiddenItemId:function(aD,aC){var aB=(aC!=s[aD]);if(aB){s[aD]=aC;if(ax(aD)){if(!c){y();}else{al();J.onItemsChanged();if(aC){z();}}}}},resetHiddenItemIds:function(aD){aD=aD||{};var aC=s;s=aD;var aF;for(var aB=0;aB<D.length;aB++){var aE=D[aB];if(s[aE]&&!aC[aE]||!s[aE]&&aC[aE]){if(ax(aE)){aF=true;}}}if(aF){if(!c){y();}else{al();J.onItemsChanged();z();}}},resetItems:function(aB,aC){p(aB||D);_selectedItemId=-1;if(typeof aC!="undefined"){L=aC;}},getItemElId:j,selectPrevious:i,selectNext:au,selectItemById:d,getSelectedItem:ae,getSearchEntry:function(aB){return aB?ap.getSearchEntry(aB):ab;},SEARCH_RESULT_ERROR:B,SEARCH_RESULT_LOADING:e,SEARCH_RESULT_APPEND_ITEMS:O,SEARCH_RESULT_SET_ITEMS:an,SEARCH_RESULT_SET_ITEMS_CACHED:u,SEARCH_RESULT_UNKNOWN:h,destroy:function(){E();ap.clearCaches();J=null;}};};});define("OK/suggest/searchEngines",["jquery","OK/utils/utils","OK/utils/vanilla"],function(c,i,g){function d(m,l,n,o){return j("/dk?cmd="+m,l,n,o);}function f(m){var l=m.address;if(m.distance){if(l.length>0){l+=" ("+m.distance+")";}else{l=m.distance;}}m.latitude=parseFloat(m.latitude);m.longitude=parseFloat(m.longitude);m.text=g.encodeHtml(m.name);m.smallText=m.categoryName;m.smallText2=g.encodeHtml(l);}function h(n){for(var l=0;l<n.length;l++){var m=n[l];m.imageSrc=m.photo;m.text=g.encodeHtml(m.name);m.ui=""+m.id;m.ul=0+m.id;m.uf=g.encodeHtml(m.name);m.mkto=true;}}function k(l,n){l.id=l.ui;l.imageSrc=OK.userCache.getLinkOnUserAvatar(l);l.text=l.uf;if(!n){var m=l.mkto;if(!m){l.disabled=true;}}}function j(s,l,p,q){var r={};var n={};function o(x,u,z,A){if(!r[x]){r[x]={query:x,index:0,itemIds:[],hasMore:true,requestId:""};}var w=r[x];if(!w.hasMore||(u&&w.itemIds.length>=u)){z(w,[]);return w;}var y="search-d-"+new Date().getTime();w.requestId=y;var t={"gwt.requested":window.pageCtx.gwtHash,refId:w.requestId};var v=m.prepareRequest(x,w,t);if(v===false){return;}i.ajax({type:"POST",url:s,data:t,dataType:l,timeout:10000}).done(function(D,B,K){var C=K.getResponseHeader("TKN");if(C){OK.tkn.set(C);}if(w.requestId!==y||r.length==0){A(false,x);return;}var E;if(l=="html"){E=OK.util.parseJSON(D);}else{if(l=="json"){E=D;}}var H=m.processResponse(E,w);if(H){var G=[];for(var F=0;F<H.length;F++){var J=H[F];var I=J.id;w.itemIds.push(I);G.push(I);n[I]=J;}z(w,G);}else{A(true,x);}}).fail(function(B,D,C){A(false,x);});return w;}var m={search:o,prepareRequest:p,processResponse:q,clearCaches:function(){r={};n={};},getItemById:function(t){return n[t];},getSearchEntry:function(t){return r[t];}};return m;}function b(o,p){var q={};var m={};function n(v,s,w,x){if(!q[v]){q[v]={query:v,index:0,itemIds:[],requestId:""};}var u=q[v];if(u.itemIds.length){w(u,[]);return u;}u.requestId="search-d-"+new Date().getTime();var r={refId:u.requestId};var t=l.prepareRequest(v,u,r);if(t===false){return;}require(["OK/YandexMapsApi"],function(y){y.then(function(z){z.suggest(r.request,r.options).then(function(D){var A=l.processResponse(D,u);if(A){var E=[];for(var B=0;B<A.length;B++){var C=A[B];var F=C.id;u.itemIds.push(F);E.push(F);m[F]=C;}w(u,E);}else{x(true,v);}},function(){x(true,v);});});});return u;}var l={search:n,prepareRequest:o,processResponse:p,clearCaches:function(){q={};m={};},getItemById:function(r){return m[r];},getSearchEntry:function(r){return q[r];}};return l;}function e(l){var n={};var m=j("/web-api/suggest/locations/profile","json",function(q,p,o){o.q=p.query;if(l){o.cid=l.value;}},function(q,s){s.hasMore=false;var o=q||[];for(var r=0;r<o.length;r++){var p=o[r];p.id=p.cityId;p.text=p.city;p.smallText=p.regions?p.regions+", "+p.country:p.country;if(p.city){n[p.city.trim().toLowerCase()]=p;}}return o;});m.locationByCityCache=n;return m;}function a(l){return d("FriendsSearch","html",function(p,o,n){var m="d.in";c.extend(n,{"d.sq":o.query,"d.o":o.index,"d.d":m});},function(n,m){var v=n.searchEnabled;if(v===false){return null;}var r=n["jsp.cc"];var u=n["jsp.stc"]||0;m.index=m.index+r;m.hasMore=m.index<u;m.totalCount=u;var s=[];var p=n["jsp.sr"]||[];var t=n["jsp.sl"]||[];if(t.length){t.forEach(function(w){p[w.ui]=w;});}if(!l){OK.userCache.updateUserCache(p);}if(!t.length){for(var q in p){if(Object.prototype.hasOwnProperty.call(p,q)){var o=p[q];k(o,l);s.push(o);}}}else{t.forEach(function(w){k(w,l);s.push(w);});}return s;});}return{createSearchEngine:d,createYandexSearchEngineEndpoint:b,locationsSearchEngine:e(),createLocationsSearchEngine:e,friendsSearchEngine:a(),allFriendsSearchEngine:a(true),prepareUsersForRenderer:function(m){for(var l=0;l<m.length;l++){k(m[l]);}},mentionsEngine:d("FriendsSearch","html",function(o,n,m){var l="d.in";c.extend(m,{"d.sq":n.query,"d.o":n.index,"d.d":l,"d.wg":"on"});},function(n,l){var w=n.searchEnabled;if(w===false){return null;}var r=n["jsp.cc"];var v=n["jsp.stc"]||0;l.index=l.index+r;l.hasMore=l.index<v;l.totalCount=v;var s=[];var p=n["jsp.sr"]||[];var u=n["jsp.sl"]||[];var m={};if(!u.length){for(var q in p){if(Object.prototype.hasOwnProperty.call(p,q)){var o=p[q];if(!o.group){m[q]=o;}}}}else{u.forEach(function(x){m[x.ui]=x;});}OK.userCache.updateUserCache(m);function t(x,y){x.id=x.ul;if(x.group){var A=x.photo;if(A){x.imageSrc=A;}}else{x.imageSrc=OK.userCache.getLinkOnUserAvatar(x);}x.text=x.uf;var z=x.mkto;if(!z){x.disabled=true;}y.push(x);}if(!u.length){for(q in p){if(Object.prototype.hasOwnProperty.call(p,q)){t(p[q],s);}}}else{u.forEach(function(x){t(x,s);});}return s;}),conversationsSearchEngine:d("ConversationsSearch","html",function(n,m,l){c.extend(l,{"st.query":m.query,"st.count":m.index});if(m.forwardMarker){c.extend(l,{"st.lastelem":m.forwardMarker});}},function(n,p){var q=n["jsp.cc"];p.hasMore=n["jsp.hm"];p.index=p.index+q;p.forwardMarker=n["jsp.fwd"];var m=[];var r=n["jsp.ch"];for(var o=0;o<r.length;++o){var l=r[o];l.disabled=false;l.mkto=true;l.uf=l.text;l.ui=l.id;l.ul=l.id;m.push(l);}return m;}),placesSearchEngine:d("PostingFormPlacesSearch","json",function(n,m,l){l["d.sq"]=n.query;l["d.o"]=m.index;l["ps.pin"]=n.pin;if(n.coords){l["ps.lt"]=n.coords[0];l["ps.lng"]=n.coords[1];}},function(n,q){var m=n.searchEnabled;if(m===false){return null;}var r=n["jsp.scc"]||0;var o=n["jsp.sr"]||[];var l=Math.min(n["jsp.stc"]||0,200);q.index=q.index+r;q.hasMore=q.index<l;q.totalCount=l;q.realTotalCount=n["jsp.str"]||0;for(var p=0;p<o.length;p++){f(o[p]);}return o;}),preparePlaceForRenderer:f,groupsSearchEngine:d("SearchCrossPostingGroups","json",function(n,m,l){l["d.sq"]=m.query;l["d.o"]=m.index;},function(n,p){if(n.searchEnabled===false){return null;}var r=n["jsp.cc"]||0;var m=n["jsp.stc"]||0;p.index=p.index+r;p.hasMore=p.index<m;p.totalCount=m;var l=n["jsp.sr"]||[];for(var o=0;o<l.length;o++){var q=l[o];q.imageSrc=q.photo;q.text=g.encodeHtml(q.name);}return l;}),userGroupsSearchEngine:j("/web-api/suggest/groups/portal","json",function(n,m,l){l.q=m.query;},function(m,o){o.hasMore=false;var l=m||[];for(var n=0;n<l.length;n++){var p=l[n];p.text=g.encodeHtml(p.name);}return l;}),prepareAdvertSelectionForRenderer:h,advertCatalogSearchEngine:function(l){return d("AdvertCatalogsSearch","json",function(o,n,m){m["d.sq"]=n.query;m["d.fwd"]=n.forwardMarker;m["d.gr"]=l;},function(m,o){if(m.searchEnabled===false){return null;}o.totalCount=m["jsp.stc"]||0;o.hasMore=m["jsp.hm"];o.forwardMarker=m["jsp.fwd"];var n=m["jsp.sr"]||[];h(n);return n;});},commentMentionsEngine:function(m,l){return d("ParticipantsSearch","html",function(p,o,n){n["st.query"]=o.query;n["st.did"]=m();if(l){n["st.wg"]="on";}},function(p,n){var y=p.searchEnabled;if(y===false){return null;}var u=p["jsp.cc"];var x=p["jsp.stc"]||0;n.index=n.index+u;n.hasMore=n.index<x;n.totalCount=x;var v=[];var s=p["jsp.sr"]||{};var o={};for(var t in s){if(Object.prototype.hasOwnProperty.call(s,t)){var q=s[t];if(!q.group){o[t]=q;}}}OK.userCache.updateUserCache(o);for(var t in s){if(Object.prototype.hasOwnProperty.call(s,t)){var q=s[t];if(q.group){q.id=q.ui;var r=q.photo;if(r){q.imageSrc=r;}}else{q.id=t;q.imageSrc=OK.userCache.getLinkOnUserAvatar(q);}q.text=q.uf;var w=q.mkto;if(!w){q.disabled=true;}v.push(q);}}return v;});}};});define("OK/suggest/renderers",[],function(){function c(d){this.options=d;return this;}c.prototype.createItemElement=function(d){return'<div class="ucard-mini'+(d.selected?" __selected":"")+(d.disabled?" __na":"")+'">'+(d.imageSrc?'<img class="ucard-mini_img" src="'+d.imageSrc+'" alt="Image" width="32" height="32">':(d.stub?'<div class="ucard-mini_img '+d.stub+'"></div>':""))+'<div class="ucard-mini_cnt"><div class="ucard-mini_cnt_i ellip">'+(d.text?d.text:"")+"</div>"+(d.smallText?'<div class="ucard-mini_info">'+d.smallText+"</div>":"")+"</div></div>";};c.prototype.setItemSelected=function(e,f,d){f.find(".ucard-mini").toggleClass("__selected",d);};function a(d){this.options=d;return this;}a.prototype.createItemElement=function(d){return'<div class="ucard-mini'+(d.selected?" __selected":"")+(d.disabled?" __na":"")+'">'+d.image+'<div class="ucard-mini_cnt"><div class="ucard-mini_cnt_i ellip">'+(d.text?d.text:"")+"</div>"+(d.smallText?'<div class="ucard-mini_info">'+d.smallText+"</div>":"")+"</div></div>";};a.prototype.setItemSelected=function(e,f,d){f.find(".ucard-mini").toggleClass("__selected",d);};function b(d){this.options=d;return this;}b.prototype.createItemElement=function(d){return'<div class="ucard-v __xxs __h'+(d.selected?" __selected":"")+(d.disabled?" __na":"")+'">'+(d.imageSrc?'<div class="section"><div class="photo"><img class="photo_img" src="'+d.imageSrc+'" alt="Image" width="32" height="32"></div></div>':"")+'<div class="caption"><div class="ellip">'+(d.text?d.text:"")+"</div>"+(d.smallText?'<div class="info ellip">'+d.smallText+"</div>":"")+"</div></div>";};b.prototype.setItemSelected=function(e,f,d){f.find(".ucard-v").toggleClass("__selected",d);};return{MiniCard:c,UCard:b,ConversationCard:a};});define("OK/postingForm/mentions",["jquery","OK/suggest/suggestImpl","OK/suggest/searchEngines","OK/suggest/renderers","OK/logger"],function(g,f,h,e,l){var b="mediatopic.m";var a="pform_name";var d="__active";var c="data-name";var i=g("<span class='"+a+" o'></span>").get(0);var j=new RegExp("[W#$%!^&*()_+'']");function k(m){var q={ELEMENT_NODE:1,TEXT_NODE:3};function o(w){return w.nodeType==q.TEXT_NODE;}function t(x,w){return x.nodeType==q.ELEMENT_NODE&&x.tagName.toUpperCase()==w;}function n(w){return t(w,"BR");}function u(z){var y=t(z,"SPAN");if(y){var x=g(z);var w=!x.contents().is(function(){return !o(this);});if(w){if(z.className==a+" o"){x.removeAttr("style");return true;}else{return false;}}}return false;}function p(x){var y=t(x,"DIV");if(y){var w=g(x);w.removeAttr("style");w.removeAttr("class");}return y;}function r(w){return o(w)||n(w)||u(w);}function s(w){return p(w)&&!g(w).contents().is(function(){return !r(this);});}while(true){var v=m.contents().not(function(){return r(this)||s(this);});if(v.length==0){break;}v.filter(function(){return this.nodeType!=q.ELEMENT_NODE;}).remove().end().filter(function(){return this.nodeType==q.ELEMENT_NODE;}).replaceWith(function(){var w=g(this).contents();if(this.tagName.toUpperCase()=="DIV"||this.tagName.toUpperCase()=="P"){return w.filter(function(){return r(this);}).wrap("<div></div>").end();}else{return w;}});}}return function(n){var m={bindStep:0,getDebugStep:function(){return bindStep;},suggestCtx:{onItemClicked:g.noop,onLoadingChanged:g.noop,getMaxSelectedFriends:function(){return 1;},onItemsChanged:g.noop,onSelectedItemChanged:g.noop,getMaxItemsInSuggest:function(){return 5;},getMarkFriendDisabledMsg:function(){return m.markDisabledMsg;},elementId:n||"_mPF",mention:true,customCls:""},suggest:null,suggestElement:null,suggestElementVisible:false,mentionsCharStart:3,mentionsFirstCharUpperCase:true,cleanupOnPaste:true,redesign:false,customCls:"__mentions",searchTimer:false,searchTimerDelay:0,scMenuWidth:"300px",useText:false,util:function(){l.error("mt.e","util");},selector:function(){l.error("mt.e","selector");},init:function(q,t,r,o,w){bindStep=1;m.markDisabledMsg=q;m.util=t;m.selector=r;bindStep=2;if(!document.getElementById(m.suggestCtx.elementId)){bindStep=3;var s=e.MiniCard;var u=new s();u.createItemElement=function(x){if(x.group){x.smallText=x.gi;}else{x.smallText=x.disabled?m.markDisabledMsg:"";}return s.prototype.createItemElement(x);};bindStep=4;var v=w!=undefined?w:(o?h.mentionsEngine:h.friendsSearchEngine);m.suggest=f(v,m.suggestCtx,u);bindStep=5;var p="sc-menu "+m.customCls;if(o){m.redesign=true;m.searchTimerDelay=300;p+=" __redesign";}g(document.body).append('<div id="'+m.suggestCtx.elementId+'" class="'+p+'">'+m.suggest.createHtml()+'<div class="sc-menu_arw_w"><div class="sc-menu_arw"></div></div></div>');bindStep=6;m.suggestElement=g("#"+m.suggestCtx.elementId).css({width:m.scMenuWidth});m.suggestElementVisible=true;bindStep=7;}},destroy:function(){m.suggest&&m.suggest.destroy();m.suggest=null;g("#"+m.suggestCtx.elementId).remove();},bind:function(s){var q=false;var C;var w=g(s);bindStep=8;var y=w.parent().find(".pform_name-bg");bindStep=9;if(y.length===0){y=g('<span class="pform_name-bg"></span>');y.insertBefore(w);}bindStep=10;z();bindStep=11;if(!m.selector.supportsRange()){l.success(b,"not_supported");return;}bindStep=12;var p;function v(){w.focus();if(p){m.selector.addRange(p);}}function r(){if(m.util.isFireFox){p=m.selector.getRange();}}if(!m.util.isFireFox){w.on("focusout.mentions",function(){p=m.selector.getRange();});}w.on("keydown.mentions",function(D){if((D.which===13||D.which===9||D.which===27||D.which===38||D.which===40)&&m.suggestElementVisible){D.preventDefault();if(D.which===9){D.stopPropagation();}if(D.which===27){D.stopPropagation();z();}}}).on("keyup.mentions",function(I){var H,G;m.suggestCtx.onItemClicked=g.noop;m.suggestCtx.getSearchQuery=function(){return H?H:"";};m.suggestCtx.onLoadingChanged=function(J){if(!J&&m.suggest.hasVisibleItems()){t(G,I);}if(!m.suggest.hasVisibleItems()){z();}};var E=m.selector.getRange();var D=m.util.getSelectedNode(E,E.startContainer,E.startOffset,true);if(m.util.isSpace(I.which)&&m.util.isSpan(D.parentNode)&&g(D.parentNode).hasClass(a)&&D.parentNode.lastChild===D&&(m.util.isText(D)&&D.nodeValue.length===E.startOffset)){B(D.parentNode,E);I.preventDefault();}H=o(D,E,I,q);if(H&&((H.length>=(m.mentionsCharStart>0?m.mentionsCharStart:3)&&(!m.mentionsFirstCharUpperCase||(m.mentionsFirstCharUpperCase&&H[0].toUpperCase()===H[0]&&!j.test(H[0]))))||H[0]==="@"||H[0]==="+")){var F=x(D,E);if(F){if(I.which===13||I.which===9){q=false;A(F,E);}else{G=F.getBoundingClientRect();l.success(b,"search");if(H[0]==="@"||H[0]==="+"){l.success(b,"trigger");H=H.substr(1);q=m.redesign;}m.searchTimer&&clearTimeout(m.searchTimer);if(!m.redesign||H[0]==="@"||H[0]==="+"||m.searchTimerDelay==0||m.suggestElementVisible){m.searchTimer=false;m.suggest.search(H);}else{m.searchTimer=setTimeout(function(){m.suggest.search(H);},m.searchTimerDelay);}m.suggestCtx.onItemClicked=function(){if(m.util.isInEditor(F.startContainer)){A(F,E);z();}};}}}if(!G||!m.suggest.hasVisibleItems()){z();}m.util.normalizeFont();u(I,E);r();}).on("paste.mentions",function(){setTimeout(function(){if(m.cleanupOnPaste){m.util.cleanWordComments(w);k(w);}r();},50);}).on("click.mentions",function(){w.focus();r();});function o(E,F,J,H){if(J.which===27){return null;}var I=F.startOffset;if(I<=0||!m.util.isText(E)||E.nodeValue.length<=0||!H&&m.util.isSpace(J.which)||g(E).parents("."+a).length!=0){return null;}var D=E.nodeValue;var G=D[I-1];if(!H&&m.util.isSpace(G)){return null;}if(H){for(C=I-1;C>=0;C-=1){if(D[C]=="+"||D[C]=="@"){break;}}}else{for(C=I-1;C>=0;C-=1){if(m.util.isSpace(D.charCodeAt(C))){C+=1;break;}}}if(C<0){C+=1;}return D.substring(C,I);}function x(D,E){var F;if(m.util.isText(D)&&C>=0){F=document.createRange();F.setStart(D,C);F.setEnd(D,E.startOffset);return F;}return null;}function A(F,E){var H,G=m.suggest&&m.suggest.getSelectedItem();if(F&&G&&!G.disabled){document.getSelection().removeAllRanges();document.getSelection().addRange(F);H=i.cloneNode(false);F.surroundContents(H);var D=g(H);D.html(m.useText?G.text:G.un);D.attr(G.group?"data-group-id":"data-user-id",G.ul).attr(c,D.html());B(H,E);}}function B(E,D){var F=document.createTextNode(String.fromCharCode(160));w.focus();m.util.after(E,F);D.setStart(F,1);m.selector.addRange(D);}function t(M,G){var D;if(M){if(m.redesign){var P=w.offset().left;var E=w.width();var O=10;var F=1;var J=(O+F)*2;var I=300;var N=P+E+J>M.left+I;var L=M.bottom+g(window).scrollTop();if(N){m.suggestElement.css({left:M.left-O,top:L});}else{m.suggestElement.css({left:P+E+O*2-I,top:L});}var H=window.innerHeight;var K=m.suggestElement.outerHeight(true);if(L+K>H){m.suggestElement.css({top:L-M.height-K});}}else{m.suggestElement.css({left:M.left-140,top:M.bottom+g(window).scrollTop()});}m.suggestElement.removeClass("sc-menu__hidden");m.suggestElementVisible=true;D=y.parent().get(0).getBoundingClientRect();y.css({top:M.top-D.top-2,left:M.left-D.left,width:M.width,height:M.height});y.toggleClass(d,true);if(G.which==38){m.suggest&&m.suggest.selectPrevious();}else{if(G.which==40){m.suggest&&m.suggest.selectNext();}}l.success(b,"show_menu");}else{z();}}function z(){q=false;m.suggestElement.css({left:0,top:-1000});m.suggestElementVisible=false;m.suggest.resetSelection();y.css({top:0,left:0,width:0,height:0});y.removeClass(d);}function u(G,E){var D,F=true;if(G.which===8&&m.util.isFireFox){D=m.selector.getFocusElement(E);if(g(D).hasClass(a)){g(D.childNodes).each(function(H,I){if(m.util.isText(I)&&I.nodeValue.length>0){F=false;}});if(F&&s.innerHTML.indexOf(D.outerHTML)===0){g(D).replaceWith(document.createTextNode(String.fromCharCode(160)));w.focus();}}}}bindStep=14;return{unbind:function(){w.off(".mentions");y.remove();m.searchTimer&&clearTimeout(m.searchTimer);m.searchTimer=false;},getFocus:function(){return p;},restoreFocus:v,hide:z,log:function(){w.find("span."+a).each(function(D,E){if(this.innerHTML!==g(this).attr(c)){l.success(b,"mention_changed");}});}};}};return m;};});define("OK/scroll",[],function(){function c(e,k){var h=b(k);var j=a;var g=Date.now();var i=e.scrollTop;var d=i;this._animationId=g;var f=(function(){if(this._animationId!==g){return;}var l=Math.min(Date.now()-g,h);var m=Math.round(j(l,i,k,h));e.scrollTop+=m-d;d=m;if(l<h){requestAnimationFrame(f);}}).bind(this);requestAnimationFrame(f);}function a(f,e,h,g){if((f/=g/2)<1){return h/2*f*f+e;}return -h/2*((--f)*(f-2)-1)+e;}function b(e){var d=Math.min(500,Math.max(300,Math.abs(e)*3));return Math.floor(d);}return{animateVScroll:c};});define("OK/discussions/CommentForm",["require","OK/textarea","jquery","OK/utils/vanilla","OK/discussions/NewCommentsLabel","OK/AttachPicker","OK/LinkDetector","OK/discussions/LinkAttachController","OK/emojiarea","OK/StickerSuggester","OK/postingForm/mentions","PTS/discussion.client","OK/suggest/searchEngines","OK/scroll"],function(l,s,e,y,t,g,w,h,H,x,A,I,f,d){var m={commentAreaContainer:e(),scrollingContainer:document.body,onStateChanged:e.noop,persistant:true,collapsable:true,cleanOnPaste:false,isStickyForm:true,typingListener:{onTypingStatusChanged:e.noop},parseLinks:true,instantSending:false,instantPaste:false,sendOnCtrlEnter:false,newLineOnCmdEnter:false,collapseText:true},B=["PHOTOUPLOADED","VIDEOUPLOADED","FILE"],q=e("html"),v=q.hasClass("gecko"),E="\u200B",a=e(),p=false,c=q.hasClass("chrome")||q.hasClass("mac-chrome"),D=q.hasClass("mac-saf");function o(J){if(v&&!p){p=true;a=e(document.createTextNode(E));J.textarea.append(a);J.container.toggleClass("__placeholder",J.isEmpty());}}function C(J){if(v&&p){p=false;a=null;if(J.getValue().substr(0,1)===E){J.setValue(J.getValue().substr(1));}J.container.toggleClass("__placeholder",J.isEmpty());}}function z(J){J.hasFocus=false;if(J.typingStatusCheck){J.typingStatusCheck=clearInterval(J.typingStatusCheck);}J.textarea.off("click.cC keyup.linkParsing paste.linkParsing");e(document).off("paste.imagePasting");}function G(J){l(["OK/AttachUploader"],function(L){var K=e(".js-uploader-hook",J.discussion.element);if(J.options.parseLinks){J.onPasteUploader=K.data("uploader");if(!J.onPasteUploader){J.onPasteUploader=new L();J.onPasteUploader.activate(K);}}e(document).on("paste.imagePasting",function(N){var O=(N.clipboardData||N.originalEvent.clipboardData);if(O&&O.items){var M=O.items;e.each(M,function(Q,R){var P=R.getAsFile();if(P&&P.type.indexOf("image")===0){OK.logging.logger.success("discussions.imagePasted");P.lastModifiedDate=new Date();P.name="attached-picture"+P.lastModifiedDate;if(J.onPasteUploader){J.onPasteUploader.onFileSelect([P]);}}});}});});}function k(J){var K=J.container&&J.container[0]&&J.container[0].closest(".comment-form_cnt");return K&&K.querySelector(".instant-comments");}function u(K){var J=k(K);if(J){J.addEventListener("click",function(N){var M=N.target;if(M.classList.contains("usmile")){n(K);K.postToForm({content:M.getAttribute("data-code"),isSticker:true,stickerPlace:null,});}});J.classList.toggle("__activated",true);var L=J.querySelector(".instant-comments_stickers");L.addEventListener("click",function(){var M=K.textarea.data("emojiarea");M&&M.$button.click();});}}function b(L){var K=k(L);if(K){var J=!L.replyMode;K.classList.toggle("__collapsed",!J);}}function n(K){var J=k(K);if(J){J.classList.toggle("__collapsed",true);}}function j(K){var J=K.container&&K.container[0]&&K.container[0].closest(".plc");if(J){d.animateVScroll(J,J.scrollHeight);}}function F(J,M,L){var P=0;try{this.options=e.extend({},m,M.options,L||{});P=1;this.textarea=J;P=2;this.form=this.textarea.closest("form");P=3;this.container=this.textarea.closest(".js-comments_form");P=4;this.cancelBtn=e(".comments_add-controls_cancel",this.container);P=5;this.official=e(".form-actions__official",this.container);P=6;this.attached=e(".attachedInput",this.container);P=7;this.officialContainer=e(".comments_add-controls_checkbox",this.container);P=8;this.userAvatar=e(".comments_author-avatar__user",this.container);P=9;this.groupAvatar=e(".comments_author-avatar__group",this.container);P=10;this.discussion=M;P=11;this.replyMode=false;P=12;this.comment=null;P=13;this.replyCommentIdInput=e('[name="st.cId1"]',this.container);P=14;var N=e(".attachPicker",this.container);P=15;if(N&&N.length>0){P=16;this.objectId=N.data("object-id");}else{P=17;this.objectId=null;}P=18;this.states={};P=19;var O=e(".tipDiscussion",this.container);if(O.size()>0){this.label=new t(O,M,this);}P=20;this.linkDetector=new w(J);P=21;this.linksController=new h(this.objectId);P=22;this.disabled=false;P=23;var K=e(".js-st-suggest",this.container);P=24;if(K.size()>0){P=25;this.stickerSuggester=new x(this,K[0]);}this.persistants=null;}catch(Q){OK.logging.logger.success("messagesLayer","e.commentForm_"+P);}}F.states={initial:"__initial",active:"__active",disabled:"__disabled",error:"__error",notify:"__notify",cancelable:"__cancelable",invisible:"__invisible",progress:"__progress"};function i(J){if(J.options.mentionsEnabled){OK.loader.use(["jQuery","OKCustomJs","OKTextarea"],function(){var M=A("cfm_"+Date.now());var L=OK.editor.util;var K=OK.editor.selector;L.isSafari=OK.util.isSafari();L.isWebKit=OK.util.isWebkit();M.mentionsCharStart=J.options.mentionsCharStart;M.useText=true;var N;if(J.options.participantsSearchEnabled){N=f.commentMentionsEngine(function(){return J.discussion.getId2();},J.options.groupMentionsEnabled);}M.init(I.markFriendDisabled,L,K,true,N);J.mentions=M.bind(J.textarea);});}}F.prototype={init:function(){var R=0;var Y=this,V=this.container,X=this.textarea,J=e(".js-comments_add-error",this.container),K=e(".form-actions_yes",V),M=e(".comments_add-controls_save",V);function N(){V.addClass("__disabled");K.attr("disabled","disabled").addClass("__disabled");M.attr("disabled","disabled").addClass("__disabled");Y.disabled=true;}function U(){V.removeClass("__disabled");K.removeAttr("disabled","disabled").removeClass("__disabled");M.removeAttr("disabled","disabled").removeClass("__disabled");Y.disabled=false;}function W(){return Y.disabled;}function Q(){Y.isInProgress=true;Y.posted=e.Deferred();C(Y);var ac=X.data("emojiarea");if(ac){ac.hideMenu();}var ab=Y.isValid();if(Y.options.instantSending&&ab){Y.resetState();}else{N();}return ab;}function P(){C(Y);var ab=X.data("emojiarea");if(ab){ab.hideMenu();}Y.resetState();}function S(ab){U();Y.setCaretToEnd();if(!Y.isValid()){return;}Y.changeState(F.states.error);if(ab&&ab.key){J.html(ab.key);}}function O(){Y.hasFocus=true;if(Y.options.collapsable){e(document).off("click.cF").on("click.cF",function(){Y.deactivate(false);});}o(Y);X.on("keydown.esc",aa);if(!Y.options.instantPaste){X.one("blur",function(){z(Y);});}X.on("click.cC",function(){Y.changeState(F.states.active);});Y.changeState(F.states.active);V.on("click.cC",function(ac){ac.stopPropagation();});if(Y.options.parseLinks){X.on("keyup.linkParsing paste.linkParsing",r.bind(Y));}if(Y.typingStatusCheck){OK.logging.logger.success("discussions.typingAlreadyActivated");}else{var ab=Y.options.typingCheckTimeout||1000;Y.typingStatusCheck=setInterval(function(){if(Y.isEditMode()){return;}var ad=X.data("previousText");if(ad){var ac=Y.getValue().length,ae=ad.length;if(ac===0){Y.options.typingListener.onTypingStatusChanged(2);}else{if(ac!==ae){Y.options.typingListener.onTypingStatusChanged(0);}}}X.data("previousText",Y.getValue());},ab);}if(Y.options.isStickyForm&&!Y.discussion.isPanelSticky()){V.each(function(){Y.discussion.scrollController.makeVisible(this);});}if(!Y.options.instantPaste){G(Y);}if(Y.mentions){Y.mentions.hide();}OK.logging.logger.success("discussions.formActivate",Y.discussion.scrollController.isScrolledToBottom());}function aa(ab){if(ab.which===38&&!Y.isValid()){Y.discussion.list.editLast();ab.stopPropagation();}else{if(ab.keyCode===27){Y.cancelReplyEditMode();ab.stopPropagation();}}}try{R=1;l(["OK/textCounter"],function(){var ab=Y.textarea.attr("data-maxLength"),ac=ab?ab:4096;e(".txt-counter",Y.container).textCounter(X,{maxLength:ac,valueGet:function(){return Y.getValue(true);}});});R=2;Y.initAutosize();R=3;if(Y.objectId){var T=g.get(Y.objectId);T.on("update",Y.onAttachUpdate.bind(Y));T.on("instantSendAttaches",Y.instantSendAttaches.bind(Y));T.serializeAttachesCb=Y.serializeAttaches.bind(Y);T.sendUploadedAttachesCb=Y.sendUploadedAttaches.bind(Y);}R=4;if(Y.options.persistant){Y.persistants=X.persistant({afterInit:function(ab){Y.collapse();}});}R=5;Y.form.submit(function(ah,ai){ah.preventDefault();Y.beforeFormSubmit();if(!Y.isValid()||W()){return;}if(Y.options.checkAttachOnSubmit){var ae=Y.attached.val();var ab=ae&&ae!==""?JSON.parse(Y.attached.val()):[];if(ab.length>0){var af=false;for(var ad=0;ad<ab.length;ad++){var ac=ab[ad];if((B.indexOf(ac.type)>-1)&&ac.id<0){af=true;}}if(af){if(Y.options.asyncUploadEnabled){Y.scheduleMessage();P();}else{S();}return;}}}var ag=Y.serialize({});Y.createRequest(ag,Q,S,U);OK.logging.logger.success("discussions.formSubmit",ai||false);});R=6;X.keypress(function(an){var al=an.keyCode||an.which,ag=13,ap=10,am=D&&(an.ctrlKey||an.altKey),ae=(al===ag)&&an.altKey,ab=(al===ag)&&!an.ctrlKey&&!an.metaKey,ai=(al===ag||al===ap)&&(an.ctrlKey||an.metaKey),ad=Y.options.sendOnCtrlEnter?ai:ab,af=Y.options.sendOnCtrlEnter?ab:ai,ah=Y.options.newLineOnCmdEnter&&!am&&(ae||af);if(ad&&!an.altKey&&!an.shiftKey){Y.form.trigger("submit",[true]);an.preventDefault();}if(ah){an.preventDefault();if(window.getSelection){var ao=window.getSelection(),ak=ao.getRangeAt(0),ar=document.createElement("br"),aq=this.childNodes.length,ac=this.childNodes[aq-1];if(aq<2||(ac.nodeName&&ac.nodeName=="#text")){var aj=document.createElement("br");this.appendChild(aj);}ak.deleteContents();ak.insertNode(ar);ak.setStartAfter(ar);ak.setEndAfter(ar);ak.collapse(false);ao.removeAllRanges();ao.addRange(ak);}}Y.changeState(F.states.active);}).keydown(function(ae){var ab=ae.keyCode||ae.which,af=ab===37||ab===39;af&&ae.stopPropagation();var ad=(ab===13||ab===10)&&ae.metaKey;if(Y.options.newLineOnCmdEnter&&c&&ad){var ac=jQuery.Event("keypress");ac.keyCode=13;ac.metaKey=true;e(this).trigger(ac);}}).focus(O).focus(b.bind(Y,Y)).one("focus",i.bind(Y,Y));R=7;Y.options.cleanOnPaste&&X.on("paste",function(ab){ab.preventDefault();var ac=(ab.originalEvent||ab).clipboardData;if(ac){document.execCommand("insertText",false,ac.getData("text/plain"));}else{if(window.clipboardData){document.execCommand("paste",false,window.clipboardData.getData("Text"));}}});R=8;var L=function(){var ab=Y.isBlank();Y.container.toggleClass("__placeholder",ab);if(ab){Y.linksController.reset();}return L;};R=9;X.on("textchange",L());R=10;Y.initSmiles();R=11;Y.cancelBtn.click(e.proxy(this.onCancel,this));if(Y.official.length>0){Y.official.change(e.proxy(this.onOfficialChange,this));}R=12;Y.changeState(F.states.initial,true);R=13;o(Y);if(Y.options.instantPaste){G(Y);}u(Y);}catch(Z){OK.logging.logger.success("messagesLayer","e.commFormInit_"+R);}return this;},beforeFormSubmit:function(){},scheduleMessage:function(){},destroy:function(){z(this);this.textarea.off();if(this.textarea.emojiareaOff){this.textarea.emojiareaOff();}this.textarea.removeData();this.container.off(".cC");e(document).off(".cF");e(".js-comments_smiles_trigger",this.container).off("click");this.cancelBtn.off();this.form.off();if(this.stickerSuggester){this.stickerSuggester.destroy();}if(this.onPasteUploader){this.onPasteUploader.deactivate();}if(this.persistants){this.persistants.off();}if(this.mentions){this.mentions.hide();this.mentions.unbind();}if(this.objectId){var J=g.get(this.objectId);J.off("update");J.off("instantSendAttaches");}},isEmpty:function(){var J=this.getValue().trim().replace(/[\n\s]+/gi,"");return J.length===0||(v&&J===E);},isBlank:function(){var J=this.getValue();return J.length===0||(v&&J===E);},showNotification:function(J){if(this.label){this.label.show(J);}},showNotificationAboutNew:function(J){if(this.label){this.label.showAsNew(J);}},onSuccess:function(N,M){var J=this,P=N.getResponseHeader(OK.navigation.HEADER).split(",")[0],L=M.split(OK.navigation.SPLITER)[0];var K=function(R){if(!J.isEditMode()){var Q=J.discussion.scrollController.hasMore();if(Q){setTimeout(J.showNotification.bind(J,R),100);}else{if(R){R.element.each(function(){var S=J.discussion.scrollController.isVisibleBottomOf(this);if(!S){setTimeout(J.showNotification.bind(J,R),100);}});}}}if(!J.options.instantSending){J.resetState();}};var O=J.discussion.commentsCount;OK.logging.logger.success("discussions.commentPosted",O<=5?O:(O<=10?10:(O<=20?20:(O<=50?50:"50+"))));if(J.isEditMode()){if(M){OK.hookModel.setHookContent(P,M.split(OK.navigation.SPLITER)[0]);J.comment.init(e(OK.hookModel.getHookById(P).element.firstChild));}K(J.comment);}else{J.discussion.post(P,L).always(K);}},createRequest:function(N,M,Q,L){var K=this,P=e.param(N),J=function(){},M=M||J,Q=Q||J,L=L||J,O=e.ajax({type:"POST",headers:{TKN:OK.tkn.get()},url:K.getSubmitUrl(),data:P+"&gwt.requested="+window.pageCtx.gwtHash,beforeSend:M});O.done(function(R,U,T){try{if(T.getResponseHeader("failed")==="true"){Q(OK.util.parseJSON(R));}else{K.onSuccess(T,R);}}catch(S){Q();throw S;}});O.fail(Q).then(L);O.always(function(){K.isInProgress=false;K.posted&&K.posted.resolve();});return O.then(function(){n(K);j(K);});},getSubmitUrl:function(){return this.form.attr("action");},clear:function(){this.fullText=null;this.setValue("").changeState(F.states.error,false).changeState(F.states.progress,false);if(this.objectId){g.clear(this.objectId);}this.linksController.reset();},onCancel:function(J){this.discussion.replyMode(false);this.discussion.editMode(false);J.preventDefault();},onOfficialChange:function(){if(this.official.length>0){if(this.official.prop("checked")){this.userAvatar.hide();this.groupAvatar.show();}else{this.groupAvatar.hide();this.userAvatar.show();}}},getAttachesCount:function(){var K=this.attached.val();var J=K&&K!==""?JSON.parse(this.attached.val()):[];J=J.filter(function(L){return L.type!=="VIDEOERROR";});return J.length;},isValid:function(){return !this.isEmpty()||this.getAttachesCount()>0;},deactivate:function(J){if(this.options.collapsable){e(document).off("click.cF");this.textarea.off("keydown.esc change.valid textchange.valid");this.container.off("click.cC");if(J||!this.isValid()){this.changeState(F.states.initial).changeState(F.states.error,false).changeState(F.states.active,false);}}if(this.mentions){this.mentions.hide();}return this;},setComment:function(J){this.comment=J;this.replyCommentIdInput.val(this.comment?this.comment.id:"");return this;},resetState:function(){var J=this;J.clear();J.discussion.replyMode(false);if(J.isEditMode()){J.discussion.editMode(false);}},activateEditMode:function(K){this.replyMode=false;this.comment=K;this.setValue(K.getText());if(this.objectId){var J=K.getAttachments();g.clear(this.objectId);g.add(this.objectId,J);this.linksController=new h(this.objectId);}this.setCaretToEnd();this.textarea.focus();if(this.official.length>0){this.official.prop("checked",K.official);this.onOfficialChange();this.officialContainer.hide();}this.changeState(F.states.cancelable);return this;},activateReplyMode:function(J){this.replyMode=true;this.setComment(J);this.setCaretToEnd();this.textarea.focus();if(this.official.length>0&&J.official){this.options.canReplyFromGroup=this.official.prop("checked");this.official.prop("checked",false);this.onOfficialChange();this.officialContainer.hide();}this.changeState(F.states.cancelable);this._preparePhotoLayerReplyMode(J);return this;},_preparePhotoLayerReplyMode:function(M){var N=this.container[0];var L=N&&N.closest(".plc");var O=M&&M.element&&M.element[0];if(!N||!L||!O){return;}n(this);var K=N.getBoundingClientRect().top;var J=O.getBoundingClientRect().bottom;if(K<J){d.animateVScroll(L,J-K);}},cancelReplyEditMode:function(){var J=this;if(J.isReplyMode()){J.discussion.replyMode(false);}else{J.discussion.editMode(false);J.collapse().deactivate(true).textarea.blur();}},deactivateReplyEditMode:function(){if(!this.isReplyMode()&&!this.isEditMode()){return this;}if(this.options.canReplyFromGroup){this.official.prop("checked",true);this.userAvatar.hide();this.groupAvatar.show();this.officialContainer.show();}if(this.isEditMode()){this.linksController=new h(this.objectId);}this.clear();this.replyMode=false;if(this.official.length>0){this.officialContainer.show();}this.setComment(null);this.deactivate(true);this.changeState(F.states.cancelable,false);return this;},changeState:function(M,J){var L=0;try{J=J==undefined?true:J;L=1;if(this.states[M]===J){return this;}L=2;var K=this;if(M){L=3;if(M!=F.states.initial&&J){L=4;K.changeState(F.states.initial,false);}L=6;K.options.commentAreaContainer.toggleClass(M,J);L=7;K.options.onStateChanged.call(K.textarea,M,J);L=8;K.states[M]=J;L=9;K.textarea.trigger("commentForm.stateChanged",[M,J]).trigger("autosize.resize");}return this;}catch(N){OK.logging.logger.success("messagesLayer","e.commFormState_"+L);}},onStateChange:function(J){this.options.onStateChanged=J;},getValue:function(P){if(this.fullText){return this.fullText;}var K=this;var J=1;var L=3;var M=["p","div","pre","form"];function N(){var S=[];var R=[];function Q(){S.push(R.join(""));R=[];}function V(ab){if(ab.nodeType===L){var X=ab.nodeValue;v&&(X=X.replace(new RegExp(E,"g"),""));R.push(X);}else{if(ab.nodeType===J){var aa=ab.tagName.toLowerCase();var W=M.indexOf(aa)!==-1;if(W&&R.length){Q();}if(aa==="img"){if(P){var ac=ab.getAttribute("alt")||"";if(ac){R.push(ac);}}else{R.push(ab.outerHTML);}return;}else{if(aa==="br"){Q();}else{if(ab.hasAttribute("data-user-id")||ab.hasAttribute("data-group-id")){R.push(ab.outerHTML);return;}}}var Z=ab.childNodes;for(var Y=0;Y<Z.length;Y++){V(Z[Y]);}if(W&&R.length){Q();}}}}if(K.textarea.length>0){var U=K.textarea[0].childNodes;for(var T=0;T<U.length;T++){V(U[T]);}}if(R.length){Q();}return S.join("\n");}var O=N();return O.replace(/<br\s*[\/]?>/gi,"\n");},setValue:function(K){var J=this;this.textarea.html(K);if(K===""&&this.isEmpty()){o(this);}J.textarea.trigger("textchange").trigger("autosize.resize");return this;},serialize:function(Q){var R=Q.content,O=Q.isSticker,J=O&&this.options.sendStickerAsAttach,N={"st.dOFC":this.official.length>0&&this.official.prop("checked")?"on":"off","st.dAGid":this.container.attr("data-author-groupId"),"st.dM":(J?"":R||this.getValue(true)),"st.dRT":this.comment===null?"off":"on"};var K;if(J){K=JSON.stringify([{type:"STICKER",code:R}]);}else{K=this.attached&&this.attached.length>0?this.attached.val():"";}if(K&&K.length>0&&(!O||J)){e.extend(N,{"st.attached":K});}var T=this.linksController.getAttachedLinks();if(T.length>0&&!O){T=e.map(T,function(V,U){return y.encodeHtml(V);});e.extend(N,{links:T.join(",")});}var M=Math.round(new Date().getTime()*Math.random());if(this.isEditMode()){var P="editComment-"+M;e.extend(N,{"st.tlb.act":"actEC","st.cntId":this.comment.blockHookId,"st.refId":P});}else{var L="cf"+M,S="sendComment-"+M;e.extend(N,{"st.tlb.act":"actSC","st.cntId":L,"st.refId":S});}if(this.comment){e.extend(N,{"st.cId1":this.comment.id});}return N;},isEditMode:function(){return this.comment&&!this.replyMode;},isReplyMode:function(){return this.comment&&this.replyMode;},focus:function(){this.textarea.focus();},collapse:function(){this.fullText=this.getValue();var L=this;if(L.options.collapseText){var K=[];var N=[];var O=this.fullText.replace(/<img.*?>/gi,function(P,Q){K.push(P);N.push(Q);return"";});if(O.length>50){O=O.substring(0,50)+"…";}for(var M=0,J=K.length;M<J;M++){if(N[M]>=O.length){break;}O=O.substr(0,N[M])+K[M]+O.substr(N[M]);}this.setValue(O);}this.changeState(F.states.active,false);setTimeout(function(){L.textarea.trigger("textchange").trigger("autosize.resize");},10);this.textarea.one("focus",function(){L.expand();});if(!L.options.collapseText){L.focus();}return this;},expand:function(){if(this.fullText){this.setValue(this.fullText.replace(/\n/g,"<br>"));this.fullText=null;this.changeState(F.states.active);this.setCaretToEnd();}return this;},extendedEmojiareaOptions:function(){var J=this;return{stickerSource:function(){return"discussions";},commentsWrapperEl:J.discussion.element};},postToForm:function(K){var J=this,L=J.serialize(K),M=function(N){if(N&&(N.type==="STICKER_SERVICE_UNAVAILABLE"||N.type==="STICKER_SERVICE_UNAVAILABLE_VIP")){var O=N.type==="STICKER_SERVICE_UNAVAILABLE_VIP"?33:19;l(["OK/emojiarea"],function(P){P.callStickerSetLayer(O);});}};if(J.isReplyMode()){J.discussion.replyMode(false);}return J.createRequest(L,null,M);},instantSendAttaches:function(M,K){var J=this,L;if(K&&K.length){K.forEach(function(N){L=J.serialize({content:" ",attached:"["+JSON.stringify(N)+"]"});J.createRequest(L);});if(J.isReplyMode()){J.discussion.replyMode(false);}}},serializeAttaches:function(J){return this.serialize({content:" ",attached:"["+JSON.stringify(J)+"]",instantAttachSend:true});},sendUploadedAttaches:function(J,K){},initSmiles:function(){var J=this,M=0;try{if(!J.emojiarea){M=1;var L=e(".js-comments_smiles_trigger",J.container);M=2;var K=e.extend({button:L,postFunction:J.postToForm.bind(J),scrollingContainer:J.discussion.scrollController.element,stickerSuggester:J.stickerSuggester,needStickerOnSmileSuggester:!!J.container.find(".js-smile-st-suggest").length},J.extendedEmojiareaOptions());M=3;if(e.fn.emojiarea){M=30;J.textarea.emojiarea(K);}M=4;J.emojiarea=true;}}catch(N){OK.logging.logger.success("messagesLayer","e.commFormSmile_"+M);}},setCaretToEnd:function(L){var K=this,J=function(){K.textarea.each(function(){var M=document.createRange();M.selectNodeContents(this);M.collapse(false);var N=window.getSelection();N.removeAllRanges();N.addRange(M);});K.textarea.trigger("change");};if(L){J();}else{setTimeout(J,5);}},checkStickyRecalculate:function(L){var K=this.options.stickyContainerParent.outerHeight(),J=this.options.stickyContainer.outerHeight();if(K!==J){L(K,J);}},initAutosize:function(){var J=this;this.textarea.autosize({onBeforeResize:function(){var N=0;try{var M=J.discussion;N=1;var K=M.scrollController;N=2;var L=K&&K.isScrolledToBottom&&K.isScrolledToBottom();N=3;this.scrolledToBottom=L;}catch(O){OK.logging.logger.success("messagesLayer","e.commFormoOnBeforeResize_"+N);}},callback:function(){if(J.options.stickyContainer&&J.options.stickyContainerParent){J.checkStickyRecalculate(function(L,K){J.discussion.scrollController.scroll(K-L);J.options.stickyContainerParent.css({minHeight:J.options.stickyContainer.outerHeight()});});if(this.scrolledToBottom){J.discussion.scrollController.scrollToBottom();}J.options.stickyContainer.scrollTop(J.options.stickyContainer.prop("scrollHeight"));}}});},whenPosted:function(J){if(this.isInProgress){this.posted.done(J);}else{J();}},onAttachUpdate:function(){if(this.options.isStickyForm&&this.options.stickyContainer&&this.options.stickyContainerParent){var J=this;requestAnimationFrame(function(){J.checkStickyRecalculate(function(){J.options.stickyContainerParent.css({minHeight:J.options.stickyContainer.outerHeight()});});});}this.setCaretToEnd();this.discussion.scrollController.trigger();}};function r(N){var J=this;J.linkDetectionTimer&&clearTimeout(J.linkDetectionTimer);function L(){if(J.linksInProgress){J.linksInProgress=J.linksInProgress-1;if(J.linksInProgress===0){J.changeState(F.states.progress,false);}}}function M(P){if(P){J.changeState(F.states.progress,true);J.linksInProgress=(J.linksInProgress||0)+1;}}var O=N.type==="paste";function K(){var P=J.linkDetector.parse(J.getValue(),!O);P.then(function(Q){if(Q.length>0){OK.logging.logger.success("discussions.linksParsed",Q.length,O);}e.each(Q,function(R,S){OK.logging.logger.success("discussions.linkParsed");J.linksController.process(R,S).progress(M).always(L);});});}if(O){setTimeout(K,10);}else{J.linkDetectionTimer=setTimeout(K,400);}}F.linkParsingHandler=r;return F;});define("OK/discussions/Comment",["jquery","OK/discussions/CommentForm","OK/utils/utils"],function(c,b,a){var d=function(f,e,g){if(arguments.length===2){g=new Date(f.data("time"));}this.discussion=e;this.time=g;this.level=parseInt(f.data("level"));this.url=f.data("url");this.userId=f.data("uid");this.unseen=false;this.init(f);};d.prototype={init:function(e){this.element=e;this.parent=this.element.parent();this.blockHookId=OK.hookModel.getNearestBlockHookId(this.element.get(0));this.contentBlockHookId=this.element.data("cid")+"";this.contentContainer=c("#hook_Block_"+this.contentBlockHookId,this.element);this.textContainer=c(".comments_text",this.contentContainer);this.id=this.element.data("id");this.content=this.contentContainer.html();this.official=e.data("official");this.initHandlers();},initHandlers:function(){this.element.on("click",".comments_cancel-reply",c.proxy(this.cancel,this));},destroy:function(){this.element.off("click",".comments_cancel-reply");this.element.off();this.element.removeData();},edit:function(){var e=this;this.discussion.editMode(true,this);this.element.each(function(){if(!e.discussion.scrollController.isVisibleBottomOf(this)){e.discussion.scrollController.scrollToBottom(this);}});},setContent:function(e){OK.hookModel.setHookContent(this.contentBlockHookId,e);},initExpand:function(){var e=this;require(["OK/discussions/Reveal"],function(f){e.element.each(function(){f.activate(this);});});},expand:function(){var e=this;require(["OK/discussions/Reveal"],function(f){e.element.each(function(){f.expand(this);});});},cancelEdit:function(){this.discussion.editMode(false);this.setContent(this.content);},cancel:function(f){this.element.trigger("comment.cancel");f.preventDefault();f.stopPropagation();return this;},select:function(){this.element.addClass("__active");return this;},refresh:function(){c.ajax({type:"POST",headers:{TKN:OK.tkn.get()},data:{"gwt.requested":window.pageCtx.gwtHash},url:this.url}).done(function(j,f,k){var e=j.split(OK.navigation.SPLITER),h=k.getResponseHeader(OK.navigation.HEADER).split(",");for(var g=0;g<e.length;g++){if(h[g]){OK.hookModel.setHookContent(h[g],e[g]);}}});return this;},bind:function(e,f){this.element.on(e,f);return this;},unbind:function(e,f){this.element.off(e,f);return this;},deselect:function(){this.element.removeClass("__active");},highlight:function(e){var f=this;f.element.addClass("__highlight");e===undefined&&(e=true);e&&setTimeout(function(){f.element.removeClass("__highlight");},3000);},updateKlass:function(){var f=this.element.data("classurl"),e=this;if(f){a.ajax({type:"POST",url:f}).done(function(h,g,i){e.highlight();a.updateBlockModelCallback(h,g,i);});}},getAttachments:function(){var e=this.element.data("attaches");return e||[];},getText:function(){var f=this;var e=1;var g=3;var h=["p","div","pre","form"];function i(){var l=[];var k=[];function j(){l.push(k.join(""));k=[];}function o(u){if(u.nodeType===g){var q=u.nodeValue;k.push(q);}else{if(u.nodeType===e){var t=u.tagName.toLowerCase();var p=h.indexOf(t)!==-1;if(p&&k.length){j();return;}if(t==="img"){k.push(u.outerHTML);return;}else{if(t==="br"){j();}else{if(u.hasAttribute("data-user-id")||u.hasAttribute("data-group-id")){k.push(u.outerHTML);return;}}}var s=u.childNodes;for(var r=0;r<s.length;r++){o(s[r]);}if(p&&k.length){j();}}}}if(f.textContainer.length>0){var n=f.textContainer[0].childNodes;for(var m=0;m<n.length;m++){o(n[m]);}}if(k.length){j();}return l.join("");}return i();}};return d;});define("OK/discussions/CommentEntry",[],function(){var a=function(b,c){this.element=b;this.comment=c;this.next=null;this.prev=null;};a.prototype={append:function(b){if(this.comment.id===b.comment.id){return false;}this.next=b;b.prev=this;b.element.insertAfter(this.element);return true;},prepend:function(b){if(this.comment.id===b.comment.id){return false;}if(this.prev){this.prev.next=b;}this.prev=b;b.next=this;b.element.insertBefore(this.element);return true;},compare:function(b){return this.comment.time.getTime()-b.comment.time.getTime();}};return a;});define("OK/ReplyList",["require","jquery","OK/logger","OK/utils/utils","OK/utils/dom"],function(c){var d=c("jquery"),b=c("OK/logger"),a=c("OK/utils/utils"),e=c("OK/utils/dom");var f=function(g){this.toggleClick=g&&g.toggleClick;this.clearOnDestroy=g&&g.clearOnDestroy;this.onlyOnClick=g&&g.onlyOnClick;};f.prototype={init:function(h){this.container=d(h);var g=this.onlyOnClick?"click":"hover click";this.container.on(g,".comments_replied",d.proxy(this.showReply,this));},destroy:function(){if(!this.onlyOnClick){this.container.off("hover");}this.container.off("click");if(this.clearOnDestroy){var g=e.byClass(this.container[0],"comments_reply-comment");if(g){g.forEach(function(i){var h=i.classList.contains("__show")&&!i.classList.contains("__popup");if(h){i.classList.remove("__show");i.classList.add("__popup");}});}}},showReply:function(k){var q=d(k.target).closest(".comments_replied");if(q.length==0){return;}var p=this,i=q[0],h=q.data("url"),g=parseInt(q.data("level"),10)||0;function o(){var s=i.reply;if(s){var r=s.hasClass("__show")&&!s.hasClass("__popup");if(!r){s.removeClass("__popup").addClass("__show").children().removeClass("__active __popup");if(p.scroller){p.scroller.scroll(s.height());s.each(function(){p.scroller.makeVisible(this);});}}else{if(p.toggleClick){s.addClass("invisible");setTimeout(function(){s.removeClass("__show invisible").addClass("__popup");},100);if(p.scroller){p.scroller.scroll(-s.height());}}}}}function m(){i.showTimeout=setTimeout(function(){var r=(i.reply||d());r.addClass("__show");if(!i.arrow){i.arrow=r.find(".comments_reply-comment_arrow").css("left",function(){return q.offset().left-r.offset().left;});}},300);}function n(){setTimeout(function(){clearTimeout(i.showTimeout);(i.reply||d()).removeClass("__show");},100);}if(!i.embedded){var l=p.onlyOnClick&&k.type==="click";if(k.type==="mouseenter"||l){if(!i.reply&&!i.requested){i.requested=true;a.ajax({url:h}).done(function(t,s,z){var v=t.split(OK.navigation.SPLITER),w=z.getResponseHeader(OK.navigation.HEADER).split(",");for(var u=0;u<v.length;u++){var x=w[u];if(x){var y=OK.hookModel.getHookById(x).element,r=d(y);r.children().addClass("__active __popup");OK.hookModel.setHookContent(x,v[u]);i.reply=r;if(l){o();}else{m();}}}});}else{m();}}if(k.type==="mouseleave"){n();}if(k.type==="click"){i.embedded=true;o();}}else{if(p.toggleClick){var j=i.reply.hasClass("__show")&&!i.reply.hasClass("__popup");if(k.type==="click"){o();}else{if(!j&&k.type==="mouseenter"){m();}else{if(!j&&k.type==="mouseleave"){n();}}}}}k.preventDefault();}};return f;});define("OK/discussions/CommentsList",["jquery","OK/discussions/Comment","OK/discussions/CommentEntry","OK/ReplyList"],function(c,d,b,e){var a=function(h,f,g){this.selectedComment=null;this.container=c(h);this.discussion=g;this.scroller=f;this.last=null;this.parentHookId=OK.hookModel.getNearestBlockHookId(h);this.replyList=new e();};a.prototype={init:function(){this.replyList.init(this.container);this.container.on("mousedown click",".comments_reply",c.proxy(this.reply,this)).on("click","a.comments_edit",c.proxy(this.edit,this)).on("click",".comments_text_more",c.proxy(this.expandComment,this));this.initExpandComments();},destroy:function(){this.container.off("hover click",".comments_replied");this.container.off("mousedown click",".comments_reply");this.container.off("click","a.comments_edit");this.container.off("click",".comments_text_more");var f=c(".comments_i",this.container);f.off("click",".comments_cancel-reply");f.off();f.removeData();},createListHead:function(){var f=this.container.children();if(f.length==0){return null;}var g=f.last();var h=new d(c(".comments_i",g),this.discussion);return new b(g,h);},getLast:function(){if(!this.last||!c.contains(this.container.get(0),this.last.element.get(0))){this.last=this.createListHead();}return this.last;},getComment:function(h){var g=this,f=h.closest(".comments_i"),i=new d(f,g.discussion);return i;},editLast:function(){var f=c("a.comments_edit:last",this.container);if(f.length==0){return;}this.editComment(this.getComment(f));},edit:function(f){this.editComment(this.getComment(c(f.target)));f.preventDefault();f.stopPropagation();},expandComment:function(f){this.getComment(c(f.target)).expand();},editComment:function(h){var g=this.selectedComment;if(g){g.cancelEdit();}var f=this;h.bind("comment.cancel",function(){f.discussion.editMode(false);});h.edit();this.selectedComment=h;OK.logging.logger.success("discussions.commentEdit","click");},reply:function(g){if(g.type!=="mousedown"){var f=this,h=this.getComment(c(g.target));h.bind("comment.cancel",function(){f.discussion.replyMode(false);});OK.logging.logger.success("discussions.commentReply","click");f.discussion.replyMode(true,h);g.preventDefault();}g.stopPropagation();},selectComment:function(h){if(h){this.deselectComment(this.selectedComment);this.container.addClass("__blur");this.selectedComment=h;h.select();var f=0;if(this.discussion.elements.stickyContainer.length>0){f=this.discussion.elements.stickyContainer.offset().top;}var g=(h.element.offset().top+h.element.outerHeight())-f;if(g>0){this.scroller.scroll(g+10);}}},deselectComment:function(f){f=f||this.selectedComment;if(f){f.deselect();this.container.removeClass("__blur");this.selectedComment=null;}},addNewComment:function(l,i){var q=c.Deferred();if(this.scroller.hasMore()){return q.resolve(null);}var p=this,h=c('<div id="hook_Block_'+l+'">').html(i),j=new d(c(".comments_i",h),this.discussion),m=new b(h,j),o=this.scroller.isScrolledToBottom();if(o){this.discussion.toggleStickyPanel(false);}var n=this.getLast(),g=false;if(n){var f=m.compare(n);if(f>=0){if(g=n.append(m)){this.last=m;}}else{var k=n;while(k.prev!=null&&m.compare(k.prev)<=0){k=k.prev;}g=k.prepend(m);}}else{g=true;this.last=m;this.container.append(m.element);c(document.createElement("div")).addClass("comments_first_sep").appendTo(h);}if(o){this.scroller.scroll(m.element.outerHeight());this.discussion.toggleStickyPanel(true);}if(g){h.each(function(){if(p.parentHookId){OK.hookModel.captureBlockHook(p.parentHookId,this);}});}if(g){q.resolve(j);}else{q.fail(j);}return q.promise();},updateComment:function(f){var g=this.findComment(f);if(g){g.refresh();}},findComment:function(g){if(g){var f=c('[data-id="'+g+'"]',this.container);if(f.length!=0){return new d(f,this.discussion);}}return null;},findCommentsFromAuthor:function(g){var f=this,h=[];c(".comments_i",this.container).each(function(){var j=c(this),i=g==j.data("uid");if(i){h.push(new d(j,f.discussion));}});return h;},deleteStub:function(l,i){var h=OK.hookModel.getHookById(l).element,j=c("input[type=checkbox]",h);var g=c(h);g.find(".block-user").change(function(){var m=c(h).find(".delete-content");m.toggleClass("invisible");m.find("input[type=checkbox]").prop("checked",false);});j.change(function(){var m=true;j.each(function(){m=m&&!this.checked;});c(".comments_delete_form-action",h).toggleClass("invisible",m);});var f=function(s){var q=window.localStorage.getItem(s);if(!q){return;}j.each(function(t){if(q.indexOf("c"+t)!=-1){c(this).prop("checked","checked").trigger("change");}});var m=g.find(".block-user-dd");var p=m.find("option");for(var o=0;o<p.length;o++){if(q.indexOf("bu"+o)!=-1){p.eq(o).attr("selected","selected");m.trigger("change");break;}}var r=g.find(".delete-content-dd");var n=r.find("option");for(o=0;o<n.length;o++){if(q.indexOf("dd"+o)!=-1){n.eq(o).attr("selected","selected");r.trigger("change");break;}}};var k=g.find(".lsid").val();if(window&&window.localStorage&&k){f(k);g.find(".comments_delete_form-action").click(function(){var o="";j.each(function(p){if(c(this).prop("checked")){o+="c"+p;}});if(g.find(".block-user").prop("checked")){var m=g.find(".block-user-dd option");m.each(function(p){if(c(this).prop("selected")){o+="bu"+p;return false;}});}if(g.find(".delete-content-cb").prop("checked")){var n=g.find(".delete-content-dd option");n.each(function(p){if(c(this).prop("selected")){o+="dd"+p;return false;}});}if(o){window.localStorage.setItem(k,o);}});}},isVisible:function(f){return this.scroller.isVisible(f.element.get(0));},highlightUnseen:function(){var f=this.getLast();while(f){if(f.comment.unseen){f.comment.highlight();f.comment.unseen=false;}f=f.prev;}},getFirstUnseen:function(){var g=this.getLast();while(g){if(g.comment.unseen){g=g.prev;}else{var f=g.next;if(f){return f.comment;}return null;}}return null;},initExpandComments:function(){var f=this,g=c(".comments_i",this.container);g.each(function(h,i){var j=f.getComment(c(i));j.initExpand();});}};return a;});define("OK/discussions/TypingStatus",["jquery"],function(c){var b=function(e,d){this.element=e;this.discussion=d;this.currentStatus=0;this.typingUsers=[];};function a(e){var d="",f="";c.each(e,function(){var g=this["uf"];if(g){d+=f;d+=g;f=", ";}});return d;}b.prototype={init:function(){if(!this.inited){this.usersContainer=c(".comments-typing_tx",this.element);this.inited=true;}return this;},show:function(){var d=this.discussion.scrollController.isScrolledToBottom();this.element.removeClass("invisible");if(d){this.discussion.scrollController.scrollToBottom();}return this;},hide:function(){this.element.addClass("invisible");return this;},setTypingUsers:function(d){this.typingUsers=d;this.show().setStatus(0).usersContainer.html(a(d));return this;},removeUser:function(e){var d=this;c.each(this.typingUsers,function(f,g){if(parseInt(this.ul,10)===e){d.typingUsers.splice(f,1);return false;}});if(this.typingUsers.length===0){this.hide();}else{this.usersContainer.html(a(this.typingUsers));}},setStatus:function(d){c(".comments-typing",this.element).removeClass("__status-"+this.currentStatus).addClass("__status-"+d);this.currentStatus=d;return this;}};return b;});define("OK/utils/textchange",["jquery"],function(a){a.event.special.textchange={setup:function(c,b){a(this).data("lastValue",this.contentEditable==="true"?a(this).html():a(this).val());a(this).bind("keyup.textchange",a.event.special.textchange.handler);a(this).bind("cut.textchange paste.textchange input.textchange",a.event.special.textchange.delayedHandler);},teardown:function(b){a(this).unbind(".textchange").removeData("lastValue");},handler:function(b){a.event.special.textchange.triggerIfChanged(a(this));},delayedHandler:function(c){var b=a(this);setTimeout(function(){a.event.special.textchange.triggerIfChanged(b);},25);},triggerIfChanged:function(b){var c=b[0].contentEditable==="true"?b.html():b.val();if(c!==b.data("lastValue")){b.trigger("textchange",[b.data("lastValue")]);b.data("lastValue",c);}}};return a.event.special.textchange;});define("OK/Discussion",["require","jquery","OK/DiscussionManager","OK/discussions/ScrollController","OK/discussions/CommentsList","OK/discussions/CommentForm","OK/discussions/TypingStatus","OK/utils/textchange","OK/utils/utils"],function(d){var h=d("jquery"),k=d("OK/DiscussionManager"),b=d("OK/discussions/ScrollController"),e=d("OK/discussions/CommentsList"),i=d("OK/discussions/CommentForm"),n=d("OK/discussions/TypingStatus"),j=d("OK/utils/textchange"),m=d("OK/utils/utils");var g={containerId:null,commentsListContainerId:null,commentAreaId:null,commentAreaCounterId:null,commentAreaContainerId:null,scrollingContainerId:null,lastCommentsUrl:null,isStickyForm:true,stickyContainerId:null,isFormActiveByDefault:false,mentionsEnabled:false,groupMentionsEnabled:false,mentionsCharStart:3,participantsSearchEnabled:false,batchUnsubscribe:false};var f={},o;function a(){var p=Object.keys(f);f={};m.ajax({url:"/dk?cmd=DiscussionsUnsubscribe",data:{"st.dIds":p.join(",")}});}var l=function(s,w,t,v,r){this.id=w;this.type=t;this.element=s;this.options=h.extend({},g,r||{});var p=h(".comments_cnt",this.element);var q=h(".comments_sticky",this.element);var u=h(".js-addFormContainer",this.element);this.elements={container:p,commentsListContainer:h(".comments_lst_cnt",this.element),commentArea:h(".js-comments_add",u),commentAreaContainer:h(".js-comments_form",u),stickyContainer:q,stickyContainerParent:q.parent(),scrollingContainer:this.options.scrollingContainerId?document.getElementById(this.options.scrollingContainerId):window};this.scrollController=new b(this.elements,this.options.loaderId);this.setCount(v);};l.prototype={getId:function(){return this.type+"_"+this.id;},getId2:function(){return this.id+"_"+this.type;},getTypeString:function(){if(this.typeString){return this.typeString;}return this.typeString=this.element.attr("data-types");},focusForm:function(q,p){this.form.focus();},init:function(){var q=this;if(h.data(this.element,"instance")){return this;}var t=q.form=new i(q.elements.commentArea,q,q.elements);var u=q.list=new e(q.elements.commentsListContainer[0],q.scrollController,q);u.init();t.init().textarea.one("focus",function(){t.onStateChange(function(x){if(x==i.states.active||x==i.states.error){var w=q.elements.stickyContainer.outerHeight();q.elements.stickyContainer.parent().css({minHeight:w});q.elements.stickyContainer.each(function(){if(!q.scrollController.isVisibleBottomOf(this)){if(!q.isPanelSticky()){q.scrollController.scroll(w);}}});}});});var s=h("#mtLayer");if(q.element.closest(s).length>0){s.one("mtLayer.close",function(){q.unsubscribe();q.editMode(false);});}var p;h(".js-friendsList",this.element).on("click",".js-name",function(z){var y=h(this),A=y.attr("data-uid");function x(){var B=q.list.findCommentsFromAuthor(A);h.each(B,function(){this.highlight(true);});if(B.length>0){q.scrollController.scrollToTopOf(B[0].element.get(0));}return B.length>0;}function w(B){if(B.responseText){B=B.responseText;}if(!p){p=h(document.createElement("div"));p.prependTo(q.element);}p.html(B).find(".tipDiscussion").addClass("__active");setTimeout(function(){h(".tipDiscussion",p).removeClass("__active");},3000);OK.logging.logger.success("discussions.findFriendComment","notFound");}OK.logging.logger.success("discussions.findFriendComment","click");if(!x(A)){q.scrollController.load(y.attr("href")).done(x).fail(w);}else{OK.logging.logger.success("discussions.findFriendComment","foundCurrentPage");}z.preventDefault();}).on("click",".js-showAll",function(w){h(this).addClass("invisible");h(".js-nameCnt",w.delegateTarget).removeClass("invisible");});var r=q.element.data("cid");if(r){var v=q.list.findComment(r);if(v){v.element.each(function(){q.scrollController.scrollToCenter(this);v.highlight(true);});}}return this;},destroy:function(){if(this.needToUnsubscribe()){this.unsubscribe();}this.editMode(false);this.replyMode(false);var p=h(".js-friendsList",this.element);p.off("click",".js-name");p.off("click",".js-showAll");this.element.removeData();this.form.destroy();this.list.destroy();this.elements.container.off();this.stickyPanel&&this.stickyPanel.deactivate();},post:function(r,q){var p=this;return p.list.addNewComment(r,q).done(function(s){p.updateCount(1);p.scrollController.trigger();if(s){p.pen&&p.pen.removeUser(s.userId);}});},postPush:function(r,p,q){this.post(r,p);},replyMode:function(p,q){var r=this.form,s=this.list;if(p){r.activateReplyMode(q);s.selectComment(q);}else{r.deactivateReplyEditMode();s.deselectComment();}},editMode:function(p,q){var r=this.form,s=this.list;if(p){r.activateEditMode(q);s.selectComment(q);}else{r.deactivateReplyEditMode();s.deselectComment();}},refresh:function(p){if(this.options.lastCommentsUrl){var t=this.list,s={"gwt.requested":window.pageCtx.gwtHash},r=t.getLast();if(r){h.extend(s,{"st.cId1":r.comment.id});}var q={type:"POST",headers:{TKN:OK.tkn.get()},data:h.extend(s,{"st.dCo":p||1}),url:this.options.lastCommentsUrl.replace(/&amp;/g,"&")};return h.ajax(q);}},updateComment:function(p){this.list.updateComment(p);},subscribe:function(){k.add(this);},unsubscribe:function(){if(this.options.batchUnsubscribe){o&&clearTimeout(o);f[this.getId2()]=true;o=setTimeout(a,1000);}else{var p=this.element.attr("data-unurl");if(p){m.ajax({url:p});}}k.remove(this);},showLatest:function(q){var p=this;if(this.scrollController.hasMore()){this.scrollController.loadMore().done(function(){p.markAsRead();p.pen&&p.pen.hide();});}else{if(q){q.element.each(function(){if(p.options.isStickyForm){p.scrollController.scrollToCenter(this);}else{p.scrollController.scrollTo(this);}});}else{this.list.getLast().comment.element.each(function(){if(p.options.isStickyForm){p.scrollController.scrollToCenter(this);}else{p.scrollController.scrollTo(this);}});}p.markAsRead();p.list.highlightUnseen();}},toggleStickyPanel:function(p){if(!p){this.elements.stickyContainer.removeClass("__on").addClass("__off");}this.scrollController.trigger();},isPanelSticky:function(){return this.stickyPanel&&this.stickyPanel.isStickyOn();},updateCount:function(p){this.setCount(this.commentsCount+p);},setCount:function(q){var p=this;this.commentsCount=Math.max(q,0);h(".comments_h",this.element).each(function(){var s=h(this),r=s.find(".lstp-t");s.toggleClass("__hidden",p.commentsCount<1);r.html(p.commentsCount.toString().replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g,"$1&nbsp;"));});d(["OK/CommentWidgets"],function(r){r.setCount(p.id,p.type,p.commentsCount);});if(this.commentsCount>0){this.element.removeClass("__empty");c(p);if(this.form){this.form.initAutosize();}}},deleteComment:function(q,p){this.list.deleteStub(q,p);this.updateCount(-1);this.scrollController.trigger();},restoreComment:function(){var p=this;p.updateCount(1);},markAsRead:h.noop,setTypingUsers:function(p){if(!this.pen){this.pen=new n(h(".comments_pen_cnt",this.element),this);this.pen.init();}this.pen.setTypingUsers(p);},resetTypingStatus:function(){this.pen&&this.pen.hide();},setTypingStatus:function(p){this.pen&&this.pen.setStatus(p);},processNewComments:function(q){var p=this;q.done(function(r){p.form.whenPosted(function(){if(!p.scrollController.hasMore()&&r){if(p.scrollController.isVisibleBottomOf(p.element[0])){p.markAsRead();}h(r).each(function(){var u=h(this),s=u.attr("data-wId")||"nc"+Date.now();var t=p.postPush(s,u,true===u.attr("data-own"));if(t){t.done(function(v){p.processComment(v);});}});}});});},processComment:function(p){if(p!=null){if(this.list.isVisible(p)){p.highlight();}else{p.unseen=true;this.form.showNotificationAboutNew(this.list.getFirstUnseen());}}},needToSubscribe:function(){return true;},needToUnsubscribe:function(){return true;}};function c(p){if(p.options.isStickyForm){d(["OK/StickyPanel"],function(q){var r=h(".comments_first_sep",p.elements.container);if(r.length===0){r=p.elements.container;}p.stickyPanel=new q();p.stickyPanel.activateWithOptions(p.elements.stickyContainer,{container:p.elements.scrollingContainer,bound:r});});}}return l;});define("OK/utils/delegate",[],function(){function c(f){this.listenerMap=[{},{}];if(f){this.root(f);}this.handle=c.prototype.handle.bind(this);}c.prototype.root=function(f){var h=this.listenerMap;var g;if(this.rootElement){for(g in h[1]){if(h[1].hasOwnProperty(g)){this.rootElement.removeEventListener(g,this.handle,true);}}for(g in h[0]){if(h[0].hasOwnProperty(g)){this.rootElement.removeEventListener(g,this.handle,false);}}}if(!f||!f.addEventListener){if(this.rootElement){delete this.rootElement;}return this;}this.rootElement=f;for(g in h[1]){if(h[1].hasOwnProperty(g)){this.rootElement.addEventListener(g,this.handle,true);}}for(g in h[0]){if(h[0].hasOwnProperty(g)){this.rootElement.addEventListener(g,this.handle,false);}}return this;};c.prototype.captureForType=function(f){return["blur","error","focus","load","resize","scroll"].indexOf(f)!==-1;};c.prototype.on=function(f,k,q,h){var n,p,m,o;if(!f){throw new TypeError("Invalid event type: "+f);}if(typeof k==="function"){h=q;q=k;k=null;}if(h===undefined){h=this.captureForType(f);}if(typeof q!=="function"){throw new TypeError("Handler must be a type of Function");}n=this.rootElement;p=this.listenerMap[h?1:0];if(!p[f]){if(n){n.addEventListener(f,this.handle,h);}p[f]=[];}if(!k){o=null;m=e.bind(this);}else{if(/^[a-z]+$/i.test(k)){o=k;m=b;}else{if(/^#[a-z0-9\-_]+$/i.test(k)){o=k.slice(1);m=a;}else{o=k;m=d;}}}var g=p[f];var l,j;var r=false;for(l=g.length-1;l>=0;l--){j=g[l];if((!k||k===j.selector)&&(!q||q===j.handler)){r=true;break;}}if(!r){g.push({selector:k,handler:q,matcher:m,matcherParam:o});}return this;};c.prototype.off=function(g,l,o,j){var m,k,n,h,f;if(typeof l==="function"){j=o;o=l;l=null;}if(j===undefined){this.off(g,l,o,true);this.off(g,l,o,false);return this;}n=this.listenerMap[j?1:0];if(!g){for(f in n){if(n.hasOwnProperty(f)){this.off(f,l,o);}}return this;}h=n[g];if(!h||!h.length){return this;}for(m=h.length-1;m>=0;m--){k=h[m];if((!l||l===k.selector)&&(!o||o===k.handler)){h.splice(m,1);}}if(!h.length){delete n[g];if(this.rootElement){this.rootElement.removeEventListener(g,this.handle,j);}}return this;};c.prototype.handle=function(f){var n,k,p=f.type,q,r,j,m,g=[],o,h="ftLabsDelegateIgnore";if(f[h]===true){return;}o=f.target;if(o.nodeType===3){o=o.parentNode;}q=this.rootElement;r=f.eventPhase||(f.target!==f.currentTarget?3:2);switch(r){case 1:g=this.listenerMap[1][p];break;case 2:if(this.listenerMap[0]&&this.listenerMap[0][p]){g=g.concat(this.listenerMap[0][p]);}if(this.listenerMap[1]&&this.listenerMap[1][p]){g=g.concat(this.listenerMap[1][p]);}break;case 3:g=this.listenerMap[0][p];break;}k=g.length;while(o&&k){for(n=0;n<k;n++){j=g[n];if(!j){break;}if(j.matcher.call(o,j.matcherParam,o)){m=this.fire(f,o,j);}if(m===false){f[h]=true;f.preventDefault();return;}}if(o===q){break;}k=g.length;o=o.parentElement;}};c.prototype.fire=function(f,h,g){return g.handler.call(h,f,h);};var d=(function(f){if(!f){return;}var g=f.prototype;return(g.matches||g.matchesSelector||g.webkitMatchesSelector||g.mozMatchesSelector||g.msMatchesSelector||g.oMatchesSelector);}(Element));function b(g,f){return g.toLowerCase()===f.tagName.toLowerCase();}function e(f,g){if(this.rootElement===window){return g===document;}return this.rootElement===g;}function a(g,f){return g===f.id;}c.prototype.destroy=function(){this.off();this.root();};return c;});define("OK/AbstractShortcutMenu",["OK/utils/dom","OK/utils/vanilla","OK/utils/delegate"],function(h,f,e){var d=54;var c="ShortcutMenu";var b=null;var g=document.createElement("div");g.id="hook_Block_"+c;document.body.appendChild(g);OK.hookModel.captureBlockHook("body",g);g.addEventListener("change",function(){if(b&&b.visible()){b.positingElement();}});function a(){this.holder=null;this.menuElement=null;this.showTimeout=null;this.hideTimeout=null;this.ajaxRequest=null;this.direction="";this.position="center";this._visible=false;this.inplace=false;this.detectScrollableContainer=false;this.menuElementHoverInListenerCalled=false;}a.getActiveInstance=function(){return b;};a.setActiveInstance=function(i){b=i;};a.getBlockId=function(){return c;};a.prototype.getBlock=function(){if(this.inplace){return this.block;}return g;};a.prototype.getHtml=function(){};a.prototype.initListeners=function(i){this.shortcutMenuDelegate=new e(i);this.shortcutMenuDelegate.on("click",".sc-menu a",this.menuElementLinkClickListener.bind(this));this.shortcutMenuDelegate.on("click",".sc-menu .js-hide",this.menuElementClickListener.bind(this));this.shortcutMenuDelegate.on("click",".js-forceHide",this.hideMenu.bind(this));this.shortcutMenuDelegate.on("mouseenter",this.menuElementHoverInListener.bind(this));this.shortcutMenuDelegate.on("mouseleave",this.hoverOutListener.bind(this));if(OK.device.isTouch){this.shortcutMenuDelegate.on("touchstart",this.holderTouchStartListener.bind(this));}};a.prototype.processHTML=function(k){var j=[];if(this.inplace){this.initBlock();j[0]=this.blockId;}else{j[0]=a.getBlockId();}var i=this.getBlock();f.updateBlocks(k,j);this.initListeners(i);this.menuElement=h.firstByClass(i,"sc-menu");this.positingElement();this.menuElement.classList.remove("sc-menu__hidden");this.holder.classList.add("__vis");a.setActiveInstance(this);this._visible=true;};a.prototype.showMenu=function(){clearTimeout(this.hideTimeout);this.showTimeout=null;if(this.visible()){return;}if(b){b.hide();}this.processHTML(this.getHtml());};a.prototype.hideMenu=function(){this.clearShowTimeout();this.clearHideTimeout();if(this.menuElement){this.menuElement.classList.add("sc-menu__hidden");OK.hookModel.setHookContent(c,"");this.menuElement=null;}this.holder.classList.remove("__vis");if(this.shortcutMenuDelegate){this.shortcutMenuDelegate.off();}this._visible=false;a.setActiveInstance(null);};a.prototype.hide=function(){this.clearShowTimeout();this.clearHideTimeout();if(this.menuElement){this.hideMenu();}};a.prototype.getClosestScrollable=function(k){if(!this.closestScrollable){var i=/(auto|scroll)/;var j=h.traverseParents(this.element,function(l){var m=window.getComputedStyle(l);var n=i.test(m.overflow+m.overflowY+m.overflowX);return n&&(!k||(l.scrollHeight>l.clientHeight));});this.closestScrollable=j||window;}return this.closestScrollable;};a.prototype.isTopDirection=function(m,j){var l=this.holder.getBoundingClientRect().top;if(this.detectScrollableContainer){var k=this.holder.getBoundingClientRect().height;var n=this.getClosestScrollable();var q=l-n.getBoundingClientRect().top;var i=n.clientHeight-k;var p=n.scrollTop+q+k+j;var o=n.scrollHeight;return i/2<q||(p>o);}else{return window.innerHeight-m-l<j;}};a.prototype.isInsideViewportWhileCentered=function(o){var j=this.holder.getBoundingClientRect();var k=j.left;var l=window.innerWidth-OK.scrollBar.width;if(this.detectScrollableContainer){var i=this.getClosestScrollable().getBoundingClientRect();k=k-i.left;l=i.right;}var n=k+(j.width-o)/2;var m=n+o;return n>0&&m<l;};a.prototype.toRightFromHolder=function(j,l){if(this.detectScrollableContainer){var i=this.getClosestScrollable().getBoundingClientRect();var k=this.holder.getBoundingClientRect().left-i.left;return i.width/2>k;}else{return(window.innerWidth-OK.scrollBar.width)>(j.left+l);}};a.prototype.visible=function(){return this._visible;};a.prototype.getOffset=function(i){var j=i.getBoundingClientRect();return{left:j.left+window.pageXOffset,top:j.top+window.pageYOffset};};a.prototype.positingElement=function(){var i=h.outerSize(this.holder,false,true);var v=this.inplace?{top:0,left:0}:this.getOffset(this.holder);var p=h.outerSize(this.holder,true,true);var k=h.outerSize(this.menuElement,true,true);var y=this.position;if(y==="center"&&!this.isInsideViewportWhileCentered(k)){y="auto";}if(y!=="center"&&y!=="auto"){this.menuElement.classList.add("__noarrow");}var A;var j=h.outerSize(this.menuElement,false,true);if(this.direction==="top_force"||this.direction==="bottom_force"){A=this.direction==="top_force";}else{if(this.direction==="top"){A=this.getOffset(this.holder).top-window.pageYOffset-90>j;}else{if(this.direction==="bottom"){A=false;}else{A=this.isTopDirection(i,j);}}}var r=v.top;var l=[];if(A){this.menuElement.classList.add("sc-menu__top");var m;if(this.inplace){m=r+i;l.push("top: auto; bottom: "+Math.round(m)+"px;");}else{r-=j;l.push("bottom: auto; top: "+Math.round(r)+"px;");}}else{this.menuElement.classList.remove("sc-menu__top");if(!this.inplace){r+=i;}l.push("bottom: auto; top: "+Math.round(r)+"px;");}var w=Math.round(v.left-(k-p));var z=Math.round(v.left);var t=Math.round(v.left+((p-k)/2));switch(y){case"left":l.push("left: "+w+"px;");break;case"right":l.push("left: "+z+"px;");break;case"auto":var x=h.firstByClass(this.menuElement,"entity-shortcut-menu_arw"),u=0,s=x?d:0,q=this.toRightFromHolder(v,k);if(q){this.menuElement.classList.remove("__right");this.menuElement.classList.add("__left");}else{this.menuElement.classList.add("__right");this.menuElement.classList.remove("__left");}if(!s){x=h.firstByClass(this.menuElement,"sc-menu_arw");if(x){var o=x.getBoundingClientRect();if(o.width){var n=this.menuElement.getBoundingClientRect();if(q){s=(o.left-n.left)*2+o.width;}else{s=((n.left+n.width)-(o.left+o.width))*2+o.width;}}}}if(p<s){u=(s-p)/2;}if(q){l.push("left: "+(z-u)+"px;");}else{l.push("left: "+(w+u)+"px;");}break;default:l.push("left: "+t+"px;");break;}this.menuElement.setAttribute("style",l.join(""));};a.prototype.ajaxClose=function(i){if(this.ajaxRequest){this.ajaxRequest.xhr.abort();this.ajaxRequest=null;if(typeof i==="function"){i();}}};a.prototype.hoverInListener=function(i){if(OK.device.isTouch&&i){return;}this.clearHideTimeout();if(!this.showTimeout&&!this.visible()){this.showTimeout=setTimeout(this.showMenu.bind(this),this.showDelay);}};a.prototype.hoverOutListener=function(){this.clearShowTimeout();this.ajaxClose();if(!this.hideTimeout&&this.visible()){this.hideTimeout=setTimeout(function(){if(this.hideOnBlurElement!==document.activeElement){this.hideMenu();}else{this.hideTimeout=null;}}.bind(this),this.hideDelay);}};a.prototype.menuElementHoverInListener=function(){this.menuElementHoverInListenerCalled=true;if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}};a.prototype.menuElementLinkClickListener=function(i){if(!h.parent(i.target,"js-doNotHide",this.block)){this.menuElementClickListener();}};a.prototype.menuElementClickListener=function(){if(true===this.hideTimeout){this.hideTimeout=null;}this.hoverOutListener();};a.prototype.holderTouchStartListener=function(i){i.stopPropagation();};a.prototype.clearShowTimeout=function(){if(this.showTimeout){this.showTimeout=clearTimeout(this.showTimeout);}};a.prototype.clearHideTimeout=function(){if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}};return a;});define("OK/discussions/CommentFormAuthorMenu",["OK/utils/dom","OK/AbstractShortcutMenu"],function(d,b){function c(){}c.prototype={activate:function(k){var h=this;h.container=k;h.compId=k.getAttribute("data-compId");h.author=document.getElementById(h.compId);h.authorAvatar=d.firstByClass(h.author,"js-comments_author-avatar");h.authorName=d.firstByClass(h.author,"js-comments_author-name");if(h.author){h.commentsForm=d.parent(h.author,"js-comments_form");}if(!h.commentsForm){return;}h.clickHandler=function(i){return a(h,i);};h.container.addEventListener("click",h.clickHandler);var f=d.firstByClass(h.commentsForm,"iblock-cloud");if(f){f.classList.remove("__active");}var g=h.commentsForm.getAttribute("data-author-groupId");var l=d.byClass(h.container,"js-comments_authormenu-card");for(var j=0;j<l.length;j++){var e=l[j].getAttribute("data-groupId");if((!e&&!g)||(g==e)){l[j].classList.add("__selected");break;}}},deactivate:function(){var e=this;if(e.container&&e.clickHandler){e.container.addEventListener("click",e.clickHandler);}}};function a(f,i){var h=d.parent(i.target,"js-comments_authormenu-card");var g=d.firstByClass(h,"js-comments_authormenu-avatar");if(!h||!g){return;}f.commentsForm.setAttribute("data-author-groupId",h.getAttribute("data-groupId"));f.commentsForm.setAttribute("data-author-json",h.getAttribute("data-json"));if(f.authorAvatar){f.authorAvatar.innerHTML=g.innerHTML;}if(f.authorName){f.authorName.innerHTML=h.getAttribute("data-name");}var j=d.byClass(f.container,"js-comments_authormenu-card");j.forEach(function(k){k.classList.remove("__selected");});h.classList.add("__selected");var e=b.getActiveInstance();e&&e.hide();i.stopPropagation();}return c;});define("OK/discussions/Reveal",["OK/utils/dom"],function(a){return{expand:function(b){a.firstByClass(b,"comments_text").classList.remove("__reveal-2","__reveal-3");a.firstByClass(b,"comments_text_more").classList.add("invisible");},activate:function(e){var g=a.firstByClass(e,"comments_text");if(!g){return;}var b=parseInt(g.getAttribute("data-max-lines"),10);if(isNaN(b)){return;}var d=a.firstByClass(e,"comments_text_more"),f=parseInt(window.getComputedStyle(g)["line-height"],10)||21,c=g.firstChild.clientHeight/f;var h=c>b+1;if(h){d.classList.remove("invisible");}else{g.classList.remove("__reveal-2","__reveal-3");}}};});define("OK/discussions/Mentions",[],function(){var g=function(j){var l=window.getSelection();l.removeAllRanges();for(var k=0,h=j.length;k<h;++k){l.addRange(j[k]);}};var e=function(){var l=window.getSelection(),j=[];if(l.rangeCount){for(var k=0,h=l.rangeCount;k<h;++k){j.push(l.getRangeAt(k));}}return j;};function a(h,i){this.element=i;this.textarea=document.getElementById(i.getAttribute("data-bind"));}function d(){if(this.hasFocus){this.selection=e();}}function f(){this.hasFocus=false;}function c(){this.hasFocus=true;}function b(){var i=this;var n=window.getSelection();if(this.selection){g(this.selection);}else{var j=document.createRange();j.selectNodeContents(this.textarea);j.collapse(true);this.selection=[j];n.removeAllRanges();n.addRange(j);}if(n.getRangeAt&&n.rangeCount){var m=" ",o=n.anchorNode&&n.anchorNode.nodeType===Node.TEXT_NODE&&/\s+$/.test(n.anchorNode.textContent),k=document.createTextNode(m);var l=document.createTextNode("@");var h=n.getRangeAt(0);h.deleteContents();h.insertNode(l);if(n.anchorOffset!==0&&!o){h.insertNode(k);}setTimeout(function(){h.setStart(l,1);h.collapse(true);n.removeAllRanges();n.addRange(h);i.textarea.focus();var p=document.createEvent("Event");p.initEvent("keyup",true,true);i.textarea.dispatchEvent(p);},10);}}a.prototype={activate:function(){this.textarea.addEventListener("focus",this.focusListener=c.bind(this));this.textarea.addEventListener("change",this.textareaListener=d.bind(this));this.textarea.addEventListener("mouseup",this.textareaListener);this.textarea.addEventListener("keyup",this.textareaListener);this.textarea.addEventListener("blur",this.blurListener=f.bind(this));this.element.addEventListener("click",this.clickListener=b.bind(this));},deactivate:function(){this.element.removeEventListener("click",this.clickListener);this.textarea.removeEventListener("focus",this.focusListener);this.textarea.removeEventListener("blur",this.blurListener);this.textarea.removeEventListener("change",this.textareaListener);this.textarea.removeEventListener("mouseup",this.textareaListener);this.textarea.removeEventListener("keyup",this.textareaListener);}};return a;});define("b/discussions",["require","OK/Discussion","OK/DiscussionManager","OK/discussions/ScrollController","OK/discussions/Comment","OK/discussions/CommentEntry","OK/discussions/CommentsList","OK/discussions/CommentForm","OK/discussions/CommentFormAuthorMenu","OK/discussions/LinkAttachController","OK/discussions/TypingStatus","OK/utils/textchange","OK/discussions/Reveal","OK/discussions/Mentions"],function(a){a("OK/Discussion");a("OK/DiscussionManager");a("OK/discussions/ScrollController");a("OK/discussions/Comment");a("OK/discussions/CommentEntry");a("OK/discussions/CommentsList");a("OK/discussions/CommentForm");a("OK/discussions/CommentFormAuthorMenu");a("OK/discussions/LinkAttachController");a("OK/discussions/TypingStatus");a("OK/utils/textchange");a("OK/discussions/Reveal");a("OK/discussions/Mentions");return function(){};});