define(["OK/logger","OK/utils/utils","OK/utils/throttle","OK/LogClicks"],function(o,m,n,k){var e="seen",h="log.seen";var b=[];var a=[];var c=n(150,function g(){var p=a.length;while(p--){a[p].onScroll();}});function i(p,r,q){OK.logging.info(e+" "+p+" "+r);o[q?"force":"success"](e,p,r);}function l(p){OK.logging.alert(h+" "+p);o.error(h,p);}function j(){this.params={};this.seenStartTime=0;this.hoverStartTime=0;this.onScrollSeenTimer=null;this.logData={};}j.prototype.activate=function(p){this.element=p;this.params=JSON.parse(p.getAttribute("data-seen-params"));if(this.params.options){this.seenTimeout=this.params.options.seenTimeout;this.skipVisible=this.params.options.skipVisible||false;this.hoverTimeout=this.params.options.hoverTimeout;this.seenPartial=this.params.options.partial||0.01;this.seenForce=this.params.options.force||false;this.onScrollSeen=this.params.options.onScrollSeen||false;this.onScrollSeenTimeout=this.params.options.onScrollSeenTimeout||10000;this.onScrollPartial=this.params.options.onScrollPartial||0.6;var r=k.getLogDataAsString(p);var q=r&&k.parseLogData(r);if(q&&q.feedFeatures){this.params.data=this.params.data||{};this.params.data.feedFeatures=q.feedFeatures;if(q.feedPosition){this.params.data.feedPosition=Number(q.feedPosition);}if(q.feedLocation){this.params.data.feedLocation=q.feedLocation;}}}this.boundMouseEnter=this.mouseEnter.bind(this);this.boundMouseLeave=this.mouseLeave.bind(this);this.boundClick=this.onClick.bind(this);if(this.hoverTimeout){this.element.addEventListener("mouseenter",this.boundMouseEnter);this.element.addEventListener("mouseleave",this.boundMouseLeave);}if(this.seenTimeout){this.element.addEventListener("click",this.boundClick);}if(this.seenTimeout&&!this.skipVisible){if(m.isElementPartiallyInViewport(p,this.seenPartial)){this.shown();}}return this;};j.prototype.deactivate=function(){if(this.hoverTimeout){this.element.removeEventListener("mouseenter",this.boundMouseEnter);this.element.removeEventListener("mouseleave",this.boundMouseLeave);}if(this.seenTimeout){this.element.removeEventListener("click",this.boundClick);this.hidden();}};j.prototype.shown=function(){this.logData=Object.assign({},this.params.data);this.seenStartTime=Date.now();};j.prototype.shownOnScroll=function(){if(!this.onScrollSeen||this.onScrollSeenTimer||this.logData.seen){return;}var p=m.isElementPartiallyInViewport(this.element,this.onScrollPartial);if(!p){return;}this.onScrollSeenTimer=setTimeout(function(){if(this.logData.seen){return;}this.logData.seen=this.onScrollSeenTimeout;i(this.params.type,JSON.stringify(this.logData),this.seenForce);}.bind(this),this.onScrollSeenTimeout);};j.prototype.hidden=function(){if(this.seenStartTime&&!this.logData.seen){var p=Date.now()-this.seenStartTime;if(p>=this.seenTimeout){this.logData.seen=p;i(this.params.type,JSON.stringify(this.logData),this.seenForce);}}this.logData.seen=0;this.seenStartTime=0;if(this.onScrollSeenTimer){clearTimeout(this.onScrollSeenTimer);this.onScrollSeenTimer=null;}};j.prototype.mouseEnter=function(){this.hoverStartTime=Date.now();};j.prototype.mouseLeave=function(){if(this.hoverStartTime){var p=Date.now()-this.hoverStartTime;if(p>=this.hoverTimeout){this.logData.hovered=p;}}this.hoverStartTime=0;};j.prototype.onScroll=function(){if(this.seenTimeout){var p=m.isElementPartiallyInViewport(this.element,this.seenPartial);if(p){if(!this.seenStartTime){this.shown();}this.shownOnScroll();}else{this.hidden();}}};j.prototype.onClick=function(){if(this.seenStartTime){this.logData.seen=Date.now()-this.seenStartTime;}else{if(this.skipVisible){this.shown();}this.logData.seen=0;}this.logData.seen=this.seenStartTime?Date.now()-this.seenStartTime:0;this.logData.clicked=true;i(this.params.type,JSON.stringify(this.logData),this.seenForce);this.seenStartTime=0;};function f(q){var p=b.indexOf(q);if(p===-1){b.push(q);a.push(new j().activate(q));}if(a.length===1){window.addEventListener("scroll",c,true);}}function d(q){var p=b.indexOf(q);if(p!==-1){a[p].deactivate();b.splice(p,1);a.splice(p,1);}if(!a.length){window.removeEventListener("scroll",c,true);}}return{logError:l,logSuccess:i,activate:f,deactivate:d};});