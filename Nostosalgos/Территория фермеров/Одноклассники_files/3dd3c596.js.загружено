define("OK/messages/BrowserNotifications",["PTS/messaging.client","OK/logger","OK/utils/dom","OK/utils/vanilla","OK/WebPush","OK/NotificationPermissionPopup"],function(N,v,c,w,k,F){var a="notification_enabled_messenger",e="notification_enabled_messenger_pro",r="notification_enabled_messenger_pro_hidden_till",l="1",I="js-notifications-on",d="js-notifications-off",q="__hidden",t="data-web-push-interop-enabled",C="data-web-push-extended-settings-enabled",D=[],E,H,L;var P=false,i=false;function O(){return window.Notification&&window.Notification.permission==="granted";}function G(){return O()&&window.localStorage&&window.localStorage.getItem(a)!=="0";}function M(){return window.Notification&&window.Notification.permission==="denied";}function n(){return window.localStorage&&window.localStorage.getItem(e)===l;}function A(){if(window.localStorage){var Q=window.localStorage.getItem(r),R=new Date();if(Q){return R<(new Date(Q));}}return false;}function p(Q,S,R){Q&&Q.classList.toggle("invisible",R);S&&S.classList.toggle("invisible",!R);}function z(Q,R){Q.classList.add("invisible");R.classList.add("invisible");}function m(Q,R){Q.onshow=function(){v.success("html5.ntf.shown");setTimeout(Q.close.bind(Q),7000);};Q.onclose=function(){D.some(function(S,T){if(S===Q){D.splice(T,1);return true;}});};Q.onclick=function(){v.success("html5.ntf.click");if(R){R.call();}};}function u(){return OK.cnst.staticUrl+"res/i/html5_notif_icon.png";}function B(U,R,S,Q,V){S=S||u();var T=new Notification(U,{body:R,icon:S,tag:Q});m(T,V);D.push(T);return T;}function x(S,T){p(S,T,G());var V=N["html5.notification.enabled.title"],R=N["html5.notification.enabled.body"],U=u(),Q="messenger-enabled";return B(V,R,U,Q);}function J(Q,R){if(!localStorage||!Notification){return false;}if(Notification.permission==="default"){Notification.requestPermission(function(S){if(S==="granted"){v.success("html5.ntf.granted");localStorage.setItem(a,"1");k.subscribe("messages").then(function(T){if(i&&T===k.STATUS_SUBSCRIBED){g(true);}},h);x(Q,R);}else{if(S==="denied"){v.success("html5.ntf.denied");}}});}else{if(Notification.permission==="denied"){if(P){F.open(function(){if(Notification.permission!=="denied"){J(Q,R);}});}}else{v.success("html5.ntf.enabled");localStorage.setItem(a,"1");k.subscribe("messages").then(function(S){if(i&&S===k.STATUS_SUBSCRIBED){g(true);}},h);x(Q,R);}}return false;}function o(){D.forEach(function(Q){Q.close();});D=[];}function j(Q,R){return function(S){J(Q,R);p(Q,R,G());S.stopPropagation();S.preventDefault();};}function f(Q,R){return function(S){if(window.localStorage){window.localStorage.setItem(a,"0");}p(Q,R,G());S.stopPropagation();S.preventDefault();v.success("html5.ntf.disable");if(!i){k.unsubscribe("messages")["catch"](h);}else{g(false);}};}function b(R,Q){return R.parentNode.getElementsByClassName(Q)[0].parentNode;}function h(){if(OK.fn.isDebug()){console.error.apply(console,arguments);}}function s(Q){return function(T){var R=c.firstByClass(document,I),S=c.firstByClass(document,d);if(R){R=R.parentNode;}if(S){S=S.parentNode;}J(R,S);K(Q);};}function K(Q){localStorage.setItem(e,l);Q.classList.add(q);}function y(Q,S){var R=new Date();R.setSeconds(R.getSeconds()+S);localStorage.setItem(r,R);Q.classList.add(q);}function g(Q){if(!k.isEnabled()){return;}w.ajax({method:"POST",url:"/web-api/webpush/messages?enabled="+(Q?"true":"false")});}return{activate:function(S){i=S.getAttribute(C)==="true";P=S.getAttribute(t)==="true";var Q=b(S,I),R=b(S,d);if(M()&&!P){z(Q,R);return;}Q.notifClickListener=j(Q,R);R.notifClickListener=f(Q,R);p(Q,R,G());Q.addEventListener("click",Q.notifClickListener);R.addEventListener("click",R.notifClickListener);},deactivate:function(S){var Q=b(S,I),R=b(S,d);if(Q.notifClickListener){Q.removeEventListener("click",Q.notifClickListener);Q.notifClickListener=null;}if(R.notifClickListener){R.removeEventListener("click",R.notifClickListener);R.notifClickListener=null;}},activatePro:function(R){if(G()||n()||A()){return;}i=R.getAttribute(C)==="true";P=R.getAttribute(t)==="true";if(M()&&!P){return;}E=c.firstByClass(R,"js-browser-notif-pro_enable");H=c.firstByClass(R,"js-browser-notif-pro_delay");L=c.firstByClass(R,"js-browser-notif-pro_close");E.notifProClickListener=s(R);E.addEventListener("click",E.notifProClickListener);if(H){var Q=parseInt(H.getAttribute("data-delay"),10);H.notifProDelayListener=function(){y(R,Q);};H.addEventListener("click",H.notifProDelayListener);}if(L){L.notifProCloseListener=function(){K(R);};L.addEventListener("click",L.notifProCloseListener);}setTimeout(function(){R.classList.remove(q);},1000);},deactivatePro:function(Q){if(E&&E.notifProClickListener){E.removeEventListener("click",E.notifProClickListener);E.notifProClickListener=null;E=null;}if(H&&H.notifProDelayListener){H.removeEventListener("click",H.notifProDelayListener);H.notifProDelayListener=null;E=null;}if(L&&L.notifProCloseListener){L.removeEventListener("click",L.notifProCloseListener);L.notifProClickListener=null;L=null;}},show:B,closeAll:o,isEnabled:G,isPermitionGranted:O,toggle:function(Q){if(localStorage){localStorage.setItem(a,Q?"1":"0");}}};});define("OK/messages/WindowVisibility",[],function(){var b="hasFocus" in document,a=true,d=[];function c(f){f=f||window.event;a=f.type==="focus";d.forEach(function(e){if(a&&e.onWindowFocus){e.onWindowFocus();}if(!a&&e.onWindowBlur){e.onWindowBlur();}});}window.addEventListener("focus",c);window.addEventListener("blur",c);return{hasFocus:function(){return b?document.hasFocus():a;},addListener:function(e){d.push(e);},removeListener:function(f){var e=d.indexOf(f);if(e>-1){d.splice(e,1);}}};});define("OK/ToolbarGrowl",["OK/logger","OK/utils/dom"],function(u,s){var d="CallApplication",r="appMain",b="__active",p="growl",e="click",a="data-id",h=(function(){var v,w,y=document.createElement("bootstrap"),x={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(w in x){if(x.hasOwnProperty(w)&&y.style[w]!==undefined){v=x[w];break;}}u.success(p,"transition",v);return v;}()),n=null,m={},t=document.getElementById("msg_toolbar_button"),o=!!(t&&t.getAttribute("data-growl-add-log")),k=!!document.querySelector(".js-msg-ok"),f=!!document.querySelector(".js-msg-tt");function j(v){if(v){return parseInt(v.getAttribute("data-time"),10)||0;}return 0;}function g(){return OK.Layers&&OK.Layers.isAnyLayerOpened();}function l(){return !(g()||document.getElementById(d)||OK.getCurrentDesktopModelId()===r);}function i(w){var v=document.createElement("div");v.innerHTML=w;return v.children.length?v.children[0]:null;}function c(v){return s.firstByClass(v,"growl_close");}function q(v){this.hookId=v;this.hidden=true;this.stash=null;}q.showAny=function(){var w,v;if(n){return;}for(w in m){if(m.hasOwnProperty(w)){v=m[w];if(v.hidden){v.show();if(!v.hidden){break;}}}}};q.hideAll=function(){if(n){n.hide();}};q.destroyByLayerId=function(v){var w=m[v];if(w){w.destroy();}};q.getByLayerId=function(v){return m[v];};q.prototype={activate:function(v){this.hook=this.getContentHook();this.layerId=v.getAttribute("data-layer");this.exclusive=v.getAttribute("data-exclusive")==="true";this.priority=parseInt(v.getAttribute("data-priority"),10)||0;m[this.layerId]=this;if(this.hook){this.elem=this.hook.element.firstChild;if(this.elem){this.activateGrowl();this.id=this.elem.getAttribute(a);this.time=j(this.elem);}}this.show();},activateGrowl:function(){var v=c(this.elem);if(v){v.addEventListener(e,this);}},deactivateGrowl:function(){var v=c(this.elem);if(v){v.removeEventListener(e,this);}},show:function(){if(this.id&&l.call(this)){if(n){if(this.priority<=n.priority){return;}else{u.success(p,"replace",this.layerId);n.hide();}}this.elem.classList.add(b);this.hidden=false;n=this;u.success(p,"show",this.layerId==="music_app"?this.layerId+"-"+this.id:this.layerId);if(this.layerId==="messages"&&o){var v=f?"tt":k?"ok":"unknown";return u.success("messagesLayer","growl",v);}}},hide:function(){if(this.elem){this.elem.classList.remove(b);this.hidden=true;if(this===n){n=null;}}},destroy:function(){if(this.elem){this.deactivateGrowl();this.hide();this.id=null;this.time=null;this.elem=null;}},setNewContent:function(x){var v=this,w=i(x),z,y;if(OK.Layers&&OK.Layers.isLayerOpened(v.layerId)){u.success(p,"ignore");}else{if(w){z=w.getAttribute(a);y=j(w);if(this.exclusive&&this.id&&this.id!==z){return;}if(v.id===z&&v.time===y){u.success(p,"equal",1);return;}if(v.hidden){this.setNewGrowl(x,z,y);}else{this.stash={html:x,id:z,time:y};this.elem.addEventListener(h,this,false);v.destroy();}}else{v.destroy();q.showAny();}}},applyNewContent:function(){this.hidden=true;if(this.stash===null){OK.hookModel.setHookContent(this.getContentHookId(),"");}else{this.setNewGrowl(this.stash.html,this.stash.id,this.stash.time);u.success(p,"replace");this.stash=null;}},setNewGrowl:function(w,y,x){if(this.id===y&&this.time===x){u.success(p,"equal",2);return;}var v=this.getContentHook();OK.hookModel.setHookContent(v.id,w);this.elem=v.element.firstChild;this.id=y;this.time=x;this.activateGrowl();setTimeout(this.show.bind(this),30);},handleEvent:function(w){var v=w.type;if(v===e){if(this.time>this.crossTime){this.crossTime=this.time;}this.destroy();q.showAny();}else{if(v===h){if(w.propertyName==="opacity"){w.target.removeEventListener(h,this);this.applyNewContent();}}}},getContentHookId:function(){return this.hookId+"_Content";},getContentHook:function(){if(!this.hook){this.hook=OK.hookModel.getHookById(this.getContentHookId());}return this.hook;}};return q;});define("OK/messages/Helper",["OK/messages/WindowVisibility","OK/utils/dom","OK/ToolbarBubble","OK/ToolbarGrowl","OK/logger","OK/utils/vanilla"],function(b,p,c,n,t,m){var k="ConversationsList",h="counter_ToolbarMessages",u="counter_UserMessages",g="counter_GroupMessages",r=c.wrap("counter_ToolbarMessages"),j=!!document.getElementById("msg_toolbar_button").getAttribute("data-button-add-log");function e(){var v=OK.hookModel.getHookById(k);if(v){return v.element;}else{return document.getElementById("hook_Block_"+k);}}function f(){return c.wrap(h);}function i(){return c.create(u);}function a(){return c.create(g);}function l(){return document.getElementById("js-chats_type");}function d(){var v=l();return v?v.getAttribute("data-filterTab"):null;}function o(){var v=l();return v?v.getAttribute("data-filterGroupId"):null;}function q(){var v=l();return v?v.getAttribute("data-filterUnanswered"):null;}function s(w){var y=r.getCount(),A=r.hasBubble();if(w){if(y!==w.conv){r.resolveCustomIcon(w.conv,w.hasReply);var x=w.updateFaviconIfNeeded;if(j){t.success("messagesLayer","bubble",x?"tt":"ok");}require(["OK/messages/MessagesAlert"],function(B){B.updateUnread(w.conv,x);});if(y>w.conv){n.destroyByLayerId("messages");if(w.showGrowlTT){m.ajax({url:"/dk?cmd=MessagesGrowl"}).then(function(B){m.updateBlockModelCallback(B);});}}}else{if(!A){r.resolveCustomIcon(0,false);}}var z=i();if(z){z.resolveCustomIcon(w.conv-w.group);}var v=a();if(v){v.resolveCustomIcon(w.group);}}else{if(!A){r.resolveCustomIcon(0,false);}}}return{isLayerOpenedAndActive:function(){return this.isWindowHasFocus()&&this.isMessageLayerOpened();},isMessageLayerOpened:function(){return OK.Layers&&OK.Layers.isLayerOpened("messages");},isWindowHasFocus:function(){return b.hasFocus();},updateToolbarBubbleFromServer:function(w){if(!w){return;}try{var A=f();var x=A.getCount();var y=w.conv;if(x!=y){A.resolveCustomIcon(y,w.hasReply);require(["OK/messages/MessagesAlert"],function(B){B.updateUnread(y);});}if(d()=="GROUP"&&!o()){var v=a();if(v){v.resolveCustomIcon(w.group);}}}catch(z){t.error("messagesLayer.error","helper_updateToolbarBubbleFromServer");t.clob("error",z.stack,"messagesLayer","helper_updateToolbarBubbleFromServer");}},getFilterTab:d,getFilterGroupId:o,getFilterUnanswered:q,newMessageNotify:s,getConvLastMsgId:function(x){var w=e();if(w){var v=p.firstByClass(w,"js-lastMsg_"+x);if(v&&v.firstChild){return v.firstChild.getAttribute("data-id");}}return null;}};});define("OK/messages/MessagesConfig",["OK/logger","OK/utils/utils"],function(c,a){var b={initialConvCount:0,initialMsgCount:0,saveUnsentMessages:false,ajaxRetryCount:3,ajaxTimeout:10000,lastMsgSyncFix:false,cacheTimeout:0,poorPasteClean:false,addCardOnRestore:false,focusSearchOnOpen:false,messagesCountForReset:-1,messagesCountForDisablePush:-1,hideTimestampOnVideoStart:false,sendDeliveredToClient:false,historyFix:false,searchTouch:false,newTyping:false,copyMsgText:false,myUnreadLeftColumn:false,typingShowTimeout:6000,chatListDrafts:false,fancyScroll:false,convDeactivateEnabled:false,convListDuplicatesFix:false,allowedTags:"p, br, div, img.emoji, img.usmile, img[alt^='#u'][alt$='s#']",user:{id:0,isPlaySound:false,isStar:false,isSendOnCtrlEnter:false},retrySend:{timeout:0,retriesCount:0,retryDelay:0,increaseBy:1000},attachItemVersions:{},asyncUploadEnabled:false,sendStickerAsAttach:false};function d(h){var g=h&&h.innerHTML,f={};if(g){try{f=OK.util.parseJSON(g);}catch(i){c.error("messagesLayer.error","confParse");}}return f;}return{activate:function(f){var e=d(f);a.extendDeep(b,e);return b;},update:function(e){a.extendDeep(b,e);return b;},get:function(){return b;},toggleSendOnEnter:function(e){b.user.isSendOnCtrlEnter=!e;}};});define("OK/messages/SoundPlayer",[],function(){var e="messages.nmst";var b="messages.pnms";var d=null;var a=null;function g(m){var l=".mp3";var i=".wav";var j="probably";var k="maybe";var h=m.canPlayType("audio/mp3");var n=m.canPlayType("audio/wav");if(h===j){OK.logging.logger.success(e,"mp3.pb");return l;}if(n===j){OK.logging.logger.success(e,"wav.pb");return i;}if(h===k){OK.logging.logger.success(e,"mp3.mb");return l;}if(n===k){OK.logging.logger.success(e,"wav.mb");return i;}OK.logging.logger.success(e,"err");return null;}function c(i){if(d!=null&&i===a){return;}var h=new Audio();var j=g(h);if(!j){return;}h.src=i+j;h.volume=0;h.play();a=i;d=h;}function f(){d.pause();d.src=d.src;d.volume=1;d.play();OK.logging.logger.success(b);}return{initAndPlay:function(h){if(!window.HTMLAudioElement){OK.logging.logger.success(e,"ns");return;}c(h);f();}};});define("OK/messages/MessagesPushController",["OK/logger","OK/NewsFetchCoordinator"],function(l,d){var k="PRIVATE",i=[],j={count:0,privateConv:0,chatConv:0,privateMessages:0,chatMessages:0,updateMessagesTime:0,readMarksTime:0,typingStatusesTime:0};function b(m){return m===k?j.privateConv:j.chatConv;}function f(m){return m===k?j.privateMessages:j.chatMessages;}function c(n){var s=n.unreadCount;if(s&&s.time&&j.count&&s.time<=j.count){n.unreadCount=undefined;}var r=n.updatedConversations;if(r&&(j.privateConv||j.chatConv)){var t=[];Object.keys(r).forEach(function(v){var u=r[v];if(u.time&&u.time<=b(u.type)){t.push(v);}});t.forEach(function(u){delete n.updatedConversations[u];});}var q=n.newMessages;if(q&&(j.privateMessages||j.chatMessages)){Object.keys(q).forEach(function(w){var u=q[w];var v=[];u.forEach(function(x){if(!(x.time&&x.time<=f(x.type))){v.push(x);}});q[w]=v;});}var p=n.updatedMessages;if(p&&j.updateMessagesTime){Object.keys(p).forEach(function(w){var u=p[w];var v=[];u.forEach(function(x){if(!(x.time&&x.time<=j.updateMessagesTime)){v.push(x);}});p[w]=v;});}var o=n.readMarks;if(o&&j.readMarksTime){Object.keys(o).forEach(function(w){var v=o[w].list;var u=[];v.forEach(function(x){if(!(x.time&&x.time<=j.readMarksTime)){u.push(x);}});o[w].list=u;});}var m=n.typingStatuses;if(m&&j.typingStatusesTime){Object.keys(m).forEach(function(w){var u=m[w].list;var v=[];u.forEach(function(x){if(!(x.time&&x.time<=j.typingStatusesTime)){v.push(x);}});m[w].list=v;});}}function a(m){return parseInt(m,10)||0;}function g(w){var r=w.unreadCount;if(r&&r.time){var u=a(r.time);if(u>j.count){j.count=u;}}var t=w.checkTime;if(!t){return;}var m="";var v=t.privateConvTime;if(v){var u=a(v);if(u>j.privateConv){j.privateConv=u;}}m=e(m,j.privateConv);var x=t.chatConvTime;if(x){var u=a(x);if(u>j.chatConv){j.chatConv=u;}}m=e(m,j.chatConv);var p=t.privateMessagesTime;if(p){var u=a(p);if(u>j.privateMessages){j.privateMessages=u;}}m=e(m,j.privateMessages);var n=t.chatMessagesTime;if(n){var u=a(n);if(u>j.chatMessages){j.chatMessages=u;}}m=e(m,j.chatMessages);var q=t.updateMessagesTime;if(q){var u=a(q);if(u>j.updateMessagesTime){j.updateMessagesTime=u;}}var s=t.readMarksTime;if(s){var u=a(s);if(u>j.readMarksTime){j.readMarksTime=u;}}var o=t.typingStatusesTime;if(o){var u=a(o);j.typingStatusesTime=u;}if(m.length>0){d.updateParam("st.mpCheckTime",m);}}function e(n,m){return n+(n.length?":":"")+m;}function h(n){if(!n){return;}var m={};i.forEach(function(o){if(o.applyNews){if(o.dependsOn){if(m.hasOwnProperty(o.dependsOn)&&!m[o.dependsOn]){m[o.name]=false;return;}}try{m[o.name]=o.applyNews(n);}catch(p){m[o.name]=false;l.error("messagesLayer","pushCtrl_"+o.name);l.clob("error",p.toString(),"messagesLayer","pushListener_applyNews");}}});}return{priority:{very_high:4,high:3,medium:2,low:1},activate:function(){d.addBlock("MPC");},register:function(m){i.push(m);i.sort(function(o,n){return n.priority-o.priority;});return function(){var n=i.indexOf(m);if(n>=0){i.splice(n,1);}};},applyNews:h,setNewContent:function(n){try{if(n){var m=OK.util.parseJSON(n);if(m){c(m);this.applyNews(m);g(m);}}}catch(o){l.error("messagesLayer.error","pushSetNewCnt");l.clob("error",o.stack,"messagesLayer","processPush");}},getCheckTime:function(){return j;}};});define("OK/messages/WindowTitleChanger",["PTS/messaging.client"],function(e){var d=document.title,c;function b(g){document.title=g;}function a(k){var h=arguments.length,j,g=0;c&&clearInterval(c);if(h>1){j=arguments;c=setInterval(function(){b(j[g]);g++;if(g>=h){g=0;}},700);}else{b(k);}}function f(h){var i=OK.util.plurals(h);var g="new.message.count."+i;a(h+" "+e[g]);}return{setTitle:a,resetTitle:function(){a(d);},setNewMessagesTitle:f};});define("OK/messages/MessagesAlert",["OK/messages/MessagesConfig","OK/messages/SoundPlayer","OK/messages/BrowserNotifications","OK/messages/MessagesPushController","OK/messages/WindowTitleChanger","OK/FaviconManager","PTS/messaging.client","OK/messages/Helper","OK/NewsFetchCoordinator","OK/logger"],function(k,p,q,r,c,f,E,a,z,F){var i,o,l,s=false,v=[],b=3000;function D(){return k.get();}function w(J){if(!a.isLayerOpenedAndActive()){return true;}if(require.defined("OK/messages/ConversationsManager")){var I=require("OK/messages/ConversationsManager"),H,G;for(H=0;H<J.length;H++){G=I.getById(J[H]);if(!G||!G.selected){return true;}}return false;}return true;}function h(){return OK.lss&&OK.lss.isMaster();}function A(){var G=performance.now();if(o&&(G-o)<b){return;}o=G;p.initAndPlay(OK.cnst.staticUrl+"res/default/sound/newMessageSound15");}function e(I){var H=D().user,G=!I&&a.isLayerOpenedAndActive();if(!H.isPlaySound||!h()||G){return;}A();}function g(){if(h()){A();}}function d(){if(s){return;}if(i>0){c.setNewMessagesTitle(i);}else{n();}}function j(G,H){i=G;if(H&&i>0){u();}d();}function u(){s=true;f.registerFavicon(0);c.setTitle(E["new.message.title"],"* * * * * * * * * * * *");l&&clearTimeout(l);l=setTimeout(function(){s=false;d();},5000);}function n(){f.removeFavicon(0);c.resetTitle();}function t(H){var G=D().user;G.isPlaySound=H;if(H){A();}}function y(I){var H=Date.now(),G=v.some(function(K,J){if(H-I.time>60000){v.splice(J,1);}return I.msgId===K.msgId;});if(!G){I.time=H;v.push(I);}return G;}function C(H,G){H.forEach(function(I){if(y(I)){F.success("html5.ntf.filter");return;}q.show(I.title,I.body,I.icon,I.convId,function(){q.closeAll();window.focus();if(G){require(["OK/messages2/layer"],function(J){J&&J.open(I.url);});}else{require(["OK/messages/MessagesLayer"],function(J){J.open({conversationId:I.convId});});}});});}function x(G){if(G.length>0&&!a.isWindowHasFocus()&&q.isEnabled()&&z.isMaster()){C(G);}}function B(G){if(!a.isWindowHasFocus()&&q.isPermitionGranted()&&h()){C(G,true);}}function m(){var G=D();i=G.initialConvCount;var H=G.initialMsgCount;if(H>0&&i>0&&!G.user.isStar){u();}}return{activate:function(H){k.activate(H);var G=this;r.register({name:"alert",priority:r.priority.medium,dependsOn:"convMgt_newMsg",applyNews:function(I){return G.applyNews(I);}});m();},applyNews:function(I){var L=I&&I.alerts;if(!L){return false;}var H=L.notifications,G=L.subscribedConvIds,J=w(G),M=H&&H.length&&J;try{e(J);}catch(K){F.error("messagesLayer.error","playSound");}if(M){i=I.unreadCount?I.unreadCount.conv:0;u();}x(H);return true;},updateUnread:j,playSoundTT:g,showNotificationsTT:B,toggleSound:t};});define("OK/messages/Timing",["OK/logger",],function(b){var a="OK/messages2/timing",e=require.defined(a),c={};function d(f){if(e){require([a],function(g){g.log("flback-"+f);});}}return{log:function(f){if(c.hasOwnProperty(f)){return;}var g;if(f=="start"){g=performance.now();}else{var h=c.start;if(!h){b.success("messagesLayer","loading.ok.error");return;}g=performance.now()-h;}c[f]=g;b.durationScalar("messagesLayer","loading.ok."+f,g);d(f);}};});define("OK/messages/MessagesToggleButton",["OK/logger","OK/messages/Timing","OK/ToolbarBubble"],function(b,d,a){var c="click",f=a.wrap("counter_ToolbarMessages");function e(h){var g=this;h.preventDefault();h.stopPropagation();d.log("start");OK.loader.execRequire("OK/messages/MessagesLayer",function(i){if(g.id==="msg_toolbar_button"&&!i.isOpen()){var j=f.hasReply()?"reply":f.getCount();b.success("messagesLayer","open",j);}i.toggle();});}return{activate:function(g){g.addEventListener(c,e);},deactivate:function(g){g.removeEventListener(c,e);}};});define("OK/AttachPicker",["jquery","OK/utils/utils"],function(d,t){var k={};var s="localStorage" in window&&window.localStorage!==null;var r={};var j={},a="OK/messages2/app";var l=8,m=d({}),u=false,c;function b(v){return v&&v.indexOf("tt_")===0;}function f(v,w){if(b(v)&&require.defined(a)){require(a).attachesSelected({objectId:v,attaches:w});}}var e=function(){};e.serialize=function(z,x,y,w){var v={type:x.toString(),id:z};if(w){v.token=w;}else{if(y||y==0){if("PHOTOERROR"===v.type){v.error=y.toString();}}if("VIDEOERROR"===v.type){v.error=y?y.toString():"video_default";}}return v;};e.addRecentGif=function(w,y){var v=y.attr("data-token"),x=y[0].hasAttribute("data-close-smiles");if(x){OK.Layers.unregisterLast();}t.ajax({type:"POST",url:"/web-api/photo/upload/attach/fixToken",data:{tokenTemplate:v}}).done(function(C,z,D){if(C){var E=C.photoId,A=C.token;var B=e.serialize(E,"RECENTGIF",undefined,A);e.add(w,[B]);}});};e.get=function(v,x){var w=k[v];if(!w){k[v]=w=d.extend(d({}),{_counter:0,objectId:v,maxCount:l,single:u,supportsLs:s,warningContainer:d(),attachedInput:d(),place:null,sessions:{},activeSession:null,edited:false,separateUploadTypes:[],serializeAttachesCb:function(){},sendUploadedAttachesCb:function(){}});}if(x){w._counter++;}return w;};e.startSession=function(v){var w=e.get(v);if(w.activeSession){return w.activeSession;}var y=OK.util.nextId();var x={sessionId:y,previewContainer:w.previewContainer,files:null,callback:null,data:null};w.sessions[y]=x;w.activeSession=x;return x;};e.detachSession=function(v,z,x){var w=e.get(v,true);var y=w.activeSession;y.callback=z;y.files=p(v);y.data=x;e.clear(v);return y;};e.findSession=function(v,y){var w=e.get(v,true);if(w.sessions){for(var x in w.sessions){if(w.sessions.hasOwnProperty(x)&&w.sessions[x].data===y){return w.sessions[x];}}}return null;};e.updatePreviewContainer=function(v,y){var w=e.get(v,true);var z=d(y);for(var x in w.sessions){if(w.sessions.hasOwnProperty(x)){w.sessions[x].previewContainer=z;}}};e.getRemainingCount=function(v){return e.get(v).maxCount-p(v).length;};e.getCount=function(v){return p(v).length||0;};e.add=function(C,v,y){var A=e.get(C);var D=p(C);var w=0,B=0;for(var z=0;z<v.length;++z){var x=v[z];if(D.indexOf(x)>=0){continue;}if(A.single){++B;if(D.length){D[0]=x;}else{D.push(x);}}else{if(D.length>=A.maxCount){++w;continue;}else{++B;D.push(x);}}}o(C,D);if(!y&&w>0){n(A);}if(B>0){h(A,false);}return w===0;};e.isEdited=function(v){var w=e.get(v);if(w){return w.edited;}};e.edit=function(v){var w=e.get(v);if(w){w.edited=true;}};e.remove=function(w,C,B){if(B){B.callback=null;var y=e.get(w);delete y.sessions[B.sessionId];m.triggerHandler("remove.session."+w,[B]);return;}var z=p(w),A=C.split(":"),x=A[0].split("_"),v=x[1]==="null";d.each(z,function(D,E){if(E&&E.type==x[0]&&(v||E.id==x[1])){z.splice(D,1);o(w,z);h(e.get(w),true);m.triggerHandler("remove."+w,[x[0],x[1]]);}});};e.removeMultiple=function(v,z,A){var x=p(v),y=x.length,w=[];z=z.replace(/&quot;/ig,'"');z=JSON.parse(z);z.forEach(function(F){var E=F.split(":"),C=E[0].split("_"),B=C[1]==="null",D;d.each(x,function(G,H){if(H&&H.type==C[0]&&(B||H.id==C[1])){D=x.splice(G,1);if(A){w.push(D[0]);}}});});if(x.length!=y){if(A){e.saveUnsent(v,w);}o(v,x);h(e.get(v),true);}};e.saveUnsent=function(v,w){c={objectId:v,ids:w};};e.restoreUnsent=function(){if(c){e.add(c.objectId,c.ids);c=null;}};function g(w,v,y){var x=[];w.forEach(function(z){if(v.separateUploadTypes.indexOf(z.type)>-1){var A=z.id;if(A<0&&!j[A]){j[A]=v.serializeAttachesCb(z);}x.push(z);}});if(x.length>0){x.forEach(function(A){var z=w.indexOf(A);if(z>-1){w.splice(z,1);}});y=JSON.stringify(w);}return y;}function i(w,y,v){var x=j[w.id];if(x){e.get(v).sendUploadedAttachesCb(x,y);delete j[w.id];return true;}return false;}e.replace=function(B,E,D,A){var F=A&&A.files;var C=F?A.files:p(B);for(var x=0;x<E.length;x++){var v=E[x].id,z=E[x].type,w=D[x];d.each(C,function(G,I){if(I.type===z&&I.id===(v===-0?0:v)){var H=i(I,w,B);if(H){C.splice(G,1);}else{C[G]=w;}return false;}});}var y=e.get(B);if(F){A.files=C;}else{o(B,C);}if(A){delete y.sessions[A.sessionId];}h(y,true,A);};e.clear=function(v){c=null;var w=e.get(v);if(w){w.activeSession=null;w.edited=false;}var x=p(v);if(x.length==0){return;}o(v,[]);h(e.get(v),false);};e.subscribe=function(v,x,w){m.on(x+"."+v,w);};e.unsubscribe=function(v,x,w){m.off(x+"."+v,w);};e.getFiles=function(v){return p(v);};e.callGifPaymentWizard=q;e.destroy=function(v){var w=k[v];w._counter--;if(w._counter<=0){if(w.button){w.button.off();w.button.removeData();w.button=null;}if(w.previewContainer){w.previewContainer.off();w.previewContainer.removeData();w.previewContainer=null;}if(w.warningContainer){w.warningContainer.off();w.warningContainer.removeData();w.warningContainer=null;}if(w.attachedInput){w.attachedInput.off();w.attachedInput.removeData();w.attachedInput=null;}if(w.sessions){for(var x in w.sessions){if(w.sessions.hasOwnProperty(x)){delete w.sessions[x];}}w.sessions=null;w.activeSession=null;}w.off();k[w.objectId]=undefined;}};e.prototype={activate:function(B){var H=d(B);var G=this.objectId=H.data("object-id")||d(".js-chat").attr("data-object-id");var C=e.get(G,true);var E=H.data("preview-url");if(E){C.previewUrl=E;C.previewContainer=d("#"+H.data("preview-id"));}var J=H.data("single");if(J){C.single=true;}var K=H.data("use-local-storage");C.supportsLs=s&&(typeof K==="undefined"||K);var I=H.data("attached-ids");if(I){o(G,I);}if(!C.single){var z=H.data("max-count");if(z){C.maxCount=parseInt(z,10);}}var F=H.attr("data-separate-types");if(F){C.separateUploadTypes=F.replace(/^\[/,"").replace(/]$/,"").split(",");}var D=H.data("button-id");if(D){C.button=d("#"+D);C.button.click(function(L){n(C);L.stopPropagation();return false;});}var y=H.data("attach-type"),x=y==="MUSIC";C.warningContainer=C.warningContainer.add(".tipAttachPicker",H);var v=d(".attachedInput",H);C.attachedInput=C.attachedInput.add(v);var A=H.attr("data-place");if(A){C.place=A;}var w=d(".attachButton",H);if(w.length>0){w.click(function(){var L=b(G);var M=[];H.find("input:hidden").each(function(){var P=this.value;if(P&&!isNaN(parseInt(P,10))){var O=false;M.every(function(Q){if(Q.id&&Q.type&&Q.id===P&&Q.type===y){O=true;return false;}return true;});if(O){return;}if(!L){M.push(e.serialize(P,y));}else{var N=this;M.push({id:P,type:String(y),url:N.getAttribute("data-url"),previewUrl:N.getAttribute("data-preview"),width:N.getAttribute("data-width"),height:N.getAttribute("data-height")});}}});if(x){C.trigger("instantSendAttaches",[M]);}else{e.add(G,M);}f(G,M);this.classList.add("__disabled");});}else{d(".attachInput",H).click(function(){var M=d(this);var N=M.data("id");if(M.data("add")){if("RECENTGIF"===y){e.addRecentGif(G,M);}else{var L=this.querySelector("img");if(b(G)){f(G,[{id:N,type:y,preview:L&&L.src,width:this.getAttribute("data-width"),height:this.getAttribute("data-height")}]);}else{e.add(G,[e.serialize(N,y)]);}}}else{e.remove(G,N);}});}if((E||v.length)&&p(G).length>0){h(C,false);}},deactivate:function(w){var x=d(w),v=k[this.objectId];d(".attachButton, .attachInput",x).off("click");x.removeData();e.destroy(this.objectId);}};function p(v){var w;if(e.get(v).supportsLs){var x="AttachPicker."+v;w=JSON.parse(localStorage.getItem(x));if(!w){return[];}return w;}w=r[v];if(!w){r[v]=w=[];}return w;}function o(v,w){if(e.get(v).supportsLs){var x="AttachPicker."+v;if(w.length==0){localStorage.removeItem(x);}else{localStorage.setItem(x,JSON.stringify(w));}return;}r[v]=w;}function n(v){v.warningContainer.addClass("__active");setTimeout(function(){if(v.warningContainer){v.warningContainer.removeClass("__active");}},3000);}function h(x,v,B){var w=B&&B.files;var y=w?B.files:p(x.objectId),A=JSON.stringify(y);if(w){if(B.callback){var z=B.callback;B.callback=null;z(A);e.destroy(x.objectId);}}else{A=g(y,x,A);if(x.button){if(y.length>=x.maxCount){x.button.removeClass("invisible");}else{x.button.addClass("invisible");}}if(x.attachedInput&&x.attachedInput.length>0){x.attachedInput.val(A);}if(x.previewUrl){require(["OK/AttachPreview"],function(C){C.update(x,A).done(function(){x.trigger("update");});});}}}function q(){t.ajax({url:"/dk?cmd=PopLayer",data:{"st.layer.cmd":"PopLayerPaymentWizardOuter","st.layer.srv":"46","st.layer.t2nd":"off","st.layer.redirect":"","st.layer.stJsCb":"attachGifCb"}}).done(function(w,v,x){t.updateBlockModelCallback(w,v,x);});}return e;});define("OK/messages/UnsentMessages",["require","OK/utils/dom","OK/utils/utils","OK/logger","OK/AttachPicker"],function(b){var l=b("OK/utils/dom"),o=b("OK/utils/utils"),r=b("OK/logger"),a=b("OK/AttachPicker"),h="invisible",q="msg_found_",i=l.firstByClass(document,"js-unsent-msg-marker"),s=i&&i.getAttribute("data-store-key"),m="localStorage" in window&&window.localStorage!==null,c=!!s&&m,d=(c&&JSON.parse(localStorage.getItem(s)))||{},j=[],e,g={},n=function(){clearTimeout(e);e=setTimeout(function(){localStorage.setItem(s,JSON.stringify(d));},10);},f=function(t){return t&&Object.keys(t).length===0&&t.constructor===Object;},k=function(){j.forEach(function(t){t.call();});},p=function(t){if(t.lastIndexOf(q,0)===0){t=t.substring(10);}return t;};(function(){var t=false;Object.keys(d).forEach(function(u){if(u.lastIndexOf(q,0)===0){delete d[u];r.success("messagesLayer","unsentFix");t=true;}});if(t){n();}})();return{registerAndCheck:function(t){if(!c){return;}j.push(t);if(this.hasUnsentMessages()){t(d);}},addMessage:function(y,x,u,t){if(!c){return;}y=p(y);var w={},v={};v[x]=u;w[y]=v;if(t){o.extendDeep(g,w);}else{o.extendDeep(g,w);o.extendDeep(d,w);n();}},removeAsync:function(v,u){if(!c){return;}v=p(v);var t=g[v];if(t){delete t[u];if(f(t)){delete g[v];}}},removeMessage:function(v,u){this.removeAsync(v,u);var t=d[v];if(t){delete t[u];if(f(t)){delete d[v];k();}}n();},removeConv:function(u){if(!c){return;}var t=g[u];if(t){delete g[u];}t=d[u];if(t){delete d[u];k();}n();},hasUnsentMessages:function(){if(f(d)){return false;}if(f(g)){return true;}return Object.keys(d).some(function(v){if(g[v]){var u=d[v],t=g[v];return Object.keys(u).some(function(w){return !t[w];});}else{return true;}});},getUnsentMessages:function(t){if(this.hasUnsentMessages()){return d[t]||{};}return{};},getAsyncMessages:function(t){return g[t]||{};},getUnsentConversations:function(){return Object.keys(d);},onAsycContinue:function(v,x,u){var t="asyncUpload",w=function(){if(u&&u.sessions&&Object.keys(u.sessions).length>0){var y=a.findSession(u.objectId,x);a.remove(u.objectId,undefined,y);}};this.onSendRetry(v,x,t,w);},onSendRetry:function(y,A,w,G){var u=0;try{var H=this,v=y.getStubEl(A),C,D,F,I=function(){},t=function(J){D.classList.toggle(h,!J);},z=function(J){F.classList.toggle(h,!J);C.classList.toggle(h,J);v.classList.toggle("__error",!J);},B=function(){u=71;D=l.removeAllListeners(D);u=72;D.addEventListener("click",function(){u=73;I.call();u=74;H.removeMessage(y.conversation.id,A);u=75;y.removeStub(A);});u=76;t(true);},E=function(){C=l.removeAllListeners(C);l.one(C,"click",function(){z(true);G.call();});};u=1;if(!v){return;}u=2;C=l.firstByClass(v,"js-retry-button");u=3;D=l.firstByClass(v,"js-stub-delete-button");u=4;F=l.firstByClass(v,"js-retry-spinner");u=5;switch(w){case"onError":B();break;case"asyncUpload":I=G;B();z(true);break;case"autoRetry":u=6;I=G;u=7;B();u=8;z(true);break;case"manualRetry":u=9;E();u=10;B();u=11;z(false);break;case"onConvActivate":u=111;if(C&&!C.classList.contains(h)){u=12;E();u=13;B();}else{u=14;t(false);}break;}}catch(x){r.success("messagesLayer","e.onSendRetry_"+u);}}};});define("OK/messages/MessageDelivery",["require","OK/messages/MessagesPushController","OK/utils/utils","OK/logger","OK/messages/MessagesConfig"],function(f){var e=f("OK/messages/MessagesPushController"),b=f("OK/utils/utils"),d=f("OK/logger"),c=f("OK/messages/MessagesConfig");function a(i){var h=c.get();if(h.sendDeliveredToClient){b.ajax({url:"/web-api/messages/conversation/markAsDelivered",data:{cid:i},timeout:h.ajaxTimeout},h.ajaxRetryCount).fail(function(){d.error("messagesLayer.error","markAsDelivered");});}}function g(j){if(!j){return true;}var i=j.updatedConversations,h=j.unreadCount?j.unreadCount.conv:0,l=0,n;if(!i||!h){return true;}try{var k=[];Object.keys(i).forEach(function(o){l=1;n=i[o];if(n&&n.groupId){l=2;k.push(o);}});if(k.length){l=3;a(k);}}catch(m){d.success("sendDeliveredToClient","e.send_"+l);}return true;}return{activate:function(h){e.register({name:"sendDeliveredToClient",priority:e.priority.medium,dependsOn:"convMgt_newMsg",applyNews:function(i){return g(i);}});}};});define("OK/messages/MessagesToolbarButton",["module","OK/logger","OK/messages/MessagesToggleButton","OK/messages/MessagesPushController","OK/ToolbarBubble","OK/messages/Helper","OK/messages/UnsentMessages","OK/utils/dom","OK/utils/utils","OK/ToolbarGrowl","OK/messages/MessageDelivery"],function(a,k,e,g,c,b,l,d,i,h,j){var f=c.wrap("counter_ToolbarMessages");g.register({name:"toolbarBtn",priority:g.priority.medium,dependsOn:"convMgt_newMsg",applyNews:function(m){b.newMessageNotify(m.unreadCount);}});return{activate:function(m){e.activate(m);j.activate(m);l.registerAndCheck(function(){m.classList.toggle("__unsent-warn",l.hasUnsentMessages());});if(m.getAttribute("data-growl")==="1"&&f.hasBubble()){if(m.getAttribute("data-growl-add-log")==="1"){k.success("messagesLayer","messageGrowlLoad","ok");}i.ajax({url:"/dk?cmd=MessagesGrowl"}).done(function(o,n,p){i.updateBlockModelCallback(o,n,p);});}if(m.getAttribute("data-ws")==="true"){require(["OK/WSConnectionCheck"],function(n){n.check();});}},deactivate:function(m){e.deactivate(m);}};});define("b/messagesButton",["OK/messages/BrowserNotifications","OK/messages/Helper","OK/messages/MessagesAlert","OK/messages/MessagesConfig","OK/messages/MessagesPushController","OK/messages/MessagesToggleButton","OK/messages/MessagesToolbarButton","OK/messages/UnsentMessages","OK/messages/WindowTitleChanger","OK/messages/WindowVisibility","OK/messages/SoundPlayer","OK/messages/MessageDelivery","OK/messages/Timing"],{});