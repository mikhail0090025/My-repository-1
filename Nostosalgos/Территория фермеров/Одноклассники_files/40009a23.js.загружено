define(["OK/logger","OK/utils/debounce","OK/utils/utils","OK/utils/dom"],function(s,l,P,d){var M=null,D=null,r,b,L,G,f,z,O=0,E,N,m,p,B,H={};var u,t,e,v,h;var y=0;var K=false;r=function(Q){var R=c(Q);if(R){R.play();M=Q;D=R;}};b=function(){if(D&&!D.paused){D.pause();}};z=function(R){if(E){clearTimeout(E);E=null;}var Q=R.detail;O=Q.container.children[Q.offset].getAttribute("data-idx");if(M&&M.sliderIdx!=O){b();}r(H[Q.container.children[Q.offset].getAttribute("data-idx")]);};L=function(Q){if(Q.target==M){return;}if(f&&Q.target.sliderIdx!=O){return;}b();r(Q.target);};N=function(Q){E=setTimeout(function(){if(f){f.dispatchEvent(new CustomEvent("uSliderClick",{detail:{forward:true}}));}E=null;},5000);};m=function(Q){if(Q.target.currentTime>=2){if(!Q.target.getAttribute("data-shown")){var R=Q.target.getAttribute("data-app-id");var S=Q.target.getAttribute("data-banner-id");if(R){s.success("GSB","app",R);}if(S){s.success("GSB","okbnr",S);}if(!R&&!S){s.success("GSB","rbnr","0");}Q.target.setAttribute("data-shown","1");Q.target.removeEventListener("timeupdate",m);}}};p=function(Q){if(M){b();}};B=function(Q){if(M){if(P.isElementInViewport(M)){r(M);}}};G=l(200,function(){if(M){if(!P.isElementInViewport(M)){b();}else{if(!D||D.paused){r(M);}}}});function x(Q){return d.firstByClass(Q,"game-preview");}function c(Q){return d.firstByClass(Q,"game-preview_video");}function w(S,V){var W=V.el;if(W&&W.children.length>0){W.innerHTML="";}if(!f){return;}var U=V.data||{};var T=A(U.html);var Q=x(T);if(!Q){i("slide.banner.broken");I(S,V);return;}var R=!S.classList.contains("invisible");if(J(T,y,R)){y+=1;k();g(x(T));}o(S);}function I(Q,R){o(Q);}function o(Q){t-=1;if(t<=0){F(Q);i("slide.banner.totalAdded."+y);if(v){clearTimeout(v);if(h){h.remove();h=null;}}}}function A(R){var Q=document.createElement("div");Q.setAttribute("data-rb-banner",true);Q.classList.add("uslider_i");Q.classList.add("__nb");Q.innerHTML=R;return Q;}function J(aa,Z,R){var V=d.firstByClass(f,"uslider_hld");if(!V){return false;}var U=j(V.children);var S=a(U,Z,R);if(S<0||S>=u){i("slide.banner.notAdded");return false;}aa.setAttribute("data-idx",S);var Y=Object.keys(U).length;var Q=S+(R?"v":"iv");if(Y<u){if(S>=Y){V.appendChild(aa);}else{V.insertBefore(aa,U[S]);for(var W=S;W<Y;W++){var X=U[W];X.setAttribute("data-idx",W+1);}}i("slide.banner.added."+Q);return true;}if(Y===u){var T=U[S];V.replaceChild(aa,T);C(x(T));i("slide.banner.replaced."+Q);return true;}return false;}function j(T){var R={};for(var S=0;S<T.length;S++){var Q=T[S];var U=Number(Q.getAttribute("data-idx"));R[U]=Q;}return R;}function a(T,W,V){var X=Object.keys(T).length;if(V){var S=3;for(var U=0;U<X-S;U++){var R=(O+2+U)%X;var Q=T[R];if(Q&&!Q.classList.contains("__nb")){return R;}}return -1;}if(W<0){return X;}return O+W*2;}function n(T){var V={};for(var S=0;S<T.length;S++){var Q=T[S];var R=x(Q);var U=Q.getAttribute("data-idx");R.sliderIdx=U;V[U]=R;}return V;}function g(Q){if(Q){Q.addEventListener("mouseenter",L);var R=c(Q);if(R){R.addEventListener("ended",N);R.addEventListener("timeupdate",m);}}}function C(Q){if(Q){Q.removeEventListener("mouseenter",L);var R=c(Q);if(R){R.removeEventListener("ended",N);}}}function k(){if(f){try{var Q=d.byClass(f,"uslider_i");H=n(Q);if(e){e();}}catch(R){i("error.reinit");}}}function q(){if(H){var R=Object.values(H);var Q=R[O];if(Q&&Q.getAttribute("data-autoplay")==="true"){if(P.isElementInViewport(Q)){r(Q);}}}}function F(Q){if(!K){if(f){f.addEventListener("uSliderAction",z);}window.addEventListener("scroll",G);window.addEventListener("blur",p);window.addEventListener("focus",B);K=true;}Q.classList.remove("invisible");q();}function i(Q){s.success("new-banners","apps.video.adv",Q);}return{activate:function(R){K=false;var W=d.byClass(R,"game-preview");if(W&&W.length>0){f=d.firstByClass(R,"uslider");if(f){var S=d.byClass(f,"uslider_i");H=n(S);O=d.firstByClass(R,"__ring")?1:0;}else{H={};for(var Q=0;Q<W.length;Q++){H[Q]=W[Q];}O=0;}}Object.values(H).forEach(function(Y){g(Y);});y=0;var T=d.firstByClass(R,"apps-showcase__b");if(T&&f){u=Number(R.getAttribute("data-maxSlidesCount"));var X=T.getAttribute("data-slot");t=Number(T.getAttribute("data-bCount"));if(X&&t>0){e=function(){f.dispatchEvent(new CustomEvent("uSliderUpdateCount",{detail:{type:"append"}}));};require(["OK/banners/BannerLoader"],function(Z){var aa=w.bind(this,R);var Y=I.bind(this,R);h=Z.subscribeToEvents(X,{onAdsSuccess:aa,onNoAds:Y,onScriptError:Y,onHideBanner:Y});});var V=Number(R.getAttribute("data-showTimeout"))||1000;var U=R.getAttribute("data-addAnyway")==="true";v=setTimeout(function(){i("load.timeout");if(!U){h.remove();h=null;}F(R);v=null;},V);return;}}F(R);},deactivate:function(){window.removeEventListener("scroll",G);window.removeEventListener("blur",p);window.removeEventListener("focus",B);if(H){Object.values(H).forEach(function(Q){C(Q);});}if(f){f.removeEventListener("uSliderAction",z);}if(h){h.remove();}if(v){clearTimeout(v);}}};});