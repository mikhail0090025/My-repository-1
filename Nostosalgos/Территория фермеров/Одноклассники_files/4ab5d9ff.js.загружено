define(["OK/reactions/ReactionController","OK/LinkedHooksStore","OK/ShortcutMenuReact"],function(f,b,g){require(["OK/ExpressReactionsPopup"]);var d="t,unlike";var h="t,hide-react-sc";var i="t,.l";var a=true;var e=b.collections.REACTION_COMPONENTS;var c=function(){this.onClick=this.onClick.bind(this);this.switchLogTarget=this.switchLogTarget.bind(this);};c.prototype={activate:function(k){this.el=k;this.blockHookId=OK.hookModel.getNearestBlockHookId(k);this.blockHook=document.getElementById("hook_Block_"+this.blockHookId);this.reactScMenuId="ShMenuExpressReact-"+this.blockHookId;this.refId=k.getAttribute("data-like-reference-id");this.hookId=k.getAttribute("data-req");this.owner=k.getAttribute("data-owner");var j=parseInt(k.getAttribute("data-react"),10);this.reactionId=isNaN(j)?null:j;this.reactionCount=parseInt(k.getAttribute("data-count"),10)||0;this.logLocation=k.getAttribute("data-ll");b.add(this.refId,e,this.hookId);k.addEventListener("click",this.onClick);this.syncPlayersLikes();this.switchLogTarget();g.setReactComponent(this.blockHookId,this);setTimeout(this.addReactSMListeners.bind(this));this.addLikesSMListeners();},deactivate:function(){b.remove(this.refId,e,this.hookId);this.el.removeEventListener("click",this.onClick);this.likersOnCountShm&&this.likersOnCountShm.hide();g.removeReactComponent(this.blockHookId,this);},syncPlayersLikes:function(){if(!this.blockHook){return;}var j=this.blockHook.getAttribute("data-player-id");j&&runLinkedVideoCallbackFromJS({callbackId:j,liked:this.reactionId!==null,likeCount:this.reactionCount});},switchLogTarget:function(){if(a){this.el.setAttribute("data-l",this.reactionId===null?i:d);}else{var j=this.getReactScMenu();if(this.reactionId===null){this.el.setAttribute("data-l",i);}else{if(j&&j.visible()){this.el.setAttribute("data-l",h);}else{this.el.setAttribute("data-l",d);}}}},getReactScMenu:function(){var j=OK.hookModel.getHookById(this.reactScMenuId);return j&&j.getInstance();},addReactSMListeners:function(){var j=this.getReactScMenu();if(j){j.menuShownListener=this.switchLogTarget;j.tmpReactionsActiveInstanceListener=this.switchLogTarget;}},addLikesSMListeners:function(){var j=this.el.querySelector(".js-sleep-shm");if(j){this.likersOnCountShm=new g();this.likersOnCountShm.activate(j);this.likersOnCountShm.tmpReactionsActiveInstanceListener=this._activateSMListener.bind(this);}},_activateSMListener:function(){var j=this.getReactScMenu();if(j){j.tmpReactionsDisabled=this.likersOnCountShm.visible();if(!j.tmpReactionsDisabled){j.checkAfterTmpReactionsDisabled();}}},onClick:function(){var k;if(a){if(this.reactionId!==null){k=null;}else{k=0;}this.changeReaction(k);}else{var j=this.getReactScMenu();if(j&&j.visible()&&this.reactionId!==null){j.hideMenu();}else{if(this.reactionId!==null){k=null;}else{k=0;}this.changeReaction(k);}}},changeReaction:function(j,k,l){k=typeof k!=="undefined"?k:this.reactionId;var m={ll:this.logLocation};if(l&&l.payload){Object.assign(m,l.payload);delete l.payload;}return this._getImpressionId().then(function(n){if(n){m.impressionId=n;}}).then(function(){f.notify(Object.assign({refId:this.refId,reactionId:j,prevReactionId:k,owner:this.owner,payload:m},l));}.bind(this));},_getImpressionId:function(){var j=this.el;var k=j.closest(".js-video-scope");if(k){return Promise.resolve(k.getAttribute("data-impression-id"));}return new Promise(function(m,l){require(["OK/alf2"],m,l);}).then(function(l){return l.findAdv(j);}).then(function(l){return l.getImpressionId();},function(){return null;});}};return c;});