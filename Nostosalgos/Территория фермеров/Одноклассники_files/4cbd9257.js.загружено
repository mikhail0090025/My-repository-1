define("OK/feedback/Settings",["OK/utils/utils","OK/utils/dom"],function(i,e){function j(k){this.element=k;this.count=parseInt(k.getAttribute("data-count"),10);}function a(m,k){var l=m.count=k;var o=l===0;var n=e.firstByClass(m.element,"js-empty");n&&n.classList.toggle("invisible",!o);d.setGroupsIsEmpty(o);e.firstByClass(m.element,"sc-menu_h").classList.toggle("invisible",o);e.firstByClass(m.element,"feedback_settings_cnt").classList.toggle("invisible",o);}j.prototype.activate=function(){a(this,this.count);};j.prototype.add=function(m){var k=OK.util.nextId(),l=this;this.remove(m);i.ajax({url:"/dk?cmd=FeedbackGroup",data:{"st.b.gId":m,"st.b.cId":k}}).done(function(o){a(l,l.count+1);var n=e.firstByClass(l.element,"js-list");n.insertAdjacentHTML("afterBegin",o);OK.hookModel.captureBlockHook(OK.hookModel.getNearestBlockHookId(n),n.firstChild);});};j.prototype.remove=function(k){var l=document.getElementById("feedbackGroup"+k);if(l){e.remove(l);a(this,this.count-1);}};function c(l){var k=this;l.preventDefault();require(["OK/feedback/FeedbackLayerController"],function(m){var n=m.getNextUnreadTime();m.hideLabel();i.ajax({url:k.getAttribute("data-href"),data:{"st.f.let":n}}).done(function(p,o,q){m.reset(q);i.updateBlockModelCallback(p,o,q);});});}function f(k){this.element=k;this.parent=e.parent(this.element,"js-deleteAll");}f.prototype.activate=function(){this.element.addEventListener("click",c);d.setMenuIsEmpty(this.parent.classList.contains("invisible"));};f.prototype.deactivate=function(){this.element.removeEventListener("click",c);};f.prototype.show=function(){this.parent.classList.remove("invisible");d.setMenuIsEmpty(false);};f.prototype.hide=function(){this.parent.classList.add("invisible");d.setMenuIsEmpty(true);};function b(k){this.element=k;}b.prototype={setGroupsIsEmpty:function(k){this.groupsIsEmpty=k;this.toggleStub();},setMenuIsEmpty:function(k){this.menuIsEmpty=k;this.toggleStub();},toggleStub:function(){e.firstByClass(this.element,"js-empty").classList.toggle("invisible",!this.groupsIsEmpty||!this.menuIsEmpty);}};var d,g,h;return{activate:function(k){d=new b(k);},list:function(k){g=new j(k);g.activate();},showDeleteAllButton:function(){if(h){h.show();}},initDeleteButton:function(k){h=new f(k);h.activate();},addGroup:function(l){if(g){var k=l.getAttribute("data-gid");g.add(k);}},removeGroup:function(l){if(g){var k=l.getAttribute("data-gid");g.remove(k);}},getDeleteAllButton:function(){return h;}};});define("OK/HookModel",["OK/utils/utils"],function(a){var b={},c=a.deferred();return{init:function(d){c.resolve(d);},hookActivated:function(e){var d=b[e],g,f,h=new Promise(function(l,k){var j=OK.hookModel.getHookById(e);if(j){var i=j.getInstance?j.getInstance():undefined;l(i);return;}g=l;f=k;});if(g&&f){h.resolve=g;h.reject=f;if(!d||!d.length){d=[];b[e]=d;}d.push(h);}return h;},removeObserver:function(g,d){var f=b[d];if(f&&f.length){var e=f.indexOf(g);if(e!=-1){f.splice(e,1);}}},activatedCallback:function(e,d){var f=b[e];if(f){delete b[e];f.forEach(function(g){g.resolve(d);});}},extractHookId:function(d){return d.substring(d.lastIndexOf("_")+1);},createHook:function(e,d){return c.promise.then(function(f){f.createHook(e,d);});}};});define("OK/feedback/ListController",["OK/utils/utils","OK/utils/dom","jquery","OK/logger","OK/feedback/Settings","OK/HookModel"],function(j,d,e,m,c,b){var l=function(r,q,p,n){var o=this;this.layer=r;this.el=q;this.element=e(q);this.pageSize=n;this.loaded=e.Deferred();this.empty=true;this.scrollController=p;this.latest=undefined;this.element.on("click",".js-expand",f.bind(this)).on("click",".js-reply",function(s){o.toggleReply(i(s));s.preventDefault();s.stopPropagation();}).on("click",".comments_text_more",a.bind(this));};var g=85;l.prototype={getListContainer:function(){return d.firstByClass(this.el,"js-feedback-list");},load:function(n,r){var p=this,o=Math.max(5,r||Math.floor(window.innerHeight/g)),s={"st.f.ps":o},q=function(t){t.showProcess=setTimeout(p.layer.showProgress.bind(p.layer,t),500);};k(p,s,q).done(function(u,t,x){try{j.updateBlockModelCallback(x.responseText,t,x);m.success("feedbackLayer","load.empty",u.length===0);}catch(w){m.error("feedbackLayer","load.insert");}p.loaded.resolve();var v=x.getResponseHeader("Has-Unread")==="true";n.resolve(p.lastTime,p.empty,v);}).fail(function(t,v,u){p.layer.showError();m.error("feedbackLayer","load.fail");m.clob("error",JSON.stringify({textStatus:v,errorThrown:u}),"feedbackLayer","load.fail");});},isEmpty:function(){return this.empty;},update:function(p,o){var n=this;if(n.loaded.state()!=="resolved"||this.isEmpty()){this.load(p);}else{n.loaded.done(function(){var r=o.getCount();if(r>n.pageSize){n.load(p,n.pageSize);return p;}var q=n.getLatest();var s={"st.firstelem":n.marker,"st.fwd":"off","st.f.ps":n.pageSize,"st.f.lat":n.lastAccessTime||(isNaN(n.lastTime)?undefined:n.lastTime),"st.f.fio":q?q.options:undefined,fetch:true};k(n,s).done(function(y,x,G){var t=parseInt(G.getResponseHeader("Last-Time-Micros"),10);var z=G.getResponseHeader("Block-Empty")==="true";if(isNaN(t)){p.resolve(n.lastTime,z);m.clob("error",JSON.stringify({marker:n.marker,countToLoad:r,loaded:e(".notif",n.element).length}),"feedbackLayer","update.null");return;}try{var F=n.getListContainer();var C=e(F);var B=OK.hookModel.getNearestBlockHookId(F);var E=document.createElement("div");E.innerHTML=y;m.success("feedbackLayer","update.empty",y.length===0);var w=Array.prototype.slice.call(E.childNodes);for(var A=w.length-1;A>=0;A--){var v=w[A];var u=v.getAttribute("id");C.prepend(v);n.scrollController.scroll(v.clientHeight);b.createHook(B,v);}}catch(D){m.error("feedbackLayer","update.insert");m.clob("error",D.stack,"feedbackLayer","update.insert");throw D;}p.resolve(n.lastTime,z);}).fail(function(){m.error("feedbackLayer","update.fail");});});}return p;},getLatest:function(){var n=this.latest;while(n&&n.isHidden()){n=n.next;}return n;},markAllAsRead:function(){this.layer.controller.unreadItemsCount=0;e(".feedback_seen",this.element).remove();this.forEach(function(n){n.markAsRead();if(n.deleted){n.toggle(false);}});if(this.latest===undefined){this.empty=true;this.load(e.Deferred());}},getItemById:function(n){return e("[data-id="+n+"]",this.element);},toggleReply:function(o){var n=this,p=e(o);p.each(function(r,q){if(q.reply){q.reply=false;q.classList.remove("__reply");delete n.activeForm;}else{q.reply=true;if(!q.form){q.form=h(n,q);}q.form.done(function(s){if(n.activeForm){n.toggleReply(n.activeForm);}n.activeForm=o;q.classList.add("__reply");s.form.focus();});}});},addItem:function(n){if(this.latest===undefined){this.latest=n;}else{var o=this.latest;var p=n.compareTo(o)>0;if(p){n.next=o;this.latest=n;}else{while(o.next&&n.compareTo(o)<0){o=o.next;}o.next=n;}}},removeItem:function(n){if(n.prev){n.prev.next=n.next;n.next.prev=n.prev;}else{this.latest=n.next;if(n.next){n.next.prev=undefined;}}},forEach:function(n){var o=this.latest;while(o){if(!n.call(o,o)){return;}o=o.next;}},getItems:function(){var n=[];this.forEach(function(o){n.push(o);});return n;}};function k(u,q,s){var p={url:"/dk",data:e.extend({cmd:"FeedbackLayerContent"},q),beforeSend:s};var n=function(){m.success("feedbackLayer","load.redirect");};var v=e.Deferred(),r=j.ajax(p,n,7);r.always(u.layer.hideProgress.bind(u.layer));r.done(function t(z,D,C){var A=C.getResponseHeader("Last-Time-Micros");var x=C.getResponseHeader("Last-Access-Time-Micros");var w=C.getResponseHeader("Inconsistent")==="true";if(w){v.reject(C);return;}if(x){u.lastAccessTime=parseInt(x,10);}if(A){u.lastTime=parseInt(A,10);require(["OK/feedback/FeedbackLayerController"],function(E){E.markAsRead(u.lastTime);});}var B=u.empty=C.getResponseHeader("Block-Empty")==="true";if(!B){c.showDeleteAllButton();var y=C.getResponseHeader("firstelem");if(y){u.marker=y;}}clearTimeout(C.showProcess);u.layer.hideError();v.resolve(z,D,C);});r.fail(function(w){v.reject(w);});v.fail(function o(w){clearTimeout(w.showProcess);});return v;}function f(q){var p=this,o=e(q.target),n=o.closest(".notif").data("href");o.closest(".notif_w").each(function(t,s){if(s.expanded){s.expanded=false;s.classList.remove("__expanded");var r=q.target.getAttribute("data-scroll");if(r){p.scrollController.scrollTop(s.listScrollTop);delete s.listScrollTop;}}else{s.listScrollTop=p.scrollController.element.scrollTop;s.expanded=true;if(!s.loaded){s.loaded=true;j.ajax({url:n}).done(function(v,u,w){j.updateBlockModelCallback(v,u,w);s.classList.add("__expanded");}).fail(function(){s.loaded=false;o.removeClass("__active");});}else{s.classList.add("__expanded");}}});q.preventDefault();}function h(r,p){var n=e.Deferred(),o=e(".js-reply",p).data("href");var q=j.ajax({url:o}).done(function(t,s,u){j.updateBlockModelCallback(t,s,u);});require(["OK/feedback/FeedbackDiscussion"],function(s){q.done(function(){var t=l.prototype.toggleReply.bind(r,p);var v=p.getElementsByClassName("comment_status")[0];var u=new s(r.layer,e(".comment-form",p),v,t);u.init();n.resolve(u);});});return n;}function i(n){return e(n.target).closest(".notif");}function a(n){require(["OK/discussions/Reveal"],function(o){e(n.target).closest(".comments_current_cnt").each(function(){o.expand(this);});});}return l;});define("OK/feedback/FeedbackLayer",["jquery","OK/utils/utils","OK/utils/vanilla","OK/feedback/ListController","OK/NewsFetchCoordinator","OK/ToolbarGrowl","OK/discussions/ScrollController","OK/logger","OK/utils/dom"],function(e,g,f,j,c,h,b,k,d){function a(l){if(l!==OK.historyManager.getState()){OK.historyManager.pushState(l);}}function i(o,l){var m=this;this.controller=l;this.el=o;this.element=e(o);var p=document.getElementById("hook_Block_FeedbackLayerContent");var n=o.getElementsByClassName("notifs_lst")[0];this.scroller=new b({scrollingContainer:n,stickyContainer:e()});this.list=new j(this,p,this.scroller,this.element.attr("data-pagesize"),l);this.label=e(".js-newTip",this.element);this.initialized=e.Deferred();this.opened=false;this.inProgress=false;this.scrollTop=0;this.header=d.firstByClass(this.el,"toolbar-layer_h");this.banner=document.getElementById("hook_Block_FeedbackLayerBanner");this.bannerLoading=false;c.addBlock("FeedbackGrowl");this.element.on("click",".js-reload",function(){m.list.load(m.initialized);});}i.prototype={toggle:function(){this.opened?this.hide():this.open();},open:function(m){var q=e.Deferred();try{var l=this;this.opened=true;this.lastState=OK.historyManager.getState();var o=this.hide.bind(this,this);OK.loader.use("OKCustomJs",function(){OK.Layers.unregisterAll();OK.Layers.register("feedback",o);});a("/marks");this.element.removeClass("invisible");OK.loader.use("OKCustomJs",function(){OK.Layers.onLayerShown();});h.destroyByLayerId("feedback");q.done(function(){l.element.triggerHandler("show",m);});if(this.inProgress||this.isInitialized()){if(this.banner&&!this.bannerLoading){this.bannerLoading=true;this.loadBanner().then(function(){l.bannerLoading=false;},function(){l.bannerLoading=false;});}q.resolve();return q.promise();}this.inProgress=true;var n=e.Deferred().done(function(r,t,s){q.resolve();if(!t){l.initialized.resolve(r,t,s);}}).always(function(){l.inProgress=false;});this.list.load(n);this.initialized.done(function(r,t,s){l.toggleHeader(s);m&&m.resolve(r);});return q.promise();}catch(p){this.showError();k.error("feedbackLayer","open");k.clob("error",p.stack,"feedbackLayer","open");return q.reject().promise();}},loadBanner:function(){return f.ajax({url:"/dk?cmd=FeedbackLayerBanner"}).then(f.updateBlockModelCallback);},hide:function(){if(!this.opened){return;}this.opened=false;OK.loader.use("OKCustomJs",function(){OK.Layers.remove("feedback");OK.Layers.onLayerHidden();});a((this.lastState&&this.lastState.indexOf("/marks")===0)?"/":this.lastState);this.scrollTop=this.list.scrollController.element.scrollTop;this.element.addClass("invisible");this.element.triggerHandler("hide");this.list.markAllAsRead();this.toggleHeader(false);if(this.banner){OK.hookModel.setHookContent("FeedbackLayerBanner","");}},on:function(m,l){this.element.on(m,l);return this;},off:function(m,l){this.element.off(m,l);return this;},isOpened:function(){return this.opened;},isInitialized:function(){return this.initialized.state()==="resolved";},focusItem:function(n){var l=this;var m=this.list.getItemById(n);m.each(function(){l.scroller.scrollToCenter(this);e(".js-reply",this).each(l.list.toggleReply.bind(l.list,this));});},showProgress:function(){var l=this.el.getElementsByClassName("notifs_wrap");Array.prototype.slice.call(l).forEach(function(m){m.classList.add("__process");});},hideProgress:function(){var l=this.el.getElementsByClassName("notifs_wrap");Array.prototype.slice.call(l).forEach(function(m){m.classList.remove("__process");});},showError:function(){var l=document.getElementById("feedbackErrorStub");l&&l.classList.remove("invisible");},hideError:function(){var l=document.getElementById("feedbackErrorStub");l&&l.classList.add("invisible");},applyConf:function(l){e(".toolbar-layer",this.element).toggleClass("__unavailable",!l.enabled);},toggleHeader:function(l){this.header.classList.toggle("__has-unread",l===true);}};return i;});define("OK/feedback/FeedbackLayerController",["jquery","OK/feedback/FeedbackLayer","OK/logger","OK/utils/utils"],function(c,o,p,m){var g=function(q,r){this.element=q;this.onClick=r.bind(this);this.visible=false;};g.prototype={show:function(){if(this.visible){return;}this.visible=true;this.element.off("click.label").on("click.label",this.onClick);this.element.removeClass("__hidden").addClass("__active");},hide:function(q){q&&this.element.addClass("__hidden");this.element.removeClass("__active");this.element.off("click.label",this.onClick);this.visible=false;}};function n(q){this.createTime=q.counter.counterCreateTime.timeMicros;this.lastEventTime=q.counter.lastEventTime?parseInt(q.counter.lastEventTime.timeMicros,10):undefined;this.count=q.counter.count;this.next=undefined;}n.prototype={isLater:function(q){return this.createTime>q.createTime;},getCount:function(){return Math.max(this.count,this.next?this.next.getCount():0);},process:function(q,y){var x=this;if(!this.lastEventTime){y.resolve(q);return;}try{var t=parseInt(this.lastEventTime,10);if(this.count>0&&t>q){var s=f.list.scrollController,r=s.scrollToTop.bind(s,function(z){c(this.element).animate({scrollTop:this.element.scrollTop+z},700);}),w=function(A,z){v.hide(true);f.off("show",w);f.list.update(y,x).done(r);if(z){y.done(z.resolve.bind(z));}},v=new g(f.label,function(){var z=this;f.off("show",w);var A=f.list.update(y,x);A.done(z.hide.bind(z,true));A.done(r);});if(f.list.isEmpty()){if(f.isOpened()){f.list.update(y,x);}else{f.on("show",w);}}else{v.show();f.on("show",w);}}else{y.resolve(q);}}catch(u){y.resolve(q);p.error("feedbackLayer","processNotification");p.clob("error",u.stack,"feedbackLayer","processNotification");}}};function e(q){this.capacity=q;this.queue=[];}e.prototype={offer:function(s){if(s.length===0||this.size()===this.capacity){return;}var r=s.shift();try{var q=this.queue[this.size()-1];if(this.isEmpty()||(r.isLater(q)&&r.count!=q.count)){!this.isEmpty()&&(q.next=r);!i&&(i=r.lastEventTime);this.queue.push(r);}}catch(t){p.error("feedbackLayer","offer");p.clob("error",t.stack,"feedbackLayer","offer");}return this.offer(s);},size:function(){return this.queue.length;},isEmpty:function(){return this.size()===0;},poll:function(){return this.queue.shift();},peek:function(){return this.queue[0];}};var h=new e(100);var f;var k={autoScroll:false,devMode:false,isEnabled:true};var d;var j=0;var a=0;var i=undefined;var l=[];function b(r,t){var q=c.Deferred();try{if(r.isEmpty()){i=undefined;return q.resolve(t);}r.peek().process((t||0),q);}catch(s){p.error("feedbackLayer","processNotifications");p.clob("error",s.stack,"feedbackLayer","processNotifications");}return q.then(function(x,u,w,v){r.poll();a=x;f.toggleHeader(!u);return b(r,x);});}return{unreadItemsCount:0,reset:function(s){h.queue=[];var r=f.list.empty=s.getResponseHeader("Block-Empty")==="true";if(!r){var q=s.getResponseHeader("firstelem");if(q){f.list.marker=q;}}},activate:function(q){f=new o(q,this);if(q.getAttribute("data-opened")){this.open();}},setNewContent:function(s){try{var q=JSON.parse(s);var r=q.notifications;var v=q.conf;if(v){k=v;}if(k.devMode){console.log("Got notifications: ",r);console.log("Queue: ",h);console.log("Configuraton",k);}if(!r||r.length===0){return;}var u=h.isEmpty();h.offer(c.map(r,function(x){var w=new n(x);if(w.count===0){require(["OK/ToolbarGrowl"],function(y){try{y.destroyByLayerId("feedback");}catch(z){p.error("feedbackLayer","destroyByLayerId");p.clob("error",Function.prototype.toString(y),"feedbackLayer","destroyByLayerId");}});}else{if(f&&f.isInitialized()){return w;}}}));if(u){b(h);}if(f){f.applyConf(k);}}catch(t){p.error("feedbackLayer","setNewContent");p.clob("error",t.stack,"feedbackLayer","setNewContent");}},toggle:function(){if(f){f.toggle();}},open:function(s){if(f){var r=c.Deferred();r.done(function q(t){a=t;if(s){f.focusItem(s);}});f.open(r);}},hide:function(){if(f){f.hide();}},on:function(r,q){if(f){f.on(r,q);}return this;},off:function(r,q){if(f){f.off(r,q);}return this;},isOpened:function(){if(f){return f.isOpened();}return false;},bindButton:function(q){d=q;},markAsRead:function(q){a=q;j=0;m.ajax({url:"/web-api/feedback/mark/"+q}).done(function(){d.updateCounter(0);});},uncount:function(q){j+=q;d&&d.updateCounter(d.counter-j);},getUncountable:function(){return j;},getLastEventTime:function(){return a;},getNextUnreadTime:function(){return i;},hideLabel:function(){f&&f.label.addClass("__hidden").removeClass("__active");},addItem:function(q){this.unreadItemsCount+=q.isUnread?1:0;f.list.addItem(q.bind(f));},removeItem:function(q){this.unreadItemsCount-=q.isUnread?1:0;f.list.removeItem(q);},forEach:function(q){f.list.forEach(q);},getList:function(){return f.list;}};});define("OK/feedback/FeedbackButton",["require","jquery","OK/feedback/FeedbackLayerController","OK/NewsFetchCoordinator"],function(c){var f=c("jquery");var g=c("OK/feedback/FeedbackLayerController");var e=c("OK/NewsFetchCoordinator");function d(h,i){this.hookId=h;this.el=i;this.element=f(i);this.toggleOn=a.bind(this,this,true);this.toggleOff=a.bind(this,this,false);this.lastTime=parseInt(this.element.attr("data-time"),10);this.counter=parseInt(this.element.attr("data-counter"),10);}function a(h,i){h.element.toggleClass("toolbar_nav_a__feedback__active",i);}function b(h,i){var j=Math.max(i,0);f(".counterText",h.element).text(j>99?"99+":j);f(".toolbar_nav_notif, .new-marker",h.element).toggleClass("invisible",j===0);}d.prototype={activate:function(){b(this,this.counter-g.getUncountable());g.bindButton(this);var h=g.isOpened();a(this,h);g.on("show",this.toggleOn).on("hide",this.toggleOff);this.element.on("click",function(i){g.toggle();i.stopPropagation();});},deactivate:function(){this.element.off("click");g.off("show",this.toggleOn).off("hide",this.toggleOff);},updateCounter:function(h,i){i=i||Date.now()*1000;if(i>this.lastTime){this.lastTime=i;b(this,h);}},setNewContent:function(i){var h=f(i);if(parseInt(h.attr("data-time"),10)>this.lastTime){OK.hookModel.setHookContent("HeaderTopNewFeedbackInToolbarWrapper",i);}}};return d;});define("OK/feedback/FeedbackDiscussion",["jquery","OK/Discussion","OK/discussions/CommentForm","OK/discussions/LinkAttachController","OK/utils/utils"],function(f,g,e,d,c){var b=function(k,h,j,i){e.call(this,h,j,i);this.onCancelFn=k;this.linksController=new d(this.objectId,{isSmall:true});};b.prototype=Object.create(e.prototype);b.prototype.constructor=b;b.prototype.onCancel=function(h){this.deactivate(true);h.preventDefault();};b.prototype.focus=function(){e.prototype.focus.call(this);this.discussion.statusElement.classList.add("invisible");};b.prototype.deactivate=function(h){e.prototype.deactivate.call(this,h);this.onCancelFn();return this;};var a=function(j,i,k,l){var h=c.parseJson(document.getElementById(i.data("params")).innerHTML);g.call(this,i,i.data("id"),i.data("type"),0,h);this.layer=j;this.onCancel=l;this.statusElement=k;};a.prototype=Object.create(g.prototype);a.prototype.constructor=a;a.prototype.init=function(){var h=this;var i=h.form=new b(this.onCancel,h.elements.commentArea,h,f.extend({},h.elements,{collapsable:false}));i.init();i.changeState(e.states.cancelable);return h;};a.prototype.destroy=function(){this.form.destroy();this.elements.container.off();};a.prototype.post=function(k,i){this.statusElement.classList.remove("invisible");var h=this.statusElement.getAttribute("id");var j=h.substring(h.lastIndexOf("_")+1);OK.hookModel.setHookContent(j,i);this.updateCount(1);this.onCancel();return f.Deferred().resolve();};a.prototype.replyMode=function(){};a.prototype.editMode=function(h,i){};return a;});define("OK/discussions/Reveal",["OK/utils/dom"],function(a){return{expand:function(b){a.firstByClass(b,"comments_text").classList.remove("__reveal-2","__reveal-3");a.firstByClass(b,"comments_text_more").classList.add("invisible");},activate:function(e){var g=a.firstByClass(e,"comments_text");if(!g){return;}var b=parseInt(g.getAttribute("data-max-lines"),10);if(isNaN(b)){return;}var d=a.firstByClass(e,"comments_text_more"),f=parseInt(window.getComputedStyle(g)["line-height"],10)||21,c=g.firstChild.clientHeight/f;var h=c>b+1;if(h){d.classList.remove("invisible");}else{g.classList.remove("__reveal-2","__reveal-3");}}};});define("OK/feedback/FeedbackItem",["jquery","OK/discussions/Reveal","OK/utils/dom","OK/feedback/FeedbackLayerController","OK/utils/utils"],function(d,e,f,g,b){function a(j,h,i){this.id=j;this.type=h;this.isGroup=i;}a.fromElement=function(h){return new a(h.getAttribute("data-sid"),h.getAttribute("data-st"),h.getAttribute("data-sig")!==null);};a.prototype={equals:function(h){return this.id===h.id&&this.type===h.type&&this.isGroup===h.isGroup;}};function c(h,i){this.element=i;this.bound=b.deferred();this.options=parseInt(i.getAttribute("data-options"),10);this.isUnread=this.options?!(this.options&1===1):false;this.next=undefined;this.prev=undefined;}c.prototype={activate:function(h){e.activate(this.element);g.addItem(this);},deactivate:function(){f.remove(this.element);g.removeItem(this);},bind:function(h){this.bound.resolve(h);return this;},remove:function(h){this.deleted=true;d(h).offsetParent(".notif").addClass("__blur __deleted");},blur:function(i){var j=i.getElementsByClassName("notif_disabled_tx")[0];var h=f.parent(i,"notif");if(j.clientHeight>i.clientHeight){h.style.height=f.innerHeight(j);}h.classList.add("__blur");h.classList.remove("show-on-hover");},unblur:function(i){var h=f.parent(this.element,"notif");h.classList.remove("__blur");h.classList.add("show-on-hover");h.style.height="";this.element.classList.add("invisible");},toggle:function(h){this.element.parentNode.classList.toggle("invisible",this.hidden=!h);this.bound.promise.then(function(i){i.scroller.trigger();});return h;},isHidden:function(){return this.hidden;},markAsRead:function(){this.options=this.options|1;this.isUnread=false;},getSubject:function(){if(this.subject){return this.subject;}return this.subject=a.fromElement(this.element);},getGroupId:function(){if(this.groupId){return this.groupId;}return this.groupId=this.element.getAttribute("data-gid");},getLatestActorId:function(){if(this.actorId){return this.actorId;}return this.actorId=this.element.getAttribute("data-aid");},getTime:function(){if(this.time){return this.time;}return this.time=new Date(parseInt(this.element.getAttribute("data-time"),10)/1000);},compareTo:function(h){return(this.getTime()>h.getTime())-(this.getTime()<h.getTime());}};return c;});define("OK/feedback/TotalLink",[],function(c){var a={};var b=function(d,e){this.element=e;this.hookId=d;this.key=e.getAttribute("data-key");};b.prototype={activate:function(){var d=a[this.key];if(!d){d=a[this.key]=[];}for(var e=0;e<d.length;e++){OK.hookModel.setHookContent(d[e],this.element.innerHTML);}d.push(this.hookId);},deactivate:function(){a[this.key].splice(a[this.key].indexOf(this.hookId),1);},setNewContent:function(d){this.element.innerHTML=d;}};return b;});define("OK/feedback/FeedbackActions",["OK/utils/dom","OK/feedback/FeedbackLayerController"],function(d,e){function b(f,g){this.hookId=f;this.element=g;this.stack=[];this.notifElement=d.parent(this.element,"notif");this.wrapper=d.parent(this.notifElement,"notif_w");}function c(f){f.notifElement.classList.add("__blur");f.notifElement.classList.remove("show-on-hover");if(f.expanded){f.wrapper.classList.remove("__expanded");}}function a(g){var f=g.notifElement;f.classList.remove("__blur");f.classList.add("show-on-hover");if(g.expanded){g.wrapper.classList.add("__expanded");}}b.prototype={activate:function(){},deactivate:function(){},setNewContent:function(n,l,o){var q=this;function i(r){o();q.element.innerHTML=r;l();}var k=document.createElement("div");k.innerHTML=n;var g=OK.util.parseJSON(k.firstChild.innerHTML);var j=g.currentAction;var h=g.revert;if(this.stack.length===0){this.expanded=this.wrapper.classList.contains("__expanded");}if(h){if(this.stack.length>0){var p=this.stack.pop();i(p);if(this.stack.length===0){a(q);}}}else{this.stack.push(this.element.innerHTML);i(n);c(q);}var f,m;if(j==="UNSUBSCRIBE"){f=function(r){return r.getSubject().equals(g.subject);};}else{if(j==="TURN_OFF_GROUP"){f=function(r){return r.getGroupId()&&r.getGroupId()===g.groupId;};}else{if(j==="BLOCK"){f=function(r){return r.getLatestActorId()&&r.getLatestActorId()===g.latestActorId;};}}}e.forEach(function(r){if(r.element.contains(q.element)){if(j==="FORCE_DELETE"){r.toggle(false);return false;}else{r.deleted=q.stack.length>0;}}else{if(f&&f.call(this,r)){r.toggle(h);if(!h&&r.isUnread){m=(m||0)+1;}}}return true;});if(m&&m===e.unreadItemsCount){e.getList().markAllAsRead();}}};return b;});define("OK/feedback/RestoreLink",["OK/utils/dom","OK/utils/utils"],function(c,a){var b=function(f){var d=this.getAttribute("href")||this.getAttribute("data-href");a.ajax({url:d}).done(function(g,e,i){var h=parseInt(i.getResponseHeader("Last-Time-Micros"),10);a.updateBlockModelCallback(g,e,i);require(["OK/feedback/FeedbackLayerController"],function(j){j.markAsRead(h);});});f.preventDefault();};return{activate:function(d){d.addEventListener("click",b);},deactivate:function(d){d.removeEventListener("click",b);}};});define("b/feedback",["OK/feedback/FeedbackButton","OK/feedback/FeedbackDiscussion","OK/feedback/FeedbackLayer","OK/feedback/FeedbackLayerController","OK/feedback/FeedbackItem","OK/feedback/ListController","OK/feedback/Settings","OK/feedback/TotalLink","OK/feedback/FeedbackActions","OK/feedback/RestoreLink"],function(){});