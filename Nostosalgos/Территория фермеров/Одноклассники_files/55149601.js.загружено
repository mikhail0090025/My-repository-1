define(["OK/logger","OK/utils/vanilla","OK/utils/dom","OK/utils/delegate"],function(i,g,e,f){var b="ShortcutMenuReact";var h=null;var c=document.createElement("div");c.id="hook_Block_"+b;document.body.appendChild(c);OK.hookModel.captureBlockHook("body",c);c.addEventListener("change",function(){if(h&&h.visible()){h.positingElement();}});var a={};var d=function(j){this.hookId=j;this.stopClick=true;this.ajaxRequest=null;this.showTimeout=null;this.hideTimeout=null;this.menuElement=null;this.cacheable=true;this.loaded=false;this.showOnClick=true;this._hoverIn=false;};d.getActive=function(){return h;};d.setReactComponent=function(k,j){a[k]=j;};d.removeReactComponent=function(j){delete a[j];};d.getReactComponent=function(j){return a[j];};d.prototype={activate:function(k){this.element=k;this.holder=this.getHolder();this.blockId=this.element.getAttribute("data-blockid");this.block=document.getElementById("hook_Block_"+this.blockId);this.inplace=this.element.getAttribute("data-inplace");this.loaded=this.element.getAttribute("data-loaded");this.showDelay=parseInt(this.element.getAttribute("data-show"),10)||300;this.hideDelay=parseInt(this.element.getAttribute("data-hide"),10)||100;this.cacheable=!this.element.getAttribute("data-nocache");this.saveChanges=this.element.getAttribute("data-save-changes");this.direction=this.element.getAttribute("data-direction");this.position=this.element.getAttribute("data-position")||"center";this.showOnClick=this.element.getAttribute("data-onClick");this.isShowImmediately=this.element.getAttribute("data-showImmediately");this.showImmediatelySelector=this.element.getAttribute("data-showImmediatelySelector");this.relatedMenu=this.getRelatedMenu();this.hideOnClick=this.element.getAttribute("data-hideOnClick");this.hideOnScroll=this.element.getAttribute("data-hideOnScroll");this.ignoreDoubleHoverIn=this.element.getAttribute("data-ignore-double-hover-in");if(!this.holder){i.error("asm","noholder");i.success("asm","noholder",this.buildParamFingerprint());return;}this.handlers={};this.boundAjaxFail=this.ajaxFail.bind(this);this.boundAjaxDone=this.ajaxDone.bind(this);this.holderDelegate=new f(this.holder);if(OK.device.isTouch){this.holderDelegate.on("touchstart",this.holderTouchStartListener);var j=this.holder.getElementsByTagName("a")[0];if(!j){j=e.traverseParents(this.holder,function(l){return l.tagName.toUpperCase()==="A";},document.body,true);}if(j){this.linkDelegate=new f(j);this.linkDelegate.on("touchstart",this.touchHandle.bind(this),true);}}this.holderDelegate.on("mouseleave",this.hoverOutListener.bind(this));if(this.showOnClick){this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.showMenu);}else{this.holderDelegate.on("mouseenter",this.hoverInListener.bind(this));if(this.hideOnClick){this.holderDelegate.on("click",this.hoverOutListener.bind(this));}}if(this.inplace&&this.loaded){this.initListeners(this.getBlock());}if(this.isShowImmediately){this.showImmediately();}},deactivate:function(){if(!this.holder){return;}this.ajaxClose();this.hide();this.removeOneTimeListener(this.oneClickListener);this.removeOneTimeListener(this.oneScrollListener);this.removeOneTimeListener(this.oneBodyTouchListener);this.removeOneTimeListener(this.oneImmediatelyHandler);this.holderDelegate.destroy();if(this.linkDelegate){this.linkDelegate.destroy();}if(this.shortcutMenuDelegate){this.shortcutMenuDelegate.destroy();}this.tmpReactionsActiveInstanceListener=null;},buildParamFingerprint:function(){var k=[this.inplace,this.loaded,this.cacheable,this.showOnClick,this.hideOnClick,this.hideOnScroll];var j="";k.forEach(function(l){j+=(!!l*1).toString();});return j;},hoverInListener:function(j){if((this.ignoreDoubleHoverIn&&this._hoverIn)||(OK.device.isTouch&&j)){return;}this._hoverIn=true;this.clearHideTimeout();if(!this.showTimeout&&!this.visible()){this.showTimeout=setTimeout(this.showMenu.bind(this),this.showDelay);}},checkAfterTmpReactionsDisabled:function(){if(this._hoverIn){this._hoverIn=false;this.hoverInListener();}},hoverOutListener:function(){this._hoverIn=false;this.clearShowTimeout();this.ajaxClose();if(!this.hideTimeout&&(h===this)){this.hideTimeout=setTimeout(this.hideMenu.bind(this),this.hideDelay);}},menuElementHoverInListener:function(){this.menuElementHoverInListenerCalled=true;if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}},menuElementLinkClickListener:function(j){if(!e.parent(j.target,"js-doNotHide",this.block)){this.menuElementClickListener();}},menuElementClickListener:function(){if(true===this.hideTimeout){this.hideTimeout=null;}this.hoverOutListener();},holderTouchStartListener:function(j){j.stopPropagation();},hide:function(){this.clearShowTimeout();this.clearHideTimeout();if(this.menuElement){this.hideMenu();}},getHolder:function(){var j=this.element.getAttribute("data-holder");return j?document.getElementById(j):this.element.previousElementSibling;},getRelatedMenu:function(){var j=this.element.getAttribute("data-related"),k;if(j){k=OK.hookModel.getHookById(j);return k.getInstance?k.getInstance():null;}return null;},getBlock:function(){if(this.inplace){return this.block;}return c;},getHtml:function(){if(!this.block){return"";}var j=this.block.innerHTML;if(!this.inplace||!this.cacheable){OK.hookModel.setHookContent(this.blockId,"");if(this.cacheable){this.block.innerHTML=j;}}return j;},initBlock:function(){if(this.element&&!this.block){var l=Array.prototype.slice.call(this.element.children);var m=null;for(var j=0;j<l.length;j++){if(l[j].classList.contains("posR")){m=l[j];break;}}if(!m){var k=document.createElement("div");k.id="hook_Block_"+this.blockId;k.className="posR";this.element.appendChild(k);this.block=k;OK.hookModel.captureBlockHook(this.hookId,k);}else{this.block=m;}}},initListeners:function(j){this.shortcutMenuDelegate=new f(j);this.shortcutMenuDelegate.on("click",".sc-menu a",this.menuElementLinkClickListener.bind(this));this.shortcutMenuDelegate.on("click",".sc-menu .js-hide",this.menuElementClickListener.bind(this));this.shortcutMenuDelegate.on("click",".js-forceHide",this.hideMenu.bind(this));this.shortcutMenuDelegate.on("mouseenter",this.menuElementHoverInListener.bind(this));this.shortcutMenuDelegate.on("mouseleave",this.hoverOutListener.bind(this));if(OK.device.isTouch){this.shortcutMenuDelegate.on("touchstart",this.holderTouchStartListener.bind(this));}},showMenu:function(){clearTimeout(this.hideTimeout);this.showTimeout=null;if(this.tmpReactionsDisabled){return;}if(this.relatedMenu&&this.relatedMenu.hide){this.relatedMenu.hide();}if(h){if(this.visible()){return;}h.hide();}if(this.showOnClick){this.removeOneTimeListener(this.oneClickListener);this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.hideMenu);}if(this.hideOnScroll){var j=/(auto|scroll)/;var m=e.traverseParents(this.element,function(n){var o=window.getComputedStyle(n);return(j.test(o.overflow+o.overflowY+o.overflowX))&&(n.scrollHeight>n.clientHeight);});m=m||window;this.oneScrollListener=this.addOneTimeListener(m,"scroll",this.hoverOutListener);}this.showTimeout=null;if(OK.device.isTouch){this.oneBodyTouchListener=this.addOneTimeListener(document.body,"touchstart",this.hoverOutListener);}if(this.ajaxRequest){return;}this.startTime=Date.now();if(this.loaded){var l=this.getHtml();this.processHTML(l,undefined,!this.inplace||!this.cacheable);i.success("asm","show","cache");}else{var k=this.element.getAttribute("data-url");this.ajaxRequest=g.ajax({url:k,dataType:"html"},function(){});this.ajaxRequest.then(this.boundAjaxDone,this.boundAjaxFail);}},showImmediately:function(){var j=this;if(j.showImmediatelySelector){setTimeout(function(){var k=j.showImmediatelySelector+":hover";j.showImmediatelyElement=e.traverseParents(j.holder,function(l){return l.matches(k);});if(j.showImmediatelyElement.matches(k)){j.showMenu();j.oneImmediatelyHandler=this.addOneTimeListener(j.showImmediatelyElement,"mouseleave",function(){setTimeout(function(){if(!j.menuElementHoverInListenerCalled){j.hideMenu();}},j.hideDelay);});}},1);}},visible:function(){return h===this;},hideMenu:function(){this.clearShowTimeout();if(!this.visible()&&!this.showOnClick){return;}this.hideTimeout=null;this.stopClick=true;if(this.showOnClick){this.removeOneTimeListener(this.oneClickListener);this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.showMenu);}this.ajaxClose(function(){i.success("asm","ajax","to");});if(this.menuElement){this.menuElement.classList.add("sc-menu__hidden");this.getHtml();if(this.saveChanges&&!this.inplace&&this.loaded&&this.cacheable){this.initBlock();this.block.innerHTML=c.innerHTML;}OK.hookModel.setHookContent(b,"");this.menuElement=null;}this.holder.classList.remove("__vis");if(this.shortcutMenuDelegate&&!this.cacheable){this.shortcutMenuDelegate.off();}h=null;this.tmpReactionsActiveInstanceListener&&this.tmpReactionsActiveInstanceListener();},touchHandle:function(j){if(this.stopClick){j.preventDefault();j.stopPropagation();this.stopClick=false;if(!this.showOnClick){this.hoverInListener();}return false;}else{this.hoverOutListener();}},getOffset:function(j){var k=j.getBoundingClientRect();return{left:k.left+window.pageXOffset,top:k.top+window.pageYOffset};},positingElement:function(){var q=e.outerSize(this.holder,false,true);var l=this.inplace?{top:0,left:0}:this.getOffset(this.holder);var t=e.outerSize(this.holder,true,true);var k=e.outerSize(this.menuElement,true,true);if(this.position!=="center"&&this.position!=="auto"){this.menuElement.classList.add("__noarrow");}var r;var o=e.outerSize(this.menuElement,false,true);if(this.direction==="top"){r=this.getOffset(this.holder).top-window.pageYOffset-90>o;}else{if(this.direction==="bottom"){r=false;}else{r=window.innerHeight-q-this.holder.getBoundingClientRect().top<o;}}var s=l.top;var m=[];if(r){this.menuElement.classList.add("sc-menu__top");var j;if(this.inplace){j=s+q;m.push("top: auto; bottom: "+Math.round(j)+"px;");}else{s-=o;m.push("bottom: auto; top: "+Math.round(s)+"px;");}}else{this.menuElement.classList.remove("sc-menu__top");if(!this.inplace){s+=q;}m.push("bottom: auto; top: "+Math.round(s)+"px;");}var p=Math.round(l.left-(k-t));var u=Math.round(l.left);var n=Math.round(l.left+((t-k)/2));switch(this.position){case"left":m.push("left: "+p+"px;");break;case"right":m.push("left: "+u+"px;");break;case"auto":if((window.innerWidth-OK.scrollBar.width)>(l.left+k)){m.push("left: "+u+"px;");this.menuElement.classList.remove("__right");this.menuElement.classList.add("__left");}else{m.push("left: "+p+"px;");this.menuElement.classList.add("__right");this.menuElement.classList.remove("__left");}break;default:m.push("left: "+n+"px;");break;}this.menuElement.setAttribute("style",m.join(""));},processHTML:function(m,n,k){var l=[];if(n&&n.getResponseHeader(OK.navigation.HEADER)){l=n.getResponseHeader(OK.navigation.HEADER).split(",");}var j;if(this.inplace){this.initBlock();l[0]=this.blockId;j=this.block;}else{l[0]=b;j=c;}if(k){g.updateBlocks(m,l);this.initListeners(this.getBlock());}this.menuElement=e.firstByClass(j,"sc-menu");this.positingElement();this.menuElement.classList.remove("sc-menu__hidden");this.holder.classList.add("__vis");h=this;this.tmpReactionsActiveInstanceListener&&this.tmpReactionsActiveInstanceListener();},ajaxDone:function(j){i.duration("asm",Date.now()-this.startTime,"ajax");var k=j.response;if(!k||(k.split(OK.navigation.SPLITER)[0]).length===0){i.success("asm","ajax","e");return;}i.success("asm","show","ajax");if(this.cacheable&&this.element){this.loaded=true;this.initBlock();this.block.innerHTML=k.split(OK.navigation.SPLITER)[0];}this.processHTML(k,j.xhr,true);this.menuShownListener&&this.menuShownListener();this.ajaxClose();},ajaxFail:function(){this.ajaxClose(function(){i.error("asm","ajax");});},ajaxClose:function(j){if(this.ajaxRequest){this.ajaxRequest.xhr.abort();this.ajaxRequest=null;if(typeof j==="function"){j();}}},clearShowTimeout:function(){if(this.showTimeout){this.showTimeout=clearTimeout(this.showTimeout);}},clearHideTimeout:function(){if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}},addOneTimeListener:function(j,l,k){var n=this;var m=function m(o){j.removeEventListener(o.type,m);k.call(n,o);};j.addEventListener(l,m);return{element:j,type:l,handler:m};},removeOneTimeListener:function(j){if(j){j.element.removeEventListener(j.type,j.handler);j=null;}}};return d;});