define("OK/notifications/LayerController",["OK/utils/utils","OK/logger","OK/ToolbarGrowl","OK/ToolbarBubble"],function(I,q,f,D){var k="layer_notifications",l=null,j=D.wrap("counter_Notifications"),v=u("ntf_toolbar_button"),g="toolbar_nav_a__notif__active",t=false,o="/",A=0,b=1,J=false,G=false;return{show:function(L){L=L||{};if(G){return;}m();n();var K=u("hook_Block_NotificationsLayer");if(K.innerHTML){OK.loader.use(["OKCustomJs"],x);}else{OK.loader.use(["OKCustomJs"],B);v.classList.add(g);w(z());G=true;I.ajax({url:v.getAttribute("data-link"),data:{"st.ntf.cat":L.category||l||"All","st.ntf.reset":(A>0?"off":"on"),"st.ntf.page":b}}).fail(function(){v.classList.add(g);G=false;q.error("ll","ntf");e(z());H();}).done(function(N,M,O){G=false;n();f.destroyByLayerId(k);I.updateBlockModelCallback(N,M,O);OK.loader.use(["OKCustomJs"],x.bind(window,L.callback));});}},hide:E,reset:C,showContent:function(M,L){m();F().classList.remove("__process");if(M){l=M;J=false;if(L){var K=u("ntf_layer_menu_link_"+M);if(K){d(K.getAttribute("href"));}}}},toggleContent:function(){var K=F();if(K.getElementsByClassName("notif").length){w(s());e(i());}else{e(s());w(i());}},showLoader:function(){h(0);F().classList.add("__process");},category:function(){return t?l:null;},shouldCheckNews:function(){J=true;}};function m(){var K=u("ntf_layer_close");if(!t&&K){K.addEventListener("click",E);t=true;}}function c(){if(t){var K=u("ntf_layer_close");if(K){K.removeEventListener("click",E);}t=false;}}function x(K){m();OK.Layers.register(k,E);e(z());v.classList.add(g);o=OK.historyManager.getState();w(r());h(A);j.hide();if(K){K();}}function E(){if(t){p();y();d((o&&o.indexOf("/notifications")===0)?"/":o);n();H();c();var K=a();if(J||K){J=false;if(K){C();}I.ajax({url:"/dk?cmd=NotificationsController&st.checkNews=on"}).done(function(M,L,N){I.updateBlockModelCallback(M,L,N);});}}}function H(){e(r());v.classList.remove(g);OK.hookModel.setHookContent("NotificationsLayer","");if(OK.Layers&&OK.Layers.remove){OK.Layers.remove(k);OK.Layers.onLayerHidden();}}function n(){f.destroyByLayerId(k);}function a(){var K=u("ntf_layer_left_menu");return K&&K.getAttribute("data-unread")!==null;}function C(K){l=K||"All";A=0;b=1;}function B(){OK.Layers.unregisterAll();OK.Layers.onLayerShown();}function d(K){if(K!==OK.historyManager.getState()){OK.historyManager.pushState(K);}}function y(){var K=u("ntf_layer_content_inner");if(K){var M=K.parentNode;if(M&&M.getAttribute){var L=K.parentNode.getAttribute("data-page");b=parseInt(L,10)||b;}}}function e(K){if(K){K.classList.add("invisible");}}function w(K){if(K){K.classList.remove("invisible");}}function h(K){var L=s();if(L){L.scrollTop=K;}}function p(){var K=s();if(K){A=K.scrollTop;}}function i(){return u("ntf_layer_content_stub");}function F(){return u("hook_Block_NotificationsLayerContent");}function s(){return u("ntf_layer_content_scroll");}function r(){return u("ntf_layer");}function z(){return u("ntf_toolbar_layer_loader");}function u(K){return document.getElementById(K);}});define("OK/notifications/ActionsController",["OK/logger","OK/ToolbarGrowl","OK/ToolbarBubble"],function(m,j,d){var i="layer_notifications",f,h=d.wrap("counter_Notifications"),c={confirm:function(q){if(q.json.massOperationRemoved){l();}if(!f.category()&&q.html){f.reset(q.json.category);f.show({callback:function(){var u,s,r,t;s=document.createElement("div");s.innerHTML=q.html;u=document.getElementById("ntf_layer_content_inner");while(!s.id){s=s.firstChild;}r=s.id.replace("hook_Block_","");t=OK.hookModel.getHookById(r);if(t){OK.hookModel.setHookContent(r,s.innerHTML);g(t.element);}else{s=u.insertBefore(s,u.firstChild);OK.hookModel.captureBlockHook("NotificationsLayerContent",s);f.toggleContent();}if(q.json.redirectAfterNtfLayerLoaded){q.performRedirect();}}});}else{a(q.json.nid,q.html,false,q.json.counter);if(q.json.redirectAfterNtfLayerLoaded){q.performRedirect();}}if(!q.json.redirectAfterNtfLayerLoaded){q.performRedirect();}},news:function(t){var r=f.category(),s=t.json.totalUnread,u=t.json.removed,q=t.json.closed;o(u);p(q);if(r){if(s){f.shouldCheckNews();m.success("ntf","push.open",s);}}else{h.update(s);if(s>0){f.reset();}if(s===0){j.destroyByLayerId(i);}}}};return{init:function(q){f=q;n();},handle:function(q){if(q.action&&c[q.action]){c[q.action](q);}b(q.json.totalUnread);}};function g(q){var s=document.getElementById("ntf_layer_content_scroll"),r=q.offsetTop-20;if(r>0){s.scrollTop=r;q.firstChild.classList.add("__anim-highlight");}}function b(q){if(q!==undefined&&!f.category()){h.update(q);}}function p(q){var s=j.getByLayerId(i),r;if(s&&q&&q.length){for(r=0;r<q.length;r++){if(s.id===q[r]){s.destroy(true);break;}}}}function o(r){if(r){for(var q=0;q<r.length;q++){a(r[q],null,true,true);}}}function a(q,v,w,s){var r=document.getElementById("ne-"+q),z,x,y,u;if(!r){return;}z=OK.hookModel.getNearestBlockHookId(r);x=OK.hookModel.getHookById(z);if(x){y=x.element;if(w&&y.getAttribute("data-locked")==="true"){return;}if(!f.category()){var t=j.getByLayerId(i);if(t&&q===t.id){t.destroy(true);}}else{if(v){OK.hookModel.setHookContent(z,v);}else{OK.hookModel.setHookContent(z,"");u=y.parentNode;if(u){u.removeChild(y);}f.toggleContent();setTimeout(e,500);}if(s){k(r.getAttribute("data-category"));}}}}function l(){var r=document.getElementById("ntf_mass_operation"),q;if(r){q=r.parentNode;if(q){q.removeChild(r);}}}function n(){OK.util.extend(OK.ntf,{close:function(q){a(q,null,false,false);},lock:function(s){var r=OK.hookModel.getHookById("Ntf_"+s);if(r){var q=r.element;q.setAttribute("data-locked","true");}}});}function e(){var q,r=document.getElementById("ntf_layer_content_inner");if(document.createEvent){q=document.createEvent("Event");q.initEvent("scroll",true,true);r.dispatchEvent(q);}else{if(document.createEventObject){q=document.createEventObject();r.fireEvent("onscroll",q);}}}function k(s){var q=document.getElementById("ntf_counter_"+s);if(q){var r=parseInt(q.innerHTML,10)||0;if(r>0){var t=r-1;q.classList.toggle("__empty",t===0);q.innerHTML=t;}}}});define("OK/notifications/ContentData",[],function(){function a(c){if(c){var b=c.split("&&&%%%");this.json=OK.util.parseJSON(b[0]);this.action=this.json.action;if(b.length===2){this.html=b[1];}}}a.prototype={performRedirect:function(){if(this.json.redirect){var b=decodeURIComponent(this.json.redirect).replace(/&amp;/g,"&");if(b.indexOf("http://")===0||b.indexOf("https://")===0){window.open(b,"_blank");}else{navigateOnUrlFromJS(b);}}}};return a;});define("OK/Notifications",["require","OK/notifications/LayerController","OK/notifications/ActionsController","OK/notifications/ContentData","OK/NewsFetchCoordinator","OK/logger"],function(b){var f="ntf",h=b("OK/notifications/LayerController"),e=b("OK/notifications/ActionsController"),d=b("OK/notifications/ContentData"),c=b("OK/NewsFetchCoordinator"),a=b("OK/logger");function g(i){i.stopPropagation();if(h.category()){h.hide();}else{h.show();}}return{LayerController:h,activate:function(i){if(document.getElementById("ntf_layer")){a.success(f,"short-link");h.show();}i.parentNode.addEventListener("click",g);e.init(h);c.addBlock("NTF");},setNewContent:function(i){try{e.handle(new d(i));}catch(j){a.clob(f,i+"\n"+j.stack,"fail","actions");}},showContent:function(i){setTimeout(function(){h.showContent(i.getAttribute("data-category"),i.getAttribute("data-history")==="on");});}};});