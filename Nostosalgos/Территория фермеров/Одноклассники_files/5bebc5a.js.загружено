define(["OK/EventFactory","OK/PopLayerPhoto","OK/AbstractShortcutMenu","OK/ShortcutMenuReact","OK/utils/utils","OK/LogSeen","OK/utils/debounce"],function(C,w,e,s,z,D,d){var m;function t(E){m=m||C.create();m.trigger(E);}function c(){m=m||C.create();return m;}function A(G){OK.photoLayer.isLogTimeDiff=G.getAttribute("data-log-time-diff")!=="false";OK.photoLayer.loaderEnabled=G.getAttribute("data-loader-enabled")!=="false";OK.photoLayer.commentsDelta=parseInt(G.getAttribute("data-comments-delta"),10);OK.photoLayer.minHeight=parseInt(G.getAttribute("data-min-height"),10);OK.photoLayer.hideElements=G.getAttribute("data-hide-elements")!=="false";OK.photoLayer.isLogPrematureClose=G.getAttribute("data-log-premature-close")!=="false";OK.loader.use("OKPhotoLayer",function(){OK.photoLayer.onPhotoShown(false,t);});var E=G.getAttribute("data-photo-id");var H=G.getAttribute("data-seen-params");if(H){var F=JSON.parse(H);D.logSuccess(F.type,JSON.stringify(F.data));}else{if(E){D.logSuccess("PHOTO",JSON.stringify({photoId:E}));}}}function a(){OK.photoLayer.toggleFullScreenButton();}function x(F){var J=F.getAttribute("data-params");if(J){try{J=JSON.parse(J);J["st.layer.cmd"]="PopLayerPhotoOuter";J.cmd="PopLayerPhoto";J["st.layer.showNav"]="on";J["st.layer.limitedUi"]="on";J["st.layer.revNav"]="off";var E=J["st.layer.reqAttempt"]||1;var G=J["st.layer.reqDelay"]||500;var H=E>1?parseInt(G):1;setTimeout(function(){z.ajax({url:"/dk",data:J}).done(function(L,K,M){z.updateBlockModelCallback(L,K,M);});},H);}catch(I){}}}function r(E){return E.querySelector(".plc")!==null;}function j(){var E=document.getElementById("photoLayerLog");return E&&E.getAttribute("data-layer-log-type");}function k(F){F=F||document.getElementById("photoLayerWrapper");var E=F.querySelector(".photo-layer_photo");F.setAttribute("data-l",JSON.stringify({target:"photoLayer",windowWidth:window.innerWidth,windowHeight:window.innerHeight,withRightColumn:r(F),layerWidth:E&&E.clientWidth,layerHeight:E&&E.clientHeight,layerType:j()}));}function v(){OK.loader.use("OKPhotoLayer",function(){OK.photoLayer.footerRendered();});}function l(G){var H=document.getElementById("photoLayerWrapper"),J=G.getAttribute("data-add"),F=G.getAttribute("data-remove");requestAnimationFrame(function(){var L=j();var K="DAILY_PHOTO";var M="__v2";var N="__daily-photo";if(L===K){H.classList.add("__ready");}H.classList.toggle(M,(r(H)&&L!==K));H.classList.toggle(N,L===K);k(H);i();y();});if(H&&J){H.classList.add(J);}if(H&&F){H.classList.remove(F);}var E=H.querySelector(".photo-layer_cnt_main");if(E){var I=function(){H.classList.toggle("__opened-sm",!!e.getActiveInstance()||!!s.getActive());};E.addEventListener("mouseenter",I);E.addEventListener("mouseleave",I);}}function f(E){var F=document.getElementById(E);if(F){F.click();}}function q(){f("plsp_next");}function o(){f("plsp_prev");}function B(){var E=document.getElementById("plsp_next"),H=document.getElementById("plsp_prev"),G=document.getElementById("plp_photoLink"),F;F=function(K){var J=K.currentTarget.getAttribute("data-fh");if(J){w.handleOnNavigate(J);var I=document.getElementById("scrollToTopPhotoLayer");if(I){I.dispatchEvent(new CustomEvent("hideScrollElement"));}K.preventDefault();}};E.addEventListener("click",F,false);H.addEventListener("click",F,false);G.addEventListener("click",q,false);}function b(E){if(E.keyCode===39){q();E.preventDefault();}else{if(E.keyCode===37){o();E.preventDefault();}}}function u(){if(!OK.photoLayer.isShown()){OK.photoLayer.open();}z.ajax({url:this.getAttribute("data-url")}).done(z.updateBlockModelCallback);}function p(E){E.addEventListener("click",u);}function n(E){E.removeEventListener("click",u);}function g(E){var F,H,I;if(E){H=E.getAttribute("data-expand-text")||"• • •";I=E.getAttribute("data-collapse-text")||"• • •";if(E.scrollHeight>E.offsetHeight){F=document.createElement("a");F.className="lstp";F.textContent=H;F.addEventListener("click",G);if(E.nextSibling){E.parentNode.insertBefore(F,E.nextSibling);}else{E.parentNode.appendChild(F);}}}function G(){E.classList.toggle("__expanded");if(E.classList.contains("__expanded")){E.style.maxHeight=E.scrollHeight+"px";F.textContent=I;}else{E.style.maxHeight="";F.textContent=H;}}}function i(){g(document.querySelector(".photo-layer_descr_tx"));}function y(){g(document.querySelector(".plc-people-pins_body"));}function h(E){if(E.requestFullscreen||E.webkitRequestFullscreen||E.mozRequestFullScreen){E.classList.remove("invisible");}}return{getPhotoShownEvent:c,prepareLayer:A,toggleFullScreenButton:a,updateWrapper:l,loadNavigation:x,footerRendered:v,activateNavigation:B,next:q,prev:o,keyboardHandler:b,activateOpenCrop:p,deactivateOpenCrop:n,activateFullScreenButton:h};});