define(["OK/utils/dom","OK/utils/vanilla","OK/logger","OK/cookie"],function(u,q,w,v){var e=20000,h=30000,j=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,r,m,l,c,n,t,b;function i(B,A){var x=Array.prototype.slice.call(arguments),y=["right-column-v2"];y.push.apply(y,x);w.success.apply(w,y);try{if(v.readCookie("dme")==="true"||OK.fn.isDebug()){console.info.apply(console,y);}}catch(z){}}var a=5000;var f=function(){var x=new Promise(function(A,z){var y=setTimeout(function(){z("timeout");},a);require(["OK/banners/moneySave","mrg-smokescreen/Welter"],function(C,B){t=C;b=B;clearTimeout(y);A();},function(){clearTimeout(y);z("error");});});f=function(){return x;};return x;};function o(){var A=document.getElementById("fourthColumnWrapper");if(!A){return;}var B=document.getElementById("hook_Block_FrOln4thCol"),E=false,z;if(!B){B=document.getElementById(t.transformNow("hook_Block_FrOln4thCol"));E=!!B;}if(!B){return;}var D=u.firstByClass(B,"fo4c_h");if(!D){return;}var C=Array.prototype.slice.call(B.querySelectorAll('.fo4c_h > [id^="hook_Block"]')),y=[];C.forEach(function(F){D.removeChild(F);switch(F.id){case"hook_Block_GiftOfTheDayOrBanner":case"hook_Block_ForthColumnTopBanner":z=F=document.createElement("div");z.id="RightColumnBannerInner";break;}y.push(F);});t.obfuscateNow(B,[".gifts-widget-w",".fr-motivator-portlet"],E);var x=t.transformNow("fo4c_h");y.forEach(function(F){D.appendChild(F);});b.wrap(B,"."+x+' > [id^="hook_Block"]');if(!z){return;}t.obfuscateNow(z);return t.attachTopRightBanner(A,z).then(function(){z.setAttribute("class",t.transformNow("banner_new__loaded"));var G=u.firstByClass(document,"friendsOnlineHook");var F=G?G.nativeHookImpl:null;if(F){F.doReflow();}return B;});}function p(){clearTimeout(n);}function d(x,y){this.message=x;this.param=y||"";}function k(x){q.updateBlockModelCallback(x);i("show-0");return f().then(function(){i("moneysaveLoad-done");},function(y){throw new d("moneysaveLoad-error",y);}).then(function(){return t.ready();}).then(function(){return t.detectAdBlock();}).then(function(y){if(!y){throw new d("moneysaveReady-noAdblock");}else{i("moneysaveReady-adblock");}return x;},function(y){if(y instanceof d){throw y;}else{throw new d("moneysaveReady-error",y&&y.message);}}).then(function(y){if(OK.getCurrentDesktopModelId()!==m){return s(1);}else{return y;}}).then(function(y){q.updateBlockModelCallback(y);i("show-1");var A=document.getElementById("fourthColumnWrapper");b.wrap(A,'#hook_Block_FourthCol > [id^="hook_Block"]');var z=document.getElementById("hook_Block_FrOln4thCol");i("obfuscate-start");return o();}).then(function(y){if(!j||!y){return;}r=new j(function(z){z.forEach(function(A){var B=A.attributeName;if(A.type==="childList"&&A.addedNodes.length>0){o();}});});r.observe(y,{childList:true});}).then(function(){i("obfuscate-done");p();},function(y){if(y instanceof d){i(y.message,y.param);p();}else{i("error",y.message);}});}function g(){if(!OK.getCurrentDesktopModelId||!OK.getCurrentDesktopModelId()||!OK.gwtModuleFullyFinished){l=setTimeout(g,50);}else{s(0).then(k);}}function s(y){clearTimeout(c);i("request-"+y+"-start");var x=OK.getCurrentStateLink();m=OK.getCurrentDesktopModelId();x+=(x.indexOf("?")===-1?"?":"&")+"cmd=FourthCol";return q.ajax({url:x}).then(function(z){i("request-"+y+"-done");return z;},function(z){i("request-"+y+"-error");throw z;});}return{activate:function(x){i("activate");c=setTimeout(function(){i("block-model-fail");},e);n=setTimeout(function(){i("timeout");},h);g();},deactivate:function(x){i("deactivate");if(r){r.disconnect();r=null;}if(l){clearTimeout(l);}}};});