define(["OK/capture","OK/logger","OK/NewsFetchCoordinator","OK/utils/utils","OK/utils/dom"],function(m,l,d,k,e){function b(n,p){var o=n.getBoundingClientRect();return o.top>(window.innerHeight-p)&&o.left>0&&o.top<window.innerHeight&&o.right<window.innerWidth;}function i(r,o){var s=r.getBoundingClientRect(),n=Math.min(s.bottom,window.innerHeight)-Math.max(0,s.top),p=Math.min(s.right,window.innerWidth)-Math.max(0,s.left),q=r.offsetHeight,t=r.offsetWidth;return n>0&&p>0&&q*o<=n&&t*o<=p;}function f(n){this.parent=e.parent(n,"feed-list");this.offset=parseInt(n.getAttribute("data-offset"),10)||200;this.unsubscribe=n.getAttribute("data-unsubscribe")==="true";this.checkMore=parseInt(n.getAttribute("data-check-more"),10)||5;this.minCreated=parseInt(n.getAttribute("data-min-created"),10)||0;d.addBlock("MainFeedsNewFeedPush");}function c(){if(this.unsubscribe){k.ajax({type:"POST",url:"/web-api/feed/markAsInactive"}).fail(function(){l.error("Failed to mark as inactive in feed");});}}function g(v){var w=document.createElement("div");w.innerHTML=v;var r=w.childNodes;if(r.length===0){return;}var z=h(r,this.minCreated);if(!z){return;}var y;var x;var q=this.parent.childNodes;if(q.length===0){return;}var o=true;var n=q.length;for(var u=0;u<n;u++){var A=q[u];if(A.className.indexOf("feed")>=0){var p=j(A);if(p){delete z[p];}if(!o){continue;}if(b(A,this.offset)){y=A;}else{if(y){o=false;}else{if(i(A,0.2)){x=A;}else{if(x){o=false;}}}}if(!o){if(this.checkMore==0){break;}if(u+this.checkMore<n){n=u+this.checkMore;}}}}for(var s in z){if(!z.hasOwnProperty(s)){continue;}var t=z[s];if(!t){continue;}if(y){this.parent.insertBefore(t,y);}else{if(x){this.parent.insertBefore(t,x.nextSibling);}else{continue;}}m.activate(t);}}function h(n,s){var t={};var q=false;for(var p=n.length-1;p>=0;p--){var r=n[p];if(s>0){var u=a(r);if(u&&u<s){continue;}}var o=j(r);if(o){t[o]=r;q=true;}}if(!q){return null;}return t;}function j(n){var o=n.getAttribute("data-seen-params");if(!o&&n.firstElementChild){o=n.firstElementChild.getAttribute("data-seen-params");}if(o){var p=JSON.parse(o);if(p.data){return p.data.gId;}}return null;}function a(n){var o=n.getAttribute("data-seen-params");if(!o&&n.firstElementChild){o=n.firstElementChild.getAttribute("data-seen-params");}if(o){var p=JSON.parse(o);if(p.data){return p.data.created;}}return null;}return{activate:f,deactivate:c,setNewContent:g};});