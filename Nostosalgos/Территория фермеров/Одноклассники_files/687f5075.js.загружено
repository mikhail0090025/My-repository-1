define(["OK/utils/throttle","OK/utils/dom"],function(i,c){var h="js-viewport-container",a=[],f=false,j=i(100,function(){a.forEach(function(k){k.calculate();});});function d(l){var k=null;a.some(function(m){if(m.element===l){k=m;return true;}});return k;}function g(m,l){var k=m.indexOf(l);if(k>-1){m.splice(k,1);}}function b(m,l,n,k){this.element=m;this.container=l;this.callback=n;this.predicate=k?k.bind(this):null;}b.prototype={destroy:function(){this.container=null;},isInViewport:function(){var n=this.container.rect,m=this.element.getBoundingClientRect(),k=n.top,l=n.bottom;return(m.top>=k&&m.top<=l)||(m.bottom>=k&&m.bottom<=l);},calculate:function(){var k=this.predicate?this.predicate():this.isInViewport();if(this.visible===k){return;}this.visible=k;this.callback.call(this.element,k);}};function e(k){this.element=k;this.items=[];this.listener=i(100,this.calculate.bind(this));this.element.addEventListener("scroll",this.listener);this.updateRect();}e.prototype={add:function(k){this.items.push(k);this.updateRect();k.calculate();},updateRect:function(){this.rect=this.element.getBoundingClientRect();},remove:function(l){var k=null;this.items.forEach(function(m){if(m.element===l){k=m;return true;}});if(k){k.destroy();g(this.items,k);}},isEmpty:function(){return this.items.length===0;},isLast:function(k){return this.items[this.items.length-1]===k;},calculate:function(){this.updateRect();this.items.forEach(function(k){k.calculate();});},destroy:function(){this.element.removeEventListener("scroll",this.listener);}};return{add:function(m,o,k){var n=c.parent(m,h),l;if(n===null){n=window;}l=d(n);if(!l){l=new e(n);a.push(l);}l.add(new b(m,l,o,k));if(!f){window.addEventListener("resize",j);f=true;}},remove:function(l){var m=c.parent(l,h),k;if(m===null){m=window;}k=d(m);if(k){k.remove(l);if(k.isEmpty()){k.destroy();g(a,k);}}if(f&&a.length===0){window.removeEventListener("resize",j);f=false;}},getContainer:function(k){var l=c.parent(k,h);return d(l);}};});