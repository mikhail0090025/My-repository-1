define(["webrtc/adapter","OK/cookie"],function(H,D){var h=null,t=[],R=[],B=null,O=null,a=false,q=false,w=null,y=null,m=false,v=false,I=null;function E(T,V,S,W,Y,X,Z){var aa=false;if(T){aa=O?{deviceId:{exact:O.deviceId}}:true;}var U=false;if(V){U={width:{min:S||1024,max:W||1280},height:{min:Y||576,max:X||720},aspectRatio:{ideal:Z||16/9}};if(B){U.deviceId={exact:B.deviceId};}}this.audio=aa;this.video=U;}E.prototype.getNative=function(){return Object.assign({},{audio:this.audio,video:this.video});};E.prototype.simplify=function(){if(this.video.width||this.video.height){delete this.video.width;delete this.video.height;}else{if(this.video.aspectRatio){delete this.video.aspectRatio;}else{if(this.video.deviceId||this.audio.deviceId){delete this.video.deviceId;delete this.audio.deviceId;}}}if(this.video&&!Object.keys(this.video).length){this.video=true;}if(this.audio&&!Object.keys(this.audio).length){this.audio=true;}return this;};E.prototype.canSimplify=function(){return !!(this.video.width||this.video.height||this.video.aspectRatio||this.video.deviceId||this.audio.deviceId);};E.prototype.isVideo=function(){return !!this.video;};E.prototype.isAudio=function(){return !!this.audio;};function g(T,S,U){E.call(this,false,true,null,T,null,S);delete this.video.deviceId;if(U){this.video.mandatory={chromeMediaSource:"desktop",chromeMediaSourceId:U,minWidth:this.video.width.min,maxWidth:this.video.width.max,minHeight:this.video.height.min,maxHeight:this.video.height.max};this.video.optional=[{googTemporalLayeredScreencast:true},{aspectRatio:16/9}];delete this.video.width;delete this.video.height;delete this.video.aspectRatio;}else{this.video.mediaSource="screen";}}g.prototype=Object.create(E.prototype);g.prototype.constructor=E;function r(S){try{return JSON.parse(window.localStorage.getItem("_vc_"+S));}catch(T){return null;}}function b(S,T){try{window.localStorage.setItem("_vc_"+S,JSON.stringify(T));}catch(U){}}function z(){if(h){return h;}if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices){return Promise.resolve([]);}return h=navigator.mediaDevices.enumerateDevices().then(function(T){t=T.filter(function(V){if(V.kind==="videoinput"){if(V.label){a=true;}return true;}return false;});R=T.filter(function(V){if(V.kind==="audioinput"){if(V.label){q=true;}return true;}return false;});var S=r("videoinput"),U=r("audioinput");B=t.find(function(V){return V.deviceId===S;})||null;O=R.find(function(V){return V.deviceId===U;})||null;h=Promise.resolve(T);return T;})["catch"](function(){h=null;return[];});}function K(){if(!A()){return Promise.resolve();}return new Promise(function(U){var T={};if(u()){T.sdpSemantics="plan-b";}var S=new window.RTCPeerConnection(T);S.createOffer({offerToReceiveVideo:true}).then(function(V){if(/^a=rtpmap:\d+ VP8\/\d+$/m.test(V.sdp)){m=true;}if(/^a=mid:0$/m.test(V.sdp)){v=true;}U();})["catch"](U);});}function k(S){console.log("Try to get media",S.getNative());return navigator.mediaDevices.getUserMedia(S.getNative())["catch"](function(T){switch(T.name){case"PermissionDeniedError":case"PermissionDismissedError":case"NotAllowedError":case"SecurityError":case"DOMException":return Promise.reject("permission");case"OverconstrainedError":case"TypeError":case"NotFoundError":if(S.canSimplify()){return k(S.simplify());}return Promise.reject("unknown");case"AbortError":case"NotReadableError":return Promise.reject("access");default:return Promise.reject("unknown");}});}function Q(){return Promise.all([z(),K()]);}function s(){return t;}function n(){return R;}function c(){return t.length>0;}function F(){return R.length>0;}function i(){return B;}function N(){return O;}function l(){return a;}function f(){return q;}function j(S){if(!f()){return false;}if(c()&&(S||!e())){return l();}return true;}function C(S){var U=true,T=c()&&(S.video||!e());return k(new E(U,T,S.minWidth,S.maxWidth,S.minHeight,S.maxHeight,S.aspectRatio)).then(function(V){if(c()&&!S.video&&e()){V.addTrack(J(S.minWidth,S.minHeight));}return V;});}function p(S){return k(new g(screen.width,screen.height,S));}function P(S){return k(new E(false,true,S.minWidth,S.maxWidth,S.minHeight,S.maxHeight,S.aspectRatio));}function o(){return k(new E(true,false));}function e(){if(!window.HTMLCanvasElement||!window.HTMLCanvasElement.prototype.captureStream){return false;}if(!window.RTCRtpSender||!window.RTCRtpSender.prototype.replaceTrack){return false;}return true;}function G(S,T){return z().then(function(U){var V=U.find(function(W){return W.kind===S&&W.deviceId===T;});if(V){if(S==="videoinput"){B=V;}else{O=V;}b(S,T);return V;}return null;});}function J(T,S){if(!y){y=document.createElement("canvas");y.getContext("2d");}y.width=T||1024;y.height=S||576;if(!w||w.readyState==="ended"){var U=y.captureStream(25);w=Object.assign(U.getVideoTracks()[0],{enabled:false});}return w;}function A(){try{return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.RTCPeerConnection&&window.RTCIceCandidate&&window.RTCSessionDescription&&true;}catch(S){return false;}}function u(){if(I===null){var S=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);I=S?parseInt(S[2],10):0;}return I;}function d(){return m;}function M(){return v;}var x={getCameras:s,getMicrophones:n,getSavedCamera:i,getSavedMicrophone:N,hasCamera:c,hasMicrophone:F,hasCameraPermission:l,hasMicrophonePermission:f,hasPermissions:j,getUserMedia:C,getUserVideo:P,getUserAudio:o,getScreenMedia:p,canReplaceTrack:e,saveDeviceId:G,getBlackMediaTrack:J,isBrowserSupported:A,getChromeVersion:u,canVP8:d,isUnifiedPlan:M};function L(U,W,V,T){if(T.isBuild){V(x);}else{var S=(D.readCookie("dme")==="true"||OK.fn.isDebug())&&window.console;if(S){H.disableLog(false);}Q().then(function(){V(x);});}}return Object.assign({},x,{init:Q,load:L});});