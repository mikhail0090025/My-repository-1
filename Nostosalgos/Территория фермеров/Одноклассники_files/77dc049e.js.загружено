define(["jquery","OK/utils/vanilla","OK/utils/utils","OK/utils/dom","OK/alf2"],function(g,k,l,e,i){var h={},c=false;var m=function(){};m.prototype={activate:function(s){var x=g(s);this.hookElem=x;this.blockHookId=OK.hookModel.getNearestBlockHookId(s);this.blockHook=g("#hook_Block_"+this.blockHookId);this.url=this.blockHook.attr("data-url");this.wideCnt=false;this.noCnt=false;var z=this.blockHook.attr("data-flags");var y=this.hookElem.attr("data-flags");if(z||y){var w=(z+","+y).split(",");for(var t=0;t<w.length;t++){switch(w[t]){case"wideCnt":this.wideCnt=true;break;case"noCnt":this.noCnt=true;break;}}}this.id1=x.data("id1");this.id2=x.data("id2")||0;this.idStr=x.data("idStr");this.type=x.data("type");this.owner=x.data("owner");if(this.owner===undefined){this.owner=null;}this.like=x.data("like")||"on";this.count=x.data("count")||0;this.isReshare="RESHARE"==this.type;this.resharesRestricted=this.blockHook.data("resharesrestricted");var r="off"!=x.attr("data-canlike");if(this.url&&r){if(r){x.click(o.bind(this));}if(!this.isReshare){x.mouseenter(j.bind(this));}}var u=g(".widget",this.blockHook);u.toggleClass("__compact","true"==this.blockHook.attr("data-compact"));u.toggleClass("__no-count",this.noCnt);u.toggleClass("__wide-count",this.wideCnt);u.toggleClass("__null","true"==x.attr("data-null"));u.toggleClass("__only-icon","true"==this.blockHook.attr("data-only-icon"));if(this.isReshare&&(this.count==0)){x.mouseleave();}p(this);var q=this.blockHook.data("player-id");if(q){var v="off"==this.like;runLinkedVideoCallbackFromJS({callbackId:q,liked:v,likeCount:this.count});}},deactivate:function(q){var r=g(q);r.off();r.removeData();f(this);}};function p(r){if("true"===r.blockHook.attr("data-no-push")){return;}var s=d(r),q=h[s];if(!q){h[s]=q=[];}if(r.count>-1&&q.length>0&&!c){b(s,r.blockHook.html());}q.push(r);}function f(r){var t=d(r),q=h[t];if(!q||q.length==0){return;}var s=q.indexOf(r);if(s>-1){q.splice(s,1);}}function b(u,t){c=true;try{var q=h[u];if(!q||q.length==0){return;}var s;var r=[];for(s=0;s<q.length;s++){r.push(q[s].blockHookId);}for(s=0;s<r.length;s++){OK.hookModel.setHookContent(r[s],t);}}finally{c=false;}}function d(q){return q.type+"_"+q.id1+"_"+q.id2;}function j(){a.call(this,false);}function o(r){var q=r.target.getAttribute("uid");if(!OK.isStopped()&&!q){a.call(this,true);}}function n(r){var s=r.get(0);var q;var t=e.parent(s,"js-video-scope");if(t){q=t.getAttribute("data-impression-id");}if(q){return Promise.resolve(q);}return i.findAdv(s).then(function(u){return u.getImpressionId();});}function a(t){var v=d(this),q=this.isReshare,w=this.resharesRestricted;var r,u=false;if(this.hookElem.data("clickFromVideo")){w="on";}this.hookElem.removeData("clickFromVideo");if(q){if(!t){return;}r={};}else{r={"st.v.refId1":this.id1,"st.v.refId2":this.id2,"st.v.type":this.type,"st.v.owner":this.owner,"st.v.count":this.count,"st.v.resharesRestricted":w};if(this.idStr){r["st.v.refIdStr"]=this.idStr;}r["st.v.hookId"]=this.blockHookId;if(this.blockHook.hasClass("__vis")){r["st.v.hookId"]=this.blockHookId;}if(t){r["st.v.like"]=this.like;}}if(t&&r["st.v.like"]==="on"){u=true;}function s(){l.ajax({type:"POST",url:this.url,data:r}).done(function(z,x,B){if(z==null||z.length==0){return;}if(t){h[v].forEach(function(C){C._haveDataToSave=false;});}if(q){l.updateBlockModelCallback(z,x,B);}else{var y=z.indexOf(OK.navigation.SPLITER),A;if(y<0){A=z;}else{A=z.substring(0,y);l.updateBlockModelCallback(z.substring(y),x,B);}b(v,A);}});}if(u){n(this.hookElem).then(function(x){if(x){r["st.v.impressionId"]=x;}s();},s);}else{s();}}return m;});