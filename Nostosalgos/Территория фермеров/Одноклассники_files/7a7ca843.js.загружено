define(["jquery","OK/logger","okVideoPlayerUtils","OK/utils/utils","PTS/video.player"],function(an,I,o,R,h){var ah={UNKNOWN:"UNKNOWN",OK:"OK",ERROR:"ERROR",UPLOADING:"UPLOADING",CREATING:"CREATING",PROCESSING:"PROCESSING",ONLINE:"ONLINE",OFFLINE:"OFFLINE",LIVE_NOT_STARTED:"LIVE_NOT_STARTED",LIVE_ENDED:"LIVE_ENDED",LIVE_INTERRUPTED:"LIVE_INTERRUPTED",ON_MODERATION:"ON_MODERATION",BLOCKED:"BLOCKED",CENSORED:"CENSORED",COPYRIGHTS_RESTRICTED:"COPYRIGHTS_RESTRICTED",UNAVAILABLE:"UNAVAILABLE",LIMITED_ACCESS:"LIMITED_ACCESS"};var N=q("MiniVideoPlayer");var O="no_flash_installed";var p="not_found";var C=null;var E=null;var aw={};var i;var t=null;var a=null;var ad=null;an(window).on("onMusicPlaying",function(){if(aw.isExternalPlayer){ai();}else{T(true);}});function P(){return !!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement);}function B(){if(!P()){return;}if(document.exitFullscreen){document.exitFullscreen();}else{if(document.webkitExitFullscreen){document.webkitExitFullscreen();}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else{if(document.msExitFullscreen){document.msExitFullscreen();}}}}}function X(aF,ay,ax,aA,aC){var aE=an("#"+ay),aD=an("#"+ax);B();if(!aD.length){aD=an("<div>",{id:ax}).insertAfter(aE);}else{aD.empty();}var az=an("<div/>",{"class":"vp_video_stub_w"}),aB=an("<div/>",{"class":"vp_video_stub __na"}).appendTo(az);an("<div/>",{"class":"vp_video_stub_txt",html:(aC||h[aA])}).appendTo(aB);aE.addClass("invisible");aD.append(az);if(aF.poster){an("<img/>",{width:"100%",src:aF.poster,"class":"vp-video_stub_i"}).insertBefore(az);}}function L(){if(t){clearTimeout(t);t=null;}if(a){clearInterval(a);a=null;}if(ad){clearTimeout(ad);ad=null;}}function e(ax){for(var ay in ax){if(ax.hasOwnProperty(ay)){if(typeof ax[ay]!=="string"){ax[ay]=encodeURIComponent(JSON.stringify(ax[ay]));}}}return ax;}function ae(ax){ax.isExternalPlayer&&an.ajax({url:"/dk?cmd=videoStatNew",contentType:"application/json",type:"POST",data:JSON.stringify({duration:ax.flashvars.metadata.movie.duration,movieId:ax.flashvars.metadata.movie.movieId,contentId:ax.flashvars.metadata.movie.contentId,location:ax.flashvars.location,providerId:ax.provider,batch:[{name:"started"}]})}).error(function(){I.error("OKVideoStart","failOG");});}function ab(ay){var ax=ay.flashvars.metadata.movie;if(ax){return !ax.paymentStatus||ax.paymentStatus==="PAID";}return true;}function j(az,ay,aA,ax){return an.ajax({url:az?decodeURIComponent(az):"/dk?cmd=videoPlayerMetadata",data:ay,dataType:"json",type:"POST",headers:{TKN:OK.tkn.get()}}).done(aA).error(ax);}function l(az,ax,ay,aB){var aC=az.flashvars.metadataUrl,aA={};if(!aC){if(az.flashvars.metadata){aA.mid=az.flashvars.metadata.movie.movieId;}else{if(ay){ay();}return;}}if(aB&&az.flashvars.metadata){aA.is="on";}else{az.flashvars.metadata={};}aA["st.location"]=az.flashvars.location;j(aC,aA,function(aD){if(aD&&!aD.error){an.extend(true,az.flashvars.metadata,aD);if(az.blockWebrtc){delete az.flashvars.metadata.webrtcUrl;}delete az.flashvars.metadataUrl;if(ax){ax();}}else{if(ay){ay();}}},function(){if(ay){ay();}});}function c(aF,aD,aE){if(aD&&aF.stubEnabled){var az;try{var aB=OK.cnst.staticUrl+"res/i/video/stub.mp4";az=document.createElement("video");var aA=1;if(aF.verifyInline){aA=az&&"playsInline" in az;}if(az&&aA){aD.appendChild(az);var ax=document.createElement("source");ax.setAttribute("src",aB);var ay="act_video_"+Math.round(1000000000*Math.random());az.id=ay;az.setAttribute("playsInline","1");az.appendChild(ax);az.load();az.play().then(aE.bind(null,ay))["catch"](function(aG){if(az){aD.removeChild(az);}aE(null);});return;}}catch(aC){if(az){aD.removeChild(az);}}}aE();}function au(az,ax,ay){if(az.flashvars.metadata){if(typeof az.flashvars.metadata==="string"){az.flashvars.metadata=JSON.parse(az.flashvars.metadata);}if(ax){ax();}}else{l(az,ax,ay);}}function Y(ay,ax){return an.ajax({url:"/dk",data:{cmd:"videoCommand",a:"getVideoPlayerAttributes","st.vv_movieId":ay,"st.location":ax},dataType:"json",type:"POST",headers:{TKN:OK.tkn.get()}});}function H(ax){var ay=document.querySelector("link[href*='"+ax+"']");if(ay){ay.disabled=true;ay.parentNode.removeChild(ay);}}function aq(aB,ax,aE){var aA="okHtml5Player",az={paths:{okHtml5Player:aB.html5url}},ay=require.defined(aA);if(ay){var aD=require.toUrl(aA),aC=require.toUrl(aA+".css");if(aD!==aB.html5url){H(aC);require.undef(aA);require.config(az);}}else{require.config(az);}require([aA],function(aF){aF.embedPlayer(ax,ax,aB.flashvars,aE);});}function d(ay,ax){require(["swfobject"],function(aB){if(aB.getObjectById(ax)){return;}var aC=aB.hasFlashPlayerVersion(ay.minFlashVersionNewPlayer||"11.2.0")&&ay.url11?ay.url11:ay.url;var aA={id:ax,name:ax};var aD={allowScriptAccess:ay.asa?"always":"never",wmode:ay.wmode||"opaque",allowFullScreen:true,menu:false,bgcolor:"#000000"};var az={autoplay:true,wmode:aD.wmode,stageVideo:aD.wmode=="direct"||aD.wmode=="gpu",playerId:ay.playerId};if(!ay.isExternalPlayer){az=e(an.extend({},ay.flashvars,az));}aB.embedSWF(aC,ax,"100%","100%","10.0.0",null,az,aD,aA);});ae(ay);}function D(ay,ax){var az=document.createElement("iframe");az.id=ax;az.className="vid-card_player";az.width="100%";az.height="100%";az.tabIndex="999";az.frameBorder="no";az.scrolling="no";az.allowFullScreen=true;az.setAttribute("allowfullscreen","");az.src=ay.url;var aA=document.getElementById(ax);aA.parentNode.replaceChild(az,aA);ae(ay);}function m(aM,aD,aB){var aJ=aM.flashvars.metadata,aL=aJ.liveStreamInfo,aG=aJ.movie.status,aC=Date.now()+aM.timeshift,aA=parseInt(aL.startTime,10);function aH(aS,aR){var aQ=~~((aS-aR)/1000),aP=~~(aQ/3600),aN=~~(aQ/60)%60,aO=aQ%60;return(aP<10?"0"+aP:aP)+":"+(aN<10?"0"+aN:aN)+":"+(aO<10?"0"+aO:aO);}function aK(aN,aP,aR,aQ){var aO=an("<div/>",{"class":"vp_broadcast-stub_ac button-pro"});an("<div/>",{"class":aN}).appendTo(aO);an("<div/>",{"class":"vp_broadcast-stub_ac_tx",text:h[aP]}).appendTo(aO);aO.on("click",function(){OK.VideoPlayer.toggleSubscriptionFromFlash(aJ.movie.albumId,aR,function(){aO.addClass("invisible").siblings(".vp_broadcast-stub_ac").removeClass("invisible");},aQ);});return aO;}var az=an("<div/>",{id:aB,"class":"vp_broadcast-stub_w"}),aF=an("<div/>",{"class":"vp_video_stub_w"}).appendTo(az),aI=an("<div/>",{"class":"vp_broadcast-stub"}).appendTo(aF),aE=an("<div/>",{"class":"vp_broadcast-stub_tx"}).appendTo(aI);an("<img/>",{width:"100%",src:aM.poster,"class":"vid-card_img"}).appendTo(az);an("#"+aB).replaceWith(az);if(aG===ah.OFFLINE){aE.html(h.live_stream_offline);G(aM.liveRertyTimeout,true);}else{if(aA>aC){aE.html(h.live_stream_after);var ay=an("<div/>",{"class":"vp_broadcast-stub_time js-live-time",text:aH(aA,aC)}).appendTo(aI);a=setInterval(function(){aC=Date.now()+aM.timeshift;if(aA<aC){clearInterval(a);G(0,true);return;}ay.text(aH(aA,aC));},1000);if(aM.notifyEnabled&&aJ.subscribed===false&&aJ.movie.albumId){var ax=an("<div/>").appendTo(aI);aK("vp_broadcast-stub_ac_ic ic_notifications-on-w","notify","subscribe","Video_NotifyLive").appendTo(ax);aK("vp_broadcast-stub_ac_ic ic_notifications-off-w","not-notify","unsubscribe","Video_NotNotifyLive").addClass("invisible").appendTo(ax);}}else{aE.html(h.live_stream_ended);}}}function av(ay,az){if(document.getElementById("hook_Cfg_CurrentUser")){var ax=window.location.href;if(ax.indexOf("?")<0){ax+="?";}else{ax+="&";}ax+="cmd=PopLayer";ax+="&st.cmd="+OK.getCurrentDesktopModelId();ax+="&st.layer.cmd=PopLayerPaymentWizardOuter";ax+="&st.layer.timestamp="+Date.now();ax+="&st.layer.appId="+encodeURIComponent(ay.appId);ax+="&st.layer.appDescription=";ax+="&st.layer.appName="+encodeURIComponent(ay.title);ax+="&st.layer.appCode="+encodeURIComponent(ay.productCode);ax+="&st.layer.currency="+encodeURIComponent("OK");ax+="&st.layer.appPrice="+encodeURIComponent(ay.price);ax+="&st.layer.appOptions=";ax+="&st.layer.appAttributes=";ax+="&st.layer.appUiConf=";ax+="&st.layer.callback=true";ax+="&st.layer.srv=22";ax+="&st.layer.appOptionCode=";ax+="&st.layer.appCardOnly=off";navigateOnUrlFromJS(ax);if(az){OK.loader.use(["OKCustomJs"],function(){OK.Layers.subscribe("modal_hook",function aA(aB){if(!aB){OK.Layers.unsubscribe("modal_hook",aA);az(true);}else{az(false);}});});}}}function ac(ax,aA,az,aB){var ay=ax.flashvars.metadata.paymentInfo;if(document.getElementById("hook_Cfg_CurrentUser")){av(ay,function(aC){if(aC){l(ax,function(){if(ab(ax)){z(ax,aA,az,aB);}});}});}else{if(ax.flashvars.isEmbed==="1"){window.open(ax.flashvars.metadata.movie.url,"_blank");}else{R.ajax({type:"GET",url:"/dk",data:{cmd:"PopLayerLogin","st.cmd":"anonymMain","st.redirect":decodeURIComponent(OK.historyManager.getState())}}).done(R.updateBlockModelCallback);}}}function k(ay,ax){av(ay,!ax?null:function(az){if(az){R.ajax({url:ax}).done(R.updateBlockModelCallback);}});}function y(az,ay){var ax=V();if(ax&&ax.call){ax.call(az,ay);}}function z(aB,aG,aY,a1){aB.flashvars.translations=h;var aL=aB.flashvars.metadata;if(!aL||aL.error){X(aB,aG,aY,aL&&aL.error||p);return;}if(aY!==C&&f()){R.ajax({url:aB.flashvars.metadata.movie.link.replace(/&amp;/g,"&"),data:{"st.vpl.mini":true,"st.vpl.ipl":true}}).done(R.updateBlockModelCallback).done(function(){if(!f()){z(aB,aG,aY,a1);}});return;}var aM=o.dash,ay=o.mp4,aE=o.hls,aJ=o.webrtc&&!aB.webrtcBrokenH264,aA=o.flash.major>=10,aH=!!(aB.flashvars.metadata&&aB.flashvars.metadata.metadataEmbedded),aR=!!(aB.flashvars.metadata&&aB.flashvars.metadata.hlsManifestUrl),aI=!!(aB.flashvars.metadata&&aB.flashvars.metadata.hlsMasterPlaylistUrl),aF=!!(aB.flashvars.metadata&&aB.flashvars.metadata.liveDashManifestUrl),aS=!!(aB.flashvars.metadata&&aB.flashvars.metadata.rtmpUrl),az=!!(aB.flashvars.metadata&&aB.flashvars.metadata.webrtcUrl),aK=!!(aB.flashvars.metadata&&aB.flashvars.liveStream),aC=!!(aB.flashvars.metadata&&aB.flashvars.metadata.emptyPlayer),a0=aB.flashvars.metadata.liveStreamInfo,aU=aB.flashvars.metadata.movie&&aB.flashvars.metadata.movie.status,a2=aB.flashvars.metadata.movie&&aB.flashvars.metadata.movie.statusText,a4=aB.flashvars.metadata.movie&&aB.flashvars.metadata.movie.paymentStatus,aW,aV=an("#"+aG),aP=an("#"+aY);function aD(){try{D(aB,aY);}catch(a5){X(aB,aG,aY,p);}}function aX(){if(ay){aq(aB,aY,a1);aW=1;}else{X(aB,aG,aY,O);}}function aO(){if(az&&aJ){aq(aB,aY,a1);aW=1;}else{if(aS&&aA){aQ();}else{if((aM&&aF)||(aE&&aI)){aq(aB,aY,a1);aW=1;}else{aQ();}}}}function aQ(){if(!aA){X(aB,aG,aY,O);}else{d(aB,aY);}}function ax(){if((aM&&aH)||(aE&&aR)){aq(aB,aY,a1);aW=1;}else{if(aH&&aA){d(aB,aY);}else{if(ay){aX();}else{aQ();}}}}function aZ(){if(aC){aq(aB,aY,a1);}else{if(aB.isIframePlayer){aD();}else{if(aB.isExternalPlayer||!aB.isHtml5Player){aQ();}else{if(aF||aI||aS||az){aO();}else{if(aH||aR){ax();}else{if(ay){aq(aB,aY,a1);aW=1;}else{aQ();}}}}}}if(a1&&!aW){var a5=document.getElementById(a1);if(a5){a1.parentNode.remove(a5);}}}function a3(){var a5=parseInt(a0.endTime,10),a7=Date.now()+aB.timeshift;if(a5&&a7<a5){var a6=~~((parseInt(a0.endTime,10)-a7)/1000);ad=setTimeout(function(){G(0,true);},a6*1000+3000);}}if(C!==aY){ai();}if(aB.isExternalPlayer&&window.odklMusic&&window.odklMusic.playingTrack()){var aT=document.getElementById("music_layer");if(aT&&aT.pause){aT.pause();}else{if(window.__getMusicFlash){window.__getMusicFlash().lcPause();}}}C=aY;E=aG;aw=aB;i=a1;if(aP.length&&aP.prop("tagName").toLowerCase()==="object"){aP.remove();aP.length=0;}if(!aP.length&&ab(aB)){aV.addClass("invisible");var aN=an("<div>",{id:aY,"class":"vid-card_player"}).insertAfter(aV);an("<img/>",{width:"100%",src:aB.poster,"class":"vid-card_img vid-card_img-delayed"}).appendTo(aN);}if(aC){aU=ah.ONLINE;}else{if(a0&&aU===ah.ONLINE&&!aI&&!aF&&!az&&!aK){aU=ah.OFFLINE;}}switch(aU){case ah.OK:case ah.ONLINE:case ah.COPYRIGHTS_RESTRICTED:case ah.BLOCKED:case ah.CENSORED:!aC&&a0&&a3();if(!a4||a4==="PAID"){aZ();}else{X(aB,aG,aY,aU,a2);}break;case ah.OFFLINE:case ah.LIVE_NOT_STARTED:case ah.LIVE_ENDED:case ah.LIVE_INTERRUPTED:if(a0){m(aB,aG,aY);}else{X(aB,aG,aY,aU,a2);}break;default:X(aB,aG,aY,aU,a2);}}function ak(ax){return ax+"C";}function q(ax){return ax+"E";}function s(ax,az,ay){az=az||ak(ax.playerId);ay=ay||q(ax.playerId);if(!ax.timeshift){ax.timeshift=ax.timestamp?parseInt(ax.timestamp,10)-Date.now():0;}c(ax,document.getElementById(az),function(aA){au(ax,function(){z(ax,az,ay,aA);},function(){X(ax,az,ay,p);});});}function ai(){if(C&&E){L();an("#"+C).remove();an("#"+E).removeClass("invisible");an("#"+i).remove();C=null;E=null;i=null;aw={};}}function T(ax){if(ax||!f()){y("togglePlay",false);}}function n(){y("togglePlay",true);}function K(ax){y("setVolume",ax);}function af(ax){y("toggleMute",ax);}function al(ax){y("rotate",ax);}function ao(ay,ax){y(ax?"seekTime":"seek",ay);}function W(ax){y("changeAnnotations",ax);}function aa(){y("callToStream",Array.prototype.slice.call(arguments));}function ar(ax){y("showProgressTip",ax);}function Q(){y("hideProgressTip",null);}function G(az,ay,ax){if(ax){aw.blockWebrtc=ax;}t=setTimeout(l.bind(null,aw,function(){z(aw,E,C,i);},function(){X(aw,E,C,p);},ay),az||0);}function V(){return C?document.getElementById(C):null;}function U(){return C;}function Z(){var ax=V();return ax&&ax.isPlaying&&ax.isPlaying();}function g(){var ax=V();return ax&&ax.isEnded&&ax.isEnded();}function ap(){var ax=V();return ax&&ax.isSilent&&ax.isSilent();}function r(){return E;}function F(){return E?document.getElementById(E):null;}function w(){return F()?F().parentNode:null;}function x(){return aw;}function J(az,aA,aB,ax,ay){Y(az,ay).always(function(aD){aD=aD||{flashvars:{}};aD.playerId=aA||aD.playerId||null;aD.width=aB||aD.width||null;aD.height=ax||aD.height||null;if(window.odklMusic&&window.odklMusic.playingTrack()){aD.flashvars.silent="1";}var aC=(typeof aD.error==="string")?aD.error:"",aF=ak(aD.playerId),aE=q(aD.playerId);if(aC||!aD.url){X(aD,aF,aE,p);}else{s(aD,aF,aE);}});}function f(){return C===N;}var M=3000;var at=function(){var ax=new Promise(function(aB,aA){function ay(aC){I.success("banner.feed","alf-okvideo",aC);}var az=setTimeout(function(){ay("timeout");aA();},M);require(["OK/alf2"],function(aC){ay("load");clearTimeout(az);aB(aC);},function(){ay("error");clearTimeout(az);aA();});});at=function(){return ax;};return ax;};function u(ax){var az=ax.closest(".js-video-scope"),ay;if(az.length){if(az.data("id")){az=an("#"+az.data("id"));}if(az.length){ay=az.children(".js-video-pixels").data("pixelsjson");}}if(ay){return Promise.resolve(ag(ay));}return at().then(function(aA){return aA.findAdv(ax[0]);}).then(function(aA){ay=aA.getVideoPixels();if(ay){return ag(ay);}return{};});}function ag(aA){var aC={};var ax=function(aE,aD){if(!aC.hasOwnProperty(aE)){aC[aE]=[];}aC[aE].push(aD);};try{for(var az in aA){if(aA.hasOwnProperty(az)){var ay=aA[az];if(ay.type==="playheadReachedValue"){if(ay.hasOwnProperty("pvalue")){ax(ay.type+"Percent"+ay.pvalue,ay.url);}else{if(ay.hasOwnProperty("value")){ax(ay.type+"Second"+ay.value,ay.url);}}}else{ax(ay.type,ay.url);}}}}catch(aB){}return aC;}function S(aE){var aJ=an(aE),aA=aJ.data("playerContainerId"),ax=aJ.data("playerElementId"),aD=aJ.data("isSticky"),aN=aJ.data("options"),aM=aJ.data("autostart"),aI=aJ.data("viewportTimeout"),aL=aJ.data("viewportPolicy"),aC=aJ.data("isBannerVideo")||(aJ[0].getAttribute("data-is-fla")==="true"),ay=aJ.data("alt-autoplay"),aH=aJ.data("drop-autoplay"),az=aJ.data("do-not-stick"),aG=aJ.data("sticky-timeout"),aF=aJ.data("additionalLogging"),aB=aJ.data("visiblePart");aN.timeshift=aN.timestamp?parseInt(aN.timestamp,10)-Date.now():0;function aK(){if(!aJ.find("#"+aA).length){an("<div>",{id:aA,"class":"vid-card_cnt_w"}).css({width:"100%",height:"100%"}).append(an("<div>",{"class":"vid_play"})).appendTo(aJ);}aJ.find("#"+aA).on("click",function(aP){aP.preventDefault();require(["OK/StickyPlayer"],function(aQ){if(aQ.isActive()){aQ.updateView({reset:true});}});c(aN,document.getElementById(aA),function(aQ){au(aN,function(){if(ab(aN)){z(aN,aA,ax,aQ);}else{ac(aN,aA,ax,aQ);}},function(){X(aN,aA,ax,p);});});});if(aM){s(an.extend(true,{flashvars:{autostart:1}},aN),aA,ax);}if(aI&&aL&&aL.policy==="NO_AUTOSTART"){aI=null;}if(aI&&!aN.isExternalPlayer){if(aD){require(["OK/VideoAutoplayFlowAlt"],function(aP){aP.activateViewportPlayerWithSticky(an.extend(true,{stickyTimeout:aG,doNotStick:az},aN),aA,ax,aI,aB);});}else{if(ay){require(["OK/VideoAutoplayFlowAlt"],function(aP){aP.activateViewportPlayer(an.extend(true,{canBeDropped:aH},aN),aA,ax,aI,aB);});}else{require(["OK/VideoAutoplayFlow"],function(aP){aP.activateViewportPlayer(an.extend(true,{},aN),aA,ax,aI,aL,aF);});}}}var aO=am(aE);if(aO!==undefined){aO.videoCard={seek:function(aP){if(C===null){s(an.extend(true,{flashvars:{fromTime:aP}},aN),aA,ax);}else{y("seekTime",aP);}}};}}if(aC){u(aJ).then(function(aO){if(Object.keys(aO).length>0){aN.flashvars.pixels=aO;}aK();},aK);}else{aK();}}function aj(az){var ax=an(az),aC=ax.data("playerContainerId"),aB=ax.data("viewportTimeout"),aA=ax.data("isSticky"),ay=ax.data("alt-autoplay");if(aB){if(aA){require(["OK/VideoAutoplayFlowAlt"],function(aD){aD.deactivateViewportPlayerWithSticky(aC);});}else{if(ay){require(["OK/VideoAutoplayFlowAlt"],function(aD){aD.deactivateViewportPlayer(aC);});}else{require(["OK/VideoAutoplayFlow"],function(aD){aD.deactivateViewportPlayer(aC);});}}}if(aC===E){ai();}ax.off();}function am(ay){var az=ay.parentNode;var ax=30;while(az!==document&&--ax>0){if(az.classList.contains("js-video-scope")){return az;}az=az.parentNode;}}function b(az){var ay=am(az.target);var ax=ay.videoCard;if(ax!==undefined){ax.seek(parseInt(az.target.getAttribute("data-position"),10));}}function v(ax){ax.addEventListener("click",b);}function A(ax){ax.removeEventListener("click",b);}return{activate:S,deactivate:aj,createMusicPreview:J,start:s,stop:ai,pause:T,play:n,retry:G,volume:K,setMuted:af,orientation:al,seek:ao,hasMiniPlayer:f,getPlayer:V,getPlayerId:U,getContainerId:r,getPlayerContainer:F,getPlayerContainerWrapper:w,getOptions:x,prolongPayment:k,isPlaying:Z,isEnded:g,isSilent:ap,createPlayerContainerId:ak,createPlayerElementId:q,initTimestamp:v,destroyTimestamp:A,changeAnnotations:W,callToStream:aa,showTooltip:ar,hideTooltip:Q};});