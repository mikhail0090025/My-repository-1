define(["jquery","OK/has","OK/AttachPicker","FileAPI","OK/utils/utils","OK/logger"],function(g,c,h,d,q,r){var l="PHOTOUPLOADED",f="FILE",p=50*1024*1024,b="OK/messages2/app";c.add("filereader",function(){return window.FileReader!==undefined;});var a=function(){};a.prototype={activate:function(w){var x=this.hookElem=g(w),y=x.data("min-size-check"),v=this;var s=x.data("object-id");this.picker=h.get(s);this.dropArea=x.parent();this.minSizeCheck=typeof y==="undefined"||y;var u=x.attr("data-attach-upload-type");this.attachType=u?u:l;this.args={limit:"10",allocateAt:x.data("allocate-url")};this.hoverListener=function(z){g(this).toggleClass("__dnd",z);};if(d.support.dnd){this.dropListener=this.onFileSelect.bind(this);this.dropArea.dnd(this.hoverListener,this.dropListener);}var t=g(w);if(t.is(":input")){t.on("change",m.bind(v));}x.data("uploader",v);},deactivate:function(){this.hookElem.removeData();this.hookElem.off("change");if(d.support.dnd){this.dropArea.offdnd(this.hoverListener,this.dropListener);}this.dropArea.off();},onFileSelect:function(){var s=this;var t=arguments;OK.loader.use(["OKPhotoUploader"],function(){n.apply(s,t);});}};function m(t){var s=this;OK.loader.use(["OKPhotoUploader"],function(){var u=d.getFiles(t);n.call(s,u);d.reset(t.target||t.srcElement||t.currentTarget);});}function j(t,u,v){var s=[];u.forEach(function(w){if(!e(w)){s.push(w.photoId);}});if(s.length==0){v(u);return;}setTimeout(function(){q.ajax({url:t,data:{ids:s}}).done(function(w){if(w&&w.finished){o(u,w.errorIds);v(u);}else{j(t,u,v);}}).fail(function(){r.error("messagesLayer.error","attachWaitProcessFailed");});},1000);}function o(t,s){if(t&&t.length&&s&&s.length){t.forEach(function(u){if(s.indexOf(u.photoId)>-1){u.errorMsg="processing";}});}}function e(s){return s.errorMsg||s.response&&s.response.error;}function n(s){var z=this.picker.objectId;if(z&&z.indexOf("tt_")===0&&require.defined(b)){require(b).attachesSelected({objectId:z,attaches:s.map(function(D){return{type:"PHOTO",file:D};})});g("#popLayer_mo",".js-photo-attach-dialog").click();return;}var B=this;var y=h.startSession(this.picker.objectId);var u=this.attachType;var A=u===f&&B.hookElem&&B.hookElem.attr("data-file-check-url");var t=Object.create(OK.photoUpload.controllers.AbstractContoller);OK.util.extend(t,{onPause:function(D,E){},onBlockerError:function(E){if(E&&this.files){for(var D=0;D<this.files.length;D++){this.files[D].errorMsg=E;}onComplete(this.files);}},onStart:function(F){var E=[];for(var D=0;D<F.length;++D){E.push(h.serialize(F[D].fileId,u));}g("#popLayer_mo",".js-photo-attach-dialog").click();B.picker.on("update.uploader"+y.sessionId,function(){for(var H=0;H<F.length;++H){var G=F[H];G.attachItem=g(".attachItem"+G.fileId,y.previewContainer);k(G);}});h.add(B.picker.objectId,E);return true;},onProgress:function(H,G,F,D){var E=0;if(D){E=Math.round(D*100);}if(F&&F.progressBar){F.progressBar.attr("style","width: "+E+"%;");}},onFileComplete:function(F,E,D){if(!D){return;}if(D.progressBar){D.progressBar.attr("style","width: 100%;");}OK.photoUpload.logSuccess("attach_uploader_file_complete");},onComplete:function(E){var D=function(F){var P=[],O=[];for(var L=0;L<F.length;++L){var J=F[L];var M=h.serialize(J.fileId,u);P.push(M);var N=e(J);var I;if(N){var H=J.response?parseInt(J.response.id,16):J.fileId;if(isNaN(H)){H=-OK.util.nextId();}I=h.serialize(H,"PHOTOERROR",N);}else{var G=J.response?parseInt(J.response.id,16):J.photoId;var K=J.response?J.response.token:undefined;I=h.serialize(G,u,undefined,K);}O.push(I);}B.picker.off("uploader"+y.sessionId);h.replace(B.picker.objectId,P,O,y);};if(A&&E.length){j(A,E,D);}else{D(E);}}});for(var w=0;w<s.length;++w){s[w].fileId=-OK.util.nextId();}t.files=s;t.args=this.args;t.skipMinSizeCheck=!this.minSizeCheck;var C={abortCurrentRequest:false,attachExif:this.hookElem&&this.hookElem.data("attach-exif"),attachType:u};var v=this.hookElem&&this.hookElem.attr("data-file-upload-size-limit");if(v){C.fileUploadSizeLimit=v;}var x=this.hookElem&&this.hookElem.attr("data-unsupported-ext");if(x){x=x.replace(",","|");C.unsupportedExtensionsRegexp=new RegExp("("+x+")$");}OK.photoUpload.addBatchToQueue("AttachUploader"+y.sessionId,s,t,C);}function i(s){if(/image/.test(s.imgSrc)){s.attachImg.attr("src",s.imgSrc);return true;}return false;}function k(t){t.attachImg=g(".preview-image",t.attachItem);t.progressBar=g(".progress_bar",t.attachItem);if(!t.attachImg.length||t.size>p||!c("filereader")){return;}if(i(t)){return;}var s=new FileReader();s.onload=function(u){t.imgSrc=u.target.result;i(t);g(this).unbind();};s.readAsDataURL(t);}return a;});