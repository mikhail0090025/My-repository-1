define(["OK/logger","jquery","OK/utils/debounce","OK/utils/utils","OK/OKVideo"],function(p,b,a,k,q){var l="video.autoplay.flow",j="play_viewport",o="pause_viewport",d="out_viewport",c="viewport_player";var g={};var h=null;var f=null;var n=false;function i(){return !(window.odklMusic&&odklMusic.playingTrack());}function e(u,t,y,x,w,s,v){u.flashvars.silent="1";u.flashvars.statType="auto";if(s&&(s.policy==="COUNTDOWN"||s.policy==="DELAY")){u.flashvars.statType="autodelay";}this.startPolicy=s;this.badgeEl=t.querySelector(".vid-card_badge-autoplay");this.timeEl=t.querySelector(".vid-card_badge-time");n=v;this.autoplayScrollHandler=a(w,function(){if(!i()||q.hasMiniPlayer()){return;}var B=q.getPlayerId(),A=q.getPlayer(),C=q.isPlaying(),z=A&&k.isElementInViewport(A);if(C&&z){return;}if(B===x){if(z){this._debounce(A,q.play,j);}else{if(C){q.pause();p.success(l,o,c);}else{this.deactivate();}}}else{if(k.isElementInViewport(t)){this._debounce(t,this._startPlayer.bind(this),j,u,y,x);}else{this._stopPlayer();}}}.bind(this));b(window).on("scroll",this.autoplayScrollHandler);}e.prototype._startPlayer=function(s,v,u){if(h){return;}if(!this.startPolicy||!this.badgeEl||!this.timeEl){q.start(s,v,u);return;}var w=function(x){if(this.startPolicy.policy==="COUNTDOWN"){this.badgeEl.classList.remove("invisible");this.timeEl.innerHTML=x;}}.bind(this);var t=Math.round(this.startPolicy.delay/1000);w(t);f=this;h=setInterval(function(){if(q.isPlaying()){this._stopPlayer();}else{if(!--t){this._stopPlayer();q.start(s,v,u);}else{w(t);}}}.bind(this),1000);};e.prototype._stopPlayer=function(){if(this===f&&h){clearInterval(h);h=null;f=null;this.badgeEl.classList.add("invisible");}};e.prototype._debounce=a(50,function(s,u,t){if(n&&(!s||!k.isElementInViewport(s))){p.success(l,d,c);}u.apply(this,Array.prototype.slice.call(arguments,3));p.success(l,t,c);});e.prototype.deactivate=function(){b(window).off("scroll",this.autoplayScrollHandler);};function r(u,y,x,w,s,v){var t=document.getElementById(y);if(!t){return;}g[y]=new e(u,t,y,x,w,s,v);}function m(s){if(g[s]){g[s].deactivate();g[s]=null;}}return{activateViewportPlayer:r,deactivateViewportPlayer:m};});