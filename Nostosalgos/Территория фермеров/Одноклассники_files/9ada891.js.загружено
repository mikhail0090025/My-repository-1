define(["OK/utils/throttle","OK/utils/utils"],function(j,i){var k={};var l={TOP:"top",SCROLL:"scroll",BOTTOM:"bottom"};var e={UP:"up",DOWN:"down"};var h=document.documentElement.classList.contains("small-toolbar")?48:76;var f=i.gwtExperimentsCfg.mch;function d(m){return m.getBoundingClientRect().top+window.pageYOffset;}function g(m){this.fixedTopThreshold=h;this.wrapperAbsoluteTop=0;this.topShift=0;this.stickyWrapper=m;this.stickyContainer=document.querySelector(m.getAttribute("data-sticky-container"))||m.firstChild;this.scrollContainer=document.querySelector(m.getAttribute("data-scroll-container"))||window;this.mainContentColumn=document.querySelector(m.getAttribute("data-main-content-column"));this.scrollHandler=j(10,this.onScroll.bind(this));this.resizeHandler=j(10,this.onResize.bind(this));this.init(true);this.render();this.scrollContainer.addEventListener("scroll",this.scrollHandler,false);window.addEventListener("resize",this.resizeHandler,false);}g.prototype.init=function(o){var m=d(this.stickyWrapper);this.scrollDelta=0;this.scrollPosition=window.pageYOffset;this.scrollDirection=null;if(this.scrollPosition<150){o=true;}if(o){this.setTopShift(0);this.setState(l.SCROLL);}else{if(this.wrapperAbsoluteTop&&this.topShift&&(this.state===l.SCROLL)){var n=this.topShift+(this.wrapperAbsoluteTop-m);this.setTopShift(n);this.setState(l.SCROLL);}}if(this.state===l.SCROLL){this.wrapperAbsoluteTop=m;}};g.prototype.onScroll=function(){var m=window.pageYOffset;if(m===this.scrollPosition){return;}this.scrollDelta=m-this.scrollPosition;this.scrollDirection=this.scrollDelta>0?e.DOWN:e.UP;this.scrollPosition=m;this.render();};g.prototype.onResize=function(){this.render();};g.prototype.destroy=function(){this.scrollContainer.removeEventListener("scroll",this.scrollHandler);window.removeEventListener("resize",this.resizeHandler);};g.prototype.setState=function(n){var m=this.stickyContainer.classList;switch(n){case l.TOP:m.remove("__fixed-bottom");m.add("__fixed-top");this.stickyContainer.style.marginTop=0;break;case l.SCROLL:m.remove("__fixed-top","__fixed-bottom");this.stickyContainer.style.marginTop=this.topShift+"px";break;case l.BOTTOM:m.remove("__fixed-top");m.add("__fixed-bottom");this.stickyContainer.style.marginTop=0;break;}this.state=n;};g.prototype.setTopShift=function(m){if(this.topShift!==m){this.topShift=m<0?0:m;}};g.prototype.render=function(){var o=window.pageYOffset;var p=window.innerHeight-this.fixedTopThreshold;var q=this.stickyContainer.getBoundingClientRect();var m=q.height;var n=d(this.stickyWrapper);if((!(f&&OK.Layers.isAnyLayerOpened))&&(document.documentElement.scrollHeight-document.body.clientHeight)<o){return;}if(document.documentElement.scrollHeight<=(n+m)){this.init(true);return;}if(this.mainContentColumn){if(this.stickyWrapper.clientHeight>(this.mainContentColumn.clientHeight+12)){this.init(true);return;}}if(m<=p){if(o>(n-this.fixedTopThreshold)){this.setState(l.TOP);}else{this.init(true);}}else{if(this.scrollDirection===e.UP){if((n-this.fixedTopThreshold)>o){this.init(true);return;}switch(this.state){case (l.SCROLL):if(q.top>this.fixedTopThreshold){this.setState(l.TOP);}break;case (l.BOTTOM):this.setTopShift(o+q.top-n-this.scrollDelta);this.setState(l.SCROLL);break;}}if(this.scrollDirection===e.DOWN){switch(this.state){case (l.TOP):this.setTopShift(o+q.top-n);this.setState(l.SCROLL);break;case (l.SCROLL):if(q.bottom<=window.innerHeight){this.setState(l.BOTTOM);}break;}}if(this.scrollDirection===null&&this.topShift===0){if(o>(n-this.fixedTopThreshold)){this.setState(l.TOP);}}}};function c(m){return m.getAttribute("data-sticky-id");}function b(o){var n=c(o);var m=new g(o);if(!n){throw new Error("data-sticky-id must be specified");}k[n]=m;return m;}function a(n){var m=c(n);if(m){k[m].destroy();delete k[m];}}return{activate:b,deactivate:a};});