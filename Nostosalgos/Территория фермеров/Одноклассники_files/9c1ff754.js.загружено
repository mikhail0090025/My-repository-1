define(["OK/logger","OK/utils/vanilla","OK/pms!photoUploaderConfig"],function(t,n,r){var o=3;var d="|";var c=/st\.albumIds=(\d+)/;var s=document.body;var l=null;var i=0;var b=(r.appConfig.commonPhotoStates||"").split(d);var f=(r.appConfig.unsortedPhotoStates||"").split(d);var g=(r.appConfig.photoAlbumStates||"").split(d);function e(u,v){j().then(function(w){if(w){w.uploadPhotos(u,v);}});}function j(){if(!l){var v=r.appConfig.root+r.appConfig.app;var u=Date.now();l=new Promise(function(x,w){require([v],function(y){y(s,{config:r}).then(function(z){z.addEventListener("redirect-to",p);z.addEventListener("upload-complete",m);z.addEventListener("log-stats",a);z.addEventListener("log-error",q);x(z);},w);},function(y){w(y.requireType);});}).then(function(w){t.duration("photo.uploader",Math.abs(Date.now()-u),"resolve");return w;},function(w){require.undef(v);l=null;if(i<o){i++;return j();}else{t.error("photo.uploader","resolve.fail");q({detail:w});}});}return l;}function p(v){var u=v.detail;navigateOnUrlFromJS(u);}function m(x){var u=x.detail;var w=OK.getCurrentDesktopModelId();var v=OK.getCurrentStateLink();if(u&&h(w,v,u.id)){n.ajax({url:v}).then(n.updateBlockModelCallback);}}function h(w,v,u){return b.indexOf(w)!==-1||(f.indexOf(w)!==-1&&!u)||(g.indexOf(w)!==-1&&k(v)===u);}function k(v){var u=c.exec(v);if(u){return parseInt(u[1],10);}}function a(u){t.success("photo.uploader","stats",JSON.stringify(u.detail));}function q(u){t.success("photo.uploader","error",u.detail);}return{uploadPhotos:function(u,v){i=0;e(u,v);}};});