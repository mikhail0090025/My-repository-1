define(["OK/utils/dom","OK/logger"],function(o,r){var n="__video",a="__last",i="__ready",b="data-auto-play",m="transitionend",q="ended",e="loadeddata",g="click",d="mouseenter",k="mouseleave",l=[],j=document.createElement("video"),f=j.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')!=="",p=OK.util.isSafari(),h=function(){l.forEach(function(s){s.stop();});};(function(){r.success("messagesLayer","livesticker","supportsMp4_"+f);})();var c=function(v){this.element=v;this.first=o.firstByClass(v,"js-live-sticker_first");this.video=o.firstByClass(v,"js-live-sticker_video");this.last=o.firstByClass(v,"js-live-sticker_last");this.loopCount=this.video&&this.video.getAttribute("data-loop-count")||0;this.delay=this.element.getAttribute("data-delay")||1000;this.infinitePlayDelay=this.element.getAttribute("data-infinity-play-delay");this.playing=false;if(this.video){var t=this,u=t.element.getAttribute("data-play-on-hover")==="true",s=u?d:g;t.video.load();t.video.addEventListener(e,function w(){t.element.playListener=function(x){if(!t.playing){t.playFirstFrame(false);}};t.element.addEventListener(s,t.element.playListener);if(u){t.element.stopListener=function(x){t.stop();};t.element.addEventListener(k,t.element.stopListener);}if(t.element.hasAttribute(b)){t.element.removeAttribute(b);t.playFirstFrame(true);}else{t.element.classList.add(i);}t.video.removeEventListener(e,w);});}};c.prototype={playFirstFrame:function(t){var s=this,u=s.element.classList,v=u.contains(a);if(s.element.hasAttribute("data-stop-all-on-play")){h();}s.onVideoFadeIn=function(){s.playVideo();s.video.removeEventListener(m,s.onVideoFadeIn);};s.video.addEventListener(m,s.onVideoFadeIn);s.setIsPlaying(true);r.success("messagesLayer","livesticker",t?"play.auto":"play.click");if(v||t){if(v){s.video.currentTime=0.01;if(p){s.video.load();}u.remove(a);}clearTimeout(s.timeout);s.timeout=setTimeout(function(){u.add(n);},s.delay);}else{u.add(n);}},playVideo:function(){var s=this,t=s.video;s.onPlayEnded=function(){s.loopCountLeft--;if(s.loopCountLeft>0){this.play();}else{t.removeEventListener(q,s.onPlayEnded);s.playLastFrame();}};t.addEventListener(q,s.onPlayEnded);s.loopCountLeft=s.loopCount;t.play();},playLastFrame:function(){var t=this.element.classList,s=this;t.remove(n);t.add(a);s.setIsPlaying(false);if(s.infinitePlayDelay){clearTimeout(s.infinitePlayTimeout);s.infinitePlayTimeout=setTimeout(function(){s.playFirstFrame(true);},s.infinitePlayDelay);}},setIsPlaying:function(s){this.element.classList.toggle(i,!s);this.playing=s;},stop:function(){if(this.playing){var s=this,t=s.video;clearTimeout(s.timeout);clearTimeout(s.infinitePlayTimeout);t.removeEventListener(m,s.onVideoFadeIn);if(s.element.classList.contains(n)){t.removeEventListener(q,s.onPlayEnded);t.pause();s.playLastFrame();}else{s.setIsPlaying(false);}}},deactivateSticker:function(){var s=this,t=s.element;s.stop();t.removeEventListener(g,t.playListener);t.removeEventListener(d,t.playListener);if(t.stopListener){t.removeEventListener(k,t.stopListener);t.stopListener=null;}t.playListener=null;}};return{activate:function(s){if(!f){return;}l.push(new c(s));},deactivate:function(s){l.some(function(u,t){if(u.element===s){u.deactivateSticker();l.splice(t,1);return true;}});}};});