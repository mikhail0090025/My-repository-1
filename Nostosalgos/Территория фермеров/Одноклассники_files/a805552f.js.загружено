define("OK/autophotopins/PhotoPins",["OK/utils/utils","OK/utils/dom","OK/logger"],function(i,e,j){var h="photo.autopins";var a="auto-photo-pins-hover",d="auto-photo-pins-remove",c="auto-photo-pins-restore",f="auto-photo-pins-submit";function b(l,k){this.parent=l;this.element=k;this.removed=false;this.userId=parseFloat(k.getAttribute("data-user-id"));this.photoIds=JSON.parse(k.getAttribute("data-photo-ids")).map(parseFloat);this.removeButton=e.firstByClass(k,"photo-pins_pin_remove");this.restoreButton=e.firstByClass(k,"photo-pins_pin_restore");this.bindedOnRemove=this.onRemove.bind(this);this.bindedOnRestore=this.onRestore.bind(this);this.bindedOnMouseOver=this.onMouseOver.bind(this);this.bindedOnMouseOut=this.onMouseOut.bind(this);this.removeButton.addEventListener("click",this.bindedOnRemove);this.restoreButton.addEventListener("click",this.bindedOnRestore);this.element.addEventListener("mouseover",this.bindedOnMouseOver);this.element.addEventListener("mouseout",this.bindedOnMouseOut);}b.prototype={onRemove:function(){document.dispatchEvent(new CustomEvent(d,{detail:{userId:this.userId}}));},onRestore:function(){document.dispatchEvent(new CustomEvent(c,{detail:{userId:this.userId}}));},onMouseOver:function(){document.dispatchEvent(new CustomEvent(a,{detail:{userId:this.userId,on:true}}));},onMouseOut:function(){document.dispatchEvent(new CustomEvent(a,{detail:{userId:this.userId,on:false}}));},deactivate:function(){this.removeButton.removeEventListener("click",this.bindedOnRemove);this.restoreButton.removeEventListener("click",this.bindedOnRestore);this.element.removeEventListener("mouseover",this.bindedOnMouseOver);this.element.removeEventListener("mouseout",this.bindedOnMouseOut);}};function g(k){}g.EVENT_HOVER=a;g.EVENT_REMOVE=d;g.EVENT_RESTORE=c;g.EVENT_SUBMIT=f;g.prototype={activate:function(l){var k=this;this.element=l;this.widgetId=this.element.getAttribute("data-widget-id");this.activityId=this.element.getAttribute("data-activity-id");this.viewMode=this.element.getAttribute("data-view-mode");this.photoIds=JSON.parse(l.getAttribute("data-photo-ids")).map(parseFloat);this.editorEnabled=l.getAttribute("data-editor-enabled")==="true";this.editorExtended=l.getAttribute("data-editor-extended")==="true";this.rightColumn=l.getAttribute("data-right-column")==="true";this.hideOnSubmit=l.getAttribute("data-hide-on-submit")==="true";this.ownUnconfirmedPreview=l.getAttribute("data-own-unconfirmed-preview")==="true";this.canRefreshUnconfirmedAlbum=l.getAttribute("data-can-refresh-album")=="true";this.containerPath=l.getAttribute("data-container-path");this.actionCounter=0;this.submitted=false;this.switchButton=e.firstByClass(l,"photo-pins_switch");if(this.switchButton){this.switchButton.addEventListener("click",this.switchEditing.bind(this));}this.submitButtons=e.byClass(l,"photo-pins_submit");if(this.submitButtons){this.bindedOnSubmit=this.onSubmit.bind(this);this.submitButtons.forEach(function(m){m.addEventListener("click",k.bindedOnSubmit);});}this.submitAllButton=e.firstByClass(l,"photo-pins_submit-all");if(this.submitAllButton){this.bindedOnSubmitAll=this.onSubmitAll.bind(this);this.submitAllButton.addEventListener("click",this.bindedOnSubmitAll);}this.pinsList=l.querySelector(".photo-pins_pins");this.pins=[];e.byClass(this.pinsList,"photo-pins_pin").forEach(function(m){k.pins.push(new b(k,m));});this.removedPins=[];this.removedPinsContainer=e.firstByClass(l,"photo-pins_removed");this.removedPinsList=e.firstByClass(l,"photo-pins_removed-pins");this.removedPinsCounter=e.firstByClass(l,"photo-pins_removed_counter");this.bindedHandleEventSubmit=this.onEventSubmit.bind(this);this.bindedOnRemovePin=this.onRemovePin.bind(this);this.bindedOnRestorePin=this.onRestorePin.bind(this);document.addEventListener(f,this.bindedHandleEventSubmit);document.addEventListener(d,this.bindedOnRemovePin);document.addEventListener(c,this.bindedOnRestorePin);},onRemovePin:function(m){var l=this.pins.findIndex(function(n){return n.userId===m.detail.userId;});if(l<0){return;}var k=this.pins[l];this.pins.splice(l,1);this.removedPinsList.appendChild(k.element);this.removedPins.push(k);this.removedPinsCounter.textContent=this.removedPins.length;this.removedPinsContainer.classList.toggle("invisible",this.removedPins.length===0);if(this.removedPins.length===1&&this.editorEnabled&&!this.editorExtended){this.switchEditing();}this.logUserAction("removePin");},onRestorePin:function(m){var l=this.removedPins.findIndex(function(n){return n.userId===m.detail.userId;});if(l<0){return;}var k=this.removedPins[l];this.removedPins.splice(l,1);this.pinsList.appendChild(k.element);this.pins.push(k);this.removedPinsCounter.textContent=this.removedPins.length;this.removedPinsContainer.classList.toggle("invisible",this.removedPins.length===0);if(this.removedPins.length===0&&this.editorEnabled&&!this.editorExtended){this.switchPreview();}this.logUserAction("restorePin");},switchEditing:function(){this.element.classList.remove("__preview");this.element.classList.add("__editing");this.viewMode="EDITING";this.logUserAction("switch");},switchPreview:function(){this.element.classList.remove("__editing");this.element.classList.add("__preview");},onSubmit:function(){var k={};var l={};this.removedPins.forEach(function(m){l[m.userId]=true;m.photoIds.forEach(function(n){k[n]=true;});});this.pins.forEach(function(m){m.photoIds.forEach(function(n){k[n]=true;});});this.logUserAction("submit");this.doSubmit(Object.keys(k),Object.keys(l));},onSubmitAll:function(){this.logUserAction("submit-all");this.doSubmit(this.photoIds,[]);},doSubmit:function(k,n){var l=this;var m={"st.v.photoIds":k.join(","),"st.v.rejectedUserIds":n.join(","),"st.v.activityId":this.activityId,"st.v.viewMode":this.viewMode,"st.v.cpath":this.containerPath};return i.ajax({type:"POST",url:"/web-api/submit-photo-pins",data:m}).done(function(s,p,u){try{var t=s.acceptedUserIds.map(parseFloat),r=s.rejectedUserIds.map(parseFloat),o=s.photoIds.map(parseFloat);document.dispatchEvent(new CustomEvent(f,{detail:{sender:l,photoIds:o,acceptedUserIds:t,rejectedUserIds:r}}));}catch(q){}l.submitted=true;});},onEventSubmit:function(n){if(n.detail.sender===this&&this.hideOnSubmit){i.updateBlocks("","",[this.widgetId]);if(this.ownUnconfirmedPreview&&this.canRefreshUnconfirmedAlbum){o(this.activityId);}var m=e.firstByClass(document,"js-auto-pins-wrap");if(m){m.style.display="none";}return;}if(!l(this.photoIds,n.detail.photoIds)){return;}var k=p(this.photoIds,n.detail.photoIds);if(k.length===0){i.updateBlocks("","",[this.widgetId]);return;}i.ajax({url:"/dk",type:"POST",data:{cmd:"AutoPhotoPinsBlock","st.v.activityId":this.activityId,"st.v.widgetId":this.widgetId,"st.v.photoIds":k.join(","),"st.v.editorEnabled":this.editorEnabled,"st.v.editorExtended":this.editorExtended,"st.v.rightColumn":this.rightColumn,"st.cmd":"userMain"}}).done(function(s,q,t){var r=i.getBlockIds(s,q,t);if(r){i.updateBlocks(s,q,r);}});function l(q,r){for(var s=0;s<r.length;s++){if(q.indexOf(r[s])===-1){return false;}}return true;}function p(r,q){var s=r.slice();q.forEach(function(t){var u=s.indexOf(t);if(u>=0){s.splice(u,1);}});return s;}function o(q){i.ajax({url:"/dk",type:"POST",data:{"st.cmd":"userUnconfirmedPhotopins",cmd:"UserPhotoUnconfirmedPinsMRB","st._aid":q}}).done(i.updateBlockModelCallback);}},deactivate:function(){var k=this;if(!this.submitted){this.removedPins.slice().forEach(function(l){l.onRestore();});}if(this.switchButton){e.removeAllListeners(this.switchButton);}if(this.submitButtons){this.submitButtons.forEach(function(l){l.removeEventListener("click",k.bindedOnSubmit);});}this.pins.forEach(function(l){l.deactivate();});this.removedPins.forEach(function(l){l.deactivate();});document.removeEventListener(f,this.bindedHandleEventSubmit);document.removeEventListener(d,this.bindedOnRemovePin);document.removeEventListener(c,this.bindedOnRestorePin);},logUserAction:function(k){j.success(h,k,Math.min(this.actionCounter++,15));}};return g;});define("OK/autophotopins/PhotoFeed",["OK/utils/dom","OK/utils/utils","OK/autophotopins/PhotoPins"],function(d,a,c){function b(f,g){var e=this;this.element=g;this.photoId=parseFloat(g.getAttribute("data-photo-id"));this.pins=d.byClass(g,"photo-pins-feed_pin");this.pinsById={};this.pins.forEach(function(h){var i=parseFloat(h.getAttribute("data-pin-id"));e.pinsById[i]=h;});this._bindedHandleHover=this._handleHover.bind(this);this._bindedHandleRemove=this._handleRemove.bind(this);this._bindedHandleRestore=this._handleRestore.bind(this);this._bindedHandleSubmit=this._handleSubmit.bind(this);document.addEventListener(c.EVENT_HOVER,this._bindedHandleHover);document.addEventListener(c.EVENT_REMOVE,this._bindedHandleRemove);document.addEventListener(c.EVENT_RESTORE,this._bindedHandleRestore);document.addEventListener(c.EVENT_SUBMIT,this._bindedHandleSubmit);}b.prototype._handleHover=function(f){var e=this.pinsById[f.detail.userId];if(e){e.classList.toggle("visible",f.detail.on);}};b.prototype._handleRemove=function(f){var e=this.pinsById[f.detail.userId];if(e){e.classList.toggle("__removed",true);}};b.prototype._handleRestore=function(f){var e=this.pinsById[f.detail.userId];if(e){e.classList.toggle("__removed",false);}};b.prototype._handleSubmit=function(e){if(e.detail.photoIds.indexOf(this.photoId)>=0){this.deactivate();d.remove(this.element);}};b.prototype.deactivate=function(){document.removeEventListener(c.EVENT_HOVER,this._bindedHandleHover);document.removeEventListener(c.EVENT_REMOVE,this._bindedHandleRemove);document.removeEventListener(c.EVENT_RESTORE,this._bindedHandleRestore);document.removeEventListener(c.EVENT_SUBMIT,this._bindedHandleSubmit);};return b;});define("OK/autophotopins/PhotoLayer",["OK/autophotopins/PhotoPins"],function(b){var a;return{init:function(c){if(a){this.destroy();}a={handleHover:function(d){c.showPhotoPin(String(d.detail.userId),d.detail.on);},handleSubmit:function(d){d.detail.acceptedUserIds.forEach(function(e){c.acceptAutoPhotoPin(String(e));});d.detail.rejectedUserIds.forEach(function(e){c.rejectAutoPhotoPin(String(e));});},handleRemove:function(d){c.disablePhotoPin(String(d.detail.userId),true);},handleRestore:function(d){c.disablePhotoPin(String(d.detail.userId),false);}};document.addEventListener(b.EVENT_HOVER,a.handleHover);document.addEventListener(b.EVENT_SUBMIT,a.handleSubmit);document.addEventListener(b.EVENT_REMOVE,a.handleRemove);document.addEventListener(b.EVENT_RESTORE,a.handleRestore);},destroy:function(){if(!a){return;}document.removeEventListener(b.EVENT_HOVER,a.handleHover);document.removeEventListener(b.EVENT_SUBMIT,a.handleSubmit);document.removeEventListener(b.EVENT_REMOVE,a.handleRemove);document.removeEventListener(b.EVENT_RESTORE,a.handleRestore);a=null;}};});define("OK/autophotopins/PhotoPreview",["OK/utils/dom","OK/utils/utils","OK/autophotopins/PhotoPins"],function(d,a,c){function b(e){}b.prototype={activate:function(e){this.currentPhotoId=parseFloat(e.getAttribute("data-current-photo-id"));this.currentPhotoIndex=parseInt(e.getAttribute("data-current-photo-index"));this.photoIds=JSON.parse(e.getAttribute("data-photo-ids")).map(parseFloat);this.nextPhotoLink=e.getAttribute("data-next-photo-link");this.bindedOnEventSubmit=this.onEventSubmit.bind(this);document.addEventListener(c.EVENT_SUBMIT,this.bindedOnEventSubmit);this.nextBtn=e.querySelector(".photo-layer_slider_ctrl.__next");this.prevBtn=e.querySelector(".photo-layer_slider_ctrl.__prev");this.bindedOnNextBtn=this.onNextBtn.bind(this);this.bindedOnPrevBtn=this.onPrevBtn.bind(this);this.nextBtn.addEventListener("click",this.bindedOnNextBtn);this.prevBtn.addEventListener("click",this.bindedOnPrevBtn);this.holder=d.firstByClass(e,"photo-layer_slider_hld");this.offset=0;this.slider=d.firstByClass(e,"photo-layer_slider");this.bindedOnMouseOver=this.onMouseOver.bind(this);this.bindedOnMouseOut=this.onMouseOut.bind(this);this.slider.addEventListener("mouseover",this.bindedOnMouseOver);this.slider.addEventListener("mouseout",this.bindedOnMouseOut);this.focusOn(this.currentPhotoIndex);},onMouseOver:function(){var f=0,e=this.holder.scrollWidth-this.holder.clientWidth;this.prevBtn.classList.toggle("hidden",this.offset===f);this.nextBtn.classList.toggle("hidden",this.offset===e);},onMouseOut:function(){this.prevBtn.classList.add("hidden");this.nextBtn.classList.add("hidden");},onEventSubmit:function(g){var e=g.detail.photoIds;if(f(e,this.photoIds)){OK.photoLayer.close();return;}if(e.length===1&&e[0]===this.currentPhotoId){if(this.nextPhotoLink){a.ajax({type:"POST",url:this.nextPhotoLink}).done(a.updateBlockModelCallback);}else{OK.photoLayer.close();}}function f(h,j){for(var k=0;k<j.length;k++){if(h.indexOf(j[k])===-1){return false;}}return true;}},onNextBtn:function(){var g=this.holder.childNodes;for(var f=0;f<g.length;f++){var e=g.item(f);if(e.offsetLeft+e.scrollWidth>this.offset+this.holder.clientWidth){this.changeOffset(e.offsetLeft,true);return;}}},onPrevBtn:function(){var g=this.holder.childNodes;for(var f=g.length-1;f>=0;f--){var e=g.item(f);if(e.offsetLeft<this.offset){var h=e.offsetLeft+e.scrollWidth-this.holder.clientWidth;this.changeOffset(h,true);return;}}},focusOn:function(g){var h=this.holder.childNodes,f=h[g],i=f.offsetLeft+f.scrollWidth/2,e=this.offset+this.holder.clientWidth/2,j=i-e;this.changeOffset(j,false);},changeOffset:function(g,f){var h=0,e=this.holder.scrollWidth-this.holder.clientWidth;g=Math.min(g,e);g=Math.max(g,h);this.setTransform(-g,f);this.offset=g;},setTransform:function(e,f){var g="transform: translateX("+e+"px);",i="transition: transform .6s ease-out;",h="transition: unset";this.holder.style.cssText=g+(f?i:h);},deactivate:function(){this.nextBtn.removeEventListener("click",this.bindedOnNextBtn);this.prevBtn.removeEventListener("click",this.bindedOnPrevBtn);this.slider.removeEventListener("mouseover",this.bindedOnMouseOver);this.slider.removeEventListener("mouseout",this.bindedOnMouseOut);}};return b;});define("b/autophotopins",["OK/autophotopins/PhotoPins","OK/autophotopins/PhotoFeed","OK/autophotopins/PhotoLayer","OK/autophotopins/PhotoPreview"],{});