define("OK/messages/Chatname",["OK/utils/dom","OK/utils/utils","OK/messages/MessagesPushController"],function(p,r,f){var a="__edit",j="ConversationNameText",d,e,h,g,m;function i(s){s.stopPropagation();}function q(){e.classList.remove(a);m.removeEventListener("click",q);}function c(){var s=OK.hookModel.getHookById(j);g.value=s.element.getAttribute("title");q();}function k(){e.classList.add(a);g.focus();g.selectionStart=g.selectionEnd=1000;m.addEventListener("click",q);}function n(s){var t=document.createElement("div");t.innerText=s;return t.innerHTML;}function l(){var v=g.value.trim(),s=n(v),t=OK.hookModel.getHookById(j),u=t.element.getAttribute("title");if(v.length===0||v===u){g.value=u;q();return;}OK.hookModel.setHookContent(j,s);g.setAttribute("value",v);t.element.setAttribute("title",v);t.element.classList.remove("invisible");if(h){h.classList.add("invisible");}q();r.ajax({url:"/web-api/messages/chatname/change",data:{cid:d,name:s}}).fail(function(){k();}).done(function(w){f.applyNews(w.news);});}function o(s){if(s.keyCode===27){s.preventDefault();s.stopPropagation();q();}else{if(s.keyCode===13){s.preventDefault();s.stopPropagation();l();}}}function b(){OK.Layers.unregisterAll();}return{bind:function(s){s.on("click",".js-chat-name-toggle",k).on("keydown",".js-chat-name-field",o).on("click",".js-chat-name-cancel",c).on("click",".js-chat-name-submit",l);},activate:function(s){d=s.getAttribute("data-id");s=s.parentNode;g=p.firstByClass(s,"js-chat-name-field");h=p.firstByClass(s,"js-chat-name-stub");e=p.parent(s,"js-chat_toolbar");m=document.getElementById("msg_layer_wrapper");g.addEventListener("click",i);},deactivate:function(){g.removeEventListener("click",i);q();g=null;h=null;e=null;m=null;}};});define("OK/autosize",[],function(){function a(){this.resize=this.resize.bind(this);}a.prototype={activate:function(b){this.el=b;b.addEventListener("input",this);if(b.getAttribute&&b.getAttribute("data-on-load")==="1"){this.resize(b);}},deactivate:function(){this.el.removeEventListener("input",this);this.el=null;if(this.timeout){clearTimeout(this.timeout);}},handleEvent:function(b){if(this.timeout){clearTimeout(this.timeout);}this.timeout=setTimeout(this.resize,50);},resize:function(){a.resize(this.el);}};a.resize=function(b){b.style.height="0";b.style.height=b.scrollHeight+"px";};return a;});define("OK/messages/Chatname2",["OK/utils/dom","OK/utils/utils","OK/messages/MessagesPushController","OK/autosize"],function(q,t,g,c){var b="__edit",o="keydown",u="blur",i="ConversationNameText",e,f,a,h,m;function d(w){if(w.keyCode===27){w.preventDefault();w.stopPropagation();s();}else{if(w.keyCode===13){w.preventDefault();w.stopPropagation();k();}}}function s(){a.removeEventListener(o,d);a.removeEventListener(u,l);f.classList.remove(b);}function j(){f.classList.add(b);a.addEventListener(u,l);a.addEventListener(o,d);c.resize(a);a.focus();a.selectionStart=a.selectionEnd=1000;}function p(w){a.value=w;a.setAttribute("data-prev",w);}function r(w){var x=document.createElement("div");x.innerText=w.value;return x.innerHTML;}function v(x){var w=q.firstByClass(document,"js-chat_name_tx_wr"),y=q.firstByClass(w,"js-chat_name_link");if(y&&w){w.classList.toggle("__w-link",x);if(x){x=x.replace(/&amp;/g,"&");y.href=x;y.title=x;}}}function n(x,w){if(x.trim().length===0||x===w){p(w);s();return true;}else{return false;}}function l(y){var x=r(a),w=a.getAttribute("data-prev");n(x,w);}function k(){var x=r(a),w=a.getAttribute("data-prev");if(n(x,w)){return;}s();t.ajax({url:"/web-api/messages/chatname/change",data:{cid:e,name:x}}).fail(function(){j();}).done(function(y){if(y){var z=y.chatTheme;OK.hookModel.setHookContent(i,z);h.element.setAttribute("title",z);p(z);m.innerHTML=z;v(y.chatThemeUrl);g.applyNews(y.news);}});}return{activate:function(w){f=w;e=w.getAttribute("data-id");m=q.firstByClass(f,"js-change-value-tx");m.addEventListener("click",j);a=q.firstByClass(w,"js-change-value-field");h=OK.hookModel.getHookById(i);},deactivate:function(){s();a=null;m.removeEventListener("click",j);m=null;f=null;}};});define("OK/messages/ConversationsList",["OK/capture","OK/utils/utils","OK/utils/dom","OK/messages/MessagesConfig","OK/messages/Helper","OK/logger","OK/discussions/ScrollController","OK/messages/UnsentMessages"],function(l,t,q,u,b,w,p,a){var v={},e=[],c,j="ConversationsList",f,d,n;function m(z,y){var A,x;for(A in z){if(z.hasOwnProperty(A)){x=z[A];if(x){y(A,x);}}}}function k(){var x=this;if(e.length<q.byClass(x.element,"chats_i").length){setTimeout(k.bind(x),200);return;}a.registerAndCheck(function(){var y=a.getUnsentConversations(),z=u.get().addCardOnRestore;e.forEach(function(A){A.unMarkAsUnsent();});y.forEach(function(B){var A=v[B];if(A){A.markAsUnsent();}else{if(z){t.ajax({url:"/dk",data:{cmd:"ConversationsListItem","st.convId":B},timeout:u.get().ajaxTimeout},u.get().ajaxRetryCount).done(function(E,C,F){if(!E||E.length===0){a.removeConv(B);w.success("messagesLayer","retryAddedConvEmpty");}else{var D=t.getBlockIds(E,C,F);x.appendItemPlaceholder(B);t.updateBlocks(E,C,D);A=v[B];A.markAsUnsent(true);w.success("messagesLayer","retryAddedConv");}});}}});});}function o(){if(e.length){return e[0].element.parentNode;}var x=OK.hookModel.getHookById(j);if(x){return x.element;}return document.getElementById("hook_Block_"+j);}function s(x){var y=b.getFilterTab(),z=b.getFilterGroupId();if(!x){return !y;}return y==="GROUP"&&(!z||z===x);}function g(A){var x=o();if(!s(A.groupIdFilter)){return;}if(x){var z=document.createElement("div");z.innerHTML=A.html;var y=z.firstElementChild;y.setAttribute("data-push","true");x.insertBefore(y,x.firstChild);l.captureAndActivate(j,y);}else{w.error("messagesLayer.error","appendConvNoContainer");}}function h(x){c=x;f=x.id;}function i(y){var x=o();return x.querySelector("[data-id='"+y+"']");}function r(A){var x=-1;for(var y=0;y<e.length;y++){var z=e[y];if(z.id==A){x=y;break;}}return x;}return{activate:function(y){this.element=y;var x=this,z;d=document.getElementById("msg_dialogs_list_scroller");n=new p({scrollingContainer:d});if(!x.hasSelected()&&u.get().focusSearchOnOpen){require(["OK/messages/Search"],function(A){A.focusSearchInConvList();});}setTimeout(k.bind(this),100);z=document.getElementById("ConversationsListSearch_field_query");if(z){z.addEventListener("searchEnd",function(){n.scrollToTop();});}},deactivate:function(){this.deselect();},update:function(z){if(b.getFilterTab()=="GROUP"){return;}var y;if(e[0]!==z){y=e.indexOf(z);if(y>0){e.splice(y,1);var x=o();x.insertBefore(z.element,x.firstChild);e.unshift(z);}}},restore:function(x){var y=r(x.id);v[x.id]=undefined;this.add(x,y);},add:function(y,x){v[y.id]=y;if(x&&x>=0&&x<e.length){e.splice(x,0,y);}else{if(y.isPush){e.unshift(y);}else{e.push(y);}}if(y.isActive()){this.deselect();h(y);}},getById:function(x){return v[x];},isEmpty:function(){return d.classList.contains("__empty");},markAsRead:function(y){var x=this.getById(y);return x&&x.markAsRead();},markAsAnswered:function(y){var x=this.getById(y);return x&&x.markAsAnswered();},mute:function(z,y){var x=this.getById(z);if(x){if(y){x.mute();}else{x.unmute();}}},select:function(y){if(!y){return false;}var x=v[y];this.deselect();if(x){x.select();h(x);require(["OK/messages/Search"],function(z){if(z.isSearchInConvList()&&y.indexOf("msg_found_",0)===-1){z.setConversationId(y);}});return true;}return false;},deselect:function(){if(c){c.deselect();var x=c.id;c=null;return x;}return null;},getLastSelectedId:function(){return f;},hasSelected:function(){return !!c;},scrollToTop:function(){n.scrollToTop(function(A){var y=this.element,z=A/5,x=function(){y.scrollTop+=z;if(y.scrollTop>0){requestAnimationFrame(x);}};x();});},onNewMessageAdded:function(y){var x=this.getById(y);if(!x){return;}x.updateTyping(false);},remove:function(A,x){var z=this.getById(A),y;if(!z){return;}v[A]=undefined;y=e.indexOf(z);if(y>-1){e.splice(y,1);}if(x){return;}if(z.isActive()){require(["OK/messages/MessagesLayer"],function(B){B.reset();c=null;});}z.remove();},removeConversations:function(y){var x=this;y.forEach(function(z){x.remove(z);});},appendItemPlaceholder:function(A){var y="ConvItem_"+A,x,z;if(!OK.hookModel.getHookById(y)){x=o();z=document.createElement("div");z.id="hook_Block_"+y;if(x){x.insertBefore(z,x.firstChild);}OK.hookModel.captureBlockHook(j,z);}},makeVisible:function(y){var x=this.getById(y);if(x&&!n.isVisible(x.element)){n.scrollToCenter(x.element);}},applyUpdatedConversations:function(x){if(x){m(x,function(D,z){var C=v[D];if(z){if(C){OK.hookModel.setHookContent(C.hookId,z.html);}else{if(u.get().convListDuplicatesFix){var A=i(D);if(A){var y=A.getAttribute("data-hookId");var B=y?"true":"false";w.success("messagesLayer","convListUpdateDuplicateFix",B);if(y){OK.hookModel.setHookContent(y,z.html);}else{g(z);}}else{g(z);}}else{g(z);}}}});}},applyTypingStatuses:function(x){if(x){m(x,function(A,y){var z=v[A];if(y&&z){z.applyTyping(y);}});}},applyReadMarks:function(x){if(x){m(x,function(A,y){var z=v[A];if(y&&z){z.applyReadMarks(y);}});}},onConversationClosed:function(x){var y=v[x.convId];if(y){y.onConversationClosed(x);}},updateLastMessage:function(C,B,y,z,D,x){var A=this.getById(C);if(A){A.setLastMessage(B,y,z,D,x);}},items:e};});define("OK/messages/ConversationsManager",["require","OK/messages/ConversationsList","OK/messages/MessagesPushController","OK/utils/utils","OK/logger","OK/messages/MessagesConfig"],function(d){var f=d("OK/messages/ConversationsList"),h=d("OK/messages/MessagesPushController"),i=d("OK/utils/utils"),j=d("OK/logger"),c=d("OK/messages/MessagesConfig"),g;function l(m){return g&&g.id===m?g:null;}function b(o,n){var q,p,m;for(q in o){if(o.hasOwnProperty(q)){m=o[q];p=l(q);if(p&&m){p[n](m);}}}}function e(n,o){var t,s,m,q,p=0;try{for(t in n){p=1;if(n.hasOwnProperty(t)){p=2;m=n[t];p=3;q=o&&o[t];p=4;s=l(t);p=5;if(s&&m){p=6;s.applyNewMessages(m,q?q.newCommentsCount:-1);}}}}catch(r){j.success("messagesLayer","e.addNewMsg_"+p);}}h.register({name:"convMgt_newMsg",priority:h.priority.high,applyNews:function(o){var m=o.newMessages,n=o.updatedConversations;if(n){try{f.applyUpdatedConversations(n);b(n,"applyConvUpdate");}catch(p){j.error("messagesLayer.error","convMgt_newMsg_conv");}}if(m){try{e(m,n);}catch(p){j.error("messagesLayer.error","convMgt_newMsg_msg");}}return true;}});h.register({name:"convMgt_updatedMsg",priority:h.priority.low,applyNews:function(m){var n=m.updatedMessages;if(n){b(n,"applyUpdatedMessages");return true;}return false;}});h.register({name:"convMgt_removedConv",priority:h.priority.medium,applyNews:function(m){var n=m.removed;if(n){f.removeConversations(n);return true;}return false;}});h.register({name:"convMgt_readMarks",priority:h.priority.medium,applyNews:function(m){var n=m.readMarks;if(n){if(c.get().myUnreadLeftColumn){f.applyReadMarks(n);}b(n,"applyReadMarks");return true;}return false;}});h.register({name:"convMgt_typingStatuses",priority:h.priority.medium,applyNews:function(n){var m=n.typingStatuses;if(m){f.applyTypingStatuses(m);b(m,"applyTypingStatuses");return true;}return false;}});h.register({name:"convMgt_convInfoUpdates",priority:h.priority.medium,applyNews:function(n){var m=n.convInfoUpdates;if(m){b(m,"applyConvInfoUpdate");return true;}return false;}});h.register({name:"convMgt_rmPin",priority:h.priority.low,applyNews:function(m){if(m.removedPinsChatIds){if(g&&m.removedPinsChatIds.indexOf(g.id)>-1){g.updatePinnedMessage();}return true;}return false;}});function a(p,m,n){var o=f.getById(p);if(o){return{url:o.getLink(),data:{"st._bh":~~window.innerHeight,"st._bw":~~window.innerWidth},timeout:c.get().ajaxTimeout};}return{url:"/dk",data:{cmd:"ConversationWrapper","st.convId":p,"st.mockId":m,"st.addConv":n?null:"on","st.isFirstConv":f.isEmpty(),"st._bh":~~window.innerHeight,"st._bw":~~window.innerWidth},timeout:c.get().ajaxTimeout};}function k(){return performance?performance.now():new Date().getTime();}return{open:function(o,m,p){var n=this;return new Promise(function(w,v){var r=n.getById(o),q=document.getElementById("chat_loader"),t=f.select(o),u,s;if(r&&r.selected&&!p){q.classList.add("invisible");w();return;}u=a(o,m,t);q.classList.remove("invisible");s=k();i.ajax(u,c.get().ajaxRetryCount).done(function(A,x,C){if(t&&f.getLastSelectedId()!=o){return;}var z=i.getBlockIds(A,x,C);if(!t){t=f.select(o);}if(m){o=C.getResponseHeader("conversation_id");}if(z.length>1&&!t&&o){f.appendItemPlaceholder(o);}else{if(t){f.makeVisible(o);}}i.updateBlocks(A,x,z);var y=k();if(o){var B=o.startsWith("PRIVATE")?"prv":"chat";j.duration("messages-perf",(y-s)*1000,"loadConvContent",B);}else{q.classList.add("invisible");}w();}).fail(function(x,z,y){j.error("messagesLayer.error","convMgr_open_"+z);if(v){v();}});});},getById:function(m){return g&&g.id===m?g:null;},add:function(m){g=m;}};});define("OK/messages/MessageMerger",[],function(){var e="__collapsed",d="__first",a="__single",b="__last";function c(g){return g.classList.contains("__sys");}function f(h,g){return g&&(h.getAttribute("data-authorId")===g.getAttribute("data-authorId"))&&(h.getAttribute("data-groupId")===g.getAttribute("data-groupId"));}return{merge:function(j,h){if(!h||c(h)){return;}var g=f(h,j),i=j&&c(j);if(g&&!i){h.classList.add(e);if(j&&j.getAttribute("data-mergeable")&&h.getAttribute("data-mergeable")){h.classList.remove(a,d);if(!h.nextSibling){h.classList.add(b);}if(j){j.classList.remove(b);if(j.classList.contains(a)){j.classList.remove(a);j.classList.add(d);}}}}else{h.classList.remove(e);}},unmerge:function(j,g){var i=j.classList,h=g.classList;if(h.contains(e)){if(h.contains(a)){h.remove(e);}else{if(i.contains(a)){h.remove(e,a);}else{if(i.contains(d)){i.remove(d);i.add(a);h.remove(e,b);h.add(a);}else{i.add(b);if(h.contains(b)){h.add(a);h.remove(e,b);}else{h.add(d);h.remove(e,b);}}}}}}};});define("OK/messages/DateBar",["OK/utils/dom","OK/messages/MessageMerger"],function(d,c){var h="invisible",a={},g=[],i=(function(){var n,t=-1,o=true,q;function s(){if(o){n.classList.remove("__hidden");o=false;}}function p(){if(!o){n.classList.add("__hidden");o=true;}}function l(u){u=u||0;n.style.transform="translateY("+u+"px)";}function r(v,u){return g.length>v+1?u-g[v+1].offset:undefined;}function m(v,u){var w=g[v],x=u-w.offset,y;if(x>0){y=r(v,u);if(y<0&&y>-30){s();w.hide();l(-(30+y));}else{s();w.hide();l(0);}}else{if(x<=0){w.show();if(x>-6){l(-(30+x));s();}else{p();}}}}function k(v,u){var w=g[v],x=u-w.offset,y;if(x>0){y=r(v,u);if(y>=-30&&y<=0){l(-(30+y));}else{l(0);s();w.hide();}}else{if(x>=-30){l(-(30+x));}}}return{activate:function(u){n=u;t=-1;o=true;},reset:function(){t=-1;p();g.forEach(function(u){u.show();});},enabled:function(){return !!n;},update:function(w,v){this.replace(w);var u=q>v;if(u){m(w,v);}else{k(w,v);}q=v;},replace:function(u){if(t!==u){var v=g[t];if(v){v.show();}t=u;n.innerHTML=g[t].element.innerHTML;}}};}());function b(){g.forEach(function(k){k.offset=k.element.offsetTop;});}function f(k){a[k.id]=k;g.push(k);g.sort(function(m,l){return m.time<l.time?-1:1;});b();}function e(l){a[l.id]=null;var k=g.indexOf(l);if(k>-1){g.splice(k,1);}}function j(k){this.element=k;this.id=k.getAttribute("data-id");this.time=parseInt(k.getAttribute("data-time"),10);this.invisible=this.element.classList.contains(h);this.removed=false;this.hidden=false;this.date=this.element.firstChild.innerHTML;}j.prototype={visible:function(){if(this.invisible){this.invisible=false;this.element.classList.remove(h);b();}},show:function(){if(this.hidden){this.hidden=false;this.element.classList.remove("__hidden");}},hide:function(){if(!this.hidden){this.hidden=true;this.element.classList.add("__hidden");}},remove:function(){if(!this.removed){var k=this.element;this.removed=true;k.classList.add(h);c.merge(k.previousSibling,k.nextSibling);}}};return{check:function(){var k=g.length;if(k>0){g[k-1].visible();}},calculate:b,show:function(l){var k=-1;if(!i.enabled()){return;}g.some(function(n,m){if(!n.invisible&&n.offset<l+6){k=m;return false;}return true;});if(k>-1){i.update(k,l);}},activateFixed:function(k){i.activate(k);},deactivateFixed:function(){i.reset();},activate:function(l){var k=new j(l),m=a[k.id];if(!m){f(k);}else{if(k.time<m.time){e(m);m.remove();f(k);}else{k.remove();}}},deactivate:function(k){var m=k.getAttribute("data-id"),l=a[m];if(l){e(l);}else{d.remove(k);}}};});define("OK/messages/SearchPanel",["OK/utils/debounce","OK/utils/utils","OK/utils/dom","OK/messages/ConversationsManager","OK/messages/DateBar"],function(h,J,b,I,u){var s="__search_panel",D="__process",i="__current",g="__back",q="MessagesSearchResults",A=false,m=false,k,C,r,B,H,o,c,a,t,e,z,n=function(){var K=c.value;if(K.length<2){return;}if(e&&e.state()==="pending"){e.reject();}k.classList.add(D);e=J.ajax({url:"/dk",data:{cmd:q,"st.convId":B,"st.query":K}}).always(function(){k.classList.remove(D);}).done(function(M,L,N){J.updateBlockModelCallback(M,L,N);w();});},y=h(300,false,n);function p(){k.classList.add(g);}function l(){k.classList.remove(g);}function E(){z=false;o.classList.remove(i);H.classList.add(i);l();}function w(){z=true;H.classList.remove(i);o.classList.add(i);}function F(K){m=false;C.classList.remove(s);c.value="";OK.hookModel.setHookContent(q,"");var L=I.getById(B);if(z&&(K||!L.list.hasContent())){L.list.load().then(function(){E();l();L.scrollController.scrollToBottom();});}else{E();l();}}function f(){m=true;C.classList.add(s);c.focus();}function j(K){if(K.keyCode===27){K.preventDefault();K.stopPropagation();F(true);}}function d(K){if(K.keyCode===13){K.preventDefault();n();}else{y();}}function x(L,K){E();u.calculate();p();K.scrollController.scrollToCenter(L);L.classList.add("__active");setTimeout(function(){L.classList.remove("__active");},1500);}function v(){l();w();}function G(N){var M=N.target,L,K;if(!M.classList.contains("js-search-msg")){return;}L=M.getAttribute("data-id");K=I.getById(B);K.list.load(L).then(function(O){x(O,K);});}return{isActivated:function(){return A;},activate:function(K){A=true;k=K;B=k.getAttribute("data-id");r=document.getElementById("hook_Block_ConversationHeader");C=r.parentNode;c=b.firstByClass(k,"js-search-input");a=b.firstByClass(k,"js-search-close");t=b.firstByClass(k,"js-search-back");H=b.firstByClass(C,"js-chat-wrapper");o=b.firstByClass(C,"js-chat-search-wrapper");m=C.classList.contains(s);z=true;c.addEventListener("keyup",d);c.addEventListener("keydown",j);a.addEventListener("click",F);o.addEventListener("click",G);t.addEventListener("click",v);},deactivate:function(){A=false;c.removeEventListener("keyup",d);c.removeEventListener("keydown",j);a.removeEventListener("click",F);o.removeEventListener("click",G);t.removeEventListener("click",v);},close:function(){F(false);},toggle:function(){if(m){if(!r.classList.contains("__column")){F(true);}}else{f();}}};});define("OK/messages/Search",["require","OK/utils/debounce","OK/messages/ConversationsManager","OK/messages/MessagesConfig","OK/utils/dom","OK/logger","OK/utils/utils","OK/messages/SearchPanel"],function(f){var j=f("OK/utils/debounce"),l=f("OK/messages/ConversationsManager"),y=f("OK/messages/MessagesConfig"),b=f("OK/utils/dom"),v=f("OK/logger"),N=f("OK/utils/utils"),t=f("OK/messages/SearchPanel"),u="__search_panel",H=document,z,g,c,e,m,r,w,A,F=j(300,false,function(){e=D(c.value);});function D(d,O){C();q();var P=l.getById(m);P.searchRequest(d,O,function(){c.setAttribute("data-used","1");c.value.length>0?M():x();i();});}function p(){var d=c.value.trim();if(r===d){return;}if(d.length===0){E();}else{C();F();c.value.length>0?M():x();r=d;}}function C(){e&&e.state()==="pending"&&e.reject();}function I(){if(t.isActivated()){t.toggle();}else{try{z.classList.add(u);c.focus();}catch(d){}}}function o(){z.classList.remove(u);L();r=c.value="";a();}function a(){var d=K();d&&d.classList.add("invisible");}function n(){g.classList.remove("search-input_active");g.classList.remove("search-input_searching");}function x(){n();}function M(){n();g.classList.add("search-input_active");}function q(){n();g.classList.add("search-input_searching");}function E(){c.value="";C();N.ajax({url:"/dk?cmd=ConversationContent",data:{"st.convId":m}}).done(function(O){var P=l.getById(m),d=P.list;d.replace(O);P.scrollController.scrollToBottom();});x();r="";a();}function k(){if(w&&!w.classList.contains("__disabled")){G("older-id",1);}}function s(){if(A&&!A.classList.contains("__disabled")){G("newer-id",-1);}}function G(d,R){var S=l.getById(m);var O=S.getCenterMsg();if(!O){return;}var T=O.getAttribute("data-search-"+d);if(!T){return;}var Q=H.getElementById(T);if(Q){S.scrollController.scrollToCenter(Q);O.classList.remove("js-msg-scroll-center");Q.classList.add("js-msg-scroll-center");b.forEach(O.querySelectorAll(".msg_match_bg.__current"),function(U){U.classList.remove("__current");});b.forEach(Q.querySelectorAll(".msg_match_bg"),function(U){U.classList.add("__current");});var P=H.getElementById("searchPos");P.innerText=parseInt(P.innerText,10)+R;i();return;}D(c.value,T);}function L(){var d=l.getById(m);b.byClass(d.element,"msg_match_bg").forEach(function(O){O.classList.remove("msg_match_bg","__current");});}function K(){return b.firstByClass(document,"search-input_match");}function h(O){if(O.keyCode===13){O.shiftKey?s():k();}if(O.keyCode===27){var d=O.target,P=d.value.trim().length===0;if(P){d.blur();o();}else{E();}O.stopPropagation();}}function i(){var R=0;try{var Q=document.getElementById("searchPos");R=1;var P=document.getElementById("searchTotal");R=2;var O,d;R=3;if(!Q||!P){O=d=0;R=4;}else{O=parseInt(Q.innerText,10);R=5;d=parseInt(P.innerText,10);}R=6;if(A){A.classList.toggle("__disabled",O===0||O===1);}R=7;if(w){w.classList.toggle("__disabled",O===0||O===d);}}catch(S){v.success("messagesLayer","e.searchUpdArr_"+R);}}function J(){if(y.get().searchTouch){N.ajax({url:"/web-api/messages/search/touch"}).done(function(){v.success("messagesLayer","touchSearch");});}}function B(){var d=document.getElementById("ConversationsListSearch_field_query");f(["OK/messages/MessagesLayer"],function(O){if(d.hasAttribute("st.convId")){var P=d.getAttribute("st.convId");d.removeAttribute("st.convId");O.open({conversationId:P});}});}return{activate:function(P){var d=0;try{m=P;d=1;z=H.getElementById("hook_Block_ConversationHeader").parentNode;d=2;c=H.getElementById("chatSearchInput");d=3;g=H.getElementById("searchInputWrapperId");d=4;w=H.getElementById("searchOlder");d=5;A=H.getElementById("searchNewer");d=6;r=c&&c.value&&c.value.trim();d=7;i();}catch(O){v.success("messagesLayer","e.search_"+d);}},deactivate:function(){r=null;m=null;},openSearchPanel:function(){I();},hideSearchPanel:function(){o();},bind:function(R){var O="#chatSearchInput",Q="#ConversationsListSearch_field_query",d=O+", .js-search-input, "+Q,P="#ConversationsListSearch_cancelId",S=function(U){var T=U.type==="blur",V=l.getById(m);if(V&&V.form){V.form.toggleFakeCaret(T);}};R.on("click","#chatSearchIcon",I).on("click","#closeMsgSearchPanel",o).on("keyup",O,p).on("click","#clearQuery",E).on("click","#searchOlder",k).on("click","#searchNewer",s).on("click",P,B).on("keydown",O,h).on("focus",d,S).on("focus",Q,J).on("blur",d,S);},focusSearchInConvList:function(){var d=document.getElementById("ConversationsListSearch_field_query");return d&&d.focus();},isSearchInConvList:function(){var d=document.getElementById("ConversationsListSearch_field_query");return d&&d.value&&d.value.length>0;},isSearchInMessagesList:function(){return(z&&z.classList.contains(u))||(c&&c.getAttribute("data-used")==="1");},setConversationId:function(O){var d=document.getElementById("ConversationsListSearch_field_query");if(d){d.setAttribute("st.convId",O);}},newSearchEnabled:function(){return t.isActivated();}};});define("OK/AttachPreview",["OK/AttachPicker","OK/utils/utils"],function(d,b){var a={};function c(e,f){this.element=f;this.hookId=e;this.key=this.objectId=f.getAttribute("data-object-id");}c.prototype={activate:function(){if(!a[this.key]){a[this.key]=[];}a[this.key].push(this.hookId);this.element.addEventListener("click",this);},deactivate:function(){this.element.removeEventListener("click",this);a[this.key].splice(a[this.key].indexOf(this.hookId),1);},handleEvent:function(g){var f=g.target;while(f!==this.element){if(f.classList.contains("attachInput")){if(!f.getAttribute("data-add")){d.edit(this.objectId);d.remove(this.objectId,f.getAttribute("data-id"));}break;}f=f.parentNode;}},setNewContent:function(g,f,e){e();this.element.innerHTML=g;f();}};c.cloneContentElement=function(e){var g=a[e];if(g&&g.length>0){var f=OK.hookModel.getHookById(g[0]);if(f.element.firstChild){return f.element.firstChild.cloneNode(true);}}return null;};c.update=function(e,f){return b.ajax({type:"POST",url:e.previewUrl,data:{"st.a.attachedIds":f,"st.a.place":e.place}}).done(function(g){if(g===null){return;}var h=a[e.objectId];if(h){h.forEach(function(i){OK.hookModel.setHookContent(i,g);});}});};return c;});define("OK/messages/MessageForm",["require","jquery","OK/discussions/CommentForm","OK/utils/utils","OK/uuid","OK/messages/MessagesConfig","OK/utils/dom","OK/messages/Search","OK/messages/SearchPanel","OK/AttachPicker","OK/AttachPreview","OK/logger","OK/messages/UnsentMessages"],function(c){var i=c("jquery"),j=c("OK/discussions/CommentForm"),m=c("OK/utils/utils"),a=c("OK/uuid"),o=c("OK/messages/MessagesConfig"),h=c("OK/utils/dom"),d=c("OK/messages/Search"),k=c("OK/messages/SearchPanel"),e=c("OK/AttachPicker"),f=c("OK/AttachPreview"),n=c("OK/logger"),p=c("OK/messages/UnsentMessages"),b="__reply",l="__edit";var g=function(y,x,B){var s=0;try{var A=this,v=o.get(),u;s=1;this.conversation=x;s=2;j.call(A,y,x,B);s=3;if(!B.cleanOnPaste){y.on("paste",function(){setTimeout(function(){A.cleanPaste(y,v.allowedTags);},50);});}s=4;A.changeState(j.states.cancelable);s=5;if(A.container.hasClass("__restricted")){A.changeState(g.states.restricted);}s=6;A.init();s=7;this.menuListeners=[];if("localStorage" in window&&window.localStorage!==null){var z=0;var q=y.parents(".js-comments_form");var r=q.find(".comments_attach_trigger");for(var t in v.attachItemVersions){if(v.attachItemVersions.hasOwnProperty(t)){if(localStorage.getItem(v.user.id+"."+t)!=v.attachItemVersions[t]){(function(C,E){var D=v.user.id+"."+C;A.menuListeners=A.menuListeners.concat(q.find("."+C).parents(".u-menu_li").addClass("__new").click(function(){localStorage.setItem(D,E);i(this).removeClass("__new");if((--z)<=0){r.removeClass("__new");}}));})(t,v.attachItemVersions[t]);}}}this.menuListeners.forEach(function(C){z+=C.length;});if(z>0){r.addClass("__new");}}}catch(w){n.success("messagesLayer","e.msgForm_"+s);}};g.prototype=Object.create(j.prototype);g.prototype.constructor=g;g.prototype.destroy=function(){j.prototype.destroy.call(this);this.menuListeners.forEach(function(q){q.off();});};g.states=m.extendDeep({restricted:"__restricted"},j.states);g.prototype.initAutosize=function(){};g.prototype.extendedEmojiareaOptions=function(){var q=this;return{stickerSource:function(){return q.conversation.isChat?"multichat":"messages";},commentsWrapperEl:q.conversation.element,postcardsEnabled:true,onSuggestSend:q.setValue.bind(q,"")};};g.prototype.cleanPaste=function(t,v){var q=this;t.find("*").addBack().contents().filter(function(){return this.nodeType===8;}).remove();var u=t.find("*:not("+v+")");u.contents().unwrap();u.remove();t.find("*:not(img.emoji, img.usmile, img[alt^='#u'][alt$='s#'])").each(function(){var x=this.attributes,y=x.length;while(y--){var w=x[y];this.removeAttributeNode(w);}});var s=t.children(),r=s.size()===1;if(r){s.contents().unwrap();}if(r||u.size()>0){t.get(0).normalize();q.setCaretToEnd(true);}};g.prototype.serialize=function(z){var B=z.content||this.getValue(false),r=z.msgMarker||this.comment,s=z.attached||(this.attached&&this.attached.val()),w=z.isSticker,E=z.asyncAttach,x=z.instantAttachSend,t=z.stickerPlace,F=this,u=F.isEditMode(),C=u?F.comment:a.generate(),q=w&&this.options.sendStickerAsAttach,v={"st.txt":(q?"":B),"st.uuid":C};if(q){s=JSON.stringify([{type:"STICKER",code:B}]);}if(r){i.extend(v,{"st.msgMarker":r});if(this.isEditMode()){i.extend(v,{"st.msgEdit":true});}}if(d.isSearchInConvList()){i.extend(v,{"st.updateConvList":true});}if(d.isSearchInMessagesList()&&!k.isActivated()){i.extend(v,{"st.updateMessagesList":true});}if(s&&s.length>0&&(!w||q)){i.extend(v,{"st.attach":s});}if(F.objectId){i.extend(v,{"st.ptfu":!e.isEdited(F.objectId)});}if(t){i.extend(v,{"st.stickerPlace":t});}if(!u){var A,y;if(E||x){A=x?null:f.cloneContentElement(F.objectId);if(A){var D=i(A);D.find(".attach-photo_del").removeClass("attach-photo_del");D.find(".ic_close-g").removeClass("ic_close-g");}y=e.get(F.objectId);}F.conversation.list.addStubMessage(C,B,s,y,A);p.addMessage(F.conversation.id,C,v,E||x);if(E){p.onAsycContinue(F.conversation.list,C,y);}}return v;};g.prototype.onSuccess=function(v,u){var q=this,t=u.json.type&&u.json.type==="EDITED";var s=u.blockIds.indexOf("ConversationsListWrapper");if(s>=0){OK.hookModel.setHookContent(u.blockIds[s],u.dataBlocks[s]);}var r=u.blockIds.indexOf("ConversationContent");if(r>=0){OK.hookModel.setHookContent(u.blockIds[r],u.dataBlocks[r]);q.conversation.onMessageInSearchSent(u.uniqueId);return;}if(t){q.conversation.list.updateMessages(u.json);}else{q.conversation.post(u.uniqueId,u.json);}if(u.lastMessage&&u.lastMessageId){OK.hookModel.setHookContent(u.lastMessageId,u.lastMessage);}};g.prototype.scheduleMessage=function(){var t=function(w,v,u,y,x){return function(z){i.extend(w,{"st.attach":z});x.sendMessage(w,v,y);};};var r=this.serialize({asyncAttach:true});var s=t(r,this.getSubmitUrl(),this.objectId,this.conversation.id,this.options.messageAjaxController);var q=r["st.uuid"];e.detachSession(this.objectId,s,q);n.success("messagesLayer","async","photo");};g.prototype.sendUploadedAttaches=function(q,r){i.extend(q,{"st.attach":"["+JSON.stringify(r)+"]"});this.createRequest(q);};g.prototype.createRequest=function(t,s,v,r){var u=this.options.messageAjaxController.sendMessage(t,this.getSubmitUrl(),this.conversation.id,s,v,r),q=this;u.always(function(){q.isInProgress=false;q.posted&&q.posted.resolve();});return u;};g.prototype.showReplyEditPanel=function(D){var A=this,q=A.isReplyMode(),z,v;A.hideReplyEditPanel();if(!A.commentsAddInput){z=A.commentsAddInput=h.firstByClass(A.container[0],"comments_add_input");if(z){A.replyNameContainer=h.firstByClass(z,"comments_add_info_reply_name");A.replyContainer=h.firstByClass(z,"msg_reply");A.replyText=h.firstByClass(z,"msg_reply_tx");A.editMsgContainer=h.firstByClass(z,"comments_add_info_edit_text");v=h.firstByClass(z,"js-comments_add_info_cancel");v.addEventListener("click",A.cancelReplyEditMode.bind(A));}}if(q&&D){var t=h.parent(D,"js-msg"),B=t.classList.contains("__me"),G=t.classList.contains("__msg-sticker"),H=h.firstByClass(t,"msg_reply");if(H){t=t.cloneNode(true);H=h.firstByClass(t,"msg_reply");h.remove(H);}var I=h.firstByClass(t,"msg_name")||h.firstByClass(A.conversation.element,"js-opponent-name"),s=h.firstByClass(t,"msg_tx_cnt")||h.firstByClass(t,"js-msg_forward_tx"),r=D.getAttribute("data-attach-text"),y=G?h.firstByClass(t,"usmile")||h.firstByClass(t,"live-sticker_first"):null,u=y||s||r,x=D.getAttribute("data-attach-music"),C=h.firstByClass(A.commentsAddInput,"msg_name"),w="",E,F;if(!B){C.innerHTML=I.innerHTML;}A.replyContainer.classList.toggle("__my",B);if(u){if(y){w=y.outerHTML;}else{if(s){w=s.innerHTML;}else{if(r){F=h.firstByClass(t,"msg_attach_img")||h.firstByClass(t,"gif_preview")||h.firstByClass(t,"js-file-attach");w=F?F.outerHTML:r;}}}A.replyText.innerHTML=w;}if(x){E=h.firstByClass(t,"msg-reply-track");if(E){A.replyText.innerHTML=E.outerHTML;}}A.replyText.classList.toggle("invisible",!u&&!x);}if(!q&&A.editMsgContainer){A.editMsgContainer.innerHTML=D;}if(A.commentsAddInput){A.commentsAddInput.classList.add(q?b:l);A.conversation.scrollToBottom();}};g.prototype.hideReplyEditPanel=function(){var q=this.commentsAddInput;if(q){q.classList.remove(b);q.classList.remove(l);}};g.prototype.autoFocus=function(){this.focus();this.setCaretToEnd(true);};g.prototype.activateEditMode=function(q,r){this.replyMode=false;this.comment=q;this.setValue(r);this.setCaretToEnd();this.textarea.focus();this.changeState(j.states.cancelable);return this;};g.prototype.deactivateReplyEditMode=function(){if(!this.isReplyMode()&&!this.isEditMode()){return this;}if(this.isEditMode()){this.clear();}this.setComment(null);this.deactivate(true);return this;};g.prototype.activateRestrictedMode=function(){this.changeState(g.states.restricted,true);};g.prototype.deactivateRestrictedMode=function(){this.changeState(g.states.restricted,false);};g.prototype.isRestricted=function(){return this.states[g.states.restricted];};g.prototype.onAttachUpdate=function(){this.conversation.scrollToBottom();};g.prototype.toggleFakeCaret=function(q){this.textarea.toggleClass("add-caret",q);};return g;});define("OK/messages/TypingUtil",["OK/utils/dom"],function(b){function a(c,l){if(!c){return"";}var e=c.length>0;if(e){var g=Math.min(3,c.length);var k=c[0].name;var j=c.length>1?c[1].name:"";var i=c.length>2?(c.length-2):0;var d=i>0?l.getLMsg("typing.and.also",{count:i,countPlural:i}):"";var f=c.length===1?0:1;var h=l.getLMsg("typing.text",{oneOrMany:g,user1:k,user2:j,others:d,one:f});return h;}return"";}return{updateText:function(d,c){return new Promise(function(h,g){var e=b.firstByClass(d,"typing-tx");var f=e&&e.innerHTML;OK.loader.execRequire("OK/pts!messaging.client",function(k){var j=a(c,k);if(!f||j&&f!=j){var i=b.firstByClass(d,"typing-tx");i.innerHTML=j;}h(j);});});},updateTypingUsers:function(d,c){if(!d){return c;}d.forEach(function(f){var e=-1;for(var g=0;g<c.length;g++){var h=c[g];if(h.id==f.userId){e=g;break;}}if(f.status==="ADDED"){if(e>-1){c.splice(e,1);}c.unshift({id:f.userId,name:f.userName});}else{if(f.status==="PAUSED"||f.status==="CLEARED"){if(e>-1){c.splice(e,1);}}}});return c;},removeTypingUsers:function(c,d){if(d){d.forEach(function(g){var e=-1;for(var f=0;f<c.length;f++){var h=c[f];if(h.id==g){e=f;break;}}if(e>-1){c.splice(e,1);}});}return c;}};});define("OK/messages/TypingStatus",["OK/logger","OK/utils/utils","OK/utils/dom","OK/messages/TypingUtil","OK/messages/ConversationsList","OK/messages/MessagesConfig"],function(n,l,d,f,m,b){var k="invisible",i=3000;function e(r,q){r.container.classList.toggle("__typing",q);}function o(u,r){var t=u.firstChild,s,q;t.classList.toggle("ic12_seen",!r);t.classList.toggle("ic12_typing",r);s=d.firstByClass(u,"js-rm");q=d.firstByClass(u,"js-typing");s.classList.toggle(k,r);q.classList.toggle(k,!r);}function j(q,r){if(q.container){a(q,q.conv.list.el,null,null,false);return;}var t=d.firstByClass(r,"js-typing-new"),s;if(t){s=d.parent(t,"chat_seen",r);if(s){d.remove(s);}}else{s=d.firstByClass(r,"chat_seen");if(s){t=d.firstByClass(s,"js-typing");if(t&&!t.classList.contains(k)){o(s,false);}}}}function c(u,r,q,v,s){if(q){var t=d.firstByClass(u,"ic12_typing");if(!t){v.insertAdjacentHTML("beforeend",s);d.firstByClass(v,"js-typing").classList.add("js-typing-new");r.conv.scrollToBottom();}}else{j(r,u);}}function a(z,y,r,u,v){if(z.typingTimer){clearTimeout(z.typingTimer);z.typingTimer=null;}if(z.container){if(z.conv.isFullyLoaded()){var t=d.firstByClass(z.container,"typing-tx");t.innerHTML=z.conv.typingText;v=v&&t.innerHTML.length>0;e(z,v);}z.convListItem&&z.convListItem.updateTyping(v&&!z.conv.isScolledToBottom(),z.typingUsers,true);}else{var q=d.firstByClass(y,"chat_seen"),w,s;if(!q){c(y,z,v,r,u);}else{w=d.parent(q,"js-msg");var x=r&&w.id==r.id;if(x){o(q,v);s=d.firstByClass(y,"js-mp");if(s){s.classList.toggle(k,v);}}else{c(y,z,v,r,u);}}}if(v){z.typingTimer=setTimeout(function(){a(z,y,r,u,false);},b.get().typingShowTimeout);}}function g(s,u,q,v){if(s.typingTimer){clearTimeout(s.typingTimer);s.typingTimer=null;if(q.length===0){s.typingUsers=[];}}if(s.container){var t=s.typingUsers.length>0;if(s.conv.isFullyLoaded()){f.updateText(s.container,s.typingUsers).then(function(x){e(s,t&&x.length>0);});}s.convListItem&&s.convListItem.updateTyping(t&&!s.conv.isScolledToBottom(),s.typingUsers,true);}else{var w=d.byClass(u,"js-rmChat-user");var r=[];q.forEach(function(x){r.push(x.id);});if(w){Array.prototype.slice.call(w).forEach(function(x){var B=d.parent(x,"js-msg",u),y=d.firstByClass(x,"chat_seen_more"),C=B&&v&&B.id==v.id,A=x.getAttribute("data-userId"),z=r.indexOf(A)>-1&&C&&!y;x.classList.toggle("__typing",z);});}}if(s.typingUsers.length>0){s.typingTimer=setTimeout(function(){g(s,u,[],v);},b.get().typingShowTimeout);}}function h(q){this.conv=q;this.container=d.firstByClass(q.element,"js-typing-wr");this.typingUsers=[];this.convListItem=m.getById(this.conv.id);}function p(){return performance?performance.now():new Date().getTime();}h.prototype={send:function(q){var r=this,u=r.conv.id,s=r.lastSendTime;var t=p();if(q===0&&s&&t-s<i){return;}if(u){l.ajax({url:"/dk",data:{cmd:"MessagesTypingStatus","st.convId":u,"st.ts":q}}).always(function(){if(q===2){r.lastSendTime=0;}else{r.lastSendTime=p();}}).fail(function(){n.error("messagesLayer.error","typingStatusSend");});}},onNewMessageAdded:function(q){if(this.container){this.typingUsers=f.removeTypingUsers(this.typingUsers,q);if(this.conv.isChat){g(this,this.conv.list.el,this.typingUsers);}else{a(this,this.conv.list.el,null,null,this.typingUsers.length>0);}}else{if(!this.conv.isChat){j(this,this.conv.list.el);}}},hideConvItem:function(){if(!this.container||!this.convListItem){return;}this.convListItem.updateTyping(false,this.typingUsers,true);},showConvItem:function(){if(!this.container||!this.convListItem){return;}this.convListItem.updateTyping(this.typingUsers.length>0,this.typingUsers,true);},onConversationOpened:function(){if(!this.convListItem){this.convListItem=m.getById(this.conv.id);}if(!this.container||!this.convListItem){return;}var q=this.convListItem.getTypingUsers();if(q.length>0){this.typingUsers=q;if(this.conv.isChat){g(this,this.conv.list.el,this.typingUsers);}else{a(this,this.conv.list.el,null,null,this.typingUsers.length>0);}}this.hideConvItem();},onConversationClosed:function(){this.lastSendTime=0;if(!this.container){return;}m.onConversationClosed({convId:this.conv.id,typingUsers:this.typingUsers});},destroy:function(){this.typingUsers=[];if(this.typingTimer){clearTimeout(this.typingTimer);this.typingTimer=null;}this.container=null;this.convListItem=null;this.conv=null;},update:function(t){if(!this.conv.selected){return;}var q=this,r=q.conv.list.el,v=q.conv.list.getCards(),s=v.length?v[v.length-1]:null,u=null;if(!v.length){return;}if(!this.conv.isChat&&t.list.length>0){u=t.list[0].html;}this.typingUsers=f.updateTypingUsers(t.list,this.typingUsers);if(this.conv.isChat){g(q,r,this.typingUsers,s);}else{a(q,r,s,u,this.typingUsers.length>0);}}};return h;});define("OK/messages/ReadMarks",["OK/messages/ConversationsList","OK/messages/Helper","OK/logger","OK/utils/utils","OK/utils/dom","OK/messages/MessagesConfig"],function(n,d,p,m,i,e){var k="js-timestamp";function h(r,q,v,z){var y,s,x,u,w,t=null;for(y=r.length-1;y>=0;--y){s=r[y];if(s.parentNode.classList.contains("comments_reply-comment")){continue;}x=s.getAttribute("data-mine")==="true";if(!v||x){u=s.getAttribute("data-created");w=s.getAttribute("data-authorId");if(parseInt(u,10)<=parseInt(q.time,10)||w===q.userId){t=s;break;}if(z){break;}}}return t;}function o(q,r){var s=document.createElement("div"),u,t;s.innerHTML=r;u=i.firstByClass(s,k);t=i.firstByClass(q,k);if(t&&u){t.innerHTML=u.innerHTML;}}function g(r,q){if(!q.list||!q.list.conversation||!q.list.conversation.selected){return;}if(r){var t=OK.hookModel.getNearestBlockHookId(r);if(t){try{OK.hookModel.captureBlockHook(t,r);}catch(s){p.error("messagesLayer.error","activateReadMark");p.clob("error",s.stack,"messagesLayer","activateReadMark");}}}}function l(s,t,r,w){var u,v,q;u=document.createElement("div");u.innerHTML=t;v=i.firstByClass(u,"chat_seen_cnt");v.insertAdjacentHTML("beforeend",r.html);w.insertAdjacentHTML("beforeend",u.innerHTML);q=i.firstByClass(w,"chat_seen_cnt");g(q,s);}function c(F,C,w,z,y,E){var r=w.lastChild,t,D=F.list.conversation,B=w.getAttribute("data-authorId")==z.userId;if(r&&r.classList.contains("chat_seen")){if(!D.showMessageAuthorReadMark&&B){return;}var s=i.firstByClass(r,"js-rmChat-"+z.userId);if(s){return;}t=i.firstByClass(r,"chat_seen_cnt");if(!t){return;}if(E){var A=i.firstByClass(t,"chat_seen_more");if(!A){t.insertAdjacentHTML("beforeend",z.html);var q=i.firstByClass(t,"chat_seen_more");g(q,F);D.scrollToBottom({fancy:true});}else{var x=i.firstByClass(t,"chat_seen_amount");if(x&&z.readUsersCount){x.innerHTML=z.readUsersCount;}}}else{t.insertAdjacentHTML("beforeend",z.html);var v=i.firstByClass(r,"js-rmChat-"+z.userId);g(v,F);}}else{var u=i.byClass(C,"js-rmChat-"+z.userId);if(u&&u.length){u.forEach(function(G){f(G);});}if(!D.showMessageAuthorReadMark&&B){return;}l(F,y,z,w);D.scrollToBottom({fancy:true});}}function j(s,u,q,v,r,t){q.classList.add("__removed");setTimeout(function(){f(q);c(s,u,v,r,t);},300);}function f(r){var q=i.parent(r,"chat_seen");if(!q){return;}i.remove(r);if(i.byClass(q,"chat_seen_ava").length===0){i.remove(q);}}function a(s){var r=s.scrollController,q=r.getLoader();return q&&q.hasMore();}function b(q){this.list=q;}b.prototype={send:function(t){var s=this.list.conversation,r=t||d.isLayerOpenedAndActive(),q=this;if(s.isUnread()&&r&&!a(s)){m.ajax({url:"/web-api/messages/conversation/markAsRead",data:{cid:s.id},timeout:e.get().ajaxTimeout},e.get().ajaxRetryCount).done(function(u){q.apply();d.updateToolbarBubbleFromServer(u);}).fail(function(){p.error("messagesLayer.error","markAsRead");});}},apply:function(q){this.list.conversation.resetBubble(q);this.list.markAsRead();},clear:function(){i.byClass(this.list.el,"chat_seen").forEach(function(q){i.remove(q);});},update:function(s){var q=this,t=this.list,r=t.el,v=t.conversation,u=t.getCards();if(v.readMarkState==="DISABLED"){return;}s.list.forEach(function(z){if(z.mine){return;}var B,y,A,w,x;if(z.type==="PRIVATE"){if(v.opponentId&&z.userId&&v.opponentId!=z.userId){p.success("messagesLayer","alien_readmark");return;}y=i.firstByClass(r,"chat_seen");if(y){i.remove(y);}B=h(u,z,true);if(B){if(z.html.indexOf("chat_seen_ava_img")>-1){l(q,s.readMarkWrapper,z,B);}else{B.insertAdjacentHTML("beforeend",z.html);}}}else{A=v.readMarkState==="COLLAPSED";B=h(u,z,false,A);if(B){w=i.firstByClass(r,"js-rmChat-"+z.userId);if(w){x=i.parent(w,"js-msg",r);if(x&&x.getAttribute("id")!==B.getAttribute("id")){j(q,r,w,B,z,s.readMarkWrapper);}else{o(w,z.html);}}else{c(q,r,B,z,s.readMarkWrapper,A);}}}});}};return b;});define("OK/messages/MsgReplies",[],function(){function a(h){var d=10,f=this.element,g=h/d,e=function(){if(d){f.scrollTop+=g;d--;requestAnimationFrame(e);}};e();}function c(){var d=document.getElementById("msg_removed_tip");if(d){d.classList.add("__active");setTimeout(function(){d.classList.remove("__active");},1500);}}function b(d){this.list=d;}b.prototype={activate:function(d){d.addEventListener("click",this);},deactivate:function(d){d.removeEventListener("click",this);},scrollTo:function(e){var d=this;if(d.active){clearTimeout(this.timeoutId);d.active.classList.remove("__active");}d.active=e;e.classList.add("__active");d.list.conversation.scrollController.scrollToCenter(e,a);d.timeoutId=setTimeout(function(){d.active.classList.remove("__active");d.active=null;},1500);},handleEvent:function(h){var g=h.target,d=this,f;if(g.classList.contains("js-msg_reply")){f=g.getAttribute("data-to");d.list.load(f).then(function(e){d.scrollTo(e);},c);}}};return b;});define("OK/messages/StickerOverlays",["OK/utils/dom","OK/messages/Helper"],function(d,b){var f="sticker-overlays",k="js-sticker_play",g,e;function j(){g=null;}function i(){if(e){OK.Layers.unsubscribe(e,i);}if(g){g.stopImmediately();}}function a(){if(e){OK.Layers.unsubscribe(e,i);}if(g){g.stop();}}function c(m,o){var p=m.getAttribute("data-overlay-url"),n;if(!p){return;}n=p+"/";require(["noext!"+n+"main.js"],function(r){if(g){return;}if(o&&r.getImpl().isInteractive){return;}r.onFinished=j;g=r.run({rootUrl:n,host:d.parent(m,"js-overlays-host")});e=OK.Layers.getTopLayerId();OK.Layers.subscribe(e,i);if(!g.isInteractive){g.domRoot.addEventListener("click",a);}else{var s=r.getControlsDomRoot(),q=document.createElement("span");q.className="ic ic_close-dg chat_interactive_close";q.addEventListener("click",i);s.appendChild(q);}});}function h(m){m.stopPropagation();m.preventDefault();c(this,false);}function l(m){m.scrollController.removeListeners(f);}return{bind:function(m){m.on("click","."+k,h);m.on("mousedown",".js-chat_write",a);m.on("mousedown",".js-chat_toolbar",a);},activate:function(m){m.addEventListener("click",h);},deactivate:function(m){m.removeEventListener("click",h);},onConversationOpened:function(o){if(!o||!o.selected||!b.isMessageLayerOpened()){return;}var n=this,p=OK.Layers.getTopLayerId();if(p!=="messages"){OK.Layers.subscribe(p,function m(){OK.Layers.unsubscribe(p,m);n.activate(o);});return;}o.list.getCards().reverse().every(function(q){if(q.classList.contains("__unread")){if(q.classList.contains("__msg-sticker")){var r=d.firstByClass(q,k);if(r){if(o.scrollController.isVisible(q)){c(r,true);}else{o.scrollController.addListener(function(){if(o.scrollController.isVisible(q)){l(o);c(r,true);}},f);}return false;}}return true;}return false;});},onConversationClosed:function(m){i();l(m);},onMessageAdded:function(n){if(n){var m=d.firstByClass(n,k);if(m){c(m,true);}}},play:function(m){c(m,false);}};});define("OK/messages/MessagesList",["require","OK/messages/MsgReplies","OK/utils/dom","OK/utils/utils","OK/logger","OK/NewsFetchCoordinator","OK/messages/StickerOverlays","OK/messages/UnsentMessages","OK/messages/MessageMerger","OK/messages/MessagesConfig","OK/capture","OK/messages/DateBar","OK/AttachPicker"],function(j){var l=j("OK/messages/MsgReplies"),r=j("OK/utils/dom"),v=j("OK/utils/utils"),y=j("OK/logger"),b=j("OK/NewsFetchCoordinator"),t=j("OK/messages/StickerOverlays"),a=j("OK/messages/UnsentMessages"),f=j("OK/messages/MessageMerger"),w=j("OK/messages/MessagesConfig"),o=j("OK/capture"),e=j("OK/messages/DateBar"),g=j("OK/AttachPicker"),h,k="__active",p="__editing",q="__replying",m="invisible",x="js-msg",d="msg-stub-",n="data-uuid";function i(z){this.conversation=z;this.typingUsers=[];this.msgReplies=new l(this);}function u(B){if(B&&B.indexOf("#u")===0){var A=/[a-fA-F0-9]+/g,z=B.match(A);return z&&z.length>0&&z[0];}return null;}function c(){if(h){var z=h.previousSibling,A=h.nextSibling;r.remove(h);f.merge(z,A);}}function s(D){c();var z=document.getElementById("msg_unread_marker"),A,E,C,B;if(z){A=D.getUnreadCards();E=A?A.length:0;if(E>0){if(E>=D.getCards().length){return;}z=z.cloneNode(true);z.removeAttribute("id");z.classList.remove(m);C=A[0];B=C.previousSibling;if(B&&B.classList.contains("js-date-bar")){h=C.parentNode.insertBefore(z,B);}else{h=C.parentNode.insertBefore(z,C);f.unmerge(h.previousSibling,C);}}}}i.prototype={init:function(A){var z=this;z.setContainer(A);z.msgReplies.activate(A);z.editCheckInterval=setInterval(function(){z.checkEditActionTimeouts();},30000);s(this);},onLayerOpened:function(){s(this);},setContainer:function(z){this.el=z;},hasContent:function(){return !!this.el.firstChild;},load:function(A){var z=this,B,C;return new Promise(function(E,D){if(A){C=z.getMessageEl(A);if(C){E(C);return;}}else{if(z.hasContent()&&z.conversation.isFullyLoaded()){E();return;}}v.ajax({url:"/dk?cmd=ConversationContent",data:{"st.convId":z.conversation.id,"st.around":!!A,"st.last":!A,"st.msgMarker":A},timeout:w.get().ajaxTimeout},w.get().ajaxRetryCount).done(function(F){if(!A){z.replace(F);E();}else{B=document.createElement("div");B.innerHTML=F;if(!B.querySelector('[id="'+A+'"]')){D("message-not-found");}else{z.replace(F);C=z.getMessageEl(A);E(C);}}});});},replace:function(z){var D,A,C;try{if(!this.hasContent()){OK.hookModel.setHookContent("ConversationContent",z);C=r.firstByClass(document,"js-msg-loader").getAttribute("data-loader-id");this.conversation.scrollController.loaderId=C;this.init(this.el);}else{D=this.el.firstChild;o.deactivate(D);this.destroy();this.el.insertAdjacentHTML("beforeEnd",z);D.parentNode.removeChild(D);A=this.el.firstChild;o.activate(A);C=r.firstByClass(document,"js-msg-loader").getAttribute("data-loader-id");this.conversation.scrollController.loaderId=C;this.init(this.el);}}catch(B){y.clob("error",B.stack,"messagesLayer","msgList_replace");}},destroy:function(){clearInterval(this.editCheckInterval);this.msgReplies.deactivate(this.el);this.typingUsers=[];this.listeners=[];c();this.newMessageStub=null;},getMessageEl:function(z){if(!this.el){return null;}return this.el.querySelector('[id= "'+z+'"]');},getMessageElByUuid:function(z){if(!this.el){return null;}return this.el.querySelector("["+n+' = "'+z+'"]');},getStubEl:function(z){return r.firstByClass(this.el,d+z);},getCards:function(){var z=this.el;return z?r.byClass(z,x):[];},getFirstUnreadCard:function(){var z=this.el;return z?r.firstByClass(z,"__unread"):null;},getUnreadCards:function(){var z=this.el;return z?r.byClass(z,"__unread"):[];},addNewMessages:function(Q,E){if(!this.conversation.isFullyLoaded()){this.conversation.onMessageAdded({stub:E&&E.stub});return;}if(!Array.isArray(Q)){Q=[Q];}if(!Q.length){return;}var M=this,P=r.firstByClass(this.el,"js-messages-list").firstChild;var F=this.getCards(),G=r.firstByClass(P,"js-mp"),H=E&&E.stub,J=false,R=null,O,K;e.check();if(!F.length||H){J=true;K="bottom";}else{var z=Q[0].time;var L=Q[Q.length-1].time;var N=F[0].getAttribute("data-created");var B=F[F.length-1].getAttribute("data-created");if(z>=B){J=true;K="bottom";}else{if(L<=N){R=F[0];K="top";}else{if(F.length<2){J=true;K="bottom";}else{for(O=F.length-2;O>=0;O--){var A=F[O];var I=A.getAttribute("data-created");if(I<z){R=F[O+1];break;}}K=R?"middle":"none";}}}}if(K){y.success("messagesLayer","addNewMessages",K);}var D,S,C=[];var T=false;Q.forEach(function(X){var V,Y;if(M.getMessageElByUuid(X.uuid)){return;}if(!T){var U=r.byClass(M.el,"js-inline-keyboard-buttons");if(U){r.remove(U);}T=true;}if(G&&X.html.indexOf("js-mp")>=0){Y=r.parent(G,"js-msg_cnt");if(Y){Y.classList.remove("__spaced");}r.remove(G);}if(J){V=P.lastChild;D=V&&V.classList.contains("js-msg")?V:null;P.insertAdjacentHTML("beforeend",X.html);S=P.lastChild;}else{if(R){V=R.previousSibling;D=V&&V.classList.contains("js-msg")?V:null;R.insertAdjacentHTML("beforebegin",X.html);S=R.previousSibling;}}if(S){G=r.firstByClass(S,"js-mp");var W=S.getAttribute("data-authorId");if(C.indexOf(W)===-1){C.push(W);}}f.merge(D,S);M.activateNewMessage(X);});this.conversation.onMessageAdded({newMessageAuthors:C,stub:E&&E.stub});},replaceMessage:function(D){var B=D.uuid,C=this.getMessageElByUuid(B);if(C){var A=C.previousSibling;var E=document.createElement("div");E.innerHTML=D.html;var z=E.firstChild;C.parentNode.replaceChild(z,C);f.merge(A,z);if(z.classList.contains("__me")){t.onMessageAdded(z);}this.activateNewMessage(D);a.removeMessage(this.conversation.id,B);}else{this.addNewMessages(D);}},activateNewMessage:function(B){if(this.conversation.selected){var D,A,z=document.createElement("div");z.innerHTML=B.html;D=z.childNodes[0].id;if(D){A=document.getElementById(D);if(A){try{OK.hookModel.captureBlockHook(OK.hookModel.getNearestBlockHookId(A),A);}catch(C){}}}}},genStub:function(){if(!this.newMessageStub){var A=r.firstByClass(document,"js-stub_message"),z=A&&A.cloneNode(true);z.classList.remove("js-stub_message");z.classList.remove("invisible");z.classList.add(x);this.newMessageStub=z;}return this.newMessageStub.cloneNode(true);},addAttachToStub:function(F,B,H,E,G){if(F&&F!=="[]"){var J=this,C=function(K){return K&&r.firstByClass(K,"js-msg_attach_w");},A=function(){return C(J.getStubEl(H));},I=C(B),D=function(){if(E){g.updatePreviewContainer(E.objectId,document.getElementById("hook_Block_ConversationContent"));E.trigger("update");}};if(I){I.classList.remove(m);var z=function(){y.error("messagesLayer.error","retry.attach.empty");var K=A();if(K){K.classList.add(m);}};if(G){setTimeout(function(){var K=A();if(K){K.classList.remove("__preloader","__preloader-s");K.appendChild(G);}D();},1);}else{v.ajax({url:"/dk?cmd=AttachPreview",data:{"st.a.attachedIds":F,"st.a.passive":true,"st.a.place":"MESSAGING"},timeout:w.get().ajaxTimeout},w.get().ajaxRetryCount).done(function(M,K,N){if(M==null||M.length===0){z();return;}var L=A();if(L){L.classList.remove("__preloader","__preloader-s");L.innerHTML=M;}D();}).fail(z);}}}},addStubMessage:function(K,F,H,G,I){var B=this.genStub(),O;if(B){var N=r.firstByClass(B,"msg_tx_cnt"),J=B.getAttribute("data-authorId"),A=b.getCurrentServerTime(),L=u(F),M="msg_tx",E="src",D,C,z;if(L){C=r.firstByClass(N,"js-stub_sticker");z=C.getAttribute(E);C.setAttribute(E,z.substring(0,z.length-5)+L);C.classList.remove(m);D=r.firstByClass(B,M);D.classList.remove(M);D.classList.add("js-msg_sticker","msg_sticker");}else{F=F?F.trim().replace(/&/g,"&amp;"):F;if(!F||F.length==0){r.remove(N);}else{N.innerHTML=F;}this.addAttachToStub(H,B,K,G,I);}B.classList.add(d+K);B.setAttribute("data-created",A);B.setAttribute(n,K);O={time:A,authorId:J,html:B.outerHTML};this.addNewMessages(O,{stub:true});c();}},removeStub:function(A){var z=this.getStubEl(A);if(z){r.remove(z);}},setError:function(C,A){var B=this.getMessageElByUuid(C),z;if(B){B.classList.add("__error");z=r.firstByClass(B,"msg_error");if(z){z.innerHTML=A.error;}}},updateMessages:function(C){if(!Array.isArray(C)){C=[C];}var K=this,L,E,A,z;for(E=0;E<C.length;E++){L=C[E];A=K.getMessageEl(L.id);if(A){var I=L.type,G=L.html;if(I==="EDITED"){z=r.firstByClass(A,"js-msg-text");if(z){z.innerHTML=G;A.classList.add("__edited");r.byClass(A,"js-msg-edited").forEach(function(M){if(!M.classList.contains("js-msg-disable-edit-ic")){M.classList.remove(m);}});var J=r.firstByClass(z,"msg_tx_cnt");if(J&&this.conversation&&this.conversation.selected){OK.hookModel.captureBlockHook(OK.hookModel.getNearestBlockHookId(A),z);}}}else{if(I==="DELETED"||I==="MARK_AS_SPAM"){z=r.firstByClass(A,"js-msg-text");if(z){z.innerHTML=G;var D=r.firstByClass(A,"msg_tx");if(D){D.classList.add("__deleted");}var H=r.firstByClass(A,"msg_ac");if(H){r.remove(H);}var B=r.firstByClass(A,"js-msg-attach");if(B!==null){r.remove(B);}var F=r.firstByClass(A,"js-msg_forward");if(F!==null){r.remove(F);}}}}}}},markAsRead:function(){this.getUnreadCards().forEach(function(z){z.classList.remove("__unread");});},isSelectedMessage:function(z){return z===this.selectedMessageId;},selectMessage:function(B,z,A){var C=this.getMessageEl(B);this.deselectMessage();if(C){C.classList.add(k);if(z){C.classList.add(p);}if(A){C.classList.add(q);}}this.selectedMessageId=B;},deselectMessage:function(){var z=this.getMessageEl(this.selectedMessageId);if(z){z.classList.remove(k,p,q);}this.selectedMessageId=null;},checkEditActionTimeouts:function(){var z=r.byClass(this.el,"js-msg-edit"),C=b.getCurrentServerTime(),D,B=[],A=[];if(z){z.forEach(function(E){D=E.getAttribute("data-edit-until");if(D&&D<C){B.push(E);}else{A.push(E);}});if(B.length>0){r.remove(B);}}return A;},editLast:function(){var z=this.checkEditActionTimeouts(),B=z.length-1,A=z[B];if(A){this.conversation.handleEdit(A);}},getLast:function(){var A=this.getCards();var z=A.length?A[A.length-1]:null;return z;},hasMessages:function(){return this.getCards().length>0;}};return i;});define("OK/messages/HistoryHelper",["OK/logger"],function(){var e=require("OK/logger"),h="/messages",d,a="/";function g(l,j){if(l){if(l.lastIndexOf("msg_found_",0)===0){l=l.substring(10);}var i=l.split("_"),k;switch(i[0]){case"PRIVATE":k="/";break;case"CHAT":k="/c";break;}if(j=="GROUP"){k="/g";}return h+k+i[1];}return h;}function f(){var j=0;try{var i=OK.historyManager;j=1;var k=i.getState;j=2;return k&&k();}catch(l){e.success("messagesLayer","e.histCurrState_"+j);return"/";}}function b(){return f().indexOf(h)===0;}function c(k,i){var j=0;try{j=1;if(k&&k!==f()){j=2;OK.historyManager.pushState(k);j=3;if(i){j=4;d=k;}}}catch(l){e.success("messagesLayer","e.histPush_"+j);}}return{openLayer:function(n,j){var i=0;try{i=1;var k=f(),m=b();i=2;if(!m){i=3;a=k;}i=4;if(n){i=5;c(g(n,j),true);}else{if(!m){i=6;a=k;i=7;c(d||h,true);}}}catch(l){e.success("messagesLayer","e.openLayer_"+i);}},closeLayer:function(j){var i=!j||b();if(a&&i){c(a,false);}},resetLayer:function(j){if(j){this.openLayer();}else{var i=f();if(i!==h){c(h,true);}}}};});define("OK/messages/MessagesLayer",["require","module","OK/messages/HistoryHelper","OK/messages/MessagesConfig","OK/messages/ConversationsManager","OK/messages/ConversationsList","OK/messages/Timing","OK/logger","OK/utils/utils","OK/utils/dom","OK/utils/vanilla","OK/messages/Search","OK/messages/Chatname","OK/utils/delegate","OK/messages/Helper","OK/messages/StickerOverlays","OK/capture","OK/ToolbarGrowl"],function(h){var e=h("module"),a=h("OK/messages/HistoryHelper"),H=h("OK/messages/MessagesConfig"),T=h("OK/messages/ConversationsManager"),M=h("OK/messages/ConversationsList"),I=h("OK/messages/Timing"),y=h("OK/logger"),V=h("OK/utils/utils"),b=h("OK/utils/dom"),C=h("OK/utils/vanilla"),u=h("OK/messages/Search"),j=h("OK/messages/Chatname"),N=h("OK/utils/delegate"),o=h("OK/messages/Helper"),t=h("OK/messages/StickerOverlays"),v=h("OK/capture"),g=h("OK/ToolbarGrowl"),O="invisible",q="messages",U="toolbar_nav_a__messa__active",Q=document.getElementById("msg_layer_wrapper"),E=document.getElementById("msg_toolbar_button"),r=true,p=H.get().cacheTimeout,w=0,i=[],B,n,c,z,A,F=H.get().historyFix;function R(){var W=OK.hookModel.getHookById("MessagesAdsPanel");if(W){z=W.element;if(!z.innerHTML.length){z=null;}}}function S(){if(z&&OK.util.is4ColumnActive()){v.activate(z.firstChild);}}function m(){if(z){v.deactivate(z.firstChild);}}function D(){if(!M.hasSelected()){return;}M.deselect();V.ajax({url:"/dk",data:{cmd:"ConversationWrapper"}}).done(function(X,W,Y){a.resetLayer(F);V.updateBlockModelCallback(X,W,Y);}).fail(function(){y.error("messagesLayer.error","reset");});}function K(X){if(r){return;}r=true;c=null;m();var Y=M.deselect(),W;if(Y){W=T.getById(Y);if(W){c={id:Y,element:W.element};if(H.get().convDeactivateEnabled&&c.element){v.deactivate(c.element);}}}Q.classList.add(O);E.classList.remove(U);if(OK.Layers&&OK.Layers.remove){OK.Layers.remove(q);OK.Layers.onLayerHidden();}a.closeLayer(F);if(!X&&OK.restorePopLayerIfAny){OK.restorePopLayerIfAny();}if(H.get().hideTimestampOnVideoStart){document.removeEventListener("__videoPlayerEvent",P);}}function G(){if(!r){return;}if(OK.hideToolbarPanes){OK.hideToolbarPanes();}if(OK.hidePopLayerIfAny){OK.hidePopLayerIfAny();}r=false;if(k()){S();}Q.classList.remove(O);E.classList.add(U);OK.Layers.register(q,K,null);OK.Layers.onLayerShown();if(c){M.select(c.id);if(H.get().convDeactivateEnabled&&c.element){v.activate(c.element);}else{var X=T.getById(c.id);if(X){X.onLayerOpened();}}}else{a.resetLayer(F);}g.destroyByLayerId(q);if(H.get().hideTimestampOnVideoStart){document.addEventListener("__videoPlayerEvent",P);}var W=e.config().tns;if(W){new Image().src=W+(~~performance.now());}}function d(){return document.getElementById("js-messages_hasFriends")!==null;}function x(){var W=performance.now();if(W>(w+p)){w=W;return true;}return false;}function k(){return B||!x();}function s(){B=d();w=performance.now();n=new N(Q);u.bind(n);j.bind(n);t.bind(n);}function f(W){h(["OK/messages/CreateConversationButton"],function(X){X.openCreateConversation(W);});}function J(Y,X,W,Z){if(!X){return o.getFilterTab()?true:false;}if(o.getFilterTab()!=X){return true;}if(Y&&!r){return false;}return(o.getFilterGroupId()!=W)||(o.getFilterUnanswered()!=Z);}function P(W){h(["OK/OKVideo"],function(X){if(W.detail.name!=="started"){return;}if(A){L(A,false);}var Y=b.parent(X.getPlayer(),"msg",Q);if(!Y){return;}A=Y.id;L(A,true);});}function L(Y,W){var X=b.firstByClass(document.getElementById(Y),"msg_meta");if(X){X.classList.toggle("hidden",W);}}function l(X,W){i.push({convId:X,delayedMsg:W});}return{activate:function(X){I.log("start");var ab=X.getAttribute("data-convId");var W=X.getAttribute("data-mockId");var Y=X.getAttribute("data-filterTab");var aa=X.getAttribute("data-filterGroupId");var Z=ab||W?{conversationId:ab,mockId:W,filterTab:Y,filterGroupId:aa}:null;this.show(Z);R();},deactivate:function(){n.off();z=null;},open:function(Z){Z=Z||{};var Y=C.extractParams(Z.url),ae=Z.conversationId||Z.mockId,W=Y["st.filterGroupId"],ac=Y["st.filterUnanswered"],ab=!k()||J(ae,Z.filterTab,W,ac),ad=!ae&&!ab&&M.hasSelected(),X=Y["st.create"],aa=Y["st.crtrt"];if(!ae&&!ab&&!ad&&!X&&!r){return;}if(!ae){a.resetLayer(F);}if(Z.delayedMsg){l(Z.conversationId,Z.delayedMsg);}OK.loader.use(["OKCustomJs"],G);if(ab){I.log("data-loading");V.ajax({url:E.getAttribute("data-url"),data:{"st.convId":Z.conversationId,"st.mockId":Z.mockId,"st.filterTab":Z.filterTab,"st.filterGroupId":W,"st.filterUnanswered":ac,"st.viewportw":~~window.screen.availWidth,"st._bh":~~window.innerHeight,"st._bw":~~window.innerWidth,"st.create":X,"st.crtrt":aa},timeout:H.get().ajaxTimeout},H.get().ajaxRetryCount).fail(function(af,ah,ag){K();if(ag){y.errorEx(ag,"messagesLayer.error","open-"+ah);}else{y.error("messagesLayer.error","open-"+ah);}}).done(function(ag,af,ah){V.updateBlockModelCallback(ag,af,ah);s();I.log("data-loaded");if(!ae&&!W){I.log("onboarding");}R();});}else{if(X){f(aa);}else{if(ae){T.open(Z.conversationId,Z.mockId);}else{if(ad){this.reset();}}}}},show:function(W){if(!B){this.open(W);}else{a.resetLayer(F);OK.loader.use(["OKCustomJs"],G);}},close:function(W){K(W);},toggle:function(){if(r){this.show();}else{this.close();}},reset:D,isOpen:function(){return !r;},isLoaded:function(){return B;},getDelayedMsg:function(X){var W;i.some(function(Z,Y){if(Z.convId===X){W=Z.delayedMsg;i.splice(Y,1);return true;}});return W;}};});define("OK/messages/ScrollArrow",["OK/logger","OK/utils/dom","OK/messages/Search","OK/messages/ConversationsManager"],function(a,h,c,b){var f="__active",e="__fetching";function d(i){a.success("messagesLayer","toast",i);}function g(i){this.conversation=i;this.element=h.firstByClass(i.element,"js-new-messages-tip");this.hidden=true;this.isArrow=this.element.classList.contains("js-scroll-arrow");}g.prototype={show:function(){if(this.hidden){this.element.addEventListener("click",this);this.element.classList.add(f);this.hidden=false;this.update();}},hide:function(){if(!this.hidden){this.element.classList.remove(f);this.element.removeEventListener("click",this);this.hidden=true;}},update:function(){if(!this.hidden&&this.isArrow){this.element.classList.toggle("__new",this.conversation.isUnread());}},handleEvent:function(){this.scroll();},scroll:function(){var k=this.conversation,i=k.scrollController,j=this;if(c.isSearchInMessagesList()&&!c.newSearchEnabled()){k.selected=false;b.open(k.id);return;}if(!i.getLoader().hasMore()){d("scroll");i.scrollToBottom();}else{if(!this.fetching){this.fetching=true;d("load");j.element.classList.add(e);k.list.load().then(function(){i.scrollToBottom();j.element.classList.remove(e);j.fetching=false;},function(){i.scrollToBottom();a.error("messagesLayer.error","toast_ajax");});}}}};return g;});define("OK/messages/InfoPanelState",["OK/utils/dom"],function(c){var b={};function a(d){c.remove(d);}return{closeInfoPanel:function(){var e=document.getElementById("msg_info_panel");if(e){var f=e.getAttribute("data-convId"),d=e.getAttribute("data-type");b[f+"."+d]=true;a(e);}},hideInfoPanelIfNeeded:function(){var e=document.getElementById("msg_info_panel");if(e){var g=e.getAttribute("data-convId"),d=e.getAttribute("data-type");var f=b[g+"."+d];if(f){a(e);}}}};});define("OK/messages/CopyMsgText",["OK/utils/dom","OK/messages/MessagesConfig"],function(f,a){var c="js-copy-text";function b(){return(typeof window.getSelection!="undefined");}function e(j){var h=false;if(!j.isCollapsed){var i=document.createRange();i.setStart(j.anchorNode,j.anchorOffset);i.setEnd(j.focusNode,j.focusOffset);h=i.collapsed;i.detach();}return h;}function d(h,i){while(h&&h.className.indexOf("msg")<0){if(i){h=h.previousElementSibling;}else{h=h.nextElementSibling;}}return h;}function g(k,I,p){var o=f.firstByClass(k,c);if(!o){return"";}var z="",v=o.childNodes.length,G=p.copyType,r=p.leftRight,x=p.onlyText,n=G=="start"||G=="both",l=G=="finish"||G=="both",t=r?I.focusNode:I.anchorNode,A=r?I.anchorNode:I.focusNode,D=r?I.anchorOffset:I.focusOffset,m=r?I.focusOffset:I.anchorOffset;if(n){if(f.parent(A,c,o)!=o){n=false;D=-1;}}if(l){if(f.parent(t,c,o)!=o){l=false;m=-1;}}var H=n&&A.nodeType==3,y=l&&t.nodeType==3;var h=-1,E=-1,C,u;if(n){if(!H){h=D;}else{for(C=0;C<v;C++){u=o.childNodes[C];if(u.tagName&&u.tagName.toLowerCase()=="span"){u=u.firstChild;}if(u==A){h=C;break;}}}}if(l){if(!y){E=m-1;}else{for(C=0;C<v;C++){u=o.childNodes[C];if(u.tagName&&u.tagName.toLowerCase()=="span"){u=u.firstChild;}if(u==t){E=C;break;}}}}var s=h>=0?h:0;var F=E>=0?E:v-1;function w(j,i){if(j.tagName&&j.tagName.toLowerCase()=="span"){j=j.firstChild;}if(j.data){if(n&&l){if(D<0){D=0;}if(m<0){m=j.data.length;}i+=j.data.substring(D,m);}else{if(C===h&&H){i+=(D>0?j.data.substring(D):j.data);}else{if(C===E&&y){i+=(m>0?j.data.substring(0,m):j.data);}else{i+=j.data;}}}}else{if(j.className.indexOf("emoji")>=0){i+=j.alt;}else{if(j.tagName.toLowerCase()=="a"){i+=j.innerText;}else{if(j.tagName.toLowerCase()=="br"){i+="\n";}}}}return i;}for(C=s;C<=F;C++){u=o.childNodes[C];if(u.childNodes.length>1){for(var B=0;B<u.childNodes.length;B++){var q=u.childNodes[B];z=w(q,z);}}else{z=w(u,z);}}return z;}return{copyEvent:function(A,p,h){if(!a.get().copyMsgText||!b()){return;}var D=null;if(window.getSelection){D=window.getSelection();}if(!D){return;}var o=D.anchorNode,v=D.focusNode,r=f.parent(o,"msg",p),l=f.parent(v,"msg",p),m=!e(D);if(m&&r&&!l){l=h;}else{if(!m&&!r&&l){r=h;}}if(!r||!l){return;}var z=f.parent(o,c,r),C=f.parent(v,c,l),y=r===l,s=y&&z&&C;if(s){return;}var x="",k,B,t,i,n,w;if(m){n=d(r,false);w=d(l,true);}else{n=d(l,true);w=d(r,false);}if(!n||!w){return;}A.preventDefault();var j={leftRight:m};do{i=!i?n:i.nextElementSibling;if(i.className.indexOf("msg")>=0){k=i.getAttribute("data-copy-author");B=i.getAttribute("data-copy-date");var u=undefined;if(i==n&&n==w){u="both";}else{if(i===n){u="start";}else{if(i===w){u="finish";}}}var q=$.extend({},j,{copyType:u});t=g(i,D,q);if(t.trim().length>0){if(x.length>0){x+="\n";}x+=("["+B+"] "+k+": ");x+=t;}}}while(i!==w);x+="\n\r";if(A.clipboardData){A.clipboardData.setData("text/plain",x);}else{if(window.clipboardData){window.clipboardData.setData("Text",x);}}}};});define("OK/UserClientCache",["OK/utils/utils"],function(b){var a=b.deferred(),c=[];function d(e){c.forEach(function(f){f(e);});}return{activate:function(e){a.resolve(e);},listen:function(g,e,f){a.promise.then(function(h){h.addListener(g,e,f);});},add:function(e,f){a.promise.then(function(g){var i={};var h={ui:e,online:f||0};i[e]=h;g.updateUserCache(i);d([h]);});},remove:function(e){a.promise.then(function(f){f.removeRefFromCache(e);});},ifOnline:function(e){return new Promise(function(g,f){a.promise.then(function(i){var h=i.getFromUserCache(e);var j=h&&(h.online===1||h.online===4||h.online===5);if(j){g();}else{f();}});});},registerOnAddListener:function(e){c.push(e);},unregisterOnAddListener:function(f){var e=c.indexOf(f);if(e>-1){c.splice(e,1);}}};});define("OK/messages/ConvOnlineStatusTextUpdater",["OK/utils/utils","OK/utils/dom","OK/UserClientCache"],function(p,o,i){var b={},q,c,f="hook_Block_ConversationParticipantsText",g="js-conv-info-meta";function n(s){j(s);}function l(s){j(s);}function j(s){if(m()===0){return;}var t=false;s.forEach(function(u){var v=b[u.ui];if(v&&u.ui!=c){v.status=u.online||0;t=true;}});if(t){h();}}function e(s){}function h(){r().then(function(t){if(t){var s=document.getElementById(f);if(s){s.innerHTML=t;}var u=document.getElementById(g);if(u){u.innerHTML=t;}}});}function k(){var s=0;Object.keys(b).forEach(function(u){var t=b[u];if(u==c||t.status&&t.status>0){s++;}});return s;}function d(s){return s===1;}function a(s){return s===m();}function m(){return Object.keys(b).length;}function r(){return new Promise(function(t){var u=k();var s=m();OK.loader.execRequire("OK/pts!messaging.client",function(w){var v=null;if(q){if(d(u)){v=w.getLMsg("participants.count",{count:s,countPlural:s});}else{if(!d(u)&&!a(u)){v=w.getLMsg("participants.count.online",{count:s,online:u});}else{if(a(u)){v=w.getLMsg("participants.count.online.all",{count:s});}}}}else{if(a(u)){v=w.getLMsg("online");}}t(v);});});}i.listen(n,l,e);i.registerOnAddListener(n);return{activate:function(s){c=s.getAttribute("data-currentUserId");q=s.getAttribute("data-isChat")=="true";b=OK.util.parseJSON(s.firstChild.innerHTML);},deactivate:function(s){b={};},onAddedParticipants:function(s){s.forEach(function(t){b[t.userId]=t;});},onRemovedParticipants:function(s){s.forEach(function(t){delete b[t.userId];});}};});define("OK/messages/Column",["OK/utils/utils","OK/utils/dom"],function(m,g){var j="ChatColumnHolder",k="click",l="invisible",b="__active",c="__column",i="__fullscreen",e="__loading";function h(o){o.stopPropagation();}function n(){this.ajaxProcessing=false;}function a(o){this.ajaxProcessing=false;if(this.hookElem){OK.hookModel.setHookContent(j,o);this.el.classList.remove(e);}}function d(o){if(this.isFullscreen){return false;}while(o){if(o.id==="hook_Block_PopLayer"){return true;}if(o==this.button||o==this.block){return true;}o=o.parentElement;}}function f(){this.el=g.firstByClass(document,"js-chat_column_w");}f.prototype={activate:function(p){this.hookElem=p;this.visible=false;this.button=document.getElementById(p.getAttribute("data-holder"))||this.hookElem;this.block=document.getElementById("hook_Block_"+j);this.toolbar=g.firstByClass(document,"js-chat_toolbar");this.hideListener=this.hide.bind(this);this.clickListener=h.bind(this);this.layerName="dd-menu"+OK.util.nextId();this.button.addEventListener(k,this);if(this.isFullscreen){this.block.addEventListener(k,this.clickListener);}var q=this.button.getAttribute("data-additional-button"),o=this;this.additionalButtons=q&&g.byClass(document,q);if(this.additionalButtons){this.additionalButtons.forEach(function(r){r.addEventListener(k,o);});}},deactivate:function(){this.hide();this.button.removeEventListener(k,this);this.block.removeEventListener(k,this.clickListener);this.block=null;this.hookElem=null;var o=this;if(this.additionalButtons){this.additionalButtons.forEach(function(p){p.removeEventListener(k,o);});this.additionalButtons=null;}},show:function(){if(!this.visible){var o=this;o.visible=true;o.button.classList.add(b);o.toolbar.classList.add(c);o.el.classList.remove(l);if(o.isFullscreen){o.el.classList.add(i);}clearTimeout(this.t);this.t=setTimeout(function(){if(o.ajaxProcessing){o.el.classList.add(e);}},500);OK.Layers.register(this.layerName,o.hideListener);if(!o.isFullscreen){document.body.addEventListener(k,o.hideListener,true);}}},hide:function(p){if(this.visible){if(p&&d.call(this,p.target)){return;}var o=this;this.visible=false;this.button.classList.remove(b);this.toolbar.classList.remove(c);this.el.classList.add(l);this.el.classList.remove(i);OK.hookModel.setHookContent(j,"");OK.Layers.remove(this.layerName);document.body.removeEventListener(k,o.hideListener,true);}},handleEvent:function(o){if(this.visible){this.hide();o.stopPropagation();}else{if(!this.ajaxProcessing){this.show();this.ajaxProcessing=true;m.ajax({type:"GET",url:this.hookElem.getAttribute("data-url"),dataType:"html"}).always(n.bind(this)).done(a.bind(this));}}},setFullscreen:function(){this.isFullscreen=true;}};return f;});define("OK/messages/ColumnManager",["OK/messages/Column"],function(b){var a=[];return{activateColumn:function(d){var c;a.some(function(e,f){if(e.button===d){c=e;return true;}});if(!c){c=new b();c.setFullscreen();c.activate(d);c.handleEvent();a.push(c);}},deactivateColumns:function(){a.forEach(function(c){c.deactivate();});a=[];}};});define("OK/messages/HelloStickers",["require","OK/utils/dom","OK/logger"],function(e){var f=e("OK/utils/dom"),l=e("OK/logger"),j="click",g="__closed",k=[],b,i,d,a,c;function h(n){var p=b.classList,m=k.indexOf(a),o=n||!p.contains(g),q;if(o){if(m===-1){k.push(a);q=n?"onMsgSend":"close";}}else{if(m>-1){k.splice(m,1);}q="open";}p.toggle(g,o);if(q){l.success("messagesLayer","helloStickers",q);}}return{activate:function(m,n){b=f.firstByClass(m,"js-hello-stickers");if(b){a=b.getAttribute("data-id");c=f.parent(b,"chat_boost");if(k.indexOf(a)>-1){c.classList.remove("__hello-stickers");l.success("messagesLayer","helloStickers","hidden");}else{i=f.firstByClass(b,"js-hello-sticker-toggler");if(i){i.clickListener=function(){h();};i.addEventListener(j,i.clickListener);}}d=f.firstByClass(b,"js-quick-hello");if(d&&n){d.clickListener=function(q){var o=q.target;if(o&&o.classList.contains("js-quick-hello-tag")){var p=b.getAttribute("data-sticker-place");n({content:o.innerHTML,stickerPlace:p?"text_"+p:p});}};d.addEventListener(j,d.clickListener);}}},deactivate:function(){if(i){i.removeEventListener(j,i.clickListener);i.clickListener=null;i=null;}if(d){d.removeEventListener(j,d.clickListener);d.clickListener=null;d=null;}b=null;},close:function(){if(b){h(true);}}};});define("OK/messages/Conversation",["require","jquery","OK/messages/MessageForm","OK/messages/TypingStatus","OK/messages/ReadMarks","OK/messages/MessagesList","OK/utils/utils","OK/discussions/ScrollController","OK/messages/Helper","OK/messages/WindowVisibility","OK/utils/dom","OK/messages/MessagesLayer","OK/messages/ConversationsList","OK/messages/Search","OK/messages/SearchPanel","OK/ImagesLoadCallback","OK/logger","OK/utils/throttle","OK/messages/MessagesConfig","OK/messages/StickerOverlays","OK/messages/UnsentMessages","OK/messages/HistoryHelper","OK/messages/ScrollArrow","OK/messages/DateBar","OK/HookModel","OK/messages/InfoPanelState","OK/AttachPicker","OK/messages/CopyMsgText","OK/messages/ConvOnlineStatusTextUpdater","OK/messages/ColumnManager","OK/messages/HelloStickers","OK/messages/Timing"],function(e){var K=e("jquery"),ac=e("OK/messages/MessageForm"),b=e("OK/messages/TypingStatus"),f=e("OK/messages/ReadMarks"),p=e("OK/messages/MessagesList"),ag=e("OK/utils/utils"),ab=e("OK/discussions/ScrollController"),o=e("OK/messages/Helper"),M=e("OK/messages/WindowVisibility"),c=e("OK/utils/dom"),T=e("OK/messages/MessagesLayer"),ad=e("OK/messages/ConversationsList"),A=e("OK/messages/Search"),E=e("OK/messages/SearchPanel"),Y=e("OK/ImagesLoadCallback"),H=e("OK/logger"),L=e("OK/utils/throttle"),G=e("OK/messages/MessagesConfig"),af=e("OK/messages/StickerOverlays"),u=e("OK/messages/UnsentMessages"),a=e("OK/messages/HistoryHelper"),z=e("OK/messages/ScrollArrow"),C=e("OK/messages/DateBar"),r=e("OK/HookModel"),d=e("OK/messages/InfoPanelState"),U=e("OK/AttachPicker"),q=e("OK/messages/CopyMsgText"),I=e("OK/messages/ConvOnlineStatusTextUpdater"),i=e("OK/messages/ColumnManager"),D=e("OK/messages/HelloStickers"),S=e("OK/messages/Timing"),x=90,t="conversation",P="click",F="keydown",l="keypress",s="copy",w=86,O=70,Z=38,B=8,R=13,N,j="hook_Block_ConversationContent",aa="js-no-msg-stub",ae="__activated";function v(){return document.getElementById("hook_Block_ConversationWrapper");}function Q(ah){return !ah.selected?ah.cachedContent:ah.element;}function k(ah){return ah.scrollController.isScrolledToBottom(x);}function h(ah){if(!ah.getCenterMsg()){if(ah.scrollTop!==undefined){ah.scrollController.setScrollTop(ah.scrollTop);ah.scrolledToBottom=false;}else{if(ah.scrollToUnread){var ai=ah.list.getFirstUnreadCard();if(ai){ah.scrollController.scrollTo(ai,-200);ah.scrolledToBottom=k(ah);return;}}ah.scrollController.scrollToBottom();ah.scrolledToBottom=true;}}else{ah.scrollController.scrollToCenter(ah.getCenterMsg());}}function y(){var ah=document.getElementById("chat_loader");if(ah){ah.classList.add("invisible");}}function g(ai){var ah=c.parent(ai,"js-smileart");c.forEach(ah.childNodes,function(aj){if(aj.classList.contains("js-smileart_cnt")){aj.classList.toggle("invisible");}});}function n(){if(OK.Layers){var ah=OK.Layers.stack;return ah.length>0&&ah[ah.length-1].id==="messages";}return false;}function m(ao,aj,am){if(!n()){return false;}var an=ao.target,ak=an.tagName.toLowerCase(),al=aj.form,ai=al.textarea[0],ah=an.contentEditable==="true";return !(ak==="input"||ak==="textarea"||(ai===an&&am)||al.isRestricted()||(ah&&am));}function J(){if(N){return;}var ah=10,aj=this.element,al=this.element.scrollHeight-this.element.offsetHeight-this.element.scrollTop,ak=al/ah,ai=function(){if(ah>=0){aj.scrollTop+=ak;ah--;N=requestAnimationFrame(ai);}else{if(aj.scrollHeight-aj.offsetHeight-aj.scrollTop>0){aj.scrollTop+=aj.scrollHeight;N=null;}else{N=null;}}};ai();}function W(ah,ai){h(ah);if(!ah.msgFound&&ah.scrolledToBottom){ah.readMarks.send(ai);}}function X(ah){var ai=T.getDelayedMsg(ah.id);if(ai){ah.form.postToForm({content:ai});}}function V(ah,ak){var ai=0;try{this.element=ah;ai=1;this.id=ah.getAttribute("data-id");ai=2;this.isChat=this.id.indexOf("CHAT")>=0;ai=3;this.list=new p(this);ai=4;this.typingStatus=new b(this);ai=5;this.readMarks=new f(this.list);ai=6;this.messageAjaxController=ak;}catch(aj){H.success("messagesLayer","e.conv_"+ai);}}V.prototype={activate:function(ak){var an=0;try{var at=c.firstByClass(document,"js-msg-loader"),ao,av=this,az=v(),ar=K(az),ah=c.firstByClass(az,"chat_cnt"),aw=c.firstByClass(az,"js-chat_write"),aj=c.firstByClass(az,"js-comments_add_form"),al=c.byClass(az,aa),am,ai,ap;an=1;this.loaderId=at?at.getAttribute("data-loader-id"):null;this.element=ak;this.searchLink=ak.getAttribute("data-search-url");this.unreadCount=ak.getAttribute("data-unread-count");this.selected=true;this.readMarkState=ak.getAttribute("data-readMarkState");this.msgFound=ak.getAttribute("data-msg-found");this.showMessageAuthorReadMark=ak.getAttribute("data-showMessageAuthorReadMark")==="true";this.scrollToUnread=ak.getAttribute("data-scrollToUnread")==="true";this.typingText=ak.getAttribute("data-typingText");this.opponentId=ak.getAttribute("data-opponentId");this.keepInfoPanel=ak.getAttribute("data-keepInfoPanel")==="true";this.scrollArrow=new z(this);an=2;ak.addEventListener("click",this);document.addEventListener(F,this);document.addEventListener(l,this);document.addEventListener(s,this);M.addListener(this);an=3;A.activate(this.id);an=4;if(this.msgFound){A.openSearchPanel();}an=5;this.elements={container:ar,commentsListContainer:K(".chat_cnt",ar),commentArea:K(".js-comments_add",ar),commentAreaContainer:K(".js-comments_form",ar),scrollingContainer:document.getElementById(j),scrollEl:ah,toast:av.scrollArrow.element,noMsgStubs:al,pinnedMessagePanel:document.getElementById("hook_Block_PinnedMessage"),callHeaderPanel:document.getElementById("hook_Block_MessagesCallHeader")};an=6;am=this.typingStatus;var ax=G.get();this.isToggleFakeCaret=aj?aj.getAttribute("data-toggle-fake-caret")==="true":false;var aq=aj?aj.getAttribute("data-check-attach-on-submit")==="true":false;ai=K.extend({},av.elements,{collapsable:false,checkAttachOnSubmit:aq,isStickyForm:false,typingCheckTimeout:500,typingListener:{onTypingStatusChanged:function(aA){am.send(aA);}},parseLinks:aw?aw.getAttribute("data-parseLinks")==="true":false,instantSending:true,instantPaste:true,sendOnCtrlEnter:ax.user.isSendOnCtrlEnter,newLineOnCmdEnter:true,cleanOnPaste:ax.poorPasteClean,messageAjaxController:this.messageAjaxController,asyncUploadEnabled:ax.asyncUploadEnabled,sendStickerAsAttach:ax.sendStickerAsAttach});an=7;this.scrollController=new ab({scrollingContainer:ah},this.loaderId);an=8;this.form=new ac(av.elements.commentArea,av,ai);an=9;this.list.init(av.elements.commentsListContainer[0]);an=11;ap=function(aA){W(av,aA);};ap(true);an=12;if(ah){an=125;this.scrollController.addListener(L(200,function(){av.scrolledToBottom=k(av);an=122;if(av.scrolledToBottom){if(av.isFullyLoaded()){av.scrollArrow.hide();av.typingStatus.hideConvItem();}else{av.typingStatus.showConvItem();}an=124;av.readMarks.send();}else{if(av.scrollArrow.isArrow){av.scrollArrow.show();}av.typingStatus.showConvItem();}}),t);this.scrollController.addListener(L(10,function(){C.show(av.scrollController.getScrollTop());}),t);ao=this.scrollController.getLoader();if(ao!=null){ao.onPageLoaded=function(){C.show(av.scrollController.getScrollTop());};}}an=13;av.typingStatus.onConversationOpened(this);an=14;this.imagesLoadCallback=new Y();this.imagesLoadCallback.run(j,ap);an=16;this.repaintRichMessages();an=17;this.addUnsentMessages();an=18;a.openLayer(this.id,o.getFilterTab());an=19;if(!this.msgFound&&this.loaderId){this.promise=r.hookActivated(this.loaderId);this.promise.then(function(){if(!av.isFullyLoaded()){av.scrollArrow.show();}});}an=20;var au=o.getConvLastMsgId(this.id);if(!au&&this.list.hasMessages()){ag.ajax({url:"/dk?cmd=LastMsgUpdater",data:{"st.convId":av.id}}).done(function(aB,aA,aC){OK.hookModel.setHookContent("LastMsgUpdater",aB);});}d.hideInfoPanelIfNeeded();D.activate(az,av.form.postToForm.bind(av.form));if(av.elements.pinnedMessagePanel){av.list.msgReplies.activate(av.elements.pinnedMessagePanel);}an=21;X(av);av.markedAsUnread=false;}catch(ay){H.success("messagesLayer","e.convAct_"+an);H.clob("error",ay.stack,"messagesLayer","conv_activate");}ak.classList.add(ae);y();S.log("chat-opened");},deactivate:function(ah){this.fullyLoaded=this.isFullyLoaded();this.selected=false;if(OK.Layers.isLayerOpened("layer_promo")||OK.Layers.isLayerOpened("modal_hook")){OK.Layers.unregisterLast();}this.scrollArrow.hide();if(this.markedAsUnread){this.imagesLoadCallback.removeCallback();}this.imagesLoadCallback.done();this.imagesLoadCallback=null;ah.classList.remove(ae);ah.removeEventListener("click",this);document.removeEventListener(F,this);document.removeEventListener(l,this);document.removeEventListener(s,this);M.removeListener(this);this.editMode(false);this.replyMode(false);this.form.destroy();this.list.destroy();A.deactivate();af.onConversationClosed(this);this.typingStatus.onConversationClosed();this.typingStatus.destroy();this.typingStatus=null;this.scrollController.removeListeners(t);this.scrollController=null;if(this.promise){r.removeObserver(this.promise,this.loaderId);this.promise=null;}if(this.promise){r.removeObserver(this.promise,this.loaderId);this.promise=null;}i.deactivateColumns();D.deactivate();if(this.elements.pinnedMessagePanel){this.list.msgReplies.deactivate(this.elements.pinnedMessagePanel);}},isUnread:function(){return this.unreadCount>0;},handleEvent:function(ah){switch(ah.type){case P:this.clickEvent(ah);break;case F:this.keyDownEvent(ah);break;case s:this.copyEvent(ah);break;}},clickEvent:function(ai){var ah=ai.target,al=ah.classList,ak;while(ah&&ah!==ai.currentTarget){ak=ah.classList;if(ak.contains("js-smileart_button")){ai.stopPropagation();g(ah);break;}if(ak.contains("js-msg-reply")){ai.stopPropagation();this.replyMode(true,ah);break;}if(ak.contains("js-msg-forward")){ai.stopPropagation();i.activateColumn(ah);break;}if(ak.contains("js-msg-edit")){ai.stopPropagation();this.handleEdit(ah);break;}if(ak.contains("js-mark-as-unread")){ai.stopPropagation();this.handleMarkAsUnread(ah);break;}if(ak.contains("js-conv-markAsAnswered")){ad.markAsAnswered(this.id);ah.classList.add("invisible");ah.nextSibling.classList.remove("invisible");break;}if(ak.contains("js-call-button")){ai.stopPropagation();if(!OK.hookModel.isHookEmpty("VideoChatCall")){e(["OK/videochat/UI"],function(an){var am=an.get();am&&am.toggleMini(false);});}}if(ak.contains("js-open-emojiarea")&&!al.contains("sticker_play")){var aj=this.form.textarea.data("emojiarea");if(aj&&aj.menu){H.success("messagesLayer","livesticker","open-emojiarea");aj.menu.openTab(aj,".js-tab-postcards");}break;}ah=ah.parentNode;}},copyEvent:function(ah){q.copyEvent(ah,this.element,this.list.getLast());},keyDownEvent:function(al){var ak=al.keyCode,aj=al.altKey,an=al.ctrlKey||al.metaKey,am=an&&ak===w,ai=an&&!al.shiftKey,ah=an&&ak===O;if(!m(al,this,!ah)){return;}if(ak===B){return;}if(ak===R){this.form.form.trigger("submit",[true]);al.preventDefault();return;}if(!an&&ak===Z){this.list.editLast();return;}if(ah){if(aj){A.focusSearchInConvList();}else{if(E.isActivated()){E.toggle();}else{A.openSearchPanel();}}al.preventDefault();return;}if(am||!ai){this.form.autoFocus();}},handleEdit:function(aj){var al=aj.getAttribute("data-query"),ah=OK.hookModel.getHookById(al+"-Content"),ai,ak;if(ah){ai=c.firstByClass(ah.element,"msg_tx_cnt");ak=ai&&ai.childNodes&&ai.childNodes[0];this.editMode(true,al,ak&&ak.innerHTML);}},handleMarkAsUnread:function(aj){var ah=this,ak=aj.getAttribute("data-msg-id"),ai=G.get();ag.ajax({url:"/web-api/messages/conversation/markAsUnread",data:{cid:ah.id,mid:ak},timeout:ai.ajaxTimeout},ai.ajaxRetryCount).done(function(al){if(al){ah.markedAsUnread=true;}});},post:function(al,ai){var ah=this,aj=ai.hasOwnProperty("error");if(aj){this.list.setError(al,ai);if(ai.type==="BLOCKER"){ah.form.activateRestrictedMode();}if(ai.type==="GIF_NOT_PURCHASED"){e(["OK/AttachPicker"],function(am){am.callGifPaymentWizard();});}if(ai.type==="POSTCARD_NOT_PURCHASED"){e(["OK/emojiarea"],function(am){am.addMoneyAndSendSticker();ah.list.removeStub(al);});}if(ai.type==="STICKER_SET_NOT_PURCHASED"||ai.type==="STICKER_SET_NOT_PURCHASED_VIP"){var ak=ai.type==="STICKER_SET_NOT_PURCHASED_VIP"?33:19;e(["OK/emojiarea"],function(am){am.callStickerSetLayer(ak);ah.list.removeStub(al);});}if(ai.type!=="TEMPORARY"){u.removeMessage(this.id,al);u.onSendRetry(ah.list,al,"onError");}}else{this.list.replaceMessage(ai);this.scrollToBottom({fancy:true});this.form.deactivateRestrictedMode();}return K.Deferred().resolve();},replyMode:function(ah,aj){var ak=this.form,ai=aj&&aj.getAttribute("data-query");if(ah&&!(ak.isReplyMode()&&this.list.isSelectedMessage(ai))){ak.activateReplyMode(ai);this.list.selectMessage(ai,false,true);ak.showReplyEditPanel(aj);}else{ak.hideReplyEditPanel();ak.deactivateReplyEditMode();this.list.deselectMessage();}},editMode:function(ah,ai,ak){var aj=this.form;if(ah&&!(aj.isEditMode()&&this.list.isSelectedMessage(ai))){aj.activateEditMode(ai,ak);this.list.selectMessage(ai,true,false);aj.showReplyEditPanel(ak);}else{aj.hideReplyEditPanel();aj.deactivateReplyEditMode();this.list.deselectMessage();}},onWindowFocus:function(){if(this.scrolledToBottom&&this.selected&&!this.markedAsUnread){this.readMarks.send();}if(this.isToggleFakeCaret){this.form.toggleFakeCaret(true);}},onWindowBlur:function(){if(this.isToggleFakeCaret){this.form.toggleFakeCaret(false);}},applyNewMessages:function(ak,aj){this.list.addNewMessages(ak);if(this.selected||!this.fullyLoaded||!this.scrollToUnread){return;}var al=G.get().messagesCountForDisablePush,ah,am,ai;if(al<0){return;}if(aj&&aj>al){ah=c.firstByClass(this.cachedContent,"js-msg-loader");if(ah){am=this.list.getCards();ai=am[am.length-1];ah.setAttribute("data-lastelem",ai.getAttribute("id"));ah.setAttribute("data-hasmore",true);this.fullyLoaded=false;}}},applyConvInfoUpdate:function(am){if(am.readMarkState){this.readMarkState=am.readMarkState;}var aj=Q(this),al,ah;if(am.theme){al=c.firstByClass(aj,"js-chat-name-toggle");if(al){al.innerHTML=am.theme;}}if(am.participantsCount){ah=c.firstByClass(aj,"js-participants-count");if(ah){ah.innerHTML=am.participantsCount;}}if(am.chatIcon){OK.hookModel.setHookContent("ConversationNameIcon",am.chatIcon);OK.hookModel.setHookContent("ConversationSettingsNameIcon",am.chatIcon);}if(am.chatClosed){var ak=c.firstByClass(c.firstByClass(aj,"js-chat_write"),"js-comments_form");if(ak){ak.classList.add("__restricted");}var ai=c.firstByClass(aj,"js-chat_close-button");if(ai){c.remove(ai);}}if(am.addedParticipants){I.onAddedParticipants(am.addedParticipants);}if(am.removedParticipants){I.onRemovedParticipants(am.removedParticipants);}if(am.pinUpdated){this.updatePinnedMessage();}this.updateCallHeader(am.hasCall);},applyUpdatedMessages:function(ah){this.list.updateMessages(ah);},applyConvUpdate:function(ah){this.unreadCount=ah.newCommentsCount;this.element.setAttribute("data-unread-count",this.unreadCount);if(!this.isUnread()){this.list.markAsRead();this.scrollArrow.update();}},applyReadMarks:function(ah){if(this.readMarks){this.readMarks.update(ah);}},applyTypingStatuses:function(ah){if(this.typingStatus){this.typingStatus.update(ah);}},getCenterMsg:function(){return c.firstByClass(v(),"js-msg-scroll-center");},onLayerOpened:function(){this.list.onLayerOpened();W(this,true);},onMessageAdded:function(ah){this.scrollToBottom({fancy:true});if(this.scrollController&&!this.scrollController.hasScroll()){this.readMarks.send();}if(!this.scrolledToBottom){if(ah.stub){this.scrollArrow.scroll();}else{this.scrollArrow.show();}}if(this.readMarkState==="COLLAPSED"){this.readMarks.clear();}if(this.elements.noMsgStubs&&this.elements.noMsgStubs.length>0){c.remove(this.elements.noMsgStubs);var ai=c.firstByClass(this.element,"js-messages-list");if(ai){ai.classList.remove("invisible");}this.elements.noMsgStubs=null;}D.close();if(ah.stub&&o.getFilterTab()!="GROUP"){ad.scrollToTop();}this.repaintRichMessages();af.onConversationOpened(this);if(!ah.stub&&this.typingStatus){this.typingStatus.onNewMessageAdded(ah.newMessageAuthors);}ad.onNewMessageAdded();this.scrollArrow.update();if(!this.keepInfoPanel){d.closeInfoPanel();}},repaintRichMessages:function(){},resetBubble:function(ah){if(ah||(this.selected&&o.isLayerOpenedAndActive())){ad.markAsRead(this.id);this.scrollArrow.update();}},searchRequest:function(ai,am,al){var ah=this,ak,aj={"st.query":ai};if(am){aj["st.msgMarker"]=am;}return ag.ajax({url:this.searchLink,data:aj}).done(function(ao,an,ap){if(ah.selected){ag.updateBlockModelCallback(ao,an,ap);ak=ah.getCenterMsg();if(ak){ah.scrollController.scrollToCenter(ak);}else{ah.scrollController.scrollToBottom();ah.scrolledToBottom=true;}}}).always(function(){if(al){al();}}).fail(function(){H.error("messagesLayer.error","searchInConv");});},scrollToBottom:function(ah){if(this.selected&&this.scrollController&&(this.scrolledToBottom||ah&&ah.force)){this.scrollController.scrollToBottom(null,ah&&ah.fancy&&G.get().fancyScroll&&o.isLayerOpenedAndActive()?J:null);}},onMessageInSearchSent:function(ah){A.hideSearchPanel();if(ah){u.removeMessage(this.id,ah);}},isFullyLoaded:function(){if(this.selected){var ah=this.scrollController.getLoader();return !ah||!ah.hasMore();}else{return this.fullyLoaded;}},isScolledToBottom:function(){return this.scrolledToBottom;},addUnsentMessages:function(){var ak=0;try{var ai=this,ah=ai.unsendStubAdded,ao=ai.id;ak=1;var an=u.getUnsentMessages(ao);var al=u.getAsyncMessages(ao);ak=2;var aj=function(aw,av,at,ar){ak=4;var aq=U.get(ai.form.objectId);if(!ah){ak=5;if(ai.list.getMessageElByUuid(av)){ak=6;u.removeMessage(aw,av);return;}else{ak=7;ai.list.addStubMessage(av,at["st.txt"],at["st.attach"],aq);}}if(ar){ak=8;u.onAsycContinue(ai.list,av,aq);}else{var au=function(){ak=9;ai.form.createRequest(at);},ap=ah?"onConvActivate":"manualRetry";ak=10;u.onSendRetry(ai.list,av,ap,au);}};ak=10;Object.keys(an).forEach(function(ap){ak=11;if(!al[ap]){aj(ao,ap,an[ap],false);}});Object.keys(al).forEach(function(ap){ak=11;aj(ao,ap,al[ap],true);});ak=13;ai.unsendStubAdded=true;}catch(am){H.success("messagesLayer","e.convUnsentMessages_"+ak);}},updatePinnedMessage:function(){var ah=this,ai=ah.elements.pinnedMessagePanel;if(ai){ag.ajax({url:"/dk?cmd=PinnedMessage",data:{"st.convId":ah.id}}).done(function(ak,aj,al){ag.updateBlockModelCallback(ak,aj,al);ah.element.classList.toggle("__pin_panel",ak);});}},updateCallHeader:function(ah){var ai=this,aj=ai.elements.callHeaderPanel,ak="MessagesCallHeader";if(!aj){return;}if(ah){ag.ajax({url:"/dk?cmd=MessagesCallHeader",data:{"st.convId":ai.id}}).done(function(am,al,an){if(OK.hookModel.getHookById(ak)){ag.updateBlockModelCallback(am,al,an);}else{aj.innerHTML=am;}ai.element.classList.toggle("__call_panel",am);});}else{if(aj.childNodes.length){if(OK.hookModel.getHookById(ak)){OK.hookModel.setHookContent(ak,"");}else{aj.innerHTML="";}ai.element.classList.remove("__call_panel");}}}};return V;});define("OK/messages/MessageAjaxController",["jquery","OK/messages/ConversationsManager","OK/logger","OK/messages/MessagesConfig","OK/messages/UnsentMessages","OK/utils/utils"],function(c,b,g,h,i,f){var d=function(m,t,k,p,n,o){var q=h.get().retrySend,r=t?"auto":"manual",j=t?m.retriesLeft:q.retriesCount,s=k?m.timeout+q.increaseBy:m.timeout,l=c.ajax({type:m.type,headers:m.headers,url:m.url,data:m.data,timeout:s,retriesLeft:j-1,messageUuid:m.messageUuid,retryType:r});return e(l,p,n,o);},a=function(l,m){var j=l.split(OK.navigation.SPLITER),k=f.getBlockIds(l,"",m);return{uniqueId:k[0],json:OK.util.parseJSON(j[0]),lastMessageId:k[1],lastMessage:j[1],blockIds:k,dataBlocks:j};},e=function(l,m,n,k){var j=h.get().retrySend;l.done(function(q,o,w){try{var v=a(q,w),s=v.json.hasOwnProperty("error");var t=b.getById(m);if(!t){if(s&&v.json.type==="TEMPORARY"){i.removeAsync(m,this.messageUuid);}else{i.removeMessage(m,this.messageUuid);}g.success("messagesLayer","noconvdone");return;}t.form.onSuccess(w,v);var p=this,u=p.retryType;if(u){g.durationScalar("messagesLayer","retry."+u,p.timeout);}}catch(r){g.success("messagesLayer","reqstErr");throw r;}});l.fail(function(B,q){var y=b.getById(m);if(!y){i.removeAsync(m,this.messageUuid);g.success("messagesLayer","noconvfail");return;}var r=this,u=q==="abort",s=q==="timeout",w=B.readyState===0,o=r.retriesLeft,z=r.messageUuid,x=y.list,C,p,A=function(){if(C){clearTimeout(C);}C=setTimeout(function(){p=d(r,true,s,m,n,k);},j.retryDelay);var t=function(){if(C){clearTimeout(C);}if(p&&p.readyState!=4){p.abort();}};i.onSendRetry(x,z,"autoRetry",t);},v=function(){var t=function(){d(r,false,false,m,n,k);};i.onSendRetry(x,z,"manualRetry",t);};if(u){i.removeAsync(m,this.messageUuid);g.success("messagesLayerAsync","retryAborted");return;}if(s||w){if(o>0){A();}else{i.removeAsync(m,this.messageUuid);v();}}}).then(k);return l;};return{sendMessage:function(n,k,s,t,m,q){var j=n["st.uuid"],p=c.param(n),r=h.get().retrySend,l=function(){},o=c.ajax({type:"POST",headers:{TKN:OK.tkn.get()},url:k,data:p+"&gwt.requested="+window.pageCtx.gwtHash,timeout:r.timeout,retriesLeft:r.retriesCount,beforeSend:t||l,messageUuid:j});return e(o,s,m||l,q||l);}};});define("OK/messages/ConversationHook",["OK/messages/Conversation","OK/messages/ConversationsManager","OK/logger","OK/messages/MessageAjaxController"],function(b,c,a,d){return{activate:function(g){try{var f=new b(g,d);c.add(f);f.activate(g);}catch(h){a.success("messagesLayer","e.convHook");}},deactivate:function(f){var g=f.getAttribute("data-id"),e=c.getById(g);e.deactivate(f);}};});define("OK/messages/ConversationsListItem",["OK/messages/ConversationsList","OK/utils/dom","OK/utils/vanilla","OK/messages/MessagesConfig","OK/messages/TypingUtil","PTS/messaging.client"],function(r,q,o,s,n,t){var d="__unread",g="__unreadMy",b="__muted",l="__active",c="__typing",e="__typing_new";function h(u,v){var w;if(v.prv){w=v.id.replace("PRIVATE_","");}else{w=v.id.replace("CHAT_","c");}return u+"_"+w;}function a(w){var x=s.get(),y=h(x.user.id,w),v,z,u;if(localStorage&&x.chatListDrafts){v=localStorage.getItem(y);if(!v){return;}v=v.trim();if(v.length===0||/^[<br>\s\t\n\r]+$/.test(v)){localStorage.removeItem(y);}else{u=document.createElement("div");u.className="chats_i_tx ellip __draft";u.setAttribute("data-label",t.draft);u.innerHTML=v;if(u.innerHTML.trim().length>0){z=w.getLastMsgElement();w.draftElement=z.parentNode.insertBefore(u,z);z.classList.add("invisible");}}}}function f(u){if(u.draftElement){q.remove(u.draftElement);u.draftElement=null;u.getLastMsgElement().classList.remove("invisible");}}function j(v){var u=document.createElement("div");u.innerHTML=v;return u.firstElementChild;}function k(){var u=document.createElement("div");u.classList.add("chats_i_error");return u;}function i(u,v){u.updated=v;u.element.setAttribute("data-updated",v);r.update(u);}function p(u,v){u.counter=parseInt(v.getAttribute("data-counter"),10)||0;u.active=v.classList.contains(l);u.unreadMy=v.classList.contains(g);u.prv=u.id.indexOf("PRIVATE")===0;u.updated=parseInt(v.getAttribute("data-updated"),10)||0;u.muted=v.classList.contains(b);u.lastMsg=null;u.isPush=v.getAttribute("data-push")=="true";if(u.hookId){v.setAttribute("data-hookId",u.hookId);}u.callTimer=q.firstByClass(u.element,"js-chat-call-time");u.startCallTimer();}function m(u){this.hookId=u;this.typingUsers=[];}m.prototype={activate:function(u){this.element=u;this.id=u.getAttribute("data-id");p(this,this.element);if(r.getById(this.id)){q.remove(this.element);}else{r.add(this);}if(!this.active&&this.counter===0){a(this);}},deactivate:function(){this.stopCallTimer();r.remove(this.id,true);},setNewContent:function(z,v,w){var y=this.isActive(),x=j(z),u=this.updated;w();this.element.innerHTML=x.innerHTML;p(this,x);v();if(s.get().convListDuplicatesFix&&!r.getById(this.id)){this.isPush=true;r.restore(this);}if(y){this.select();}this.element.classList.toggle(d,this.counter>0);this.element.classList.toggle(b,this.muted);if(s.get().myUnreadLeftColumn){this.element.classList.toggle(g,this.unreadMy);}if(this.hasUnsent){this.markAsUnsent();}if(u!==this.updated){i(this,this.updated);}},select:function(){this.element.classList.add(l);this.active=true;f(this);},deselect:function(){this.element.classList.remove(l);this.active=false;a(this);},isActive:function(){return this.active;},remove:function(){q.remove(this.element);},markAsRead:function(){this.element.classList.remove(d);this.counter=0;},markAsAnswered:function(){var u=q.firstByClass(this.element,"chats_i_unread");if(u){this.element.removeChild(u);}},mute:function(){if(!this.muted){this.element.classList.add(b);this.muted=true;}},unmute:function(){if(this.muted){this.element.classList.remove(b);this.muted=false;}},markAsUnsent:function(v){var w=this.element,u=w&&q.firstByClass(w,"js-conv-counter");if(u){this.unsentMarker=w.insertBefore(k(),u);}else{this.unsentMarker=this.element.appendChild(k());}this.hasUnsent=true;if(v){i(this,Date.now());}},unMarkAsUnsent:function(){if(this.hasUnsent){this.element.removeChild(this.unsentMarker);this.hasUnsent=false;}},applyTyping:function(w){if(s.get().newTyping){this.typingUsers=n.updateTypingUsers(w&&w.list,this.typingUsers);if(this.active){return;}this.updateTyping(this.typingUsers.length>0);}else{if(this.typingTimer){this.typingTimer=clearTimeout(this.typingTimer);}var u=this,v=w.list.some(function(x){return x.status==="ADDED";});u.element.classList.toggle(c,v);if(v){u.typingTimer=setTimeout(function(){u.element.classList.remove(c);},s.get().typingShowTimeout);}}},applyReadMarks:function(v){if(!v.list){return;}var u=this;v.list.some(function(w){if(!w.mine){u.setMyUnread(false);return false;}return true;});},setMyUnread:function(u){this.unreadMy=u;this.element.classList.toggle(g,u);},toggleTyping:function(u){if(this.prv||!s.get().newTyping){var w=s.get().newTyping?e:c;this.element.classList.toggle(w,u);}else{var v=q.firstByClass(this.element,"js-typing-wr");if(v){v.classList.toggle(c,u);}}},updateTyping:function(z,u,y){if(this.typingTimer){clearTimeout(this.typingTimer);}if(this.prv||!s.get().newTyping){this.toggleTyping(z);}else{var C=document.getElementById("convListTyping");var w=q.firstByClass(this.element,"js-lastMsg");if(C){var x=this.typingUsers;if(u){x=u;}var B=q.firstByClass(w,"js-typing-wr");var v=B?B:C.cloneNode(true);n.updateText(v,x).then(function(F){var E=F.length>0;var D=q.firstByClass(w,"typing-wr");if(!D){D=w.appendChild(v);}z=z&&E;D.classList.toggle(c,z);if(!z){w.removeChild(D);}if(w.firstChild){w.firstChild.classList.toggle("invisible",z);}});}}if(z){if(!y){var A=this;this.typingTimer=setTimeout(function(){A.typingUsers=[];A.updateTyping(false);},s.get().typingShowTimeout);}}else{this.typingUsers=[];}},getLink:function(){if(this.element){var u=q.firstByClass(this.element,"chats_i_ovr");return u.getAttribute("href")+"?"+u.getAttribute("hrefattrs");}return null;},getTypingUsers:function(){return this.typingUsers;},onConversationClosed:function(u){if(u&&u.typingUsers){this.typingUsers=u.typingUsers;this.updateTyping(u.typingUsers.length>0,u.typingUsers);}},getLastMsgElement:function(){if(!this.lastMsg){this.lastMsg=q.firstByClass(this.element,"js-lastMsg");}return this.lastMsg;},setLastMessage:function(x,v,w,z,u){var y=this.getLastMsgElement();y.innerHTML=x;i(this,v);if(s.get().myUnreadLeftColumn&&w&&!z&&!u){this.setMyUnread(true);}},startCallTimer:function(){this.stopCallTimer();if(this.callTimer){var v=parseInt(this.callTimer.getAttribute("data-duration"),10),u=this;this._callTimer=setInterval(function(x){if(++v>=3600){x.textContent=x.getAttribute("data-maxvalue");u.stopCallTimer();}else{var w=new Date(1970,1,1,0,0,v,0);x.textContent=w.toISOString().substr(14,5);}},1000,this.callTimer);}},stopCallTimer:function(){if(this._callTimer){clearInterval(this._callTimer);this._callTimer=null;}}};return m;});define("OK/messages/CreateConversationButton",["require","OK/messages/ConversationsList","OK/messages/ConversationsManager","OK/utils/utils","OK/logger"],function(b){var e=b("OK/messages/ConversationsList"),c=b("OK/messages/ConversationsManager"),h=b("OK/utils/utils"),i=b("OK/logger"),a="__active",d;function f(){c.open(e.getLastSelectedId());}function g(k){var l=e.getLastSelectedId();h.ajax({url:"/dk",data:{cmd:"ConversationWrapper","st.create":true,"st.crtrt":k,"st.restoreConvId":l}}).done(function(n,m,o){e.deselect();h.updateBlockModelCallback(n,m,o);}).fail(function(){i.error("messagesLayer.error","createConv");});}function j(k){k.preventDefault();k.stopPropagation();if(d.classList.contains(a)){f();}else{g();}}return{activate:function(k){d=k;d.addEventListener("click",j);},deactivate:function(k){d.removeEventListener("click",j);},toggle:function(k){d.classList.toggle(a,k);},openCreateConversation:g,closeCreateConversation:f};});define("OK/messages/HelloStickersClose",["require","OK/utils/dom"],function(d){var e=d("OK/utils/dom"),g="click",i=[],b,h,a,c;function f(){i.push(a);h.classList.add("invisible");}return{activate:function(j){b=j;b.addEventListener(g,f);a=b.getAttribute("data-id");c=e.parent(b,"chat_boost");h=e.parent(b,"hello-stickers");if(i.indexOf(a)>-1){c.classList.remove("__hello-stickers");}},deactivate:function(){b.removeEventListener(g,f);}};});define("OK/messages/ThanksPresentsClose",["require","OK/utils/dom"],function(b){var e=b("OK/utils/dom"),d="click",a;function c(){if(a){a.classList.remove("__thanks-present");}}return{activate:function(f){f.addEventListener(d,c);a=e.parent(f,"js-chat_boost");},deactivate:function(f){f.removeEventListener(d,c);f=null;a=null;}};});define("OK/messages/InfoPanel",["OK/messages/ConversationsList","OK/utils/utils","OK/utils/dom"],function(d,a,e){var c="js-hideAc";function b(){var f=this.getAttribute("data-convId");a.ajax({url:this.getAttribute("data-url")},function(g){d.remove(f);if(OK.navigation.redirect){OK.navigation.redirect(g);}});}return{activate:function(f){var g=e.firstByClass(f,c);if(g){g.addEventListener("click",b);}},deactivate:function(f){var g=e.firstByClass(f,c);if(g){g.removeEventListener("click",b);}}};});define("OK/messages/InfoPanelClose",["OK/messages/InfoPanelState"],function(b){function a(c){c.preventDefault();c.stopPropagation();b.closeInfoPanel();}return{activate:function(c){c.addEventListener("click",a);},deactivate:function(c){c.removeEventListener("click",a);}};});define("OK/messages/UserActionConfirm",["require","OK/utils/dom","OK/messages/ConversationsList","OK/messages/ConversationsManager"],function(a){var e=a("OK/utils/dom");var c=a("OK/messages/ConversationsList");var b=a("OK/messages/ConversationsManager");function d(f){var g=document.getElementById(f);if(g){g.classList.add("__active");setTimeout(function(){g.classList.remove("__active");},2000);}}return{activate:function(i){var j=i.getAttribute("data-convId");var g=i.getAttribute("data-reopen-item")==1;if(g){c.deselect();b.open(j,null,true);}var h=i.getAttribute("data-remove-item")==1;if(h){c.remove(j);}var f=i.getAttribute("data-tip-id");if(f){d(f);}}};});define("OK/messages/LastMsgUpdater",["OK/messages/ConversationsList"],function(b){function a(d){var c=document.createElement("div");c.innerHTML=d;return c.children.length?c.children[0]:null;}return{setNewContent:function(g){var e=a(g),i,d,f,h,c;if(e){i=e.getAttribute("data-convId");d=parseInt(e.getAttribute("data-updated"),10)||0;f=e.getAttribute("data-my")==="true";h=e.getAttribute("data-edited")==="true",c=e.getAttribute("data-disableMyUnread")==="true";if(i){b.updateLastMessage(i,e.innerHTML,d,f,h,c);}}}};});define("OK/messages/MenuConfirm",["require","OK/utils/dom","OK/messages/ConversationsList","OK/messages/ConversationsManager"],function(a){var e=a("OK/utils/dom");var d=a("OK/messages/ConversationsList");var b=a("OK/messages/ConversationsManager");function c(g){var h=g.target.getAttribute("data-convId");var f=g.target.getAttribute("data-remove-item")==1;if(f){d.remove(h);}}return{activate:function(f){f.nextElementSibling.addEventListener("click",c);},deactivate:function(f){f.nextElementSibling.removeEventListener("click",c);}};});define("OK/messages/ChatPresets",["OK/utils/dom","OK/utils/utils","OK/logger"],function(c,g,j){var d,i,b="__loading",f="invisible",e="click";function a(l){var k=g.parseJson(l);if(k){i(k);}}function h(m){var n=function(o){return o.getAttribute("data-relation-type");},l=c.traverseParents(m.target,n,d,true);if(l){d.classList.add(b);var k=n(l);g.ajax({url:"/dk",data:{cmd:"ChatPresets","st.crtrt":k}}).done(function(p,o,q){a(p);}).fail(function(){j.error("messagesLayer.error","chatPresetsLoad");}).always(function(){d.classList.remove(b);});}}return{activate:function(m,l){d=c.firstByClass(m,"js-chat-preset_c");if(d){i=l;d.addEventListener(e,h);}var k=c.firstByClass(m,"js-serialised-tags");if(k){a(k.innerHTML);}},deactivate:function(){if(d){d.removeEventListener(e,h);d=null;}},toggle:function(k){if(d){d.classList.toggle(f,!k);}}};});define("OK/messages/ParticipantsAddMenu",["OK/messages/ConversationsManager","OK/messages/CreateConversationButton","OK/messages/MessagesPushController","OK/messages/ChatPresets","OK/utils/dom","OK/utils/utils","OK/utils/vanilla","OK/logger","OK/uuid"],function(ad,z,R,e,b,ae,J,G,l){var U="invisible",t="__no-friends",F="js-chat_participants_list",m="js-chat_participants_item",L="tag__show",A,P,S,u,Z,r,ag,q,ac,h,i,y,d,Y,o,v,E,V,af;function K(){return d.length+S>=u;}function k(ah){if(ah){var ai=y&&y.value.trim();Y.classList.toggle(t,!ai);}Y.classList.toggle(U,!ah);}function W(){var ak,aj=false,ah=b.byClass(r,m),ai=ah.length;if(ai>0){for(ak=0;ak<ai;ak++){if(!ah[ak].classList.contains(U)){aj=true;break;}}}k(!aj);}function X(ah){return"participant_"+ah+"_tag";}function M(am,aj,ai){var ak=document.getElementById("chat_participants_tag_template").cloneNode(true),al=document.createTextNode(aj),ah=b.firstByClass(ak,"js-tag_avatar");if(ah){ah.innerHTML=ai;ak.insertBefore(al,ah.nextSibling);}else{ak.insertBefore(al,ak.firstChild);}ak.setAttribute("id",X(am));ak.setAttribute("data-uid",am);ak.classList.remove(U);return ak;}function T(){var ah=d.length===0;o.disabled=ah;e.toggle(ah);}function g(ah){Z=K();A.classList.toggle("__full",Z);A.classList.toggle("__locked",Z);if(ah){I();}else{W();}T();y.focus();J.trigger(ag,"scroll");x();ab(h);}function O(ak){var aj,al,ah,ai;if(ak===null){return;}if(ak.getAttribute("data-disabled")==="1"){return;}aj=ak.getAttribute("data-uid");al=ak.getAttribute("data-name");ai=b.firstByClass(ak,"photo_img").firstChild;ah=M(aj,al,ai.outerHTML);h.insertBefore(ah,i);ah.classList.add(L);d.push(aj);ak.classList.add(U);g(false);}function D(ah){ah.forEach(function(aj){var ak=aj.id,ai=M(ak,aj.name,aj.avatar);h.insertBefore(ai,i);ai.classList.add(L);d.push(ak);});g(true);}function a(ah){O(b.parent(ah.target,m,A,true));}function H(ak,ai){var aj,ah=ai||document.getElementById(X(ak)),al=b.firstByClass(A,"js-chat_participants_item_"+ak);if(al){al.classList.remove(U);k(false);}aj=d.indexOf(ak);if(aj!==-1){d.splice(aj,1);}ah.parentNode.removeChild(ah);T();y.focus();Z=K();A.classList.toggle("__full",Z);A.classList.toggle("__locked",Z);}function n(){d.forEach(function(ai){var ah=document.getElementById(X(ai));if(ah){H(ai,ah);}});d=[];}function c(aj){var ai=b.parent(aj.target,"js-remove-tag"),ah;if(ai!==null){ai=ai.parentNode;ah=ai.getAttribute("data-uid");H(ah,ai);}}function Q(ai){var ah=ai.detail.elements;if(!ah||ah.length===0){return;}ah.forEach(function(aj){q.push(aj);});}function I(){q=b.byClass(r,m);ac=-1;var ah=q.length,ai=0;if(ah===0){k(true);}else{d.forEach(function(aj){var ak=b.firstByClass(A,"js-chat_participants_item_"+aj);if(ak){ak.classList.add(U);ai++;}});k(ah<=ai);}ag.scrollTop=0;}function x(ai){if(y.value){var ah=b.firstByClass(y.parentNode,"ic_close-g");if(ah!==null){ah.click(ai);}}}function ab(ah){ah.scrollTop=ah.scrollHeight;}function s(ai){var aj=r.getBoundingClientRect(),ah=ai.getBoundingClientRect(),ak=ah.top>=aj.top&&ah.bottom<=aj.bottom;if(!ak){if(ah.bottom>aj.bottom){ag.scrollTop+=ah.bottom-aj.bottom;}else{ag.scrollTop+=ah.top-aj.top;}}}function p(ah,aj){if(Z){return;}if(aj){ah++;}else{ah--;}if(ah<0||ah>q.length){return;}var ak=q[ah],ai;if(!ak||ak.getAttribute("data-disabled")==="1"||ak.classList.contains("invisible")){p(ah,aj);return;}if(ac>-1){ai=q[ac];if(ai){ai.classList.remove("__selected");}}ak.classList.add("__selected");ac=ah;s(ak);}function w(aj){var ai=b.parent(aj.target,m,this,true),ah;if(!ai){return;}ah=q.indexOf(ai);if(ah>-1){if(ac>-1){q[ac].classList.remove("__selected");}q[ah].classList.add("__selected");ac=ah;}}function N(ai){var ah=ai.which||ai.keycode;if(ah===13){if(!Z&&ac!==-1){ai.preventDefault();O(q[ac]);}}else{if(ah===40||ah===38){ai.preventDefault();p(ac,ah===40);}}}function j(){ae.ajax({url:"/dk",data:{cmd:"ConversationParticipants","st.convId":P}}).done(function(ai,ah,aj){ae.updateBlockModelCallback(ai,ah,aj);}).fail(function(){G.error("messagesLayer.error","participantsAddMenuLoad");});}function C(){return OK.Layers.stack.some(function(ah){return ah.id.indexOf("dd-menu")===0;});}function B(){if(d.length){var ah=b.firstByClass(A,"js-history-flag");ae.ajax({url:"/web-api/messages/participants/add",data:{cid:P,uids:d,hist:ah!==null&&ah.checked}}).done(function(ai){if(ai.news){R.applyNews(ai.news);}n();if(C()){OK.Layers.unregisterLast();}if(P!==ai.id){ad.open(ai.id);}else{if(ai.countLabel){OK.hookModel.setHookContent("ConversationParticipantsText",ai.countLabel);}j();}}).fail(function(){G.error("messagesLayer.error","participantsAddMenuSubmit");});}}function f(ah){var ai=[],aj=";";ah.forEach(function(){ai.push(l.generate());});o.disabled=true;ae.ajax({url:"/dk?cmd=MessagesForward",data:{"st.uuids":ai.join(aj),"st.convIds":ah.join(aj),"st.frwMsgs":E}}).done(function(al,ak,am){if(al){ae.updateBlockModelCallback(al,ak,am);}if(C()){OK.Layers.unregisterLast();}if(af&&ah.length===1){ad.open(ah[0]);}}).fail(function(){G.error("messagesLayer.error","forwardMsgSubmit");});}function aa(){if(d.length){f(d);}}return{activate:function(ah){A=ah;ac=-1;P=ah.getAttribute("data-convId");S=parseInt(ah.getAttribute("data-count"),10)||0;u=parseInt(ah.getAttribute("data-max-count"),10)||20;E=ah.getAttribute("data-forwarded-msgids");V=E&&E.length;af=ah.getAttribute("data-forwarded-open")==="true";ag=document.getElementById("chat_participants_list_id");r=b.firstByClass(ah,F);r.addEventListener("click",a);r.addEventListener("mouseover",w);r.addEventListener("dataload",Q);q=b.byClass(r,m);h=b.firstByClass(ah,"js-tags-holder");h.addEventListener("click",c);d=[];Array.prototype.slice.call(h.children).forEach(function(ak){var aj=ak.getAttribute("data-uid");if(aj){d.push(aj);}});Y=document.getElementById("chat_participants_empty_result");Y.addEventListener("click",x);i=b.firstByClass(A,"search-wrapper");y=document.getElementById("ParticipantsAddMenuSearch_field_query");y.addEventListener("searchEnd",I);y.addEventListener("keydown",N);setTimeout(function(){y.focus();},10);o=b.firstByClass(ah,"js-submit");var ai=V?aa:B;o.addEventListener("click",ai);v=b.byClass(document,"js-close-create-conv");if(v.length){v.forEach(function(aj){aj.addEventListener("click",z.closeCreateConversation);});z.toggle(true);}e.activate(ah,D);},deactivate:function(){d=null;A=null;ac=-1;r.removeEventListener("click",a);r.removeEventListener("mouseover",w);r.removeEventListener("dataload",Q);r=null;ag=null;q=null;h.removeEventListener("click",c);h=null;Y.removeEventListener("click",x);Y=null;y.removeEventListener("searchEnd",I);y=null;var ah=V?aa:B;o.removeEventListener("click",ah);o=null;if(v.length){v.forEach(function(ai){ai.removeEventListener("click",z.closeCreateConversation);});v=null;z.toggle(false);}e.deactivate();}};});define("OK/messages/ParticipantsListMenu",["OK/messages/MessagesPushController","OK/utils/utils","OK/utils/dom","OK/logger"],function(d,o,n,r){var i="invisible",e="js-chat_participants_item",q,b,f,a,m,g,l;function h(t,s){b=t;f=s;q.setAttribute("data-count",t);q.setAttribute("data-max-count",s);q.classList.toggle("__full",b>=f);}function c(){var v,u=false,s=n.byClass(m,"ugrid_i"),t=s.length;if(t>0){for(v=0;v<t;v++){if(!s[v].classList.contains(i)){u=true;break;}}}g.classList.toggle(i,u);}function k(t){var u=t.target,s;if(!u.classList.contains("js-remove")){return;}s=n.parent(u,"ugrid_i",this);s.classList.add(i);o.ajax({url:"/web-api/messages/participants/remove",data:{cid:a,uid:s.getAttribute("data-uid")}}).fail(function(){s.classList.remove(i);r.error("messagesLayer.error","participantsListMenuRemove");}).done(function(v){s.parentNode.removeChild(s);h(v.count,v.maxCount);if(v.countLabel){OK.hookModel.setHookContent("ConversationParticipantsText",v.countLabel);}if(v.news){d.applyNews(v.news);}c();});}function p(t){if(l&&l.value){var s=n.firstByClass(l.parentNode,"ic_close-g");if(s!==null){s.click(t);}}}function j(){var s=n.byClass(m,e).length;g.classList.toggle(i,s>0);}return{activate:function(s){q=s;b=parseInt(s.getAttribute("data-count"),10)||0;f=parseInt(s.getAttribute("data-max-count"),10)||20;a=s.getAttribute("data-convId");m=n.firstByClass(s,"chat_participants_list");m.addEventListener("click",k);l=document.getElementById("ParticipantsListMenuSearch_field_query");if(l){l.addEventListener("searchEnd",j);}g=document.getElementById("chat_participants_empty_result");g.addEventListener("click",p);},deactivate:function(){q=null;m.removeEventListener("click",k);m=null;if(l){l.removeEventListener("searchEnd",j);l=null;}g.removeEventListener("click",p);g=null;}};});define("OK/messages/promobubble",["OK/utils/utils"],function(b){var a=[];function d(e){this.element=e;this.listeners=[];this.closed=false;e.addEventListener("click",this);}d.prototype={deactivate:function(){this.element.removeEventListener("click",this);},handleEvent:function(){if(this.closed){return;}this.closed=true;this.listeners.forEach(function(e){e.call();});b.ajax({url:"/web-api/messages/bubble/close",data:{id:this.element.getAttribute("data-promoId")}});}};function c(f){var e;for(e=0;e<a.length;++e){if(a[e].element===f){return e;}}return -1;}return{register:function(f){var e=c(f);if(e<0){a.push(new d(f));}},unregister:function(f){var e=c(f);if(e>=0){a[e].deactivate();a.splice(e,1);}},close:function(f){var e=c(f);if(e>=0){a[e].close();}},addListener:function(f,g){var e=c(f);if(e>=0){a[e].listeners.push(g);}}};});define("OK/messages/RedLink",["OK/messages/ConversationsManager","OK/logger","OK/utils/dom"],function(d,l,e){var n,k,i,j,m,a=[],b,g;function f(o){if(g){b.classList.toggle("invisible",!o);}else{n.classList.toggle("__red-link",o);}}function c(){l.success("messagesLayer","red-link.close");f(false);if(m){a.push(m);}}function h(){var o=i.getAttribute("data-set-id"),p=o==null&&i.getAttribute("data-open-postcards")==="true",r,q;if(p){l.success("messagesLayer","red-link.postcard");q=i.getAttribute("data-postcards-search-query");if(q){r=function(){j.menu.changePostcardsQuery(q);j.menu.removeTabOpenListener(r);};j.menu.addTabOpenListener(r);}j.menu.openTab(j,".js-tab-postcards");}else{l.success("messagesLayer","red-link.sticker-set",o);r=function(){j.menu.emojiScroll.jumpToSet(o);j.menu.removeTabOpenListener(r);};j.menu.addTabOpenListener(r);j.menu.openTab(j,".__stickers");}}return{activate:function(p){var q=p.getAttribute("data-convId"),o=d.getById(q);if(!o){p.classList.add("invisible");return;}b=p;g=!!e.parent(p,"chat_boost",o.element);j=o.form.textarea.data("emojiarea");n=o.list.el.firstChild;k=document.getElementById("msg-red-link-close");if(k){k.addEventListener("click",c);}else{f(true);return;}m=p.getAttribute("data-banner-id");if(m){if(a.indexOf(m)>-1){f(false);}else{f(true);i=e.firstByClass(p,"js-messages-red-link");if(i){i.addEventListener("click",h);}}}o.scrollToBottom();},deactivate:function(){if(k){k.removeEventListener("click",c);}if(i){i.removeEventListener("click",h);}n=null;k=null;}};});define("OK/messages/StickerSetPro",["OK/utils/dom",],function(b){var g="__hidden",c="localStorage" in window&&window.localStorage!==null,f,l,a,i,h;function k(){return c&&localStorage.getItem(f)!=l;}function d(){a.classList.remove(g);}function m(){a.classList.add(g);}function j(){if(h){clearTimeout(h);h=null;}}function e(){localStorage.setItem(f,l);m();}return{activate:function(n){a=n;f=n.getAttribute("data-key");l=n.getAttribute("data-compId");if(!k()){m();}i=b.firstByClass(n,"js-sticker-set-pro_close");i.addEventListener("click",e);h=setTimeout(function(){n.classList.remove(g);},1000);},deactivate:function(n){if(i){i.removeEventListener("click",e);i=null;}j();},toggleStickersPro:function(n){if(a&&f){if(n){l=n;}if(n&&k()){d();}else{m();j();}}}};});define("OK/messages/MessagesSettingsButton",["require","OK/messages/ConversationsList","OK/utils/utils","OK/logger"],function(e){var h=e("OK/messages/ConversationsList"),i=e("OK/utils/utils"),j=e("OK/logger"),a="__active",d,b;function f(l){e(["OK/messages/ConversationsManager"],function(m){m.open(l);});}function c(){h.deselect();f();}function g(){if(d){c();}else{f(h.getLastSelectedId());}}function k(l){if(d){c();return;}if(b.classList.contains(a)){g();}else{i.ajax({url:"/dk",data:{cmd:"ConversationWrapper","st.settings":true}}).done(function(n,m,o){i.updateBlockModelCallback(n,m,o);}).fail(function(){j.error("messagesLayer.error","settings");});}}return{activate:function(l){b=l;d=b.classList.contains("js-home");l.addEventListener("click",k);},deactivate:function(l){l.removeEventListener("click",k);},toggle:function(l){if(b){b.classList.toggle(a,l);}},closeSettings:g};});define("OK/messages/MessagesSettings",["require","OK/messages/MessagesSettingsButton","OK/utils/dom"],function(b){var c=b("OK/messages/MessagesSettingsButton"),d=b("OK/utils/dom"),a;return{activate:function(e){c.toggle(true);a=d.byClass(e,"js-close-settings");a.forEach(function(f){f.addEventListener("click",c.closeSettings);});},deactivate:function(e){c.toggle(false);a.forEach(function(f){f.removeEventListener("click",c.closeSettings);});a=null;}};});define("OK/messages/AvatarCropForm",["OK/utils/utils","OK/utils/dom","OK/messages/MessagesPushController"],function(a,e,b){function c(f){return f.tagName.toLowerCase()==="input"&&f.type==="hidden";}function d(h){var g=h.target,f=e.firstByClass(g,"js-submit");h.stopPropagation();h.preventDefault();f.disabled=true;a.ajax({url:g.action,data:a.getFormData(g,c)}).always(function(){f.disabled=false;}).done(function(i){b.applyNews(i.news);OK.Layers.unregisterLast();});}return{activate:function(f){f.addEventListener("submit",d);},deactivate:function(f){f.removeEventListener("submit",d);}};});define("OK/audioPlayer",["jquery"],function($){function repaintAll(){var amsgElements=$(".amsg");if(amsgElements.length>0){amsgElements.each(function(){drawProgress($(this));});}}var b64e={};var i,A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(i=0;i<64;i++){b64e[A.charAt(i)]=i;}function decodeBase64(s){var b=0,c,x,l=0,a,r=[],L=s.length;for(x=0;x<L;x++){c=b64e[s.charAt(x)];b=(b<<6)+c;l+=6;while(l>=8){((a=(b>>>(l-=8))&255)||(x<(L-2)))&&(r.push(a));}}return r;}function drawProgress(qel){var waveData=qel.data("wave"),progress=qel.data("progress"),canvas=qel.find("canvas");if(0==canvas.length){if(!progress){progress=0;}qel.find(".amsg_tl_fg").width((progress*100)+"%");return;}var audioPeaks=qel.data("peaks");if(typeof(audioPeaks)==="undefined"){if(waveData){audioPeaks=decodeBase64(waveData);qel.data("peaks",audioPeaks);}}var fullRedraw=false,canvasDom=canvas[0],pixRatio=1;if(window.devicePixelRatio){pixRatio=window.devicePixelRatio;}var w=canvas.width()*pixRatio,h=canvas.height()*pixRatio;if(canvasDom.width!=w||canvasDom.height!=h){canvasDom.width=w;canvasDom.height=h;fullRedraw=true;}var ctx=canvasDom.getContext("2d");if(fullRedraw){ctx.clearRect(0,0,w,h);}var lineWidth=(pixRatio>1.3)?2:1,gapWidth=(pixRatio>1.3)?2:1,lineSpace=lineWidth+gapWidth,minHeight=1,lineCount=Math.floor(w/lineSpace);ctx.lineWidth=lineWidth;if(!progress){progress=0;}function drawLines(minX,maxX){var minIdx=Math.floor(Math.max((minX-gapWidth)/lineSpace-1,0)),maxIdx=Math.floor(Math.min((maxX-gapWidth)/lineSpace+1,lineCount));for(var i=minIdx;i<maxIdx;++i){var x=gapWidth+i*lineSpace,peak=0;if(audioPeaks){var pointPos=(x/w)*audioPeaks.length;if(pointPos>audioPeaks.length-1.001){pointPos=audioPeaks.length-1.001;}var lowPos=Math.floor(pointPos),offset=pointPos-lowPos;peak=audioPeaks[lowPos]*(1-offset)+audioPeaks[lowPos+1]*offset;if(peak>127){peak=127;}else{if(peak<0){peak=0;}}}var zerosSize=5,windowSize=20;if(x<zerosSize){peak=0;}else{if(x>w-zerosSize){peak=0;}else{if(x-zerosSize<windowSize){peak*=(1+Math.sin(((x-zerosSize)/(windowSize)-1/2)*Math.PI))/2;}}}if(x>w-windowSize-zerosSize){peak*=(1+Math.sin(((w-zerosSize-x)/(windowSize)-1/2)*Math.PI))/2;}var middleY=Math.floor(h/2);peak=Math.floor(minHeight+peak*(middleY-minHeight)/127);var oddWidth=(lineWidth%2);ctx.moveTo(x+oddWidth/2,middleY+peak);ctx.lineTo(x+oddWidth/2,middleY-peak);}}var paintStart=0,paintEnd=w;if(!fullRedraw){lastProgress=qel.data("paintedpos");if(typeof(lastProgress)!=="undefined"){paintStart=Math.floor(Math.min(progress,lastProgress)*w);paintEnd=Math.floor(Math.max(progress,lastProgress)*w);if(paintStart==paintEnd){return;}}}ctx.save();ctx.beginPath();ctx.rect(paintStart,0,Math.floor(w*progress),h);ctx.clip();ctx.beginPath();drawLines(paintStart,w*progress);ctx.strokeStyle="#ED812B";ctx.stroke();ctx.restore();ctx.save();ctx.beginPath();ctx.rect(Math.floor(w*progress),0,paintEnd,h);ctx.clip();ctx.beginPath();drawLines(w*progress,paintEnd);ctx.strokeStyle="#999999";ctx.stroke();ctx.restore();qel.data("paintedpos",progress);}function setProgress(qel,currentTime,duration){function formatNum(num){var result=""+num;if(result.length<2){return"0"+result;}return result;}if(currentTime>duration){currentTime=duration;}var timeLeft=duration-currentTime,min=Math.floor(timeLeft/60),sec=Math.floor(timeLeft-(min*60));qel.find(".amsg_tmr").html(formatNum(min)+":"+formatNum(sec));qel.data("progress",duration==0?0:currentTime/duration);drawProgress(qel);}function setUIState(qel,state){if($.inArray(state,["play","stop","load","error"])>-1){qel.removeClass("st_play st_stop st_load st_error");qel.addClass("st_"+state);}}function uiInState(qel,state){return qel.hasClass("st_"+state);}function validateNumber(num){if(typeof num==="undefined"||isNaN(num)){return 0;}return num;}function resetPlayer(qel){stopTimer();var pl=qel.find("audio");if(pl.length>0){if(uiInState(qel,"error")){return;}var duration=validateNumber(qel.data("dur")/1000);try{pl[0].parentNode.removeChild(pl[0]);}catch(e){}setProgress(qel,0,duration);setUIState(qel,"stop");}}function updateProgress(qel){var pl=qel.find("audio");if(pl.length==0){return;}var a=pl[0],duration=validateNumber(qel.data("dur")/1000);var currentTime=validateNumber(a.currentTime);setProgress(qel,currentTime,duration);}var timerId=null;function startTimer(qel){stopTimer();timerId=window.setInterval(function(){updateProgress(qel);},1000/30);}function stopTimer(){if(timerId!=null){window.clearInterval(timerId);timerId=null;}}function clickAPlayer(el){if(!el){return;}var qel=$(el),pr=qel.data("prov"),urlsstr=qel.data("urls"),mid=qel.data("mid"),pl=qel.find("audio");OK.logging.logger.success("amsg","init");$(".amsg").each(function(){if(this!=qel[0]){resetPlayer($(this));}});if(pl.length==0){var a=document.createElement("audio");if(!a){OK.logging.logger.error("amsg","nohtml5");return true;}var jqa=$(a);jqa.addClass("hdnplayer");var urls=eval(urlsstr);var srcErrors=0;for(var i=0;i<urls.length/2;++i){var url=urls[2*i];var ct=urls[2*i+1];var source=document.createElement("source");source.src=url;source.type=ct;a.appendChild(source);$(source).bind("error",function(e){if(++srcErrors>=urls.length/2){stopTimer();setUIState(qel,"error");var code=a.error?a.error.code:null;OK.logging.logger.error("amsg","error_"+code);$(a).remove();}});}a.autoplay="autoplay";jqa.bind("error",function(e){stopTimer(qel);setUIState(qel,"error");var code=e.target.error?e.target.error.code:null;OK.logging.logger.error("amsg","error_"+code);$(a).remove();});jqa.bind("play",function(e){startTimer(qel);OK.logging.logger.success("amsg","play");});jqa.bind("loadstart",function(e){setUIState(qel,"load");});jqa.bind("playing",function(e){startTimer(qel);setUIState(qel,"play");});jqa.bind("pause",function(e){stopTimer();setUIState(qel,"stop");OK.logging.logger.success("amsg","pause");});jqa.bind("ended",function(e){stopTimer();setUIState(qel,"stop");this.currentTime=0;this.pause();updateProgress(qel);OK.logging.logger.success("amsg","ended");});qel.append(a);a.play();setUIState(qel,"load");drawProgress(qel);}else{var a=pl[0];if(uiInState(qel,"play")||uiInState(qel,"load")){setUIState(qel,"stop");a.pause();}else{if(uiInState(qel,"stop")){setUIState(qel,"load");a.play();startTimer(qel);}else{if(uiInState(qel,"error")){setUIState(qel,"load");a.play();}}}}return false;}return{activate:function(element){var qel=$(element);drawProgress(qel);qel.on("click.audioPlayer",function(){clickAPlayer(element);});},deactivate:function(element){resetPlayer($(element));$(element).off("click.audioPlayer");},clickPlayer:clickAPlayer,repaintAll:repaintAll};});(function(){var doT={version:"1.0.3",templateSettings:{evaluate:/\{\{([\s\S]+?(\}?)+)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,encode:/\{\{!([\s\S]+?)\}\}/g,use:/\{\{#([\s\S]+?)\}\}/g,useParams:/(^|[^\w$])def(?:\.|\[[\'\"])([\w$\.]+)(?:[\'\"]\])?\s*\:\s*([\w$\.]+|\"[^\"]+\"|\'[^\']+\'|\{[^\}]+\})/g,define:/\{\{##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\}\}/g,defineParams:/^\s*([\w$]+):([\s\S]+)/,conditional:/\{\{\?(\?)?\s*([\s\S]*?)\s*\}\}/g,iterate:/\{\{~\s*(?:\}\}|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\}\})/g,varname:"it",strip:true,append:true,selfcontained:false,doNotSkipEncoded:false},template:undefined,compile:undefined},_globals;doT.encodeHTMLSource=function(doNotSkipEncoded){var encodeHTMLRules={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},matchHTML=doNotSkipEncoded?/[&<>"'\/]/g:/&(?!#?\w+;)|<|>|"|'|\//g;return function(code){return code?code.toString().replace(matchHTML,function(m){return encodeHTMLRules[m]||m;}):"";};};_globals=(function(){return this||(0,eval)("this");}());if(typeof module!=="undefined"&&module.exports){module.exports=doT;}else{if(typeof define==="function"&&define.amd){define("doT",[],function(){return doT;});}else{_globals.doT=doT;}}var startend={append:{start:"'+(",end:")+'",startencode:"'+encodeHTML("},split:{start:"';out+=(",end:");out+='",startencode:"';out+=encodeHTML("}},skip=/$^/;function resolveDefs(c,block,def){return((typeof block==="string")?block:block.toString()).replace(c.define||skip,function(m,code,assign,value){if(code.indexOf("def.")===0){code=code.substring(4);}if(!(code in def)){if(assign===":"){if(c.defineParams){value.replace(c.defineParams,function(m,param,v){def[code]={arg:param,text:v};});}if(!(code in def)){def[code]=value;}}else{new Function("def","def['"+code+"']="+value)(def);}}return"";}).replace(c.use||skip,function(m,code){if(c.useParams){code=code.replace(c.useParams,function(m,s,d,param){if(def[d]&&def[d].arg&&param){var rw=(d+":"+param).replace(/'|\\/g,"_");def.__exp=def.__exp||{};def.__exp[rw]=def[d].text.replace(new RegExp("(^|[^\\w$])"+def[d].arg+"([^\\w$])","g"),"$1"+param+"$2");return s+"def.__exp['"+rw+"']";}});}var v=new Function("def","return "+code)(def);return v?resolveDefs(c,v,def):v;});}function unescape(code){return code.replace(/\\('|\\)/g,"$1").replace(/[\r\t\n]/g," ");}doT.template=function(tmpl,c,def){c=c||doT.templateSettings;var cse=c.append?startend.append:startend.split,needhtmlencode,sid=0,indv,str=(c.use||c.define)?resolveDefs(c,tmpl,def||{}):tmpl;str=("var out='"+(c.strip?str.replace(/(^|\r|\n)\t* +| +\t*(\r|\n|$)/g," ").replace(/\r|\n|\t|\/\*[\s\S]*?\*\//g,"").replace(/>\s+/g,">").replace(/\s+</g,"<").replace(/<!--[\s\S]*?-->/g,""):str).replace(/'|\\/g,"\\$&").replace(c.interpolate||skip,function(m,code){return cse.start+unescape(code)+cse.end;}).replace(c.encode||skip,function(m,code){needhtmlencode=true;return cse.startencode+unescape(code)+cse.end;}).replace(c.conditional||skip,function(m,elsecase,code){return elsecase?(code?"';}else if("+unescape(code)+"){out+='":"';}else{out+='"):(code?"';if("+unescape(code)+"){out+='":"';}out+='");}).replace(c.iterate||skip,function(m,iterate,vname,iname){if(!iterate){return"';} } out+='";}sid+=1;indv=iname||"i"+sid;iterate=unescape(iterate);return"';var arr"+sid+"="+iterate+";if(arr"+sid+"){var "+vname+","+indv+"=-1,l"+sid+"=arr"+sid+".length-1;while("+indv+"<l"+sid+"){"+vname+"=arr"+sid+"["+indv+"+=1];out+='";}).replace(c.evaluate||skip,function(m,code){return"';"+unescape(code)+"out+='";})+"';return out;").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/(\s|;|\}|^|\{)out\+='';/g,"$1").replace(/\+''/g,"");if(needhtmlencode){if(!c.selfcontained&&_globals&&!_globals._encodeHTML){_globals._encodeHTML=doT.encodeHTMLSource(c.doNotSkipEncoded);}str="var encodeHTML = typeof _encodeHTML !== 'undefined' ? _encodeHTML : ("+doT.encodeHTMLSource.toString()+"("+(c.doNotSkipEncoded||"")+"));"+str;}try{return new Function(c.varname,str);}catch(e){if(typeof console!=="undefined"){console.log("Could not create a template function: "+str);}throw e;}};doT.compile=function(tmpl,def){return doT.template(tmpl,null,def);};}());define("text",["module"],function(d){var n,i,h,c,o,f=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],m=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,k=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,b=typeof location!=="undefined"&&location.href,e=b&&location.protocol&&location.protocol.replace(/\:/,""),g=b&&location.hostname,a=b&&(location.port||undefined),l={},j=(d.config&&d.config())||{};n={version:"2.0.13+",strip:function(p){if(p){p=p.replace(m,"");var q=p.match(k);if(q){p=q[1];}}else{p="";}return p;},jsEscape:function(p){return p.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029");},createXhr:j.createXhr||function(){var s,p,q;if(typeof XMLHttpRequest!=="undefined"){return new XMLHttpRequest();}else{if(typeof ActiveXObject!=="undefined"){for(p=0;p<3;p+=1){q=f[p];try{s=new ActiveXObject(q);}catch(r){}if(s){f=[q];break;}}}}return s;},parseName:function(r){var v,u,p,t=false,q=r.lastIndexOf("."),s=r.indexOf("./")===0||r.indexOf("../")===0;if(q!==-1&&(!s||q>1)){v=r.substring(0,q);u=r.substring(q+1);}else{v=r;}p=u||v;q=p.indexOf("!");if(q!==-1){t=p.substring(q+1)==="strip";p=p.substring(0,q);if(u){u=p;}else{v=p;}}return{moduleName:v,ext:u,strip:t};},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(s,w,q,p){var u,v,t,r=n.xdRegExp.exec(s);if(!r){return true;}u=r[2];v=r[3];v=v.split(":");t=v[1];v=v[0];return(!u||u===w)&&(!v||v.toLowerCase()===q.toLowerCase())&&((!t&&!v)||t===p);},finishLoad:function(p,r,s,q){s=r?n.strip(s):s;if(j.isBuild){l[p]=s;}q(s);},load:function(t,v,u,s){if(s&&s.isBuild&&!s.inlineText){u();return;}j.isBuild=s&&s.isBuild;var q=n.parseName(t),w=q.moduleName+(q.ext?"."+q.ext:""),r=v.toUrl(w),p=(j.useXhr)||n.useXhr;if(r.indexOf("empty:")===0){u();return;}if(!b||p(r,e,g,a)){n.get(r,function(x){n.finishLoad(t,q.strip,x,u);},function(x){if(u.error){u.error(x);}});}else{v([w],function(x){n.finishLoad(q.moduleName+"."+q.ext,q.strip,x,u);});}},write:function(t,q,r,p){if(l.hasOwnProperty(q)){var s=n.jsEscape(l[q]);r.asModule(t+"!"+q,"define(function () { return '"+s+"';});\n");}},writeFile:function(u,q,w,x,r){var v=n.parseName(q),p=v.ext?"."+v.ext:"",s=v.moduleName+p,t=w.toUrl(v.moduleName+p)+".js";n.load(s,w,function(y){var z=function(A){return x(t,A);};z.asModule=function(A,B){return x.asModule(A,t,B);};n.write(u,s,z,r);},r);}};if(j.env==="node"||(!j.env&&typeof process!=="undefined"&&process.versions&&!!process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"])){i=require.nodeRequire("fs");n.get=function(q,t,p){try{var r=i.readFileSync(q,"utf8");if(r[0]==="\uFEFF"){r=r.substring(1);}t(r);}catch(s){if(p){p(s);}}};}else{if(j.env==="xhr"||(!j.env&&n.createXhr())){n.get=function(q,u,p,s){var r=n.createXhr(),t;r.open("GET",q,true);if(s){for(t in s){if(s.hasOwnProperty(t)){r.setRequestHeader(t.toLowerCase(),s[t]);}}}if(j.onXhr){j.onXhr(r,q);}r.onreadystatechange=function(w){var v,x;if(r.readyState===4){v=r.status||0;if(v>399&&v<600){x=new Error(q+" HTTP status: "+v);x.xhr=r;if(p){p(x);}}else{u(r.responseText);}if(j.onXhrComplete){j.onXhrComplete(r,q);}}};r.send(null);};}else{if(j.env==="rhino"||(!j.env&&typeof Packages!=="undefined"&&typeof java!=="undefined")){n.get=function(p,w){var r,x,q="utf-8",s=new java.io.File(p),t=java.lang.System.getProperty("line.separator"),v=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),q)),u="";try{r=new java.lang.StringBuffer();x=v.readLine();if(x&&x.length()&&x.charAt(0)===65279){x=x.substring(1);}if(x!==null){r.append(x);}while((x=v.readLine())!==null){r.append(t);r.append(x);}u=String(r.toString());}finally{v.close();}w(u);};}else{if(j.env==="xpconnect"||(!j.env&&typeof Components!=="undefined"&&Components.classes&&Components.interfaces)){h=Components.classes;c=Components.interfaces;Components.utils["import"]("resource://gre/modules/FileUtils.jsm");o=("@mozilla.org/windows-registry-key;1" in h);n.get=function(r,v){var q,s,t,p={};if(o){r=r.replace(/\//g,"\\");}t=new FileUtils.File(r);try{q=h["@mozilla.org/network/file-input-stream;1"].createInstance(c.nsIFileInputStream);q.init(t,1,0,false);s=h["@mozilla.org/intl/converter-input-stream;1"].createInstance(c.nsIConverterInputStream);s.init(q,"utf-8",q.available(),c.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);s.readString(q.available(),p);s.close();q.close();v(p.value);}catch(u){throw new Error((t&&t.path||"")+": "+u);}};}}}}return n;});define("text!OK/NonBlockingTip.dot",[],function(){return'<div class="tip\n        {{? it.fixed }}__fixed{{?}}\n        {{? it.anim }}__anim{{?}}\n        {{? it.mid }}__mid{{?}}\n        {{? it.large }}__l{{?}}">\n    <div class="tip_cnt">\n        {{= it.message }}\n    </div>\n</div>';});define("OK/NonBlockingTip",["OK/utils/dom","doT","text!OK/NonBlockingTip.dot"],function(e,a,f){var b;var d={fixed:true,mid:true,large:true,anim:true,message:"",visibleTime:2000};var c=function(){this.container=null;};c.existingTips={};c.prototype={activate:function(g){this.container=g;this.tipUrl=e.firstByClass(g,"js-tip-block-url");var h=this;if(this.tipUrl){this.clickListener=function(){h.container.classList.add("invisible");};this.tipUrl.addEventListener("click",this.clickListener);}if(g.id){c.existingTips[g.id]=this;}if(g.getAttribute("data-show")){this.show();}},show:function(){if(this.container&&this.container.querySelector(".tip_cnt").childNodes.length>0){var g=this.container.getAttribute("data-visible-time");if(g){var h=parseInt(g,10);this.showAndCloseWithTimeout(h);}else{this.container.classList.add("__active");}}},showAndCloseWithTimeout:function(i){var h=this,g=h.container;return new Promise(function(j){g.classList.add("__active");h.timeoutId=setTimeout(function(){g.classList.remove("__active");j();},i);});},deactivate:function(){window.clearTimeout(this.timeoutId);if(this.tipUrl){this.tipUrl.removeEventListener("click",this.clickListener);}if(this.container){if(this.container.id){c.existingTips[this.container.id]=null;}this.container=null;}}};c.create=function(k){if(typeof k==="string"){k={message:k};}var g=Object.assign({},d,k);if(!b){b=a.template(f);}var j=document.createElement("div");j.innerHTML=b(g);var i=e.firstByClass(j,"tip");document.body.appendChild(j);var l=new c();l.activate(i);function h(){l.deactivate();document.body.removeChild(j);}l.showAndCloseWithTimeout(g.visibleTime).then(function(){if(g.anim){setTimeout(h,150);}else{h();}});};return c;});define("OK/PopupTipContainer",["OK/NonBlockingTip"],function(e){var d="data-visible-time",c="1000";function b(g){var h=document.createElement("div");h.id=g||"";h.classList="tip __l __mid __fixed";h.setAttribute(d,c);h.setAttribute("data-show","true");var f=document.createElement("div");f.classList="tip_cnt";h.appendChild(f);return h;}function a(f){this.elementId=f;}a.prototype.activate=function(f){this.parentNode=f?f:document.body;this.tipHtmlEl=null;this.nonBlockingTip=new e();};a.prototype.deactivate=function(){this.nonBlockingTip.deactivate();if(this.tipHtmlEl){this.tipHtmlEl.parentNode.removeChild(this.tipHtmlEl);}this.parentNode=null;this.tipHtmlEl=null;};a.prototype.getTipHtmlElWithMessage=function(g,f){if(!this.tipHtmlEl){this.tipHtmlEl=b(this.elementId);this.parentNode.appendChild(this.tipHtmlEl);}if(!f){f=c;}this.tipHtmlEl.setAttribute(d,f);this.tipHtmlEl.firstElementChild.textContent=g;return this.tipHtmlEl;};a.prototype.showTip=function(h,f){if(this.tipHtmlEl){this.nonBlockingTip.deactivate();}var g=this.getTipHtmlElWithMessage(h,f);this.nonBlockingTip.activate(g);};return a;});
/*!
 * clipboard.js v1.6.0
 * https://zenorocha.github.io/clipboard.js
 *
 * Licensed MIT © Zeno Rocha
 */
(function(b){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=b();}else{if(typeof define==="function"&&define.amd){define("Clipboard",[],b);}else{var a;if(typeof window!=="undefined"){a=window;}else{if(typeof global!=="undefined"){a=global;}else{if(typeof self!=="undefined"){a=self;}else{a=this;}}}a.Clipboard=b();}}})(function(){var d,b,a;return(function c(f,k,h){function g(q,n){if(!k[q]){if(!f[q]){var m=typeof require=="function"&&require;if(!n&&m){return m(q,!0);}if(e){return e(q,!0);}var p=new Error("Cannot find module '"+q+"'");throw p.code="MODULE_NOT_FOUND",p;}var i=k[q]={exports:{}};f[q][0].call(i.exports,function(l){var o=f[q][1][l];return g(o?o:l);},i,i.exports,c,f,k,h);}return k[q].exports;}var e=typeof require=="function"&&require;for(var j=0;j<h.length;j++){g(h[j]);}return g;})({1:[function(f,h,e){var g=9;if(Element&&!Element.prototype.matches){var j=Element.prototype;j.matches=j.matchesSelector||j.mozMatchesSelector||j.msMatchesSelector||j.oMatchesSelector||j.webkitMatchesSelector;}function i(l,k){while(l&&l.nodeType!==g){if(l.matches(k)){return l;}l=l.parentNode;}}h.exports=i;},{}],2:[function(f,g,e){var i=f("./closest");function h(n,m,o,p,l){var k=j.apply(this,arguments);n.addEventListener(o,k,l);return{destroy:function(){n.removeEventListener(o,k,l);}};}function j(l,k,m,n){return function(o){o.delegateTarget=i(o.target,k);if(o.delegateTarget){n.call(l,o);}};}g.exports=h;},{"./closest":1}],3:[function(f,g,e){e.node=function(h){return h!==undefined&&h instanceof HTMLElement&&h.nodeType===1;};e.nodeList=function(i){var h=Object.prototype.toString.call(i);return i!==undefined&&(h==="[object NodeList]"||h==="[object HTMLCollection]")&&("length" in i)&&(i.length===0||e.node(i[0]));};e.string=function(h){return typeof h==="string"||h instanceof String;};e.fn=function(i){var h=Object.prototype.toString.call(i);return h==="[object Function]";};},{}],4:[function(g,f,i){var j=g("./is");var k=g("delegate");function h(o,n,p){if(!o&&!n&&!p){throw new Error("Missing required arguments");}if(!j.string(n)){throw new TypeError("Second argument must be a String");}if(!j.fn(p)){throw new TypeError("Third argument must be a Function");}if(j.node(o)){return e(o,n,p);}else{if(j.nodeList(o)){return m(o,n,p);}else{if(j.string(o)){return l(o,n,p);}else{throw new TypeError("First argument must be a String, HTMLElement, HTMLCollection, or NodeList");}}}}function e(o,n,p){o.addEventListener(n,p);return{destroy:function(){o.removeEventListener(n,p);}};}function m(n,o,p){Array.prototype.forEach.call(n,function(q){q.addEventListener(o,p);});return{destroy:function(){Array.prototype.forEach.call(n,function(q){q.removeEventListener(o,p);});}};}function l(n,o,p){return k(document.body,n,o,p);}f.exports=h;},{"./is":3,delegate:2}],5:[function(g,h,f){function e(j){var m;if(j.nodeName==="SELECT"){j.focus();m=j.value;}else{if(j.nodeName==="INPUT"||j.nodeName==="TEXTAREA"){var l=j.hasAttribute("readonly");if(!l){j.setAttribute("readonly","");}j.select();j.setSelectionRange(0,j.value.length);if(!l){j.removeAttribute("readonly");}m=j.value;}else{if(j.hasAttribute("contenteditable")){j.focus();}var k=window.getSelection();var i=document.createRange();i.selectNodeContents(j);k.removeAllRanges();k.addRange(i);m=k.toString();}}return m;}h.exports=e;},{}],6:[function(f,g,e){function h(){}h.prototype={on:function(j,l,i){var k=this.e||(this.e={});(k[j]||(k[j]=[])).push({fn:l,ctx:i});return this;},once:function(k,m,i){var j=this;function l(){j.off(k,l);m.apply(i,arguments);}l._=m;return this.on(k,l,i);},emit:function(k){var n=[].slice.call(arguments,1);var m=((this.e||(this.e={}))[k]||[]).slice();var l=0;var j=m.length;for(l;l<j;l++){m[l].fn.apply(m[l].ctx,n);}return this;},off:function(l,p){var o=this.e||(this.e={});var k=o[l];var n=[];if(k&&p){for(var m=0,j=k.length;m<j;m++){if(k[m].fn!==p&&k[m].fn._!==p){n.push(k[m]);}}}(n.length)?o[l]=n:delete o[l];return this;}};g.exports=h;},{}],7:[function(f,g,e){(function(j,h){if(typeof d==="function"&&d.amd){d(["module","select"],h);}else{if(typeof e!=="undefined"){h(g,f("select"));}else{var i={exports:{}};h(i,j.select);j.clipboardAction=i.exports;}}})(this,function(k,j){var h=m(j);function m(p){return p&&p.__esModule?p:{"default":p};}var l=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(p){return typeof p;}:function(p){return p&&typeof Symbol==="function"&&p.constructor===Symbol&&p!==Symbol.prototype?"symbol":typeof p;};function o(p,q){if(!(p instanceof q)){throw new TypeError("Cannot call a class as a function");}}var i=function(){function p(t,r){for(var q=0;q<r.length;q++){var s=r[q];s.enumerable=s.enumerable||false;s.configurable=true;if("value" in s){s.writable=true;}Object.defineProperty(t,s.key,s);}}return function(s,q,r){if(q){p(s.prototype,q);}if(r){p(s,r);}return s;};}();var n=function(){function r(B){o(this,r);this.resolveOptions(B);this.initSelection();}i(r,[{key:"resolveOptions",value:function t(){var B=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.action=B.action;this.emitter=B.emitter;this.target=B.target;this.text=B.text;this.trigger=B.trigger;this.selectedText="";}},{key:"initSelection",value:function y(){if(this.text){this.selectFake();}else{if(this.target){this.selectTarget();}}}},{key:"selectFake",value:function z(){var D=this;var B=document.documentElement.getAttribute("dir")=="rtl";this.removeFake();this.fakeHandlerCallback=function(){return D.removeFake();};this.fakeHandler=document.body.addEventListener("click",this.fakeHandlerCallback)||true;this.fakeElem=document.createElement("textarea");this.fakeElem.style.fontSize="12pt";this.fakeElem.style.border="0";this.fakeElem.style.padding="0";this.fakeElem.style.margin="0";this.fakeElem.style.position="absolute";this.fakeElem.style[B?"right":"left"]="-9999px";var C=window.pageYOffset||document.documentElement.scrollTop;this.fakeElem.style.top=C+"px";this.fakeElem.setAttribute("readonly","");this.fakeElem.value=this.text;document.body.appendChild(this.fakeElem);this.selectedText=(0,h["default"])(this.fakeElem);this.copyText();}},{key:"removeFake",value:function x(){if(this.fakeHandler){document.body.removeEventListener("click",this.fakeHandlerCallback);this.fakeHandler=null;this.fakeHandlerCallback=null;}if(this.fakeElem){document.body.removeChild(this.fakeElem);this.fakeElem=null;}}},{key:"selectTarget",value:function q(){this.selectedText=(0,h["default"])(this.target);this.copyText();}},{key:"copyText",value:function s(){var C=void 0;try{C=document.execCommand(this.action);}catch(B){C=false;}this.handleResult(C);}},{key:"handleResult",value:function u(B){this.emitter.emit(B?"success":"error",{action:this.action,text:this.selectedText,trigger:this.trigger,clearSelection:this.clearSelection.bind(this)});}},{key:"clearSelection",value:function A(){if(this.target){this.target.blur();}window.getSelection().removeAllRanges();}},{key:"destroy",value:function w(){this.removeFake();}},{key:"action",set:function v(){var B=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"copy";this._action=B;if(this._action!=="copy"&&this._action!=="cut"){throw new Error('Invalid "action" value, use either "copy" or "cut"');}},get:function p(){return this._action;}},{key:"target",set:function v(B){if(B!==undefined){if(B&&(typeof B==="undefined"?"undefined":l(B))==="object"&&B.nodeType===1){if(this.action==="copy"&&B.hasAttribute("disabled")){throw new Error('Invalid "target" attribute. Please use "readonly" instead of "disabled" attribute');}if(this.action==="cut"&&(B.hasAttribute("readonly")||B.hasAttribute("disabled"))){throw new Error('Invalid "target" attribute. You can\'t cut text from elements with "readonly" or "disabled" attributes');}this._target=B;}else{throw new Error('Invalid "target" value, use a valid Element');}}},get:function p(){return this._target;}}]);return r;}();k.exports=n;});},{select:5}],8:[function(f,g,e){(function(j,h){if(typeof d==="function"&&d.amd){d(["module","./clipboard-action","tiny-emitter","good-listener"],h);}else{if(typeof e!=="undefined"){h(g,f("./clipboard-action"),f("tiny-emitter"),f("good-listener"));}else{var i={exports:{}};h(i,j.clipboardAction,j.tinyEmitter,j.goodListener);j.clipboard=i.exports;}}})(this,function(i,m,k,u){var r=t(m);var n=t(k);var h=t(u);function t(v){return v&&v.__esModule?v:{"default":v};}function l(v,w){if(!(v instanceof w)){throw new TypeError("Cannot call a class as a function");}}var j=function(){function v(z,x){for(var w=0;w<x.length;w++){var y=x[w];y.enumerable=y.enumerable||false;y.configurable=true;if("value" in y){y.writable=true;}Object.defineProperty(z,y.key,y);}}return function(y,w,x){if(w){v(y.prototype,w);}if(x){v(y,x);}return y;};}();function p(v,w){if(!v){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return w&&(typeof w==="object"||typeof w==="function")?w:v;}function s(w,v){if(typeof v!=="function"&&v!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof v);}w.prototype=Object.create(v&&v.prototype,{constructor:{value:w,enumerable:false,writable:true,configurable:true}});if(v){Object.setPrototypeOf?Object.setPrototypeOf(w,v):w.__proto__=v;}}var o=function(A){s(z,A);function z(G,F){l(this,z);var H=p(this,(z.__proto__||Object.getPrototypeOf(z)).call(this));H.resolveOptions(F);H.listenClick(G);return H;}j(z,[{key:"resolveOptions",value:function y(){var F=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.action=typeof F.action==="function"?F.action:this.defaultAction;this.target=typeof F.target==="function"?F.target:this.defaultTarget;this.text=typeof F.text==="function"?F.text:this.defaultText;}},{key:"listenClick",value:function v(F){var G=this;this.listener=(0,h["default"])(F,"click",function(H){return G.onClick(H);});}},{key:"onClick",value:function B(G){var F=G.delegateTarget||G.currentTarget;if(this.clipboardAction){this.clipboardAction=null;}this.clipboardAction=new r["default"]({action:this.action(F),target:this.target(F),text:this.text(F),trigger:F,emitter:this});}},{key:"defaultAction",value:function x(F){return q("action",F);}},{key:"defaultTarget",value:function D(G){var F=q("target",G);if(F){return document.querySelector(F);}}},{key:"defaultText",value:function C(F){return q("text",F);}},{key:"destroy",value:function E(){this.listener.destroy();if(this.clipboardAction){this.clipboardAction.destroy();this.clipboardAction=null;}}}],[{key:"isSupported",value:function w(){var G=arguments.length>0&&arguments[0]!==undefined?arguments[0]:["copy","cut"];var H=typeof G==="string"?[G]:G;var F=!!document.queryCommandSupported;H.forEach(function(I){F=F&&!!document.queryCommandSupported(I);});return F;}}]);return z;}(n["default"]);function q(x,v){var w="data-clipboard-"+x;if(!v.hasAttribute(w)){return;}return v.getAttribute(w);}i.exports=o;});},{"./clipboard-action":7,"good-listener":4,"tiny-emitter":6}]},{},[8])(8);});define("OK/messages/PrivateLink",["OK/PopupTipContainer","Clipboard"],function(a,d){var c,b;return{activate:function(f){var e=f.querySelector(".js-copy-private-link"),g=e&&f.getAttribute("data-message");if(!g){return;}b=new a("messagesPrivateLink");b.activate();c=new d(e);c.on("success",function(h){b.showTip(g);h.clearSelection();});},deactivate:function(){if(b){b.deactivate();}if(c){c.destroy();}}};});define("b/messagesLayer",["OK/messages/Chatname","OK/messages/Chatname2","OK/messages/Conversation","OK/messages/Column","OK/messages/ColumnManager","OK/messages/ConversationHook","OK/messages/ConversationsList","OK/messages/ConversationsListItem","OK/messages/ConversationsManager","OK/messages/CreateConversationButton","OK/messages/HistoryHelper","OK/messages/HelloStickers","OK/messages/HelloStickersClose","OK/messages/ThanksPresentsClose","OK/messages/InfoPanel","OK/messages/InfoPanelState","OK/messages/InfoPanelClose","OK/messages/UserActionConfirm","OK/messages/LastMsgUpdater","OK/messages/MenuConfirm","OK/messages/MessageForm","OK/messages/MessagesLayer","OK/messages/MessagesList","OK/messages/ParticipantsAddMenu","OK/messages/ParticipantsListMenu","OK/messages/ChatPresets","OK/messages/promobubble","OK/messages/ReadMarks","OK/messages/RedLink","OK/messages/StickerSetPro","OK/messages/Search","OK/messages/SearchPanel","OK/messages/MessagesSettings","OK/messages/MessagesSettingsButton","OK/messages/TypingStatus","OK/messages/TypingUtil","OK/messages/StickerOverlays","OK/messages/AvatarCropForm","OK/audioPlayer","OK/messages/ScrollArrow","OK/messages/DateBar","OK/messages/MsgReplies","OK/messages/MessageAjaxController","OK/messages/CopyMsgText","OK/messages/ConvOnlineStatusTextUpdater","OK/messages/PrivateLink"],{});