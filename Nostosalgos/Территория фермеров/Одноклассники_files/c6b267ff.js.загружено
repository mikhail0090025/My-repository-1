define(["OK/cookie","OK/utils/throttle","OK/LogClicks","OK/utils/dom","OK/banners/moneySave","mrg-smokescreen/Welter"],function(v,z,q,b,C,a){var h=v.readCookie("dme")==="true"||OK.fn.isDebug();var D=window;var r=null;var Q=null;var s=null;var x=null;var J=[];var i=1000;var K=0.5;var w={kineticScroll:false,recalculate:true};var y=[],H={};var p=null;function F(){var T=D.document,S=T.documentElement,R=T.body;return D.pageYOffset||S.scrollTop||R&&R.scrollTop||0;}function g(S){var R=document.createElement("span");R.innerHTML=S;R.classList.add("feed_label_char");return R;}function l(U){var W=U.textContent,V=document.createDocumentFragment(),T;for(T=0;T<W.length;T++){var S=g(W[T]);V.appendChild(S);var R=g(String.fromCharCode(97+Math.round(Math.random()*30)));R.classList.add("__fake");V.appendChild(R);}U.innerHTML="";U.appendChild(V);}var u={NotInView:0,Checking:1,InView:2};function e(T){if(!T){return false;}var S=Object.getOwnPropertyNames(T);for(var R=0;R<S.length;R++){if(T[S[R]].length){return true;}}return false;}function A(R,T){var V=T.feedId?document.querySelector('.feed[data-feed-id="'+T.feedId+'"]'):R,U=this;U.elem=V;U.metaElem=R;U.metaData=T;U.state=u.NotInView;U.timer=null;U.started=0;U.collectPixels();U.recalcPos();U.onClick=U.onClick.bind(this);U.elem.addEventListener("click",this.onClick);U.elem.okAdv=this;U.metaElem.okAdv=this;U.elLabel=b.firstByClass(V,"feed_label");U.elNote=b.firstByClass(V,"banner_note");U.elNoteMore=b.firstByClass(V,"banner_note_more");if(U.elNote&&U.elNote.classList.contains("__collapsed")){var S=U.elNote.offsetHeight;U.elNote.classList.remove("__collapsed");if(U.elNote.offsetHeight>S){U.elNote.classList.add("__collapsed");U.noteCollapsed=true;}}if(T.id){H[T.id]=this;}C.detectAdBlock().then(function(W){if(W){U.onAdBlockDetected();}});}A.prototype={hide:function(){if(this.elLabel){this.elLabel.classList.add("invisible");}},onAdBlockDetected:function(){this.adBlockDetected=true;if(!this.elem){return;}if(this.metaData.hideLinks){this.hideLinks();}if(this.metaData.obfuscate){this.obfuscate();}},obfuscate:function(){b.byClass(this.elem,"banner_note").forEach(function(T){C.obfuscate(T);});var R=b.firstByClass(this.elem,"feed_top_cnt");if(R){var S=this.elLabel;if(S){l(S);}a.wrap(R,".feed_h");C.obfuscate(R,[".feed_h",".feed_date",".feed_count",".shortcut-wrap",".button-pro",".portlet_h",".lstp",".o"]).then(function(){if(S&&S.classList.contains("feed_label")){C.obfuscate(S);}});}},hideLinks:function(){var S=this.elem.getElementsByTagName("a"),R=Array.prototype.slice.call(S);var T=this;R.forEach(function(U){if(U.getAttribute("target")==="_blank"){U.okOriginalHref=U.href;U.removeAttribute("target");U.removeAttribute("href");}});},getLinks:function(){var R=this.elem.getElementsByTagName("a");return Array.prototype.slice.call(R);},collectPixels:function(){if(!this.metaData.pixels){this.metaData.pixels={};}var R=this.metaData.pixels;b.byClass(this.elem,"adv-px").forEach(function(S){var T=S.getAttribute("data-type");if(!R.hasOwnProperty(T)){R[T]=[];}R[T].push(S.getAttribute("data-src"));S.parentNode.removeChild(S);});},inView:function(){if(this.state===u.NotInView){this.state=u.Checking;this.started=Date.now();this.timer=window.setTimeout(this.check.bind(this),i);}else{if(this.state===u.Checking){this.check();}}},lostView:function(){if(this.state===u.Checking){this.state=u.NotInView;window.clearTimeout(this.timer);}},finalize:function(){if(this.state===u.Checking){window.clearInterval(this.timer);this.timer=null;}this.elem.removeEventListener("click",this.onClick);this.elem.okAdv=null;this.metaElem.okAdv=null;this.elem=null;this.metaElem=null;this.elLabel=null;if(this.metaData.id){H[this.metaData.id]=null;}},check:function(){var R=Date.now()-this.started;if(R>=i&&this.state===u.Checking){this.state=u.InView;window.clearTimeout(this.timer);this.onImpression();}},recalcPos:function(){var R=window.pageYOffset,S=this.elem.getBoundingClientRect();this.top=Math.round(S.top)+R;this.bottom=Math.round(S.bottom)+R;},onImpression:function(){var S=this.metaData,V=this.elem;if(!S){return;}var W=S.pixels;this.visible=true;if(e(W)){var R=S.type;if(R){OK.logging.logger.success("banner.feed","view",R);OK.logging.logger.success("banner.seen","PIXEL",JSON.stringify({bannerType:R}));}else{OK.logging.logger.success("banner.feed","view");}var U=b.firstByClass(V,"feedstatspan");if(U){q.copyLogData(U,V);}var T=W.hasOwnProperty("shown_on_scroll")?"shown_on_scroll":null;if(T===null){T=W.hasOwnProperty("shownOnScroll")?"shownOnScroll":null;}this.sendPixel(T);W[T]=null;}},onClick:function(U){var T=U.target;var S=b.traverseParents(T,function(V){return V&&(V.tagName==="A");},this.elem,true);if(S){if(S.okOriginalHref){C.openLink(S.okOriginalHref,"banner.feed");}if(S.okOriginalHref||(S.getAttribute("target")==="_blank"&&S.href)){this.sendPixel("ok_redirect",U.target);}}if(this.noteCollapsed&&T===this.elNoteMore){var R=this.elNote;if(R.classList.contains("banner_note")){R.classList.remove("__collapsed");}else{C.transform("__collapsed").then(function(V){R.classList.remove(V);});}this.noteCollapsed=false;OK.logging.logger.success("banner.feed","click.banner-note-more");}else{this.handleClick(T,false);}},getMainAd:function(){var R=this.elem.getAttribute("data-id"),S;if(R&&H[R]){return H[R];}else{return this;}},getImpressionId:function(){return this.metaData.impressionId;},getVideoPixels:function(){return this.getMainAd().metaData.videoPixels;},handleClick:function(U,T){var S=this.getMainAd(),R=this.getPixelType(U,T);if(R){S.sendPixel(R,U);}S.sendLog();},sendLog:function(){var S=this.elem.getAttribute("data-type");var R=this.visible?"click.visible":"click";if(S){OK.logging.logger.success("banner.feed",R,S);}else{OK.logging.logger.success("banner.feed",R);}},getPixelType:function(X,U){var T=this.elem;var V=I(X,T);var W=this.getLogClickData(V,T);if(!W){return;}var S=I(V.parentElement,T);var R=this.getLogClickData(S,T);return L(W,R,U,X);},sendPixel:function(U,T){var V=this.metaData.pixels;if(!V){return;}var S=V[U];if(!this.metaData.stopClickPixelFallback){if(!S||!S.length){S=V.click;}}if(!S||!S.length){return;}var R=this;S.forEach(function(Y){var W=Y.indexOf("/web-api")===0;if(W){if(r.logClickLocation&&T){Y=Y+"&l="+encodeURIComponent(o(T));}if(R.adBlockDetected){Y=Y+"&bl=1";}}f("call",U,R);var X=new Image();if(r.checkLoadedPixels){X.onerror=function(){f("error",U,R);};}X.src=Y;if(h){console.info("alf-send-pixel: "+U+"; url="+Y);}});},getLogClickData:function(S,R){if(R===S){if(this.metaData.fixClickOnlyForLinks){return{target:"feedElementFix"};}else{return{target:"visible"};}}else{return q.getLogData(S);}}};function f(S,T,R){var U=R.adBlockDetected?"adb":"full";OK.logging.logger.success("banner.pixel",U+"."+S+"."+T);}function o(S){var T=[];var R=0;while((R++<10)&&S&&S.tagName&&S.tagName!=="body"){var U=S.tagName;if(S.className){U+="."+S.className;}T.push(U);if(S===S.parentNode){break;}S=S.parentNode;}return T.join("-");}function O(){var R=y.length;while(R--){y[R].recalcPos();}}function M(){if(!p){p=F();}}function L(W,S,T,V,U){if(!W||!W.target){return;}var R;switch(W.target){case"play":if(S&&S.target==="music"){R="play_music";}break;case"linkExt":R="link_ext";break;case"appLink":R="open_app";break;case"groupLink":case"userLink":case"entity1":case"groupAvatar":R="author_click";break;case"more":case"linkInt":case"collage":if(!T){R="link_int";}break;case"reshare":break;case"now":case"msg":case"feed":case"group":R="reshare";break;case"comment":case"join":case"like":case"vote":R=W.target;break;case"unlike":case"video":case"content":case"arrow":case"remove":break;case"feedElementFix":if(j(V,U)){R="click";}break;default:R="click";break;}return R;}function j(S,R){return !!b.traverseParents(S,function(T){return T.tagName&&T.tagName.toLowerCase()==="a";},R,true);}function B(S,R){return R===S||S.matches(q.LOG_ATTR_SELECTOR);}function I(S,R){if(B(S,R)){return S;}else{return b.traverseParents(S,function(T){return B(T,R);});}}function N(){var R=y.length,S;while(R--){S=y[R];if(k(S)){S.inView();}else{S.lostView();}}p=null;}function k(V){var R=V.bottom-V.top,X=R*K,S=window.pageYOffset,U,W,T;if(window.innerHeight<X){return false;}if(p){U=p;if(S>U){W=U;T=S+window.innerHeight;}else{W=S;T=U+window.innerHeight;}}else{W=S;T=window.innerHeight+S;}return((V.top+X)<T&&V.top>W)||((V.bottom-X)>W&&V.bottom<T)||(V.top<W&&V.bottom>T);}function n(T){var R=T.kineticScroll;var U=T.recalculate;var S=T.inViewInterval;r={};r.kineticScroll=R?R==="true":w.kineticScroll;r.recalculate=U?U==="true":w.recalculate;i=S?parseInt(S,10):i;}function m(R){R.classList.remove("js-alf2-wait");var S=JSON.parse(R.getAttribute("data-meta"));if(!S){S={id:R.getAttribute("id"),pixels:{},videoPixels:{},shownPart:R.getAttribute("data-shown-part")||K,recalculate:R.getAttribute("data-recalculate")||true,kineticScroll:R.getAttribute("data-kinetic-scroll")||false,type:R.getAttribute("data-type"),impressionId:R.getAttribute("data-impression-id"),inViewInterval:R.getAttribute("data-in-view-interval")||i};}if(!r){n(S);Q=z(100,N);window.addEventListener("scroll",Q);if(r.kineticScroll){document.addEventListener("touchstart",M);}s=z(250,O);window.addEventListener("resize",s);if(r.recalculate&&document.readyState!=="complete"){var V=document.getElementsByTagName("IMG");x=z(100,O);var T=V.length;while(T--){if(V[T].offsetHeight){continue;}V[T].addEventListener("load",x);J.push(V[T]);}}}var U=new A(R,S);y.push(U);N();G();}function d(R){var T=R.okAdv;T.finalize();var S=y.indexOf(T);y.splice(S,1);if(y.length===0){if(x){var U;while(U=J.pop()){U.removeEventListener("load",x);}x=null;}if(s){window.removeEventListener("resize",s);s=null;}if(r.kineticScroll){window.removeEventListener("touchstart",M);}if(Q){document.removeEventListener("scroll",Q);Q=null;}r=null;}}var E=document.getElementsByClassName("js-alf2-wait"),c=[];function t(R){return b.traverseParents(R,function(S){return S.okAdv!==undefined;},0,true);}function G(){if(!E.length&&c.length){c.forEach(function(R){R();});c=[];}}function P(S){var R=t(S);if(R){return Promise.resolve(R.okAdv);}if(!E.length){return Promise.reject();}return new Promise(function(U,T){c.push(function(){var V=t(S);if(V){U(V.okAdv);}else{T();}});});}return{activate:m,deactivate:d,findAdvEl:t,findAdv:P};});