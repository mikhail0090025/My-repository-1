define(["OK/logger","OK/utils/dom","OK/utils/vanilla","OK/utils/utils","OK/pts!mediatopic.poll","OK/ViewportTracker"],function(A,s,o,w,z,h){var q="data-query";var y="oi";var i="data-single";var e="data-change";var u="data-index";var c="na";var n="c";var f="y";var j="w";var k="er";var x="uncaught.error";var v="poll";var g={PollVote:"PollVote",PollRevote:"PollRevote",PollCancelVote:"PollCancelVote"};var p={};function b(C){var B=C.refId;if(!p.hasOwnProperty(B)){p[B]=[];}p[B].push(C);}function t(D){var C=D.refId;if(!p.hasOwnProperty(C)){return;}var B=p[C].indexOf(D);if(B!==-1){p[C].splice(B,1);}}function l(C,B){if(!p.hasOwnProperty(C)){return;}p[C].forEach(function(D){D.setData(B);});}function a(){var C=Object.getOwnPropertyNames(p),B=Math.round(Date.now()/1000);C.forEach(function(D){p[D].forEach(function(E){E.updateClosingTime(B);});});setTimeout(a,20000);}a();function m(B){if(B<=0){return"poll-closed";}if(B<60){return"poll-closing_less-than-minute";}if(B<3600){return"poll-closing_minutes";}if(B<86400){return"poll-closing_hours";}if(B<2592000){return"poll-closing_days";}return"poll-closing_days";}function d(B){if(B<=0){return 0;}if(B<60){return B;}if(B<3600){return Math.round(B/60);}if(B<86400){return Math.round(B/3600);}if(B<2592000){return Math.round(B/86400);}return Math.round(B/86400);}function r(){this.initDt=Math.round(Date.now()/1000);}r.prototype={activate:function(F){F.classList.remove("__loading");var G=this,H=G.listEl=s.firstByClass(F,"js-poll-lst");G.el=F;G.elConfirmPlace=null;G.elConfirmButton=null;G.elConfirmNoButton=null;G.query=H.getAttribute(q);G.singleChoice=H.getAttribute(i)==="true";G.changeEnabled=H.getAttribute(e)==="true";G.tillDelta=F.hasAttribute("data-till-delta")?+F.getAttribute("data-till-delta"):0;G.refId=F.getAttribute("data-ref");G.likersUrl=F.getAttribute("data-likers-url");G.closed=F.getAttribute("data-closed")==="1";G.noAnswers=F.getAttribute("data-no-answers")==="1";G.withImg=F.getAttribute("data-with-img")==="1";G.voted={};G.timer=0;G.optionResultsAfterVoting=F.getAttribute("data-option-results-after-voting")==="1";G.optionAnonymousVoting=F.getAttribute("data-option-anonymous-voting")==="1";G.elTotalLink=s.firstByClass(F,"js-poll-total-link");G.onClick=G.onClick.bind(G);G.onClickTotalLink=G.onClickTotalLink.bind(G);H.addEventListener("click",G.onClick);G.elTotalLink.addEventListener("click",G.onClickTotalLink);var C=G.elItems=s.byClass(H,"js-poll-i");var D=G.elInputs=new Array(C.length);if(!C.length){return;}for(var E=0;E<C.length;E++){var B=s.firstByClass(C[E],"js-poll-i-input");if(B===null){return;}D[E]=B;G.voted[E]=B.checked;}G.updateLikersUrlState();if(!G.query){G.disabled=true;return;}if(G.tillDelta>0){G.tillDt=this.initDt+G.tillDelta;G.tillEl=s.firstByClass(F,"js-poll-till");G._lastTillCacheIndex=m(G.tillDelta)+":"+d(G.tillDelta);}G.onConfirmYes=G.onConfirmYes.bind(G);G.onConfirmNo=G.onConfirmNo.bind(G);b(G);},deactivate:function(){var B=this;B.clearConfirmElements();B.listEl.removeEventListener("click",B.onClick);B.elTotalLink.removeEventListener("click",B.onClickTotalLink);if(B.query){t(B);}OK.util.clean(B);},getCssChange:function(){return"__change";},getAnswerByElement:function(B){return s.parent(B,"js-poll-i",false,true);},getCurrentAnswerIndex:function(D){var B=this.getAnswerByElement(D);if(B===null){return -1;}var C=B.getAttribute(u);if(C!==null){return +C;}return -1;},genConfirmationHtml:function(C){var B=this.withImg?"__white":"__sec";return'<div class="poll-v2_ac">'+z.getLMsg("confirm_"+C)+'<span class="poll-v2_ac_btns"><span class="button-pro __small js-poll-ac-yes">'+z.getLMsg("confirm_yes")+'</span><span class="button-pro __small '+B+' ml-2x js-poll-ac-no">'+z.getLMsg("confirm_no")+"</span></span></div>";},clearConfirmElements:function(){var C=this,B=C.elItems;if(C.timer){clearTimeout(C.timer);C.timer=0;}if(C.elConfirmButton){C.elConfirmButton.removeEventListener("click",C.onConfirmYes);C.elConfirmButton=null;}if(C.elConfirmNoButton){C.elConfirmNoButton.removeEventListener("click",C.onConfirmNo);C.elConfirmNoButton=null;}if(C.elConfirmPlace!==null){C.elConfirmPlace.innerHTML="";C.elConfirmPlace=null;}if(B&&B.length){B.forEach(function(D){D.classList.remove(C.getCssChange());});}},confirm:function(C,D){var F=this;if(!F.changeEnabled){return;}F.clearConfirmElements();var B=F.elItems,G=F.elConfirmPlace=s.firstByClass(B[C],"js-poll-ac-hld");if(G!==null){B[C].classList.add(F.getCssChange());var I=D?"cancel":"revote";G.innerHTML=F.genConfirmationHtml(I);A.success(v+"."+I);var E=F.elConfirmButton=s.firstByClass(G,"js-poll-ac-yes");E.setAttribute("data-index",C);E.setAttribute("data-do-сancel",D);E.addEventListener("click",F.onConfirmYes);var H=F.elConfirmNoButton=s.firstByClass(G,"js-poll-ac-no");H.addEventListener("click",F.onConfirmNo);H.setAttribute("data-op",I);F.timer=setTimeout(function(){F.clearConfirmElements();},10000);}},appendParametersToUrl:function(B,D){var C=[this.query+B,"st.v."+y+"="+D];if(B===-1){C.push("st.v.rf=on");}return C.join("&");},setError:function(E,D){var H=this,B=H.elItems,G=H.el,C=s.firstByClass(G,"js-poll-e"),F=!!E;if(C!==null){C.innerHTML=E||"";C.classList.toggle("visible",E);}},sendData:function(B,D){var E=this,F=E.cloneModel(),C=["/?cmd="+B,"st.cmd="+OK.getCurrentDesktopModelId(),E.appendParametersToUrl(D,this.getOneVote())].join("&");o.ajax({url:C}).then(function(I){var G=w.parseJson(I.response),H=G[k]||"";E.setError(H,D);if(!H){l(E.refId,G);}else{E.applyModel(F);}})["catch"](function(){E.setError(z.getLMsg("remote.error_not_decorate"),D);E.applyModel(F);});},applyModel:function(B){for(var C in B){if(B.hasOwnProperty(C)){this.setAnswerChecked(C,B[C]);}}},updateClosingTime:function(C){var F=this;if(!F.tillDt){return;}var G=F.tillDt-C,B=m(G),E=d(G),D=B+":"+E;if(F._lastTillCacheIndex===D){return;}F._lastTillCacheIndex=D;F.tillEl.innerHTML=z.getLMsg(B,{numberPlural:E,number:E});if(G<0){F.disable();F.tillDt=0;F.closed=true;h.add(F.el,function(H){if(H){h.remove(F.el);F.sendData(g.PollVote,-1);}});}},disable:function(){var B=this.elItems;this.el.classList.add("__closed");for(var D=0;D<B.length;D++){var E=B[D];E.classList.add("__disabled");var C=s.firstByClass(E,"js-poll-i-input");if(C){C.disabled=true;}}this.disabled=true;},setData:function(R){var Q=this,J=Q.elItems;try{if(J===null||!J.length){return;}var M=Q.el,B=R[c];Q.noAnswers=B;Q.el.classList.toggle("__no-answers",B);var S=R[n];if(S!==null){var L=s.firstByClass(M,"js-poll-total-label");var K=s.firstByClass(M,"js-poll-total");if(L!==null){L.innerHTML=z.getLMsg(B?"no_poll_votes":"total_not_decorate");}if(K!==null){K.innerHTML=B?"":S;}}var P=+R.maxPercentage,D=B||(S>0&&!P);for(var N=0;N<J.length;N++){var C=J[N];var F=R[n+N];if(F!==null){C.classList.toggle("__no-answers",F==="0");C.classList.toggle("js-poll-i-no-answers",F==="0");var E=s.firstByClass(C,"js-poll-i-count");if(E!==null){if(D){E.innerHTML="";}else{E.innerHTML=F;}}}var G=+R[j+N];if(!isNaN(G)){var I=s.firstByClass(C,"js-poll-i-chart"),H=s.firstByClass(C,"js-poll-i-percentage");if(I!==null){if(P){I.style.width=(G*100/P)+"%";}else{I.style.width=0;}}if(H!==null){if(D){H.innerHTML="";}else{H.innerHTML=G+"%";}}if(D){C.removeAttribute("title");}else{C.setAttribute("title",G+"%");}}Q.setAnswerChecked(N,R[f+N]||false,true);}}catch(O){A.success(x,"PH","parseResponse");}Q.updateLikersUrlState();Q.updateOptionsLabel();Q.updateView();},updateOptionsLabel:function(){var C=!this.haveVote()&&this.optionResultsAfterVoting&&!this.closed,E=null;if(this.optionAnonymousVoting&&C){E="Anonymous_ResultsAfterVoting";}else{if(this.optionAnonymousVoting){E="AnonymousVoting";}else{if(C){E="ResultsAfterVoting";}}}var B=s.firstByClass(this.el,"js-poll-options"),D="";if(E!==null){D=z.getLMsg(E);}B.innerHTML=D;},updateLikersUrlState:function(){var B=true;if(this.noAnswers){B=false;}if(this.optionAnonymousVoting){B=false;}if(this.optionResultsAfterVoting&&!this.haveVote()&&!this.closed){B=false;}this.el.classList.toggle("__with-likers",B);this.allowLikersLayer=B;},updateView:function(){for(var B in this.voted){if(this.voted.hasOwnProperty(B)){this.elItems[B].classList.toggle("__checked",this.voted[B]);}}},setAnswerChecked:function(B,D,C){this.elInputs[B].checked=D;this.voted[B]=D;if(!C){this.updateView();}},haveVote:function(){return this.getOneVote()!==-1;},getOneVote:function(){for(var B in this.voted){if(this.voted.hasOwnProperty(B)&&this.voted[B]){return +B;}}return -1;},cloneModel:function(){var C={};for(var B in this.voted){if(this.voted.hasOwnProperty(B)){C[B]=this.voted[B];}}return C;},onClickTotalLink:function(){if(!this.allowLikersLayer){return;}if(this.likersUrl){this.openLayer(this.likersUrl);}},openLayer:function(B){if(window.navigateOnUrlFromJS){navigateOnUrlFromJS(B);}},onClickItemLikersLink:function(D){if(!this.allowLikersLayer){return;}var B=this.getAnswerByElement(D);if(B.classList.contains("js-poll-i-no-answers")){return;}var C=B.getAttribute("data-likers-url");if(C){this.openLayer(C);}},onClick:function(F){var E=this,G=F.target,B=E.elItems;if(G.classList.contains("js-poll-i-user-link")){return;}if(G.classList.contains("js-poll-i-count")||G.classList.contains("js-poll-i-percentage")){F.preventDefault();E.onClickItemLikersLink(F.target);return;}if(!B.length||this.disabled){return;}var D=E.getCurrentAnswerIndex(G);if(D<0||D>=B.length){return;}var C=B[D];F.preventDefault();E.clearConfirmElements();if(E.voted[D]){E.confirm(D,true);return;}if(E.singleChoice&&E.haveVote()){E.confirm(D,false);return;}E.sendData(g.PollVote,D);E.setAnswerChecked(D,true);},onConfirmYes:function(H){var G=this,B=G.elItems;if(!B.length){return;}H.preventDefault();H.stopPropagation();var F=H.target,D=F.getAttribute("data-index"),E=F.getAttribute("data-do-сancel")==="true",C=B[D];if(E){G.sendData(g.PollCancelVote,D);G.setAnswerChecked(D,false);}else{var I=this.getOneVote();G.sendData(g.PollRevote,D);G.setAnswerChecked(I,false);G.setAnswerChecked(D,true);}G.clearConfirmElements();},onConfirmNo:function(C){C.preventDefault();C.stopPropagation();var B=this,E=C.target,D=E.getAttribute("data-op");B.clearConfirmElements();A.success(v+"."+D+".no");}};return r;});