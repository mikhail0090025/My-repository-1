define("OK/videochat/Tracer",["OK/utils/vanilla","OK/cookie"],function(j,c){var m={ERROR:4,WARN:3,INFO:2,DEBUG:1,TRACE:0};var k=(c.readCookie("dme")==="true"||OK.fn.isDebug())&&console;var l=function(){};function g(n){this._values=new Array(n);this._head=0;this._tail=1;this._capacity=n;}g.prototype.push=function(n){this._head+=1;if(this._head-this._tail>this._capacity){this._tail+=1;}this._values[this._head%this._capacity]=n;};g.prototype.pull=function(){if(this._tail>this._head){return undefined;}var n=this._tail%this._capacity;var o=this._values[n];this._values[n]=undefined;this._tail=this._tail+1;return o;};g.prototype.peek=function(){return this._values[this._tail%this._capacity];};function a(o,p,n){this._module=o;this._prefix=o.replace("OK/videochat/","");this._level=p;this._queue=n;}a.prototype.log=function(u,s,p,q){var r=l;if(k){function t(v){switch(v){case m.ERROR:return console.error;case m.WARN:return console.warn;case m.INFO:return console.info;case m.DEBUG:return console.debug;case m.TRACE:return console.trace;default:return console.debug;}}var o=[console,this._prefix+": "+s];if(p){o.push(p);}if(q){o.push(q);}r=Function.prototype.bind.apply(t(u),o);}if(u<this._level||!this._queue){return r;}function n(v){if(!v){return undefined;}if(v instanceof Error){return{name:v.name,message:v.message,stack:v.stack};}return{name:""+v};}this._queue.push({module:this._module,level:u,timestamp:Date.now(),message:s.toString(),error:n(p),context:q});return r;};a.prototype.debug=function b(o,n){return this.log(m.DEBUG,o,undefined,n);};a.prototype.trace=function(o,n){return this.log(m.TRACE,o,undefined,n);};a.prototype.info=function(o,n){return this.log(m.INFO,o,undefined,n);};a.prototype.warn=function(o,n){return this.log(m.WARN,o,undefined,n);};a.prototype.error=function(p,n,o){return this.log(m.ERROR,p,n,o);};a.prototype.report=function(){var o=[],n;while(this._queue!=null&&!!(n=this._queue.pull())){o.push(n);}if(o.length===0){return Promise.resolve({sent:false});}return j.ajax({url:"/web-api/videochat/report",data:JSON.stringify({records:o}),dataType:"json",headers:{"Content-Type":"application/json"}}).then(function(p){return{sent:true,id:p.response.id};})["catch"](function(){return{sent:false};});};var i=null;var d=m.INFO;function f(n){return new a(n,d,i);}function h(n){i=new g(parseInt(n.getAttribute("data-queue-capacity")));d=parseInt(n.getAttribute("data-log-level"));}function e(){i=null;}return{get:f,activate:h,deactivate:e};});define("OK/videochat/flash/VideoChatIntegration",[],function(){var c;var a=[];function b(){a.forEach(function(d){d();});}return{activate:function(d){c=d.getAttribute("data-id");b();},deactivate:function(d){c=null;b();},getCurrentConversationId:function(){return c;},addListener:function(d){a.push(d);}};});define("OK/videochat/flash/FlashDriver",["OK/logger","OK/videochat/Tracer","OK/videochat/flash/VideoChatIntegration","OK/messages/MessagesLayer","OK/utils/throttle","OK/utils/dom","PTS/data-pane.videoChat"],function(t,k,J,D,z,b,a){var G=k.get("OK/videochat/flash/FlashDriver");var g=["onPhoneIdle","onPhoneCallWindow","onPhoneIncomingWindow","onQuestionnaireWindow","onPhoneUIStateChanged","onPhoneUIResized","onPhoneUIModeChanged","onPhoneInitComplete","onPhonePollResult","onPhoneStateChanged","onStartConversation","onSnapshotReady","onPhoneDrag","onPhoneDragStart","onPhoneDragStop","onFlashAction"],h="topPanelPopup_vp",M="PhoneWidgetId",B="CallApplication",E="PhoneWidgetDragger",L=100,o=100,e=320,j="data-stored-top",s="data-stored-left",n="__active",K,v=z(100,f);function y(){return b.firstByClass(document,"js-vchat_integrated_container");}function c(){return b.firstByClass(document,"js-call-button");}function r(N){N.setAttribute(j,N.style.top);N.setAttribute(s,N.style.left);}function i(){if(K.integrated===true){return;}G.info("Attach ui")();var N=OK.util.getOffset(K.widget),P=y(),O=c();K.flashApp.setUIMode("integrated");K.integrated=true;K.topPanel.classList.add("vchat_integrated");if(K.integrationContainer){K.integrationContainer.classList.remove("vchat_active");}P.classList.add("vchat_active");K.integrationContainer=P;if(O){if(K.callButton){K.callButton.classList.remove("vchat_active");}O.classList.add(n);K.callButton=O;}setTimeout(v,1);}function q(){if(!K||K.integrated===false){return;}G.info("Detach ui")();if(K.flashApp){K.flashApp.setUIMode("detached");}K.integrated=false;var N=K.widget.style;if(K.widget.getAttribute(j)==null){N.top="100px";N.left=((window.innerWidth-e)/2)+"px";N.width=null;N.height=null;}else{N.top=K.widget.getAttribute(j);N.left=K.widget.getAttribute(s);N.width=null;N.height=null;}K.topPanel.classList.remove("vchat_integrated");if(K.integrationContainer){K.integrationContainer.classList.remove("vchat_active");K.integrationContainer=null;}if(K.callButton){K.callButton.classList.remove(n);K.callButton=null;}v();}function d(){if(K){var N;if(J.getCurrentConversationId()===K.appParams.conversationId){N=y();}N&&D.isOpen()?i():q();}}J.addListener(function(){d();});function x(){K&&K.appParams.conversationId&&!K.integrated&&D.open({conversationId:K.appParams.conversationId});}var C={onPhoneInitComplete:function(){G.info("onPhoneInitComplete")();t.success("vchat_app","flash.init.complete",K.type);var U=K.loader,N=K.appParams,O=K.flashApp;K.started=1;if(K.startedCB){K.startedCB();}K.topPanel.classList.remove("vchat_loading");O.setResources(JSON.stringify(a));O.setConfig(N.flashConfig);if(N.signature){O.setSecurityContext2("web",N.signature);}O.setSecurityUserID(N.uid);var T=N.conversationId,P=T.split("_"),Q=P[0],V=P[1],R=false,S;if(K.type==="audiomsg"){S="aattach";R=true;}else{if(K.type==="videomsg"){S="vattach";}}if(S){if(Q==="CHAT"){O.createAttach(N.dispatcher,N.uid,V,14,R,N.remoteUser);}else{if(Q==="PRIVATE"){if(R){O.createAudioAttach(N.dispatcher,N.uid,V,N.remoteUser);}else{O.createVideoAttach(N.dispatcher,N.uid,V,N.remoteUser);}}else{F();return;}}}else{if(K.type==="outcall"){x();O.makeCall(N.dispatcher,N.uid,V,N.remoteUser);}else{if(K.type==="incall"){O.receiveCall(N.dispatcher,JSON.parse(K.incomingParams).called_id,K.incomingParams);}else{G.info("Unknown type",{contextType:K.type})();F();return;}}}K.integrated=null;d();},onPhoneIdle:function(){G.info("onPhoneIdle")();t.success("vchat_app","flash.idle",K.type);F();},onPhoneUIModeChanged:function(N){N==="integrated"&&x();},onPhoneStateChanged:function(N){N==="accepted"&&x();}};function A(O){var P=C[O];function N(){if(!K){G.info("Ignoring flash callback (no context)"+O,{arguments:arguments})();return;}try{P.apply(P,arguments);}catch(R){G.error("Exception in callback "+O,R)();}}function Q(){G.info("Ignoring flash callback "+O,{arguments:arguments})();}window[O]=P?N:Q;}function m(){var N=document.getElementById(h);if(N){b.remove(N);}}function l(Q,P){var O={id:B,"class":"vchat_flash_app"},R={allowScriptAccess:"always",wmode:"opaque",allowFullScreen:true,bgcolor:"#000000"},N={id:B};Q.embedSWF(P,B,"400","400","11.0.0",null,N,R,O);}function f(){if(!K){window.removeEventListener("resize",v);}if(K.widget){if(K.integrated){var N=K.integrationContainer.getBoundingClientRect();K.widget.style.left=N.left+"px";K.widget.style.top=N.top+"px";K.widget.style.width=N.width+"px";K.widget.style.height=N.height+"px";}else{var O=OK.util.getOffset(K.widget),R=K.widget.getBoundingClientRect(),Q=O.left,P=O.top;if(R.left+L>window.innerWidth){Q-=Math.min(R.left+L-window.innerWidth,R.left);}if(R.top+o>window.innerHeight){P-=Math.min(R.top+o-window.innerHeight,R.top);}K.widget.style.left=Q+"px";K.widget.style.top=P+"px";r(K.widget);}}}function I(N,Q){var X=false,W=false,R,P,T,U;function V(ab){if(W){if(ab.buttons===0){O(ab);return;}var aa=ab.screenX-R,Z=ab.screenY-P;if(!X){X=Math.sqrt(Math.pow(aa,2)+Math.pow(Z,2))>6;}if(X){aa=Math.min(aa,window.innerWidth-L-U.left);Z=Math.min(Z,window.innerHeight-o-U.top);aa=Math.max(aa,-U.left);Z=Math.max(Z,-U.top);Q.style.left=(T.left+aa)+"px";Q.style.top=(T.top+Z)+"px";r(Q);}}X=true;}var Y=z(20,V);function S(Z){Z.preventDefault();Y(Z);}function O(Z){G.info("stopDragging")();X=W=false;document.removeEventListener("mousemove",S,false);document.removeEventListener("mouseup",O);window.removeEventListener("blur",O);if(K){K.stopDragging=null;}}N.addEventListener("mousedown",function(Z){W=true;R=Z.screenX;P=Z.screenY;T=OK.util.getOffset(Q);U=Q.getBoundingClientRect();X=false;K.stopDragging=O;document.addEventListener("mousemove",S,false);document.addEventListener("mouseup",O,false);window.addEventListener("blur",O,false);},false);}function u(N){require(["swfobject"],function(P){m();function R(W,V){var U=document.createElement("div");U.setAttribute("id",W);U.setAttribute("class",V);return U;}var O=R(h,"topPanel vchat_top_panel vchat_loading"),S=R(M,"vchat_widget"),T=R(E,"vchat_dragger");window.addEventListener("resize",v,false);I(T,S);document.body.appendChild(O);O.appendChild(S);S.appendChild(T);var Q=R(B,"vchat_flash_app");S.appendChild(Q);l(P,N.flashUrl);Q=document.getElementById(B);K.topPanel=O;K.widget=S;K.dragger=T;K.flashApp=Q;});}function H(N,O){p(N,N.getAttribute("data-type"),OK.util.parseJSON(N.getAttribute("data-app-params")),null,O);}function p(O,S,T,Q,P){K={loader:O,type:S,appParams:T,incomingParams:Q,startedCB:P};for(var R=0,N=g.length;R<N;++R){A(g[R]);}u(K.appParams);}function F(){window.removeEventListener("resize",v);for(var O=0,N=g.length;O<N;++O){delete window[g[O]];}if(K){if(K.topPanel){b.remove(K.topPanel);}if(K.stopDragging){K.stopDragging();}K.flashApp=null;}q();K=null;}function w(){return K&&K.started;}return{init:H,start:p,destroy:F,isStarted:w};});define("OK/videochat/flash/VideoChat",["OK/logger","OK/videochat/Tracer","OK/videochat/flash/FlashDriver"],function(f,c,e){var d=c.get("OK/videochat/flash/VideoChat");function a(g){var h=g.getAttribute("data-type");d.info("Start loading",h)();f.success("vchat_app","ldng.start",h);if(!okFlashVersion||okFlashVersion[0]<11){g.classList.add("vchat_flash_old");}e.init(g,function(){f.success("vchat_app","ldng.complete",h);if(g.parentElement){g.parentElement.querySelector("#cancel").click();}});}function b(g){d.info("Cancel loading, type:",g.getAttribute("data-type"))();f.success("vchat_app","ldng.cancel",g.getAttribute("data-type"));if(!e.isStarted()){e.destroy();}}return{startLoading:a,cancelLoading:b};});define("OK/videochat/EventEmitter",[],function(){function a(){this._handlers={};}a.prototype={addEventListener:function(b,c){if(!(typeof c==="function")){throw new Error("Listener should be a function");}if(!this._handlers[b]){this._handlers[b]=[];}this._handlers[b].push(c);return{dispose:this.removeEventListener.bind(this,b,c)};},removeEventListener:function(b,c){if(!this._handlers[b]){return;}if(!c){delete this._handlers[b];}var d=this._handlers[b].indexOf(c);if(d>=0){this._handlers[b].splice(d,1);}},_triggerEvent:function(d,b){if(!this._handlers[d]){return;}var e=this;var c=Array.prototype.slice.call(arguments,1);this._handlers[d].slice().forEach(function(f){f.apply(e,c);});}};return a;});define("OK/videochat/Enums",[],function(){return{idType:{USER:"USER",GROUP:"GROUP"},callType:{CALL_VIDEO:"CALL_VIDEO",CALL_AUDIO:"CALL_AUDIO"},callDirection:{INCOMING:"INCOMING",OUTGOING:"OUTGOING",JOINING:"JOINING"},hangupType:{CANCELED:"CANCELED",REJECTED:"REJECTED",REMOVED:"REMOVED",HUNGUP:"HUNGUP",MISSED:"MISSED",BUSY:"BUSY",FAILED:"FAILED"},participant:{CALLED:"CALLED",ACCEPTED:"ACCEPTED",REJECTED:"REJECTED",HUNGUP:"HUNGUP"},uiState:{INVISIBLE:"invisible",DISABLED:"__disabled",HOVER:"__hover",LOCAL:"__local",REMOTE:"__remote",SCREEN:"__screen",MUTED:"__mute",SILENT:"__silent",INCOMING:"__incoming",MINI:"__mini",CONNECTING:"__connecting",ERROR:"__error",ERROR_ACCESS:"__accesserror",FULLSCREEN:"__fullscreen",NOCAM:"__nocam",RATE:"__rate",VOTE:"__vote",HINT:"__hint",FLEX:"__flex",FLEX_BIG:"__flex-big",SAUSAGE:"__sausage",LONG_SAUSAGE:"__long_sausage",HIDE_SAUSAGE:"__hide_sausage",ACTIVE:"__active",LOCKED:"__lock",LANDSCAPE:"__landscape",PORTRAIT:"__portrait",STUB:"__stub",BAD_NETWORK:"__bad-network",LAST:"__last",MESSAGE:"__message",STREAM:"__stream",RECORD:"__record",OWNER:"__owner"},error:{CAMERA_PERMISSION:"camera",MIC_PERMISSION:"mic",CAMERA_ACCESS:"cameralock",MIC_ACCESS:"miclock",MIC_NOT_FOUND:"nomic",SCREEN_PERMISSION:"screenpermission",SCREEN_ACCESS:"screenlock",SCREEN_NEED_EXTENSION:"screenextension",CONNECTION:"connection",NETWORK:"network",UNKNOWN:"unknown",UNSUPPORTED:"unsupported",UI:"ui",SIGNALING_FAILED:"signalingfailed"},stat:{ERROR:"callError",DEVICES:"callDevices",CALL_SPEC_ERROR:"callSpecError",ICE_CONNECTION_STATE:"callIceConnectionState",ICE_CONNECTION_TYPE:"callIceConnectionType",ICE_RESTART:"callIceRestart",PUSH:"callPush",OUTGOING_CALL:"callStart",OUTGOING_MULTIPARTY_CALL:"callStartMultiparty",JOIN_CONVERSATION:"callJoinConversation",ACCEPTED_OUTGOING:"callAcceptedOutgoing",ACCEPT_INCOMING:"callAcceptIncoming",DECLINE_INCOMING:"callDeclineIncoming",ACCEPT_CONCURRENT:"callAcceptConcurrent",HANGUP:"callHangup",MEDIA_STATUS:"callMediaStatus",DEVICE_CHANGED:"callDeviceChanged",UI_ACTION:"callUiAction",PREFER_H264_SDP:"callPreferH264Sdp",SOCKET_ACTION:"callSocketAction",EXTENSION:"callBrowserExtension"},callStatus:{FEASIBLE:"FEASIBLE",CALLER_IS_BLOCKED:"CALLER_IS_BLOCKED",NOT_FRIENDS:"NOT_FRIENDS",CALLEE_IS_OFFLINE:"CALLEE_IS_OFFLINE",UNKNOWN_ERROR:"UNKNOWN_ERROR",UNSUPPORTED:"UNSUPPORTED"},joinError:{CONVERSATION_NOT_FOUND:"CONVERSATION_NOT_FOUND",UNKNOWN_ERROR:"UNKNOWN_ERROR"},features:{ADD_PARTICIPANT:"ADD_PARTICIPANT"},uiWidgetState:{CALLING:"__calling",CALL_IN_PROGRESS:"__call-in-progress",FINISHED:"__finished"}};});define("OK/videochat/Utils",["OK/videochat/Enums","OK/videochat/Tracer"],function(a,b){var l=(function(){var t=navigator.appVersion,r=navigator.appName,q=navigator.userAgent,u=q.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[],o=false,s=0,p;if(/trident/i.test(u[1])){p=/\brv[ :]+(\d+)/g.exec(q);return{name:"IE",version:p[1]||"Unknown",isChromeBased:o,baseChromeVersion:s};}if(u[1]==="Chrome"){o=true;s=u[2];p=q.match(/\bOPR\/(\d+)/);if(p){return{name:"Opera",version:p[1]||"Unknown",isChromeBased:o,baseChromeVersion:s};}p=q.match(/\bYaBrowser\/(\d+)/);if(p){return{name:"Yandex",version:p[1]||"Unknown",isChromeBased:o,baseChromeVersion:s};}}p=q.match(/version\/(\d+)/i);return{name:u[2]?u[1]:r,version:p&&p[1]||u[2]||t,isChromeBased:o,baseChromeVersion:s,};})();function e(s,z,o){var r=new RegExp("[\r\n]+");function u(C,E,G){var F=C.split(" ");var H=F.slice(0,3);var D;for(D=3;D<F.length;D++){if(G.includes(F[D])){H.push(F[D]);}}for(D=3;D<F.length;D++){if(!G.includes(F[D])&&!E.includes(F[D])){H.push(F[D]);}}return H.join(" ");}function y(G,H){var F=new RegExp("a=rtpmap:(\\d+) ([a-zA-Z0-9-]+)\\/\\d+");var E;var C=[];for(E=0;E<G.length;++E){var D=G[E].match(F);if(D&&D.length===3&&D[2]===H){C.push(D[1]);}}return C;}function B(E,C,F,H){var D;var G="m="+C;for(D=0;D<E.length;++D){if(E[D].startsWith(G)){E[D]=u(E[D],F,H);break;}}}var v;var A=s.split(r);if(o||z){v=y(A,"H264");}if(o){var x=v.slice(0);var w=new RegExp("a=fmtp:(\\d+) apt=(\\d+)");var t;for(t=0;t<A.length;++t){var q=A[t].match(w);if(q&&q.length===3&&x.includes(q[2])){x.push(q[1]);}}var p=new RegExp("a=(rtpmap|rtcp-fb|fmtp):(\\d+) .*");t=A.length;while(t--){var q=A[t].match(p);if(q&&q.length===3&&x.includes(q[2])){A.splice(t,1);}}B(A,"video",x,[]);}else{if(z){B(A,"video",[],v);}}return A.join("\r\n");}function k(t){var r=~~(t/3600),p=~~(t/60)%60,q=t%60,o=r?(r<10?"0"+r:r)+":":"";return o+(p<10?"0"+p:p)+":"+(q<10?"0"+q:q);}function n(o){return o?o.type+"_"+o.id:"_";}function d(o){if(!o||!o.getStats){return null;}return o.getStats(null).then(function(p){var r=null,s=null;p.forEach(function(t){if(t.type==="transport"&&t.selectedCandidatePairId){s=p.get(t.selectedCandidatePairId);}else{if(t.type==="candidate-pair"&&t.state==="succeeded"&&!s){if(!t.hasOwnProperty("selected")||t.selected){s=t;}}}});if(s&&s.localCandidateId){var q=p.get(s.localCandidateId);if(q){r={type:q.candidateType,ip:q.ip||q.ipAddress,port:q.port||q.portNumber};}}return r;})["catch"](function(){return null;});}var c=/^[0-9]+$/;var j=/^([gu])([0-9]+)$/;var h=b.get("OK/videochat/Utils");function m(q,o){var p=String(q);if(j.test(p)){h.warn("Already composite id ["+q+"] type supplied ["+o+"]")();return q;}else{if(o===a.idType.GROUP){return"g"+p;}else{if(o===a.idType.USER){return"u"+p;}else{h.warn("Unknown type ["+o+"] for id ["+q+"]")();return p.match(c)?"u"+p:p;}}}}function g(o){return m(o.id,o.idType);}function i(o){return o.participant?g(o.participant):m(o.participantId,o.participantType);}function f(q){var p=String(q),o=p.match(j);if(o){return{id:Number(o[2]),type:o[1]==="g"?a.idType.GROUP:a.idType.USER};}else{h.warn("Unsupported compositeId ["+q+"]")();return{id:c.test(p)?Number(p):q,type:a.idType.USER};}}return{userAgent:l,patchSDP:e,formatTime:k,getPeerIdString:n,getPeerConnectionHostInfo:d,composeId:m,composeParticipantId:g,composeMessageId:i,decomposeId:f};});define("OK/videochat/Logger",["OK/utils/vanilla"],function(h){var l=3000;var o={};var n=null;var g=[];var i=null;function a(p){h.ajax({url:"/dk?cmd=videoStatNew",contentType:"json",type:"POST",data:JSON.stringify(Object.assign({},o,{batch:p}))});}function d(){m();if(g.length>0){a(g);g=[];c();}}function c(){i=setTimeout(d,l);}function m(){if(i){clearTimeout(i);i=null;}}function b(){d();m();}function f(q,s,p){var r=(typeof q==="object")?q:{name:q};if(typeof s!=="undefined"){r.value=s;}r.timestamp=Date.now();r.videoChatId=n;g.push(r);if(p||!i){d();}}function j(p){Object.assign(o,p);}function k(p){if(p){l=p;}}function e(p){n=p;}window.addEventListener("beforeunload",b);window.addEventListener("unload",b);return{log:f,addStatVars:j,setBatchInterval:k,setChatId:e};});define("OK/videochat/Signaling",["OK/videochat/EventEmitter","OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/Utils","OK/videochat/Enums"],function(f,e,b,a,h){var d=b.get("OK/videochat/Signaling");var c=window.WebSocket||window.MozWebSocket;function g(j,i){f.call(this);this.socket=null;this.connected=false;this.sequence=1;this.lastStamp=0;this.commandsQueue=[];this.incomingCache=[];this.responseHandlers={};this.RECONNECT_DELAY=i.signalingReconnectDelay||500;this.RECONNECT_MAX_DELAY=i.signalingReconnectMaxDelay||5000;this.RECONNECT_MAX_COUNT=i.signalingReconnectMaxCount||20;this.WAIT_CONNECTION_DELAY=i.waitConnectionDelay||5000;this.WAIT_MESSAGE_DELAY=i.waitMessageDelay||15000;this.reconnectCount=0;this.endpoint=j;this.postfix="&platform="+i.platform+"&clientType="+i.clientType+"&appVersion="+i.appVersion+"&version="+i.protocolVersion+"&device="+i.device;this.peerId=null;this.conversation=null;this.conversationResolve=null;this.conversationReject=null;this.reconnectTimer=null;this.connectionMessageWaitTimer=null;this.doctorTimer=null;}g.events={NOTIFICATION:"NOTIFICATION",FAILED:"FAILED"};g.notifications={TRANSMITTED_DATA:"transmitted-data",ACCEPTED_CALL:"accepted-call",HUNGUP:"hungup",PARTICIPANT_ADDED:"participant-added",PARTICIPANT_JOINED:"participant-joined",CLOSED_CONVERSATION:"closed-conversation",MEDIA_SETTINGS_CHANGED:"media-settings-changed",RATE_CALL_DATA:"rate-call-data",FEATURE_SET_CHANGED:"feature-set-changed",TOPOLOGY_CHANGED:"topology-changed",PRODUCER_UPDATED:"producer-updated",CONSUMER_ANSWERED:"consumer-answered",MULTIPARTY_CHAT_CREATED:"multiparty-chat-created",FORCE_MEDIA_SETTINGS_CHANGE:"force-media-settings-change",REGISTERED_PEER:"registered-peer",RECORD_STARTED:"record-started",RECORD_STOPPED:"record-stopped"};g.prototype=Object.create(f.prototype);g.prototype.connect=function(){return new Promise(function(j,i){if(this.socket&&this.socket.readyState<c.CLOSING){e.log(h.stat.SOCKET_ACTION,"already_opened");i(Error("Socket already opened"));return;}this.conversationResolve=j;this.conversationReject=i;this._connect();}.bind(this));};g.prototype.send=function(j,i){return new Promise(function(l,k){i=i||{};if(i.participantId){var m=a.decomposeId(i.participantId);i=Object.assign({},i,{participantId:m.id,participantType:m.type});}if(!this.socket){e.log(h.stat.SOCKET_ACTION,"not_opened");d.debug("Socket not opened")();k(new Error("Socket not opened"));return;}if(this.socket.readyState>c.OPEN){e.log(h.stat.SOCKET_ACTION,"invalid_state");d.debug("Invalid state "+this.socket.readyState)();}this.commandsQueue.push({sequence:this.sequence++,name:j,params:i,responseTimer:null,resolve:l,reject:k});if(this.socket.readyState===c.OPEN){this._handleCommandsQueue();}}.bind(this));};g.prototype.hangup=function(i){return this.send("hangup",{reason:i})["catch"](function(){});};g.prototype.sendCandidate=function(j,i){return this.send("transmit-data",{participantId:j,data:{candidate:i}});};g.prototype.sendSdp=function(j,i){return this.send("transmit-data",{participantId:j,data:{sdp:i}});};g.prototype.acceptCall=function(i){return this.send("accept-call",{mediaSettings:i});};g.prototype.changeMediaSettings=function(i){return this.send("change-media-settings",{mediaSettings:i});};g.prototype.addParticipant=function(i){return this.send("add-participant",{participantId:i});};g.prototype.removeParticipant=function(i){return this.send("remove-participant",{participantId:i});};g.prototype.allocateConsumer=function(j,i){return this.send("allocate-consumer",{description:j.sdp,capabilities:i});};g.prototype.acceptProducer=function(j,i){var k={description:j.sdp};if(i){k.ssrcs=i;}return this.send("accept-producer",k);};g.prototype.changePriorities=function(i){return this.send("change-streams-priorities",{priorities:i});};g.prototype.startStream=function(i){return this.send("record-start",i);};g.prototype.stopStream=function(){return this.send("record-stop");};g.prototype.getRecordStatus=function(){return this.send("record-get-status");};g.prototype.close=function(){if(this.socket&&this.socket.readyState<c.CLOSING){this.socket.onopen=null;this.socket.onmessage=null;this.socket.onerror=null;this.socket.onclose=null;this.socket.close();this.socket=null;}this._stopWaitConnectionMessage();this._stopDoctor();clearTimeout(this.reconnectTimer);};g.prototype.getConversation=function(){return this.conversation;};g.prototype._connect=function(){if(this.socket&&this.socket.readyState<c.CLOSING){return;}d.debug("Connecting to "+this.endpoint+this.postfix)();this.socket=new c(this.endpoint+this.postfix);this.socket.onopen=this._onOpen.bind(this);this.socket.onmessage=this._onMessage.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this._startDoctor();};g.prototype._recover=function(){var i=this;var j=new Promise(function(m,l){if(!i.socket||i.socket.readyState!==c.OPEN){d.debug("Socket not opened")();l(new Error("Socket not opened"));return;}var n={sequence:i.sequence++,name:"recover",params:{stamp:i.lastStamp},responseTimer:null,resolve:m,reject:l};var k=Object.assign({command:n.name,sequence:n.sequence},n.params);n.responseTimer=setTimeout(i._handleCommandResponse.bind(i,false,k),5000);i.responseHandlers[n.sequence]=n;i.socket.send(JSON.stringify(k));});j.then(function(k){if(!k.error){k.messages.forEach(i._handleMessage.bind(i));}i._handleCommandsQueue();});};g.prototype._onOpen=function(){e.log(h.stat.SOCKET_ACTION,"opened");this._waitConnectionMessage();this._startDoctor();};g.prototype._onMessage=function(i){this._startDoctor();if(i.data==="ping"){this.socket.send("pong");return;}try{this._handleMessage(JSON.parse(i.data));}catch(j){e.log(h.stat.SOCKET_ACTION,"parse_error");d.error("Unable to parse message",j,{data:i.data})();}};g.prototype._handleMessage=function(i){if(i.type==="notification"){if(i.notification==="connection"){this.connected=true;this.conversation=i.conversation;this.reconnectCount=0;this.endpoint=i.endpoint;if(i.peerId&&this.peerId!==i.peerId.id){this.postfix+="&peerId="+i.peerId.id;this.peerId=i.peerId.id;}this._stopWaitConnectionMessage();this.conversationResolve(i.conversation);this._handleCachedMessages();if(this.lastStamp){this._recover();}else{this._handleCommandsQueue();}}else{if(!this.connected){this.incomingCache.push(i);}else{this._triggerEvent(g.events.NOTIFICATION,i);}}}else{if((i.type==="response"||i.type==="error")&&this.responseHandlers[i.sequence]){this._handleCommandResponse(true,i);}else{if(i.type==="error"){if(i.error==="service-unavailable"&&i.recoverable){e.log(h.stat.SOCKET_ACTION,"service-unavailable");this._reconnect();}else{if(!i.sequence||!i.recoverable){if(this.connected){e.log(h.stat.SOCKET_ACTION,"error-"+i.error);this._throwError(new Error("Signaling error: "+i.error));}else{this.conversationReject(new Error("Unable to connect to the signaling: "+i.error));this.close();}}}}else{e.log(h.stat.SOCKET_ACTION,"unknown_message");d.warn("Unhandled message",{message:i})();}}}this.lastStamp=i.stamp||this.lastStamp;};g.prototype._handleCachedMessages=function(){var i=this;while(this.incomingCache.length>0){var j=this.incomingCache.pop();i._handleMessage(j);}};g.prototype._throwError=function(i){this._triggerEvent(g.events.FAILED,i);};g.prototype._onError=function(i){e.log(h.stat.SOCKET_ACTION,"error");};g.prototype._onClose=function(i){e.log(h.stat.SOCKET_ACTION,"closed");d.debug("Connection closed",{code:i.code,reason:i.reason})();this.connected=false;this._stopDoctor();if(this.socket&&this.reconnectCount++<this.RECONNECT_MAX_COUNT){this._reconnect();}else{if(this.socket){Object.values(this.responseHandlers).forEach(function(j){clearTimeout(j.responseTimer);j.reject(new Error("Connection closed"));});this.commandsQueue=[];this.responseHandlers={};this.socket=null;this._throwError(new Error("Connection closed"));}}};g.prototype._reconnect=function(){var i=Math.min(this.RECONNECT_MAX_DELAY,this.RECONNECT_DELAY*Math.pow(2,this.reconnectCount-1));d.debug("Reconnect websocket after "+i+"ms ("+this.reconnectCount+")")();e.log(h.stat.SOCKET_ACTION,"reconnect");this.reconnectTimer=setTimeout(this._connect.bind(this),i);};g.prototype._handleCommandResponse=function(i,j){if(!this.responseHandlers.hasOwnProperty(j.sequence)){return;}var k=this.responseHandlers[j.sequence];clearTimeout(k.responseTimer);if(i){k.resolve(j);}else{e.log(h.stat.SOCKET_ACTION,"response-timeout");k.reject(new Error("Response timeout ["+k.name+"]"));}delete this.responseHandlers[j.sequence];};g.prototype._handleCommandsQueue=function(){while(this.commandsQueue.length>0){var j=this.commandsQueue.shift();if(!this.socket||this.socket.readyState!==c.OPEN){j.reject(new Error("Invalid state or socket already closed"));continue;}var i=Object.assign({command:j.name,sequence:j.sequence},j.params);j.responseTimer=setTimeout(this._handleCommandResponse.bind(this,false,i),5000);this.responseHandlers[j.sequence]=j;this.socket.send(JSON.stringify(i));}};g.prototype._waitConnectionMessage=function(){this.connectionMessageWaitTimer=setTimeout(function(){this.conversationReject(new Error("Unable to connect to the signaling: connection timeout"));}.bind(this),this.WAIT_CONNECTION_DELAY);};g.prototype._stopWaitConnectionMessage=function(){clearTimeout(this.connectionMessageWaitTimer);this.connectionMessageWaitTimer=null;};g.prototype._startDoctor=function(){this._stopDoctor();this.doctorTimer=setTimeout(function(){d.warn("Socket is dead, trying to reconnect")();this.close();this._connect();}.bind(this),this.WAIT_MESSAGE_DELAY);};g.prototype._stopDoctor=function(){clearTimeout(this.doctorTimer);this.doctorTimer=null;};return g;});define("OK/videochat/Capturer",["OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/Enums"],function(i,b,a){var g=b.get("OK/videochat/Capturer");function c(j){this._extensionId=j;}c.prototype._isExtensionNeeded=function(){return false;};c.prototype._installExtension=function(){return Promise.resolve();};c.prototype._getMediaSourceId=function(){return Promise.resolve(null);};c.prototype.getSourceId=function(){if(this._isExtensionNeeded()){return this._installExtension().then(this._getMediaSourceId.bind(this));}return this._getMediaSourceId();};c.prototype.destroy=function(){this._extensionId=null;};function h(){c.apply(this,arguments);this._port=null;this._extensionMessagesStack={};this._waitInstallTimeout=null;this._extensionLink="https://chrome.google.com/webstore/detail/"+this._extensionId;this._connectToExtension()["catch"](function(){});}h.prototype=Object.create(c.prototype);h.prototype.constructor=h;h.prototype._getExtensionStatus=function(){var j=this;return new Promise(function(l,k){chrome.runtime.sendMessage(j._extensionId,"ping",function(m){if(m&&m==="pong"){l();}else{k(a.error.SCREEN_NEED_EXTENSION);}});});};h.prototype._waitExtension=function(){var j=this;return new Promise(function k(m,l){if(j._waitInstallTimeout){clearTimeout(j._waitInstallTimeout);j._waitInstallTimeout=null;}if(!j._extensionId){i.log(a.stat.EXTENSION,"timeout");g.debug("Failed to install extension: timeout")();l(a.error.SCREEN_NEED_EXTENSION);return;}j._waitInstallTimeout=setTimeout(function(){j._connectToExtension().then(function(){i.log(a.stat.EXTENSION,"install");g.debug("Extension installed")();m();})["catch"](function(){k(m,l);});},1000);});};h.prototype._callExtension=function(k){var j=this;return new Promise(function(m,l){if(!j._port){l(a.error.SCREEN_NEED_EXTENSION);return;}j._extensionMessagesStack[k]=j._extensionMessagesStack[k]||[];j._extensionMessagesStack[k].push({resolve:m,reject:l});j._port.postMessage(k);});};h.prototype._connectToExtension=function(){if(this._port){return Promise.resolve();}var j=this;return this._getExtensionStatus().then(function(){var k=chrome.runtime.connect(j._extensionId,{name:"ok-screen-sharing"});if(!k){return Promise.reject(a.error.SCREEN_NEED_EXTENSION);}k.onMessage.addListener(j._onPortMessageCallback.bind(j));k.onDisconnect.addListener(j._onPortDisconnected.bind(j));j._port=k;return Promise.resolve();});};h.prototype._onPortDisconnected=function(){this._port=null;};h.prototype._onPortMessageCallback=function(k){var j=k.request;while(this._extensionMessagesStack[j]&&this._extensionMessagesStack[j].length>0){var l=this._extensionMessagesStack[j].pop();if(k.response==="PermissionDeniedError"){l.reject(a.error.SCREEN_PERMISSION);}else{if(k.response==="UnknownError"){l.reject(a.error.SCREEN_ACCESS);}else{l.resolve(k);}}}};h.prototype._isExtensionNeeded=function(){return !this._port;};h.prototype._installExtension=function(){window.open(this._extensionLink,"_blank");return this._waitExtension();};h.prototype._getMediaSourceId=function(){return this._callExtension("get-sourceId").then(function(j){return j.sourceId;});};h.prototype.destroy=function(){if(this._waitInstallTimeout){clearTimeout(this._waitInstallTimeout);this._waitInstallTimeout=null;}if(this._port){this._port.disconnect();this._port=null;}this._extensionMessagesStack={};this._extensionLink=null;c.prototype.destroy.call(this);};function e(){c.apply(this,arguments);}e.prototype=Object.create(c.prototype);e.prototype.constructor=e;e.prototype._installExtension=function(){var j=this;return new Promise(function(l,k){try{opr.addons.installExtension(j._extensionId,function(){i.log(a.stat.EXTENSION,"install");g.debug("Extension installed")();l();},function(n){i.log(a.stat.EXTENSION,n);g.error("Failed to install extension",n)();k(a.error.SCREEN_NEED_EXTENSION);});}catch(m){i.log(a.stat.EXTENSION,(typeof m==="object"&&m.message)?m.message:m);g.error("Failed to install extension",m)();k(a.error.SCREEN_NEED_EXTENSION);}});};function f(j){if(!d(j)){return null;}if(window.opr){return new e(j.operaExtensionId);}if(window.chrome){return new h(j.chromeExtensionId);}return new c();}function d(j){if(!j.capturing){return false;}if(window.opr&&(!window.opr.addons||!j.operaExtensionId)){return false;}if(window.chrome&&(!window.chrome.runtime||!j.chromeExtensionId)){return false;}return true;}return{getCapturer:f,isCapturingAvailable:d};});define("OK/videochat/MediaSource",["OK/WebRTCUtils!","OK/videochat/EventEmitter","OK/videochat/Utils","OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/Enums","OK/videochat/Capturer"],function(c,i,g,h,b,a,d){var f=b.get("OK/videochat/MediaSource");function e(j){i.call(this);this._params=j;this._stream=null;this._mediaSettings={isAudioEnabled:true,isVideoEnabled:true,isDataEnabled:false,isScreenSharingEnabled:false,audioBitrateBps:0,videoBitrateBps:0};this._capturer=d.getCapturer(j);}e.events={SOURCE_CHANGED:"SOURCE_CHANGED",TRACK_REPLACED:"TRACK_REPLACED",PERMISSIONS_REQUESTED:"PERMISSIONS_REQUESTED"};e.prototype=Object.create(i.prototype);e.prototype=Object.assign(e.prototype,{request:function(k){if(this._stream){return Promise.resolve(this._stream);}if(!c.isBrowserSupported()){return Promise.reject({access:a.error.UNSUPPORTED});}if(!c.hasMicrophone()){return Promise.reject({access:a.error.MIC_NOT_FOUND});}if(!c.hasPermissions(k)){this._triggerEvent(e.events.PERMISSIONS_REQUESTED);}var j=this;return c.getUserMedia({video:k,minWidth:this._params.videoMinWidth,maxWidth:this._params.videoMaxWidth,minHeight:this._params.videoMinHeight,maxHeight:this._params.videoMaxHeight})["catch"](function(l){if(l==="permission"){return Promise.reject({access:k?a.error.CAMERA_PERMISSION:a.error.MIC_PERMISSION});}return Promise.reject({access:k?a.error.CAMERA_ACCESS:a.error.MIC_ACCESS});}).then(function(l){if(k&&l.getVideoTracks().length===0){f.warn("Unable to obtain requested local video track")();}j._stream=l;j._mediaSettings.isVideoEnabled=k&&l.getVideoTracks().length>0;return l;});},getStream:function(){return this._stream;},getMediaSettings:function(){return this._mediaSettings;},changeDevice:function(j){if(!c.canReplaceTrack()){return Promise.resolve();}switch(j){case"videoinput":return this._changeVideoInput();case"audioinput":return this._changeAudioInput();case"screen":return this._changeScreen();default:return Promise.resolve();}},destroy:function(){if(this._stream){this._stream.getTracks().forEach(function(j){j.stop();});this._stream=null;}if(this._capturer){this._capturer.destroy();}},_changeVideoInput:function(){var j=this;this._stopLocalTrack("video");return c.getUserVideo({minWidth:this._params.videoMinWidth,maxWidth:this._params.videoMaxWidth,minHeight:this._params.videoMinHeight,maxHeight:this._params.videoMaxHeight}).then(function(l){if(!j._stream){l.getTracks().forEach(function(m){m.stop();});}else{h.log(a.stat.DEVICE_CHANGED,"video");f.debug("Camera changed")();var k=l.getVideoTracks()[0];j._stream.getVideoTracks().forEach(function(m){j._replaceLocalTrack(m,k);});j._mediaSettings.isVideoEnabled=true;j._mediaSettings.isScreenSharingEnabled=false;j._triggerEvent(e.events.SOURCE_CHANGED,{kind:"video",mediaSettings:j._mediaSettings});}})["catch"](function(k){h.log(a.stat.ERROR,"change_video");f.debug("Camera change failed",k)();});},_changeAudioInput:function(){var j=this;this._stopLocalTrack("audio");return c.getUserAudio().then(function(l){if(!j._stream){l.getTracks().forEach(function(m){m.stop();});}else{h.log(a.stat.DEVICE_CHANGED,"audio");f.debug("Microphone changed")();var k=l.getAudioTracks()[0];j._stream.getAudioTracks().forEach(function(m){j._replaceLocalTrack(m,k);});j._mediaSettings.isAudioEnabled=true;j._triggerEvent(e.events.SOURCE_CHANGED,{kind:"audio",mediaSettings:j._mediaSettings});}})["catch"](function(k){h.log(a.stat.ERROR,"change_audio");f.error("Microphone change failed",k)();});},_changeScreen:function(){var j=this;return this._capturer.getSourceId().then(function(k){j._stopLocalTrack("video");return c.getScreenMedia(k);}).then(function(l){if(!j._stream){l.getTracks().forEach(function(m){m.stop();});}else{h.log(a.stat.DEVICE_CHANGED,"screen");f.debug("Screen capturing started")();var k=l.getVideoTracks()[0];j._stream.getVideoTracks().forEach(function(m){j._replaceLocalTrack(m,k);});j._mediaSettings.isVideoEnabled=true;j._mediaSettings.isScreenSharingEnabled=true;j._triggerEvent(e.events.SOURCE_CHANGED,{kind:"screen",mediaSettings:j._mediaSettings});}})["catch"](function(k){h.log(a.stat.ERROR,"screen");f.error("Screen capturing failed",k)();});},toggleVideo:function(k){var j=this;h.log(a.stat.MEDIA_STATUS,k?"video_1":"video_0");if(!c.canReplaceTrack()){this._stream.getVideoTracks().forEach(function(m){m.enabled=k;});this._mediaSettings.isVideoEnabled=k;if(!k){this._mediaSettings.isScreenSharingEnabled=false;}this._triggerEvent(e.events.SOURCE_CHANGED,{kind:"video",mediaSettings:this._mediaSettings});return;}var l=!k?Promise.resolve(c.getBlackMediaTrack(this._params.videoMinWidth,this._params.videoMinHeight)):c.getUserVideo({minWidth:this._params.videoMinWidth,maxWidth:this._params.videoMaxWidth,minHeight:this._params.videoMinHeight,maxHeight:this._params.videoMaxHeight}).then(function(m){return m.getVideoTracks()[0];});l.then(function(m){j._stopLocalTrack("video");j._stream.getVideoTracks().forEach(function(n){j._replaceLocalTrack(n,m);});j._mediaSettings.isVideoEnabled=k;if(!k){j._mediaSettings.isScreenSharingEnabled=false;}j._triggerEvent(e.events.SOURCE_CHANGED,{kind:"video",mediaSettings:j._mediaSettings});});},toggleAudio:function(j){h.log(a.stat.MEDIA_STATUS,j?"audio_1":"audio_0");this._stream.getAudioTracks().forEach(function(k){k.enabled=j;});this._mediaSettings.isAudioEnabled=j;this._triggerEvent(e.events.SOURCE_CHANGED,{kind:"audio",mediaSettings:this._mediaSettings});},_replaceLocalTrack:function(k,j){this._stream.removeTrack(k);this._stream.addTrack(j);this._triggerEvent(e.events.TRACK_REPLACED,k,j);},_stopLocalTrack:function(j){this._stream.getTracks().forEach(function(k){if(k.kind===j){k.stop();}});}});return e;});define("OK/videochat/transport/Statistics",["OK/videochat/Utils"],function(m){function c(s){var q=[];(function r(u,t){u.forEach(function(v){if(Array.isArray(v)){r(v,t);}else{t.push(v);}});})(s,q);return q;}function d(q){return function(r){return r.map(q);};}function j(){var q=arguments;return function(r){for(var s=0;s<q.length;s++){if(q[s](r)){return true;}}return false;};}function e(q,r){return function(s){return s[q]===r;};}function p(q){return function(s,r){return s[q]-r[q];};}function i(r,q){return q.reduce(function(t,s){t[s[r]]=s;return t;},{});}function h(r,q){return Object.values(i(r,q));}function o(q){return q!=null&&typeof q==="object"&&Array.isArray(q)===false;}function b(q){return Object.keys(q).filter(function(r){return q[r]!==undefined;}).map(function(r){return[r,q[r]];}).reduce(function(r,s){r[s[0]]=o(s[1])?b(s[1]):s[1];return r;},{});}function l(r){var q=[];r.forEach(function(s){q.push(s);});return q;}function f(r){var q=[];if(RTCRtpReceiver.prototype.getStats){q.push(r.getReceivers().map(function(s){return s.getStats();}));q.push(r.getSenders().map(function(s){return s.getStats();}));}else{q.push(r.getStats());}return Promise.all(c(q)).then(d(l)).then(c).then(h.bind(null,"id"));}function a(r){var t=r.filter(e("type","candidate-pair")).sort(p("priority")).find(j(e("nominated",true),e("selected",true)));if(!t){return{};}var u={totalRoundTripTime:t.totalRoundTripTime,currentRoundTripTime:t.currentRoundTripTime,bytesSent:t.bytesSent,bytesReceived:t.bytesReceived};var s=r.find(e("id",t.remoteCandidateId));if(s){u=Object.assign({},u,{remote:{type:s.candidateType,address:s.ip||s.address,port:s.port,protocol:s.protocol}});}var q=r.find(e("id",t.localCandidateId));if(q){u=Object.assign({},u,{local:{type:q.candidateType,address:q.ip||q.address,port:q.port,protocol:q.protocol,relayProtocol:q.relayProtocol,networkType:q.networkType}});}return b(u);}function g(r,u){u=u||{};var t=i("id",r);var s=r.filter(j(e("type","inbound-rtp"),e("type","outbound-rtp")));if(m.userAgent.name==="Firefox"){s=Object.values(s.reduce(function(y,w){if(!y[w.ssrc]){y[w.ssrc]=w;}else{var v=Object.assign({},y[w.ssrc],w),x=y[w.ssrc].isRemote?w:y[w.ssrc];v.id=x.id;v.type=x.type;delete v.isRemote;delete v.remoteId;y[v.ssrc]=v;}return y;},{}));}var q={};if(m.userAgent.name==="Safari"){q=i("trackIdentifier",r.filter(e("type","track")));}return s.map(function(z){var v=z.ssrc,D=z.type,y=(z.mediaType||z.kind),B=z.codecId,x=z.trackId;if(m.userAgent.name==="Safari"){var F=/^.+_([\d]+)$/.exec(z.id);if(F){v=parseInt(F[1]);}y=(z.id.indexOf("Audio")>0?"audio":"video");if(u[v]){var A=y+"-"+u[v];if(q[A]){x=q[A].id;}}}if(!D||!v||!y){return null;}var C={ssrc:v,type:D,kind:y,bytesReceived:z.bytesReceived,bytesSent:z.bytesSent,jitter:z.jitter,packetsLost:z.packetsLost,packetsReceived:z.packetsReceived,packetsSent:z.packetsSent,fractionLost:z.fractionLost,pliCount:z.pliCount,firCount:z.firCount,nackCount:z.nackCount};if(B&&t[B]){var E=t[B];C.clockRate=E.clockRate;C.mimeType=E.mimeType;}if(x&&t[x]){var w=t[x];C.frameHeight=w.frameHeight;C.frameWidth=w.frameWidth;C.framesDecoded=w.framesDecoded;C.framesReceived=w.framesReceived;C.framesDropped=w.framesDropped;}return b(C);}).filter(function(v){return !!v;});}function n(u,s){if(!s){return u;}if(!s.rtps||!u.rtps){return u;}var r=i("ssrc",u.rtps),q=i("ssrc",s.rtps),t=(u.timestamp-s.timestamp)/1000;if(!r||!q){return u;}Object.keys(r).forEach(function(v){var x=r[v],w=q[v];if(!x||!w){return;}if(x.bytesReceived&&x.bytesReceived>w.bytesReceived){x.bandwidth=Math.round((x.bytesReceived-w.bytesReceived)/t);}if(x.bytesSent&&x.bytesSent>w.bytesSent){x.bandwidth=Math.round((x.bytesSent-w.bytesSent)/t);}if(x.packetsReceived>w.packetsReceived){x.packetLoss=parseFloat((100*(x.packetsLost-w.packetsLost)/(x.packetsReceived-w.packetsReceived)/t).toFixed(2));}if(x.framesDropped>w.framesDropped){x.framesDroppedDelta=parseFloat(((x.framesDropped-w.framesDropped)/t).toFixed(0));}});return u;}function k(q,r,s){return f(q).then(function(t){return{timestamp:Date.now(),transport:a(t),rtps:g(t,s)};}).then(function(t){return n(t,r);});}return{collect:k};});define("OK/videochat/transport/DirectTransport",["OK/WebRTCUtils!","OK/videochat/EventEmitter","OK/videochat/Utils","OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/Enums","OK/videochat/Signaling","OK/videochat/MediaSource","OK/videochat/transport/Statistics"],function(d,k,i,j,b,a,f,g,e){var h=b.get("OK/videochat/transport/DirectTransport");function c(r,o,p,l,q){k.call(this);h.debug("Create",{participantId:r,isMaster:o})();this._params=q;this._signaling=p;this._mediaSource=l;this._participantId=r;this._isMaster=false;this._pc=null;this._remoteSDP={};this._remoteCandidates={};this._state=c.states.IDLE;this._isOpen=false;this._isMaster=o;this._isRestartPrevented=false;this._remotePeerId=null;this._statInterval=null;this._listeners=[];this._listeners.push(this._signaling.addEventListener(f.events.NOTIFICATION,this._onSignalingNotification.bind(this)),this._mediaSource.addEventListener(g.events.TRACK_REPLACED,this._onReplacedTrack.bind(this)));this._pc=new RTCPeerConnection({iceServers:this._params.iceServers},{optional:[{googSuspendBelowMinBitrate:false}]});this._pc.onicecandidate=this._handleIceCandidate.bind(this);this._pc.ontrack=this._onAddTrack.bind(this);this._pc.onremovestream=this._onRemoveStream.bind(this);this._pc.oniceconnectionstatechange=this._onIceConnectionStateChange.bind(this);this._pc.onsignalingstatechange=this._onSignalingStateChange.bind(this);if(this._isMaster){try{this._addTracks(this._mediaSource.getStream());}catch(n){j.log(a.stat.ERROR,"addTrack-direct");h.error("Unable to add media source tracks",n,{participantId:this._participantId});this._failedOnCreate=n;return;}var m=this;this._createOffer(false)["catch"](function(s){if(m._state===c.states.IDLE){m._failedOnCreate=s;}else{m.close(s);}});}this._startStatInterval();}c.events={REMOTE_TRACK_ADDED:"REMOTE_TRACK_ADDED",REMOTE_STREAM_REMOVED:"REMOTE_STREAM_REMOVED",REMOTE_DATA_STATS:"REMOTE_DATA_STATS",LOCAL_DATA_STATS:"LOCAL_DATA_STATS",STATE_CHANGED:"STATE_CHANGED"};c.states={IDLE:"IDLE",OPENED:"OPENED",CONNECTING:"CONNECTING",RECONNECTING:"RECONNECTING",CONNECTED:"CONNECTED",CLOSED:"CLOSED",FAILED:"FAILED"};c.prototype=Object.create(k.prototype);c.prototype=Object.assign(c.prototype,{getState:function(){return this._state;},open:function(q){if(this._isOpen){h.debug("Transport is already opened",{participantId:this._participantId})();return;}if(this._failedOnCreate){this.close(this._failedOnCreate);}h.debug("Open transport",{participantId:this._participantId})();this._isOpen=true;this._remotePeerId=q;if(!this._isMaster){try{this._addTracks(this._mediaSource.getStream());}catch(r){j.log(a.stat.ERROR,"addTrack-direct");h.error("Unable to add media source tracks",r,{participantId:this._participantId});this.close(r);}}var p=q,n=q;if(!q){var m=Object.keys(this._remoteSDP);var l=Object.keys(this._remoteCandidates);p=m[m.length-1];n=l[l.length-1];}if(p&&this._remoteSDP[p]){this._setRemoteDescription(p,this._remoteSDP[p])["catch"](this.close.bind(this));}if(n&&this._remoteCandidates[n]){var o=this;this._remoteCandidates[n].forEach(function(s){o._addIceCandidate(n,s)["catch"](o.close.bind(this));});}this._remoteSDP={};this._remoteCandidates={};this._setState(c.states.OPENED);},preventRestart:function(){this._isRestartPrevented=true;},allowRestart:function(){this._isRestartPrevented=false;},close:function(l){this._isOpen=false;if(this._remoteStream){this._remoteStream.getTracks().forEach(function(m){m.stop();});this._remoteStream=null;}this._stopStatInterval();if(this._pc){this._pc.onicecandidate=null;this._pc.ontrack=null;this._pc.onremovestream=null;this._pc.oniceconnectionstatechange=null;this._pc.onsignalingstatechange=null;this._pc.close();this._pc=null;}this._listeners.forEach(function(m){m.dispose();});if(l){h.error("Closed",l,{participantId:this._participantId})();this._setState(c.states.FAILED);}else{h.debug("Closed",{participantId:this._participantId})();this._setState(c.states.CLOSED);}},_addTracks:function(l){l.getTracks().forEach(function(m){this._pc.addTrack(m,l);}.bind(this));},_setState:function(l){if(this._state===l){return;}h.debug("State changed to "+l,{participantId:this._participantId})();this._state=l;this._triggerEvent(c.events.STATE_CHANGED,l);},_onSignalingNotification:function(l){if(l.notification===f.notifications.TRANSMITTED_DATA){this._handleTransmittedData(l);}},_handleTransmittedData:function(m){var n=m.data,l=i.getPeerIdString(m.peerId),o=i.composeMessageId(m);if(o!==this._participantId){return;}if(n.candidate){this._addIceCandidate(l,n.candidate)["catch"](this.close.bind(this));}else{if(n.sdp){this._setRemoteDescription(l,n.sdp)["catch"](this.close.bind(this));}}},_addIceCandidate:function(l,m){h.debug("Remote ice candidate",{participantId:this._participantId,candidate:m})();if(this._isOpen&&(!this._remotePeerId||this._remotePeerId===l)){return this._pc.addIceCandidate(new RTCIceCandidate(m))["catch"](function(n){j.log(a.stat.ERROR,"addIceCandidate-direct");h.error("Unable to add remote ice candidate",n,{participantId:this._participantId,candidate:m})();throw n;}.bind(this));}this._remoteCandidates[l]=this._remoteCandidates[l]||[];this._remoteCandidates[l].push(m);return Promise.resolve();},_setRemoteDescription:function(m,l){h.debug("Remote description",{participantId:this._participantId,sdp:l})();if(this._isOpen&&(!this._remotePeerId||this._remotePeerId===m)){return this._pc.setRemoteDescription(new RTCSessionDescription(l))["catch"](function(n){j.log(a.stat.ERROR,"setRemoteDescription-direct");h.error("Unable to set remote description",n,{participantId:this._participantId,sdp:l})();throw n;}.bind(this));}this._remoteSDP[m]=l;return Promise.resolve();},_onAddTrack:function(l){h.debug("Added remote track",{participantId:this._participantId})();if(!this._remoteStream){this._remoteStream=l.streams[0];}this._triggerEvent(c.events.REMOTE_TRACK_ADDED,this._remoteStream,l.track);},_onRemoveStream:function(l){h.debug("Removed remote stream",{participantId:this._participantId})();this._remoteStream=null;this._triggerEvent(c.events.REMOTE_STREAM_REMOVED,l.stream);},_handleIceCandidate:function(l){if(l.candidate){h.debug("Local ice candidate",{participantId:this._participantId,candidate:l.candidate})();this._signaling.sendCandidate(this._participantId,l.candidate);}},_onSignalingStateChange:function(){if(!this._pc){return;}h.debug("Signaling state changed to "+this._pc.signalingState,{participantId:this._participantId})();switch(this._pc.signalingState){case"have-local-offer":this._signaling.sendSdp(this._participantId,this._pc.localDescription)["catch"](this.close.bind(this));break;case"have-remote-offer":this._createAnswer()["catch"](this.close.bind(this)).then(this._signaling.sendSdp.bind(this._signaling,this._participantId))["catch"](this.close.bind(this));break;}},_onIceConnectionStateChange:function(){if(!this._pc){return;}h.debug("Ice connection state changed to "+this._pc.iceConnectionState,{participantId:this._participantId})();j.log(a.stat.ICE_CONNECTION_STATE,this._pc.iceConnectionState);switch(this._pc.iceConnectionState){case"checking":var l=this.getState();if(l===c.states.IDLE||l===c.states.OPENED){this._setState(c.states.CONNECTING);}else{this._setState(c.states.RECONNECTING);}break;case"connected":this._setState(c.states.CONNECTED);this._stopIceRestart();i.getPeerConnectionHostInfo(this._pc).then(function(m){m&&j.log(a.stat.ICE_CONNECTION_TYPE,m.type);});break;case"failed":if(this._isRestartPrevented){this.close(new Error("Ice connection failed"));}else{this._setState(c.states.RECONNECTING);this._startIceRestart();}break;case"disconnected":if(this._isRestartPrevented){this.close(new Error("Ice connection disconnected"));}else{this._setState(c.states.RECONNECTING);}break;case"closed":this.close(new Error("Ice connection closed"));break;}},_startIceRestart:function(){if(this._iceRestartTimeout){return;}if(this._isMaster){j.log(a.stat.ICE_RESTART);h.debug("Ice restart",{participantId:this._participantId})();this._createOffer(true)["catch"](this.close.bind(this));}else{h.debug("Wait for ice restart",{participantId:this._participantId})();}this._iceRestartTimeout=setTimeout(function(){h.error("Ice restart failed",null,{participantId:this._participantId})();j.log(a.stat.ERROR,"iceRestart-direct");this._iceRestartTimeout=null;this.close(new Error("Ice restart failed"));}.bind(this),this._params.iceRestartWaitTime||20000);},_stopIceRestart:function(){if(this._iceRestartTimeout){clearTimeout(this._iceRestartTimeout);this._iceRestartTimeout=null;}},_createOffer:function(m){var n={iceRestart:!!m,offerToReceiveAudio:true,offerToReceiveVideo:true};h.debug("Create offer",{participantId:this._participantId,options:n})();var l=this;return this._pc.createOffer(n)["catch"](function(o){h.error("Unable to create offer",o,{participantId:l._participantId})();j.log(a.stat.ERROR,"createOffer-direct");throw o;}).then(function(o){h.debug("Created offer",{participantId:l._participantId,offer:o})();o=l._patchDescription(o);h.debug("Set local description",{participantId:l._participantId,offer:o})();return l._pc.setLocalDescription(o).then(function(){return l._pc.localDescription;});})["catch"](function(o){h.error("Unable to set local description",o,{participantId:l._participantId})();j.log(a.stat.ERROR,"setLocalDescription-direct");throw o;});},_createAnswer:function(){h.debug("Create answer",{participantId:this._participantId})();var l=this;return this._pc.createAnswer()["catch"](function(m){h.error("Unable to create answer",m,{participantId:l._participantId})();j.log(a.stat.ERROR,"createAnswer-direct");throw m;}).then(function(m){h.debug("Created answer",{participantId:l._participantId,answer:m})();m=l._patchDescription(m);h.debug("Set local description",{participantId:l._participantId,answer:m})();return l._pc.setLocalDescription(m);}).then(function(){return l._pc.localDescription;})["catch"](function(m){h.error("Unable to set local description",m,{participantId:l._participantId})();j.log(a.stat.ERROR,"setLocalDescription-direct");throw m;});},_patchDescription:function(l){l.sdp=i.patchSDP(l.sdp,this._params.preferH264,this._params.brokenH264);return l;},_onReplacedTrack:function(n,m){var l=this;if(this._pc){this._pc.getSenders().forEach(function(o){if(o.track.kind===m.kind){o.track.enabled=m.enabled;o.replaceTrack(m)["catch"](function(p){h.error("Unable to replace track",p,{participantId:l._participantId})();j.log(a.stat.ERROR,"replaceTrack-direct");});}});}},_startStatInterval:function(){if(this._statInterval){return;}var l=this;this._statInterval=setInterval(function(){if(!l._pc){l._stopStatInterval();return;}e.collect(l._pc,l._lastStat).then(function(n){l._lastStat=n;var m={inbound:{topology:"DIRECT",transport:n.transport,rtps:n.rtps.filter(function(o){return o.type==="inbound-rtp";})},outbound:{topology:"DIRECT",transport:n.transport,rtps:n.rtps.filter(function(o){return o.type==="outbound-rtp";})}};l._triggerEvent(c.events.REMOTE_DATA_STATS,l._participantId,m);l._triggerEvent(c.events.LOCAL_DATA_STATS,{outbound:m.outbound});});},3000);},_stopStatInterval:function(){if(this._statInterval){clearInterval(this._statInterval);this._statInterval=null;}}});return c;});define("OK/VideoChatSound",[],function(){var a="data:audio/mpeg;base64,/+MYxAAAAANIAUAAAASEEB/jwOFM/0MM/90b/+RhST//w4NFwOjf///PZu////9lns5GFDv//l9GlUIEEIAAAgIg8Ir/JGq3/+MYxDsLIj5QMYcoAP0dv9HIjUcH//yYSg+CIbkGP//8w0bLVjUP///3Z0x5QCAv/yLjwtGKTEFNRTMuOTeqqqqqqqqqqqqq/+MYxEkNmdJkUYc4AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq",d=OK.cnst.staticUrl+"res/default/sound/videochat/ring.mp3",c=OK.cnst.staticUrl+"res/default/sound/videochat/olga.mp3",o=OK.cnst.staticUrl+"res/default/sound/videochat/busy.mp3",q=OK.cnst.staticUrl+"res/default/sound/videochat/connecting.mp3",j=OK.cnst.staticUrl+"res/default/sound/videochat/beep.mp3",g=OK.cnst.staticUrl+"res/default/sound/videochat/drop.mp3";var m=null,h=true,f=null;b();function b(){try{m=new Audio();m.preload="auto";m.autoplay=false;m.loop=false;m.src=a;var s=m.play();if(!s){h=false;return;}s["catch"](function(v){if(v.name==="NotAllowedError"){window.addEventListener("click",function u(){h=true;window.removeEventListener("click",u);});h=false;}});}catch(t){h=false;}}function l(s,t,v){n();if(!h){return;}if(!Array.isArray(s)){s=[s];}v=v||0;var u=0,w=s.length;function x(){m.onended=function(){u=(u+1)%w;if(!t&&!u){n();}else{f=setTimeout(function(){f=null;m.src=s[u];m.play();},v);}};m.oncanplay=null;m.src=s[u];m.play();}if(!m.src||m.readyState>m.HAVE_FUTURE_DATA){x();}else{m.oncanplay=x;}}function k(s){l(s||[d,c],true);}function p(){l(o);}function e(){l(q,true,2000);}function r(s){l(s||j,true);}function i(){l(g);}function n(){if(m&&m.src){m.onended=null;m.oncanplay=null;m.pause();m.removeAttribute("src");}if(f){clearTimeout(f);f=null;}}return{incoming:k,busy:p,connecting:e,calling:r,drop:i,stop:n};});define("OK/videochat/UIRemoteVideo",["OK/videochat/Enums","OK/videochat/Logger","OK/videochat/Tracer","OK/utils/throttle","PTS/video.vchat"],function(h,d,b,e,g){var c=b.get("OK/videochat/UIRemoteVideo");function a(l,j,i,k,m){this._participantId=l;this._$parentElement=i;this._params=k;this._embed=!!m;this.$container=typeof j==="string"?f(j):j;this.$video=this.$container.querySelector(".video-chat_video");if(!this._embed){this.$stub=this.$container.querySelector(".video-chat_stub");this.$debugView=this.$container.querySelector(".video-chat_debug");this.$image=this.$container.querySelector(".video-chat_image");this.$statusText=this.$stub.querySelector(".video-chat_status");this.$statusTextSmall=this.$container.querySelector(".video-chat_status-small");this.videoWidth=0;this.videoHeight=0;this._setDimensions();}this._enabled=false;this._playing=false;if(typeof j==="string"){this._$parentElement.appendChild(this.$container);}this._bindedOnStarted=this._onStarted.bind(this);this.$video.addEventListener("loadeddata",this._bindedOnStarted);}a.prototype._setDimensions=function(){if(!this._embed&&(this.videoWidth!==this.$video.videoWidth||this.videoHeight!==this.$video.videoHeight)){this.videoWidth=this.$video.videoWidth;this.videoHeight=this.$video.videoHeight;this.$container.classList.toggle(h.uiState.LANDSCAPE,this.videoWidth>this.videoHeight);this.$container.classList.toggle(h.uiState.PORTRAIT,this.videoWidth<=this.videoHeight);}};a.prototype._setStatusText=function(i){if(!this._embed){this.$statusText.innerHTML=i;this.$statusTextSmall.innerHTML=i;}};a.prototype.setSrc=function(i){this._playing=false;this.$video.srcObject=i;if(i){this.$video.addEventListener("timeupdate",e(250,this._setDimensions.bind(this)));}};a.prototype.hasSrc=function(){return this.$video&&this.$video.srcObject&&true;};a.prototype.setVideoEnabled=function(i){this._enabled=i;this.$container.classList.toggle(h.uiState.REMOTE,this._enabled&&this._playing);};a.prototype.setSoundEnabled=function(i){this.$container.classList.toggle(h.uiState.SILENT,!i);};a.prototype.isVideoEnabled=function(){return this._enabled;};a.prototype.isSoundEnabled=function(){return !this.$container.classList.contains(h.uiState.SILENT);};a.prototype.setScreenSharingEnabled=function(i){this.$container.classList.toggle(h.uiState.SCREEN,i);};a.prototype.isScreenSharingEnabled=function(){return this.$container.classList.contains(h.uiState.SCREEN)&&this.$container.classList.contains(h.uiState.REMOTE);};a.prototype.setStatusConnecting=function(){this._setStatusText(g["msg-connecting"]);this.$container.classList.add(h.uiState.CONNECTING);};a.prototype.setStatusWaiting=function(){this._setStatusText(g["msg-calling"]);this.$container.classList.add(h.uiState.CONNECTING);};a.prototype.setStatusConnected=function(){this.$video.srcObject=this.$video.srcObject;this._setStatusText(g["msg-call"]);this.$container.classList.remove(h.uiState.CONNECTING);this.$container.classList.remove(h.uiState.ERROR);};a.prototype.setStatusReconnect=function(){this._setStatusText(g["msg-reconnect"]);this.$container.classList.add(h.uiState.CONNECTING);};a.prototype.setStatusError=function(i){this._setStatusText(g["msg-error-"+i]||g["msg-error-unknown"]);this.$container.classList.remove(h.uiState.ACTIVE);this.$container.classList.remove(h.uiState.CONNECTING);this.$container.classList.remove(h.uiState.REMOTE);this.$container.classList.add(h.uiState.ERROR);};a.prototype.setStatusPermissions=function(){this._setStatusText(g["msg-wait-permissions"]);};a.prototype.setActive=function(i,j){this.$container.classList.toggle(h.uiState.ACTIVE,!!i);this.$container.classList.toggle(h.uiState.LOCKED,!!j);};a.prototype.setOrder=function(i){if(this.$container.classList.contains(h.uiState.ERROR)){i+=400;}else{if(this.$container.classList.contains(h.uiState.CONNECTING)){i+=200;}}this.$container.style.order=i;};a.prototype.getId=function(){return this._participantId;};a.prototype.displayStats=function(i){function j(l){var k=["ssrc="+l.ssrc];if(l.mimeType){k.push(l.mimeType);}if(l.frameHeight&&l.frameWidth){k.push(l.frameHeight+"x"+l.frameWidth);}if(l.packetLoss){k.push("loss="+l.packetLoss+"%");}if(l.framesDroppedDelta){k.push("dropped="+l.framesDroppedDelta+"%");}if(l.volume){k.push("volume="+l.volume.toFixed(2));}return k.join(" ");}if(!this._embed){this.$debugView.innerHTML=this._participantId+"\n"+i.inbound.rtps.map(j).join("\n");}};a.prototype.getRenderStats=function(){if(!this.$video){return null;}if(this.$video.webkitDecodedFrameCount){return{decoded:this.$video.webkitDecodedFrameCount,dropped:this.$video.webkitDroppedFrameCount};}if(this.$video.getVideoPlaybackQuality){var i=this.$video.getVideoPlaybackQuality();return{decoded:Math.max(0,(i.totalVideoFrames-i.droppedVideoFrames)),dropped:i.droppedVideoFrames};}return null;};a.prototype.destroy=function(){this.$video.srcObject=null;this.$video.removeEventListener("loadeddata",this._bindedOnStarted);this._$parentElement.removeChild(this.$container);};a.prototype._onStarted=function(){c.debug("Video is playing ["+this._participantId+"]")();this._playing=true;this.setVideoEnabled(this._enabled);};function f(j){var i=document.createElement("div");i.innerHTML=j;return i.firstChild;}return a;});define("OK/videochat/UIStreaming",["OK/videochat/Enums","OK/videochat/Logger","OK/videochat/EventEmitter","OK/videochat/Utils","OK/utils/vanilla"],function(h,c,e,a,d){var f=500;var b=5000;function g(i,j){this._handlers={};this._movieId=null;this._authorId=null;this._updatePosterTimer=null;this._poster=null;this._isRecord=i.hasAttribute("data-record");this.parent=j;this.container=i;this.btnClose=this.container.querySelector(".video-chat_streaming-close");this.inputName=this.container.querySelector("#streaming_name");this.inputProfile=this.container.querySelector("#streaming_profile");this.inputVisibility=this.container.querySelector("#streaming_visibility");this.inputMovie=this.container.querySelector("#streaming_movie");this.preview=this.container.querySelector(".video-chat_streaming-preview");this.btnStartStreaming=this.container.querySelector(".__start-stream");this.btnStopStreaming=this.container.querySelector(".__stop-stream");this._initHandlers();c.log(h.stat.UI_ACTION,"record_activate");}g.events={START_STREAM:"START_STREAM",STOP_STREAM:"STOP_STREAM",RECORD_INFO:"RECORD_INFO"};g.open=function(l,i,k,j){d.ajax({url:"/dk",data:{cmd:"VideoChatRecordBlock","st.call.rec":l?"on":"off","st.call.gid":j||"","st.call.mid":i||"","st.call.aid":k?a.decomposeId(k).id:""}}).then(d.updateBlockModelCallback);};g.prototype=new e();g.prototype._initHandlers=function(){this._handlers.close=this._clickClose.bind(this);this._handlers.startStream=this._clickStartStream.bind(this);this._handlers.stopStream=this._clickStopStream.bind(this);this._handlers.select=this._clickSelect.bind(this);this.btnClose.addEventListener("click",this._handlers.close);this.btnStartStreaming&&this.btnStartStreaming.addEventListener("click",this._handlers.startStream);this.btnStopStreaming&&this.btnStopStreaming.addEventListener("click",this._handlers.stopStream);this.inputProfile&&this.inputProfile.addEventListener("change",this._handlers.select);this.inputMovie&&this.inputMovie.addEventListener("change",this._handlers.select);};g.prototype._removeHandlers=function(){this.btnClose.removeEventListener("click",this._handlers.close);this.btnStartStreaming&&this.btnStartStreaming.removeEventListener("click",this._handlers.startStream);this.btnStopStreaming&&this.btnStopStreaming.removeEventListener("click",this._handlers.stopStream);this.inputProfile&&this.inputProfile.removeEventListener("change",this._handlers.select);this.inputMovie&&this.inputMovie.removeEventListener("change",this._handlers.select);this._handlers={};};g.prototype._clickClose=function(){this.close();};g.prototype._clickStartStream=function(){c.log(h.stat.UI_ACTION,"record_start_"+(this._isRecord?"record":"stream"));var i={movieId:this.inputMovie?this.inputMovie.value:null,name:this.inputName?this.inputName.value:null,privacy:this.inputVisibility?this.inputVisibility.value:null,groupId:this.inputProfile.value,streamMovie:!this._isRecord};this._triggerEvent(g.events.START_STREAM,i);this.container.classList.add(h.uiState.DISABLED);};g.prototype._clickStopStream=function(){c.log(h.stat.UI_ACTION,"record_stop_"+(this._isRecord?"record":"stream"));this._triggerEvent(g.events.STOP_STREAM);this.container.classList.remove(h.uiState.DISABLED);};g.prototype._clickSelect=function(){g.open(this._isRecord,this.inputMovie.value,this._authorId,this.inputProfile.value);};g.prototype._loadImg=function(i){return new Promise(function(l,k){var j=new Image(),m;j.onload=function(){clearTimeout(m);l(j);};j.onerror=function(){clearTimeout(m);k(j);};m=setTimeout(function(){if(!j.complete){delete j.onload;delete j.onerror;j.src="";k(j);}},1000);j.src=i;});};g.prototype._setPoster=function(){if(!this._movieId||!this._poster){return;}var j=this._poster+"&_ts="+Date.now(),i=this;this._loadImg(j).then(function(){i.preview.innerHTML="";i.preview.style.backgroundImage="url("+j+")";})["catch"](function(){i._poster=null;});};g.prototype._updatePoster=function(){if(!this._movieId){return;}if(this._poster){this._setPoster();}else{this._triggerEvent(g.events.RECORD_INFO,this._movieId);}};g.prototype._updatePosterTimerStart=function(){var i=this,j=f;clearTimeout(this._updatePosterTimer);if(!this._movieId){return;}(function k(){i._updatePoster();i._updatePosterTimer=setTimeout(function(){j=(j*2>=b)?b:j*2;k();},j);})();};g.prototype._updatePosterTimerStop=function(){clearTimeout(this._updatePosterTimer);this._updatePosterTimer=null;};g.prototype.close=function(){OK.hookModel.setHookContent("VideoChatRecordBlock","");};g.prototype.setMovieId=function(i,j){this._movieId=i;this._authorId=j;this._updatePosterTimerStart();this.container.classList.toggle(h.uiState.DISABLED,!!i);};g.prototype.setPreview=function(j,i){if(i===this._movieId){this._poster=j;this._setPoster();}};g.prototype.deactivate=function(){this._updatePosterTimerStop();this._removeHandlers();c.log(h.stat.UI_ACTION,"record_deactivate");};return g;});define("OK/AbstractShortcutMenu",["OK/utils/dom","OK/utils/vanilla","OK/utils/delegate"],function(h,f,e){var d=54;var c="ShortcutMenu";var b=null;var g=document.createElement("div");g.id="hook_Block_"+c;document.body.appendChild(g);OK.hookModel.captureBlockHook("body",g);g.addEventListener("change",function(){if(b&&b.visible()){b.positingElement();}});function a(){this.holder=null;this.menuElement=null;this.showTimeout=null;this.hideTimeout=null;this.ajaxRequest=null;this.direction="";this.position="center";this._visible=false;this.inplace=false;this.detectScrollableContainer=false;this.menuElementHoverInListenerCalled=false;}a.getActiveInstance=function(){return b;};a.setActiveInstance=function(i){b=i;};a.getBlockId=function(){return c;};a.prototype.getBlock=function(){if(this.inplace){return this.block;}return g;};a.prototype.getHtml=function(){};a.prototype.initListeners=function(i){this.shortcutMenuDelegate=new e(i);this.shortcutMenuDelegate.on("click",".sc-menu a",this.menuElementLinkClickListener.bind(this));this.shortcutMenuDelegate.on("click",".sc-menu .js-hide",this.menuElementClickListener.bind(this));this.shortcutMenuDelegate.on("click",".js-forceHide",this.hideMenu.bind(this));this.shortcutMenuDelegate.on("mouseenter",this.menuElementHoverInListener.bind(this));this.shortcutMenuDelegate.on("mouseleave",this.hoverOutListener.bind(this));if(OK.device.isTouch){this.shortcutMenuDelegate.on("touchstart",this.holderTouchStartListener.bind(this));}};a.prototype.processHTML=function(k){var j=[];if(this.inplace){this.initBlock();j[0]=this.blockId;}else{j[0]=a.getBlockId();}var i=this.getBlock();f.updateBlocks(k,j);this.initListeners(i);this.menuElement=h.firstByClass(i,"sc-menu");this.positingElement();this.menuElement.classList.remove("sc-menu__hidden");this.holder.classList.add("__vis");a.setActiveInstance(this);this._visible=true;};a.prototype.showMenu=function(){clearTimeout(this.hideTimeout);this.showTimeout=null;if(this.visible()){return;}if(b){b.hide();}this.processHTML(this.getHtml());};a.prototype.hideMenu=function(){this.clearShowTimeout();this.clearHideTimeout();if(this.menuElement){this.menuElement.classList.add("sc-menu__hidden");OK.hookModel.setHookContent(c,"");this.menuElement=null;}this.holder.classList.remove("__vis");if(this.shortcutMenuDelegate){this.shortcutMenuDelegate.off();}this._visible=false;a.setActiveInstance(null);};a.prototype.hide=function(){this.clearShowTimeout();this.clearHideTimeout();if(this.menuElement){this.hideMenu();}};a.prototype.getClosestScrollable=function(k){if(!this.closestScrollable){var i=/(auto|scroll)/;var j=h.traverseParents(this.element,function(l){var m=window.getComputedStyle(l);var n=i.test(m.overflow+m.overflowY+m.overflowX);return n&&(!k||(l.scrollHeight>l.clientHeight));});this.closestScrollable=j||window;}return this.closestScrollable;};a.prototype.isTopDirection=function(m,j){var l=this.holder.getBoundingClientRect().top;if(this.detectScrollableContainer){var k=this.holder.getBoundingClientRect().height;var n=this.getClosestScrollable();var q=l-n.getBoundingClientRect().top;var i=n.clientHeight-k;var p=n.scrollTop+q+k+j;var o=n.scrollHeight;return i/2<q||(p>o);}else{return window.innerHeight-m-l<j;}};a.prototype.isInsideViewportWhileCentered=function(o){var j=this.holder.getBoundingClientRect();var k=j.left;var l=window.innerWidth-OK.scrollBar.width;if(this.detectScrollableContainer){var i=this.getClosestScrollable().getBoundingClientRect();k=k-i.left;l=i.right;}var n=k+(j.width-o)/2;var m=n+o;return n>0&&m<l;};a.prototype.toRightFromHolder=function(j,l){if(this.detectScrollableContainer){var i=this.getClosestScrollable().getBoundingClientRect();var k=this.holder.getBoundingClientRect().left-i.left;return i.width/2>k;}else{return(window.innerWidth-OK.scrollBar.width)>(j.left+l);}};a.prototype.visible=function(){return this._visible;};a.prototype.getOffset=function(i){var j=i.getBoundingClientRect();return{left:j.left+window.pageXOffset,top:j.top+window.pageYOffset};};a.prototype.positingElement=function(){var i=h.outerSize(this.holder,false,true);var v=this.inplace?{top:0,left:0}:this.getOffset(this.holder);var p=h.outerSize(this.holder,true,true);var k=h.outerSize(this.menuElement,true,true);var y=this.position;if(y==="center"&&!this.isInsideViewportWhileCentered(k)){y="auto";}if(y!=="center"&&y!=="auto"){this.menuElement.classList.add("__noarrow");}var A;var j=h.outerSize(this.menuElement,false,true);if(this.direction==="top_force"||this.direction==="bottom_force"){A=this.direction==="top_force";}else{if(this.direction==="top"){A=this.getOffset(this.holder).top-window.pageYOffset-90>j;}else{if(this.direction==="bottom"){A=false;}else{A=this.isTopDirection(i,j);}}}var r=v.top;var l=[];if(A){this.menuElement.classList.add("sc-menu__top");var m;if(this.inplace){m=r+i;l.push("top: auto; bottom: "+Math.round(m)+"px;");}else{r-=j;l.push("bottom: auto; top: "+Math.round(r)+"px;");}}else{this.menuElement.classList.remove("sc-menu__top");if(!this.inplace){r+=i;}l.push("bottom: auto; top: "+Math.round(r)+"px;");}var w=Math.round(v.left-(k-p));var z=Math.round(v.left);var t=Math.round(v.left+((p-k)/2));switch(y){case"left":l.push("left: "+w+"px;");break;case"right":l.push("left: "+z+"px;");break;case"auto":var x=h.firstByClass(this.menuElement,"entity-shortcut-menu_arw"),u=0,s=x?d:0,q=this.toRightFromHolder(v,k);if(q){this.menuElement.classList.remove("__right");this.menuElement.classList.add("__left");}else{this.menuElement.classList.add("__right");this.menuElement.classList.remove("__left");}if(!s){x=h.firstByClass(this.menuElement,"sc-menu_arw");if(x){var o=x.getBoundingClientRect();if(o.width){var n=this.menuElement.getBoundingClientRect();if(q){s=(o.left-n.left)*2+o.width;}else{s=((n.left+n.width)-(o.left+o.width))*2+o.width;}}}}if(p<s){u=(s-p)/2;}if(q){l.push("left: "+(z-u)+"px;");}else{l.push("left: "+(w+u)+"px;");}break;default:l.push("left: "+t+"px;");break;}this.menuElement.setAttribute("style",l.join(""));};a.prototype.ajaxClose=function(i){if(this.ajaxRequest){this.ajaxRequest.xhr.abort();this.ajaxRequest=null;if(typeof i==="function"){i();}}};a.prototype.hoverInListener=function(i){if(OK.device.isTouch&&i){return;}this.clearHideTimeout();if(!this.showTimeout&&!this.visible()){this.showTimeout=setTimeout(this.showMenu.bind(this),this.showDelay);}};a.prototype.hoverOutListener=function(){this.clearShowTimeout();this.ajaxClose();if(!this.hideTimeout&&this.visible()){this.hideTimeout=setTimeout(function(){if(this.hideOnBlurElement!==document.activeElement){this.hideMenu();}else{this.hideTimeout=null;}}.bind(this),this.hideDelay);}};a.prototype.menuElementHoverInListener=function(){this.menuElementHoverInListenerCalled=true;if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}};a.prototype.menuElementLinkClickListener=function(i){if(!h.parent(i.target,"js-doNotHide",this.block)){this.menuElementClickListener();}};a.prototype.menuElementClickListener=function(){if(true===this.hideTimeout){this.hideTimeout=null;}this.hoverOutListener();};a.prototype.holderTouchStartListener=function(i){i.stopPropagation();};a.prototype.clearShowTimeout=function(){if(this.showTimeout){this.showTimeout=clearTimeout(this.showTimeout);}};a.prototype.clearHideTimeout=function(){if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}};return a;});define("OK/videochat/UI",["OK/WebRTCUtils!","OK/utils/vanilla","OK/utils/throttle","OK/cookie","OK/videochat/EventEmitter","OK/videochat/Enums","OK/VideoChatSound","OK/videochat/Utils","OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/UIRemoteVideo","OK/videochat/UIStreaming","OK/videochat/Capturer","PTS/video.vchat","OK/FaviconManager","OK/messages/WindowTitleChanger","OK/AbstractShortcutMenu"],function(g,v,l,B,n,b,r,A,G,w,y,h,C,F,i,e,j){var x=w.get("OK/videochat/UI");var s=["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"];var m="videochat";var E=1;var k=250;var u=4;var t=12;var z=6;var f=(function(){var H=B.readCookie("dme");return(H&&("true"===H.toLowerCase()))||document.getElementById("__gwtd__m");})();var q=null;var d=null;var D=null,a=null,p=null;function c(H){v.ajax({type:"POST",url:H}).then(v.updateBlockModelCallback);}function o(H,J){this._handlers={};this._params=J;this.container=H;this.embed=H.classList.contains("call-widget");this.remoteContainer=this.container.querySelector(".video-chat_views");this.localContainer=this.container.querySelector(".video-chat_view-local");this.localVideo=this.localContainer.querySelector(".video-chat_video");this.remoteVideo={};this._frameDropStats={};this.uiStreaming=null;this._recordInfo=null;this._sliderOffsetPosition=0;this._myId=A.composeId(this.container.getAttribute("data-participant-id"),this.container.getAttribute("data-participant-type"));this._callTimer=null;this._callStartTime=0;this._handleTimer=null;this._callHandleTime=0;this.lblTime=this.container.querySelector(this.embed?".call-widget_time":".video-chat_ac_time");this._permissionsTimeout=null;this._statisticsInterval=null;if(!this.embed){this.callContainer=this.container.querySelector(".video-chat_cnt");this.overlay=this.container.querySelector(".video-chat_ovr");this._needRate=false;this._hideControlsTimeout=null;this._speakerId=null;this._speakerLocked=false;this._forceSausage=false;this._isCallActive=false;this._participantsAddLimit=Number.POSITIVE_INFINITY;this._participantsAddEnabled=false;this._participantsAddOld=false;this.srnIncoming=this.container.querySelector(".video-chat_incoming");this.lblStatus=this.container.querySelector(".video-chat_status-global");this.lblStatusSmall=this.container.querySelector(".video-chat_status-global-small");this.btnHangup=this.container.querySelector(".__hangup");this.btnCamOff=this.container.querySelector(".__camera-off");this.btnCamOn=this.container.querySelector(".__camera-on");this.btnMicOff=this.container.querySelector(".__mic-off");this.btnMicOn=this.container.querySelector(".__mic-on");this.btnMessage=this.container.querySelector(".__send-message");this.btnMessageTip=this.btnMessage&&this.btnMessage.querySelector(".video-chat_btn_tip");this.btnAddParticipantWrap=this.container.querySelector(".__add-participant-wrap");if(this.btnAddParticipantWrap){this.btnAddParticipant=this.btnAddParticipantWrap.querySelector(".__add-participant");this.listParticipants=this.btnAddParticipantWrap.querySelector(".video-chat_participants-list > .sc-menu_w");}this.btnAcceptVideo=this.container.querySelector(".__accept-video");this.btnAcceptAudio=this.container.querySelector(".__accept-audio");this.btnDecline=this.container.querySelector(".__decline");this.btnMessageLast=this.container.querySelector(".__send-message-last");this.btnRecall=this.container.querySelector(".__recall");this.btnJoin=this.container.querySelector(".__join");this.btnMini=this.container.querySelector(".__minimize");this.btnMaxi=this.container.querySelector(".__maximize");this.viewGrid=this.container.querySelector(".__view-grid");this.viewSausage=this.container.querySelector(".__view-sausage");this.btnClose=this.container.querySelector(".__close");this.btnFullscreenOn=this.container.querySelector(".__fullscreen");this.btnFullscreenOff=this.container.querySelector(".__fullscreen-off");this.btnSettings=this.container.querySelector(".__settings");this.btnSupport=this.container.querySelector(".__support");this.selectCam=this.btnSettings.querySelector(".video-chat_ac_select-cam");this.selectMic=this.btnSettings.querySelector(".video-chat_ac_select-mic");this.btnShareScreenOn=this.container.querySelector(".__capture-on");this.btnShareScreenOff=this.container.querySelector(".__capture-off");this.btnStreaming=this.container.querySelector(".__ac-stream");this.btnRecord=this.container.querySelector(".__ac-record");this.btnHideSausage=this.container.querySelector(".video-chat_hide-sausage");this.rateStars=this.container.querySelectorAll(".video-chat_rate-star_inp");this.btnVoteSend=this.container.querySelector(".js-vote-send");this.btnCloseHint=this.container.querySelector(".video-chat_hint-close");this.loaderRemote=this.container.querySelector(".video-chat_views-loader");this.arrLeft=this.container.querySelector(".video-chat_arrow.__prev");this.arrRight=this.container.querySelector(".video-chat_arrow.__next");this.debugView=this.localContainer.querySelector(".video-chat_debug");}this.addParticipantsByElements(this.container.querySelectorAll(".video-chat_view-remote"));if(!this.embed){this._setSpeakerNext();this._initDeviceSwitcher();this._initHandlers();this._registerLayer();var I=require.defined("OK/music/player")&&require("OK/music/player");if(I&&window.odklMusic&&window.odklMusic.playingTrack()){I.pause();}}G.log(b.stat.UI_ACTION,"activate");}o.open=function(N,J,I,H,M,K){var L={cmd:"VideoChatCall","st.call.ft":M?b.callType.CALL_VIDEO:b.callType.CALL_AUDIO,"st.call.dir":K?b.callDirection.INCOMING:b.callDirection.OUTGOING};if(N){L["st.call.conversationId"]=N;}if(J){L["st.call.chatId"]=J;}if(I){L["st.call.opponentId"]=I;}if(H){L["st.call.participantIds"]=H;}return v.ajax({url:"/dk",data:L}).then(function(O){if(!O.response){return Promise.reject(b.error.UI);}return v.updateBlockModelCallback(O);});};o.set=function(H){d=H;};o.get=function(){return d;};o.close=function(){if(!d.embed){OK.hookModel.setHookContent("VideoChatCall","");d=null;}return Promise.resolve();};o.events={CHANGE_DEVICE:"CHANGE_DEVICE",TOGGLE_VIDEO:"TOGGLE_VIDEO",TOGGLE_AUDIO:"TOGGLE_AUDIO",ACCEPT:"ACCEPT",DECLINE:"DECLINE",HANGUP:"HANGUP",ADD_PARTICIPANT:"ADD_PARTICIPANT",REMOVE_PARTICIPANT:"REMOTE_PARTICIPANT",CHANGE_PRIORITIES:"CHANGE_PRIORITIES",PERFORMANCE_STATISTICS:"PERFORMANCE_STATISTICS",START_STREAM:"START_STREAM",STOP_STREAM:"STOP_STREAM",RECORD_INFO:"RECORD_INFO"};o.prototype=new n();o.prototype.destroy=function(){G.log(b.stat.UI_ACTION,"deactivate");r.stop();this._stopHandleTimer();this._stopCallTimer();if(!this.embed){this._clearTitleAndFavicon();this._removeHandlers();this._unregisterLayer();}this.localVideo=null;this.remoteVideo={};if(this.embed){return;}var L=document.styleSheets[0],I=L.cssRules,J=I.length,H=0;while((H<J)&&(D||a||p)){var K=I[H];if(K===D||K===a||K===p){L.deleteRule(H);if(K===D){D=null;}else{if(K===a){a=null;}else{if(K===p){p=null;}}}J--;}else{H++;}}};o.prototype._registerLayer=function(){OK.Layers.register(m,this._hideLayer.bind(this));OK.Layers.onLayerShown();};o.prototype._unregisterLayer=function(){OK.Layers.remove(m);OK.Layers.onLayerHidden();};o.prototype._hideLayer=function(){if(this._isInState(b.uiState.LAST)){o.close();}else{this._toggleLayerSize(true);}};o.prototype._toggleLayerSize=function(H){G.log(b.stat.UI_ACTION,H?"minimize":"maximize");if(H){this.uiStreaming&&this.uiStreaming.close();this._unregisterLayer();}else{this._registerLayer();}this._toggleState(b.uiState.MINI,H);};o.prototype._initDeviceSwitcher=function(){var H=this;this._toggleState(b.uiState.NOCAM,!g.hasCamera());if((!g.hasMicrophone()&&!g.hasCamera())||!g.canReplaceTrack()){return;}var K=g.getSavedCamera(),I=g.getSavedMicrophone(),J;g.getCameras().forEach(function(L){J=document.createElement("option");J.value=L.deviceId;if(K&&L.deviceId===K.deviceId){J.selected="selected";}J.innerHTML=L.label||F.camera+" #"+(H.selectCam.length+1);H.selectCam.appendChild(J);});g.getMicrophones().forEach(function(L){J=document.createElement("option");J.value=L.deviceId;if(I&&L.deviceId===I.deviceId){J.selected="selected";}J.innerHTML=L.label||F.microphone+" #"+(H.selectMic.length+1);H.selectMic.appendChild(J);});if(!this.selectCam.length){J=document.createElement("option");J.value="";J.innerHTML=F["camera-notfound"];J.selected="selected";this.selectCam.appendChild(J);}if(!this.selectMic.length){J=document.createElement("option");J.value="";J.innerHTML=F["microphone-notfound"];J.selected="selected";this.selectMic.appendChild(J);}this.btnSettings.classList.remove(b.uiState.INVISIBLE);};o.prototype._initHandlers=function(){this._handlers.hangup=this.clickHangup.bind(this);this._handlers.camOff=this._clickCam.bind(this,false);this._handlers.camOn=this._clickCam.bind(this,true);this._handlers.micOff=this._clickMic.bind(this,false);this._handlers.micOn=this._clickMic.bind(this,true);this._handlers.addParticipantsList=this._clickAddList.bind(this);this._handlers.addParticipant=this._clickAdd.bind(this);this._handlers.sendMessage=this._clickMessage.bind(this);this.btnHangup.addEventListener("click",this._handlers.hangup);this.btnCamOff.addEventListener("click",this._handlers.camOff);this.btnCamOn.addEventListener("click",this._handlers.camOn);this.btnMicOff.addEventListener("click",this._handlers.micOff);this.btnMicOn.addEventListener("click",this._handlers.micOn);this.btnMessage&&this.btnMessage.addEventListener("click",this._handlers.sendMessage);if(this.btnAddParticipantWrap){this.btnAddParticipant.addEventListener("mousedown",this._handlers.addParticipantsList);this.listParticipants.addEventListener("mousedown",this._handlers.addParticipant);}this._handlers.acceptVideo=this._clickAcceptVideo.bind(this);this._handlers.acceptAudio=this._clickAcceptAudio.bind(this);this._handlers.decline=this._clickDecline.bind(this);this.btnAcceptVideo.addEventListener("click",this._handlers.acceptVideo);this.btnAcceptAudio.addEventListener("click",this._handlers.acceptAudio);this.btnDecline.addEventListener("click",this._handlers.decline);this._handlers.recall=this._clickRecall.bind(this);this._handlers.join=this._clickJoin.bind(this);this.btnMessageLast&&this.btnMessageLast.addEventListener("click",this._handlers.sendMessage);this.btnRecall&&this.btnRecall.addEventListener("click",this._handlers.recall);this.btnJoin.addEventListener("click",this._handlers.join);this._handlers.minimize=this._clickToggleSize.bind(this,true);this._handlers.maximize=this._clickToggleSize.bind(this,false);this._handlers.viewGrid=this._toggleSausage.bind(this,false);this._handlers.viewSausage=this._toggleSausage.bind(this,true);this._handlers.close=this._clickClose.bind(this,false);this._handlers.support=this._clickSupport.bind(this);this._handlers.fullscreenOn=this._clickFullscreen.bind(this,true);this._handlers.fullscreenOff=this._clickFullscreen.bind(this,false);this._handlers.clickSettings=this._clickSettings.bind(this);this._handlers.selectCam=this._clickSwitchDevice.bind(this,"videoinput");this._handlers.selectMic=this._clickSwitchDevice.bind(this,"audioinput");this._handlers.shareScreenOn=this._clickCapturing.bind(this,true);this._handlers.shareScreenOff=this._clickCapturing.bind(this,false);this._handlers.streamingOpen=this._clickStreaming.bind(this,false);this._handlers.recordOpen=this._clickStreaming.bind(this,true);this.btnMini.addEventListener("click",this._handlers.minimize);this.btnMaxi.addEventListener("click",this._handlers.maximize);this.viewSausage.addEventListener("click",this._handlers.viewSausage);this.viewGrid.addEventListener("click",this._handlers.viewGrid);this.btnClose.addEventListener("click",this._handlers.close);this.btnSupport.addEventListener("click",this._handlers.support);this.btnFullscreenOn.addEventListener("click",this._handlers.fullscreenOn);this.btnFullscreenOff.addEventListener("click",this._handlers.fullscreenOff);this.btnSettings.addEventListener("click",this._handlers.clickSettings);this.selectCam.addEventListener("change",this._handlers.selectCam);this.selectMic.addEventListener("change",this._handlers.selectMic);this.btnShareScreenOn.addEventListener("click",this._handlers.shareScreenOn);this.btnShareScreenOff.addEventListener("click",this._handlers.shareScreenOff);this.btnStreaming&&this.btnStreaming.addEventListener("click",this._handlers.streamingOpen);this.btnRecord&&this.btnRecord.addEventListener("click",this._handlers.recordOpen);this._handlers.hideSausage=this._clickHideSausage.bind(this);this.btnHideSausage.addEventListener("click",this._handlers.hideSausage);this._handlers.rateStar=this._clickRateStar.bind(this);this._handlers.sendVote=this._clickVoteSend.bind(this);Array.prototype.forEach.call(this.rateStars,function(J){J.addEventListener("change",this._handlers.rateStar);}.bind(this));this.btnVoteSend.addEventListener("click",this._handlers.sendVote);if(this.btnCloseHint){this._handlers.closeHint=this._clickCloseHint.bind(this);this.btnCloseHint.addEventListener("click",this._handlers.closeHint);}this._handlers.clickSliderArrowLeft=this._clickSliderArrow.bind(this,true);this._handlers.clickSliderArrowRight=this._clickSliderArrow.bind(this,false);this.arrLeft.addEventListener("click",this._handlers.clickSliderArrowLeft);this.arrRight.addEventListener("click",this._handlers.clickSliderArrowRight);this._handlers.overlay=this._clickOverlay.bind(this,true);this._handlers.containerClick=this._clickContainer.bind(this);this._handlers.containerMouseEnter=this._showControls.bind(this);this._handlers.containerMouseLeave=this._hideControls.bind(this);this._handlers.containerMouseMove=this._showControls.bind(this);this.overlay.addEventListener("click",this._handlers.overlay);this.remoteContainer.addEventListener("click",this._handlers.containerClick);this.callContainer.addEventListener("mouseenter",this._handlers.containerMouseEnter);this.callContainer.addEventListener("mouseleave",this._handlers.containerMouseLeave);this.callContainer.addEventListener("mousemove",this._handlers.containerMouseMove);this._handlers.fullscreenChange=this._onFullscreenChange.bind(this);this._handlers.beforeUnload=this._onBeforeUnload.bind(this);this._handlers.resize=l(250,this._onResize.bind(this));for(var I=0,H=s.length;I<H;I++){document.addEventListener(s[I],this._handlers.fullscreenChange);}window.addEventListener("beforeunload",this._handlers.beforeUnload);window.addEventListener("resize",this._handlers.resize);};o.prototype._removeHandlers=function(){this.btnHangup.removeEventListener("click",this._handlers.hangup);this.btnCamOff.removeEventListener("click",this._handlers.camOff);this.btnCamOn.removeEventListener("click",this._handlers.camOn);this.btnMicOff.removeEventListener("click",this._handlers.micOff);this.btnMicOn.removeEventListener("click",this._handlers.micOn);this.btnMessage&&this.btnMessage.removeEventListener("click",this._handlers.sendMessage);if(this.btnAddParticipantWrap){this.btnAddParticipant.removeEventListener("mousedown",this._handlers.addParticipantsList);this.listParticipants.removeEventListener("mousedown",this._handlers.addParticipant);}this.btnAcceptVideo.removeEventListener("click",this._handlers.acceptVideo);this.btnAcceptAudio.removeEventListener("click",this._handlers.acceptAudio);this.btnDecline.removeEventListener("click",this._handlers.decline);this.btnMessageLast&&this.btnMessageLast.removeEventListener("click",this._handlers.sendMessage);this.btnRecall&&this.btnRecall.removeEventListener("click",this._handlers.recall);this.btnJoin.removeEventListener("click",this._handlers.join);this.btnMini.removeEventListener("click",this._handlers.minimize);this.btnMaxi.removeEventListener("click",this._handlers.maximize);this.btnClose.removeEventListener("click",this._handlers.close);this.btnFullscreenOn.removeEventListener("click",this._handlers.fullscreenOn);this.btnFullscreenOff.removeEventListener("click",this._handlers.fullscreenOff);this.btnSettings.removeEventListener("click",this._handlers.clickSettings);this.selectCam.removeEventListener("change",this._handlers.selectCam);this.selectMic.removeEventListener("change",this._handlers.selectMic);this.btnShareScreenOn.removeEventListener("click",this._handlers.shareScreenOn);this.btnShareScreenOff.removeEventListener("click",this._handlers.shareScreenOff);this.btnStreaming&&this.btnStreaming.removeEventListener("click",this._handlers.streamingOpen);this.btnRecord&&this.btnRecord.removeEventListener("click",this._handlers.recordOpen);this.btnHideSausage.removeEventListener("click",this._handlers.hideSausage);Array.prototype.forEach.call(this.rateStars,function(J){J.removeEventListener("change",this._handlers.rateStar);}.bind(this));this.btnVoteSend.removeEventListener("click",this._handlers.sendVote);if(this.btnCloseHint){this.btnCloseHint.removeEventListener("click",this._handlers.closeHint);}this.arrLeft.removeEventListener("click",this._handlers.clickSliderArrowLeft);this.arrRight.removeEventListener("click",this._handlers.clickSliderArrowRight);this.overlay.removeEventListener("click",this._handlers.overlay);this.remoteContainer.removeEventListener("click",this._handlers.containerClick);this.callContainer.removeEventListener("mouseenter",this._handlers.containerMouseEnter);this.callContainer.removeEventListener("mouseleave",this._handlers.containerMouseLeave);this.callContainer.removeEventListener("mousemove",this._handlers.containerMouseMove);for(var I=0,H=s.length;I<H;I++){document.removeEventListener(s[I],this._handlers.fullscreenChange);}window.removeEventListener("beforeunload",this._handlers.beforeUnload);window.removeEventListener("resize",this._handlers.resize);this._handlers={};};o.prototype._initCapturing=function(){if(g.hasCamera()&&C.isCapturingAvailable(this._params)){this.btnShareScreenOn.classList.remove(b.uiState.INVISIBLE);this.btnShareScreenOff.classList.remove(b.uiState.INVISIBLE);}};o.prototype._setTitleAndFavicon=function(){i.registerFavicon(E);e.setTitle(F.title_incoming_call,"* * * * * * * * * * * *");if(document.hasFocus()&&window.Notification&&window.Notification.permission==="granted"){q=new Notification(F.notification_title,{body:F.notification_body,icon:OK.cnst.staticUrl+"res/i/html5_notif_icon.png",tag:"videochat-call-"+Math.random()});}};o.prototype._clearTitleAndFavicon=function(){i.removeFavicon(E);e.resetTitle();if(q){q.close();q=null;}};o.prototype._showControls=function(){clearTimeout(this._hideControlsTimeout);this.container.classList.add(b.uiState.HOVER);this._hideControlsTimeout=setTimeout(this._hideControls.bind(this),1000);};o.prototype._hideControls=function(){clearTimeout(this._hideControlsTimeout);var I=this.callContainer.querySelector(":hover"),H=j.getActiveInstance();if(H){return;}if(I&&I.classList.contains("__vchoh")){return;}if(this._speakerId&&this.remoteVideo[this._speakerId]&&!this.remoteVideo[this._speakerId].isVideoEnabled()){return;}if(this._myId===this._speakerId&&!this._isInState(b.uiState.LOCAL)){return;}this.container.classList.remove(b.uiState.HOVER);};o.prototype._onBeforeUnload=function(H){H.returnValue=F["msg-beforeunload"];return true;};o.prototype._clickCloseHint=function(){this._toggleState(b.uiState.HINT,false);};o.prototype._clickContainer=function(I){if(this.container.classList.contains(b.uiState.MINI)){this._toggleLayerSize(false);}else{if(I.target.classList.contains("video-chat_view-remote")){var J=A.composeId(I.target.getAttribute("data-participant-id"),I.target.getAttribute("data-participant-type")),K=this._speakerLocked&&J===this._speakerId;this._setSpeaker(J,!K);this._toggleSausage(true);}else{if(I.target.classList.contains("video-chat_view-local")){var H=this._speakerLocked&&this._myId===this._speakerId;this._setSpeakerLocal(!H);this._toggleSausage(true);}}}};o.prototype._clickRateStar=function(I){var H=I.target.value;if(H&&H<=this._params.maxRateForReport){x.report();}if(H&&H<=this._params.maxRateForQuestion){G.log(b.stat.UI_ACTION,"vote");this._toggleState(b.uiState.RATE,false);this._toggleState(b.uiState.VOTE,true);}else{G.log(b.stat.UI_ACTION,"sendrate");this._sendRate(H);o.close();}};o.prototype._clickVoteSend=function(){var I=this.container.querySelectorAll(".video-chat_vote_items input:checked"),J=Array.prototype.find.call(this.rateStars,function(K){return K.checked;}),H=Array.prototype.map.call(I,function(K){return K.value;});G.log(b.stat.UI_ACTION,"sendvote");this._sendRate(J?J.value:0,H.join(","));o.close();};o.prototype._clickSwitchDevice=function(I,K){var H=this,J=K.target.value;if(J){g.saveDeviceId(I,J).then(function(L){if(L){H._triggerEvent(o.events.CHANGE_DEVICE,I);}});}};o.prototype._clickCapturing=function(H){G.log(b.stat.UI_ACTION,H?"screen_1":"screen_0");this._triggerEvent(o.events.CHANGE_DEVICE,H?"screen":"videoinput");};o.prototype._clickStreaming=function(J){var H=this._recordInfo&&this._recordInfo.recordMovieId,I=this._recordInfo&&this._recordInfo.initiator;h.open(J,H,I);};o.prototype._clickMessage=function(){c(this.btnMessage.getAttribute("data-link"));G.log(b.stat.UI_ACTION,"message");this._hideLayer();this.setNewMessages(0);};o.prototype._clickRecall=function(){var H=this.btnRecall.getAttribute("data-link");c(H);G.log(b.stat.UI_ACTION,"recall");};o.prototype._clickJoin=function(){c(this.btnJoin.getAttribute("data-link"));G.log(b.stat.UI_ACTION,"join");};o.prototype._clickOverlay=function(){G.log(b.stat.UI_ACTION,"overlay");this._hideLayer();};o.prototype._clickCam=function(H){G.log(b.stat.UI_ACTION,H?"cam_1":"cam_0");this._triggerEvent(o.events.TOGGLE_VIDEO,H);};o.prototype._clickMic=function(H){G.log(b.stat.UI_ACTION,H?"mic_1":"mic_0");this._triggerEvent(o.events.TOGGLE_AUDIO,H);};o.prototype._clickAddList=function(I){G.log(b.stat.UI_ACTION,"add-participants-list");var H="/dk?cmd=VideoChatAddParticipants";Object.keys(this.remoteVideo).forEach(function(J){H+="&st.call.participantIds="+A.decomposeId(J).id;});this.listParticipants.setAttribute("data-url",H);};o.prototype._clickAdd=function(I){if(I.target.classList.contains("__participant")){var K=A.composeId(I.target.getAttribute("data-id"),b.idType.USER),J=I.target.getAttribute("data-incall")==="true",H=this;if(J){H._triggerEvent(o.events.REMOVE_PARTICIPANT,K);G.log(b.stat.UI_ACTION,"remove-participant");}else{H._triggerEvent(o.events.ADD_PARTICIPANT,K);G.log(b.stat.UI_ACTION,"add-participant");}this._closeAddFriendList();}};o.prototype._clickClose=function(){G.log(b.stat.UI_ACTION,"close");o.close();};o.prototype._clickSupport=function(){G.log(b.stat.UI_ACTION,"support");x.report();};o.prototype._clickAcceptVideo=function(){G.log(b.stat.UI_ACTION,"accept_videocall");this._triggerEvent(o.events.ACCEPT,true);};o.prototype._clickAcceptAudio=function(){G.log(b.stat.UI_ACTION,"accept_audiocall");this._triggerEvent(o.events.ACCEPT,false);};o.prototype._clickDecline=function(){G.log(b.stat.UI_ACTION,"decline_call");this._triggerEvent(o.events.DECLINE);};o.prototype.clickHangup=function(){G.log(b.stat.UI_ACTION,"hangup");this._triggerEvent(o.events.HANGUP);if(this.embed){this._toggleState(b.uiWidgetState.CALLING,false);this._toggleState(b.uiWidgetState.CALL_IN_PROGRESS,false);}};o.prototype._clickToggleSize=function(H){this._toggleLayerSize(H);};o.prototype._isInFullscreen=function(){return !!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement);};o.prototype._clickFullscreen=function(H){if(H){if(this.container.requestFullscreen){this.container.requestFullscreen();}else{if(this.container.webkitRequestFullscreen){this.container.webkitRequestFullscreen();}else{if(this.container.mozRequestFullScreen){this.container.mozRequestFullScreen();}else{if(this.container.msRequestFullscreen){this.container.msRequestFullscreen();}}}}}else{if(this._isInFullscreen()){if(document.exitFullscreen){document.exitFullscreen();}else{if(document.webkitExitFullscreen){document.webkitExitFullscreen();}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else{if(document.msExitFullscreen){document.msExitFullscreen();}}}}}}};o.prototype._clickSettings=function(I){var H=I.target;if(H.classList.contains("__opener")){H.nextSibling.classList.toggle("__visible");}};o.prototype._onFullscreenChange=function(){var H=this._isInFullscreen();G.log(b.stat.UI_ACTION,H?"fullscreen_1":"fullscreen_0");this._toggleState(b.uiState.FULLSCREEN,H);};o.prototype._closeAddFriendList=function(){var H=j.getActiveInstance();H&&H.hide();};o.prototype._onResize=function(){this._moveSliderCurrent();};o.prototype._setGlobalStatus=function(I){var J=F["msg-error-title-"+I]||F["msg-error-title-"+I.toLowerCase()]||F["msg-error-"+I]||F["msg-error-"+I.toLowerCase()]||F["msg-error-hungup"],H=F["msg-error-description-"+I]||F["msg-error-description-"+I.toLowerCase()]||"";if(I===b.hangupType.HUNGUP){H=F["msg-calltime"]+" "+this.lblTime.textContent;}this.lblStatus.innerHTML=J;this.lblStatusSmall.innerHTML=H;};o.prototype._startCallTimer=function(){this._stopHandleTimer();if(!this._callTimer){this._callStartTime=this._callStartTime||Date.now();this.lblTime.classList.remove(b.uiState.INVISIBLE);this._callTimer=setInterval(function(){this.lblTime.textContent=A.formatTime(~~((Date.now()-this._callStartTime)/1000));if(f!==this._debugEnabled){this._debugEnabled=f;var H="__debug_on";if(this._debugEnabled){this.container.classList.add(H);}else{this.container.classList.remove(H);}}}.bind(this),1000);}if(!this._statisticsInterval){this._statisticsInterval=setInterval(function(){var H={};Object.entries(this.remoteVideo).forEach(function(L){var K=L[1].getRenderStats();if(K){H[L[0]]=K;}});var I=0,J=0;Object.entries(this._frameDropStats).forEach(function(M){var K=H[M[0]];if(K){var L=K.decoded-M[1].decoded;if(L>0){J+=L;I+=K.dropped-M[1].dropped;}}});this._frameDropStats=H;J&&this._triggerEvent(o.events.PERFORMANCE_STATISTICS,{decoded:J,dropped:I});}.bind(this),1000);}};o.prototype._stopCallTimer=function(){clearInterval(this._callTimer);this._callTimer=null;this._callStartTime=0;clearInterval(this._statisticsInterval);this._statisticsInterval=null;};o.prototype._startHandleTimer=function(){if(!this._handleTimer&&this._callHandleTime>0){this.lblTime.classList.remove(b.uiState.INVISIBLE);this._handleTimer=setInterval(function(){var H=this._callHandleTime-Date.now();if(H<=0){this._stopHandleTimer();}else{this.lblTime.textContent=A.formatTime(~~(H/1000));if(f!==this._debugEnabled){this._debugEnabled=f;var I="__debug_on";if(this._debugEnabled){this.container.classList.add(I);}else{this.container.classList.remove(I);}}}}.bind(this),1000);}};o.prototype._stopHandleTimer=function(){clearInterval(this._handleTimer);this.lblTime.classList.add(b.uiState.INVISIBLE);this._handleTimer=null;this._callHandleTime=0;};o.prototype._toggleState=function(I,H){this.container.classList.toggle(I,H);};o.prototype._isInState=function(H){return this.container.classList.contains(H);};o.prototype._toggleSausage=function(H){this._forceSausage=H;this._toggleState(b.uiState.HIDE_SAUSAGE,false);this._toggleFlex();this._moveSliderCurrent();};o.prototype._toggleFlex=function(){if(this.embed||this._isInState(b.uiState.INCOMING)){return;}var I=Object.keys(this.remoteVideo).length;var H=I>=2&&I<=5&&!this._forceSausage,K=I>=4&&I<=5&&!this._forceSausage,J=I>=z||(this._forceSausage&&I>=2);this._toggleState(b.uiState.FLEX,H);this._toggleState(b.uiState.FLEX_BIG,K);this._toggleState(b.uiState.SAUSAGE,J);if(!J&&this._speakerLocked){this._setSpeakerNext();}this._checkParticipantsAddButton();this._reorderSausage();this.viewSausage.classList.toggle("__hidden",J||I<2);this.viewGrid.classList.toggle("__hidden",!J||I>=z);};o.prototype._clickHideSausage=function(){this._toggleState(b.uiState.HIDE_SAUSAGE);};o.prototype._reorderSausage=function(){if(this.embed){return;}var H=Object.values(this.remoteVideo);if(H.length>=z){H.forEach(function(J,I){J.setOrder(I);});}};o.prototype._clickSliderArrow=function(I){var H=I?-1:1;this._moveSlider(this._sliderOffsetPosition+H*k);};o.prototype._moveSliderStart=function(){this._moveSlider(0);};o.prototype._moveSliderEnd=function(){this._moveSlider(Number.POSITIVE_INFINITY);};o.prototype._moveSliderCurrent=function(){this._moveSlider(this._sliderOffsetPosition);};o.prototype._moveSlider=function(H){setTimeout(this._moveSliderPosition.bind(this,H));};o.prototype._moveSliderPosition=function(L){var K=this.remoteContainer.childNodes.length,M=this.remoteContainer.childNodes[0].offsetWidth+2*u,O=K*M,J=this.remoteContainer.offsetWidth-2*t,I=0,H=O-J;if(K<6||L<0){L=I;}if(L+J>O){L=H;}if(L<this._sliderOffsetPosition){if(L<M){L=0;}}else{if(O-L-J<M){L=H;}}this._sliderOffsetPosition=L;this.arrLeft.classList.toggle(b.uiState.INVISIBLE,L<=0);this.arrRight.classList.toggle(b.uiState.INVISIBLE,L>=H);this._toggleState(b.uiState.LONG_SAUSAGE,L>0||L<H);if(D&&a){D.style.transform="translateX("+(-L)+"px)";D.style.transition="transform .3s ease-in-out";a.style.transform="translateX("+L+"px)";a.style.transition="transform .3s ease-in-out";p.style.transform="scale(-1, 1) translateX("+(-L)+"px)";}else{document.styleSheets[0].insertRule(".video-chat.__sausage:not(.__error) .video-chat_views {transform: translateX("+(-L)+"px);transition: transform .3s ease-in-out;}",0);D=document.styleSheets[0].cssRules[0];document.styleSheets[0].insertRule(".video-chat.__sausage:not(.__error) .video-chat_view.__active .video-chat_blur,.video-chat.__sausage:not(.__error) .video-chat_view.__active .video-chat_video,.video-chat.__sausage:not(.__error) .video-chat_view.__active .video-chat_debug,.video-chat.__sausage:not(.__error) .video-chat_view.__active .video-chat_stub {transform: translateX("+L+"px);transition: transform .3s ease-in-out;}",0);a=document.styleSheets[0].cssRules[0];document.styleSheets[0].insertRule(".video-chat.__sausage:not(.__error):not(.__screen) .video-chat_view.video-chat_view-local.__active .video-chat_video {transform: scale(-1, 1) translateX("+(-L)+"px);}",0);p=document.styleSheets[0].cssRules[0];}var N=function(){this.remoteContainer.removeEventListener("transitionend",N);D.style.transition="none";a.style.transition="none";}.bind(this);this.remoteContainer.addEventListener("transitionend",N);};o.prototype._checkParticipantsAddButton=function(){if(!this.btnAddParticipantWrap){return;}var H=this._isCallActive,I=Object.keys(this.remoteVideo).length>=this._participantsAddLimit,J=this._participantsAddOld,K=this.btnAddParticipantWrap.classList;K.toggle("invisible",!H);K.toggle("iblock-cloud_show",I||J);K.toggle("__max",I);K.toggle("__old",J);if(I||J){this._closeAddFriendList();}};o.prototype._checkStartStreamButton=function(){this.btnStreaming&&this.btnStreaming.classList.toggle(b.uiState.INVISIBLE,!this._isCallActive);this.btnRecord&&this.btnRecord.classList.toggle(b.uiState.INVISIBLE,!this._isCallActive);};o.prototype._sendRate=function(H,J,K){if(!this._rateConversationId){return;}var I={"st.callvote.cid":this._rateConversationId,"st.callvote.rt":H};if(J){I["st.callvote.ans"]=J;}if(K){I["st.callvote.cmt"]=K;}return v.ajax({url:"/web-api/videochat/vote",data:I});};o.prototype._checkShowHideControls=function(I,H){if(!I&&H){this._hideControls();}else{if(I&&!H){this._showControls();}}};o.prototype.setSpeaker=function(H){if(this._speakerLocked){return;}this._setSpeaker(H);};o.prototype._setSpeaker=function(L,K){if(!this.remoteVideo[L]){x.warn("Remote video for participant ["+L+"] is not set")();return;}if(this._speakerId&&this._speakerId!==L&&this.remoteVideo[this._speakerId]){var I=this.remoteVideo[this._speakerId];I.setActive(false);}this.localContainer.classList.toggle(b.uiState.ACTIVE,false);this.localContainer.classList.toggle(b.uiState.LOCKED,false);var J=this.remoteVideo[L];J.setActive(true,K);this._speakerLocked=!!K;this._speakerId=L;this._checkShowHideControls(I&&I.isVideoEnabled(),J.isVideoEnabled());x.debug("Active speaker changed to "+L)();var H={};Object.keys(this.remoteVideo).forEach(function(M){H[M]=(M===L)?1:0;});this._triggerEvent(o.events.CHANGE_PRIORITIES,H);};o.prototype._setSpeakerNext=function(){var I=Object.keys(this.remoteVideo),H=I.length;if(H===0){return;}if(this._speakerId){this._setSpeaker(I[(I.indexOf(this._speakerId)+1)%H]);}else{this._setSpeaker(I[H-1]);}};o.prototype._setSpeakerLocal=function(J){if(this._speakerId&&this._speakerId!==this._myId&&this.remoteVideo[this._speakerId]){var I=this.remoteVideo[this._speakerId];I.setActive(false);}this._speakerLocked=J;this.localContainer.classList.toggle(b.uiState.ACTIVE,true);this.localContainer.classList.toggle(b.uiState.LOCKED,J);this._speakerId=this._myId;this._checkShowHideControls(I&&I.isVideoEnabled(),this._isInState(b.uiState.LOCAL));var H={};Object.keys(this.remoteVideo).forEach(function(K){H[K]=0;});this._triggerEvent(o.events.CHANGE_PRIORITIES,H);};o.prototype.setStartTime=function(H){this._callStartTime=H;};o.prototype.setLocalVideo=function(I,H){if(this.embed){return;}x.debug("Set local video",H)();this.localVideo.srcObject=I;this._toggleState(b.uiState.INCOMING,false);this._clearTitleAndFavicon();this._initCapturing();this._moveSliderStart();this._toggleFlex();if(I){this._toggleState(b.uiState.LOCAL,H.isVideoEnabled);this._toggleState(b.uiState.MUTED,!H.isAudioEnabled);}else{this._toggleState(b.uiState.LOCAL,false);this._toggleState(b.uiState.MUTED,true);}};o.prototype.setRemoteVideo=function(I,H){x.debug("Add remote video ["+I+"]")();if(!this.remoteVideo[I]){x.warn("Remote video for participant ["+I+"] is not set")();return;}this.remoteVideo[I].setSrc(H);};o.prototype.removeRemoteVideo=function(H){x.debug("Remove remote video ["+H+"]")();if(!this.remoteVideo[H]){x.warn("Remote video for participant ["+H+"] is not set")();return;}this.remoteVideo[H].destroy();delete this.remoteVideo[H];this._toggleFlex();this._moveSliderCurrent();};o.prototype.updateLocalVideo=function(H,L){if(this.embed){return;}x.debug("Update local video")();var K=this.localVideo.srcObject&&H.isVideoEnabled,J=this.localVideo.srcObject&&H.isAudioEnabled,I=this._isInState(b.uiState.LOCAL);this._toggleState(b.uiState.LOCAL,K);this._toggleState(b.uiState.MUTED,!J);this._toggleState(b.uiState.SCREEN,L==="screen");this._checkShowHideControls(I,K);};o.prototype.changeRemoteMediaSettings=function(N,H){x.debug("Change remote media settings for ["+N+"]",H)();if(!this.remoteVideo[N]){x.warn("Remote video for participant ["+N+"] is not set")();return;}var K=this.remoteVideo[N],M=K.hasSrc()&&H.isVideoEnabled,L=K.hasSrc()&&H.isAudioEnabled,J=K.hasSrc()&&H.isScreenSharingEnabled,I=K.isVideoEnabled();K.setVideoEnabled(M);K.setSoundEnabled(L);K.setScreenSharingEnabled(J);this._checkShowHideControls(I,M);};o.prototype.connected=function(H){G.log(b.stat.UI_ACTION,"connected");x.debug("Show connected state",{participantId:H})();this.remoteVideo[H].setStatusConnected();if(this.embed){this._toggleState(b.uiWidgetState.CALLING,false);this._toggleState(b.uiWidgetState.CALL_IN_PROGRESS,true);}else{this._reorderSausage();}this._startCallTimer();r.stop();};o.prototype.reconnect=function(H){G.log(b.stat.UI_ACTION,"reconnect");x.debug("Show reconnect state ["+H+"]")();this.remoteVideo[H].setStatusReconnect();this._reorderSausage();};o.prototype.connecting=function(H){clearTimeout(this._permissionsTimeout);this.remoteVideo[H].setStatusConnecting();this._reorderSausage();this._toggleState(b.uiState.HINT,false);r.connecting();};o.prototype.incoming=function(){r.incoming(this._params.soundIncoming);this._setTitleAndFavicon();};o.prototype.outgoing=function(H){this.remoteVideo[H].setStatusWaiting();if(this.embed){this._toggleState(b.uiWidgetState.FINISHED,false);this._toggleState(b.uiWidgetState.CALLING,true);}this._reorderSausage();r.calling(this._params.soundCalling);};o.prototype.applyGroupSettings=function(H){if(H){r.calling(H.welcomeAudioUrl||this._params.soundCalling);if(H.handleDelaySec>0){this._callHandleTime=Date.now()+H.handleDelaySec*1000;this._startHandleTimer();}}};o.prototype.accepted=function(){if(this.srnIncoming){this.srnIncoming.classList.add("invisible");}r.stop();};o.prototype.setStatus=function(I,H){if(!this.remoteVideo[I]){return;}this.remoteVideo[I].setStatusError(H.toLowerCase());this._reorderSausage();if(this._speakerId===I){this._setSpeakerNext();}};o.prototype.permissions=function(){this._permissionsTimeout=setTimeout(function(){Object.values(this.remoteVideo).forEach(function(H){H.setStatusPermissions();});this._reorderSausage();this._toggleState(b.uiState.HINT,true);}.bind(this),500);};o.prototype.onCallStateChanged=function(H,J,I){if(this.embed){return;}this._isCallActive=H;this._participantsAddLimit=I;this._participantsAddOld=!J;this._checkParticipantsAddButton();this._checkStartStreamButton();};o.prototype.toggleJoinAvailability=function(K,J){if(this.embed){return;}this.btnJoin.classList.toggle(b.uiState.INVISIBLE,!K);this.btnRecall&&this.btnRecall.classList.toggle(b.uiState.INVISIBLE,K);if(J){var L=this.btnJoin.getAttribute("data-link");if(L&&L.indexOf("st.call.chatId")===-1){this.btnJoin.setAttribute("data-link",L+"&st.call.chatId="+J);}var I=this.btnRecall&&this.btnRecall.getAttribute("data-link");if(I&&I.indexOf("st.call.chatId")===-1){this.btnRecall.setAttribute("data-link",I+"&st.call.chatId="+J);}var H=this.btnMessage&&this.btnMessage.getAttribute("data-link");if(H){this.btnMessage.setAttribute("data-link",H.replace(/\/[^\/]+$/,"/c"+J));}}};o.prototype.needRate=function(){this._needRate=true;};o.prototype.addParticipantsByElements=function(I){var H=this;Array.prototype.forEach.call(I,function(J){var K=A.composeId(J.getAttribute("data-participant-id"),J.getAttribute("data-participant-type"));if(!H.remoteVideo[K]){H.remoteVideo[K]=new y(K,J,H.remoteContainer,H._params,H.embed);}});this._toggleFlex();};o.prototype.addParticipant=function(I){if(this.remoteVideo[I]){return Promise.resolve();}var H=this;return this.loaderRemote.getLoader().loadMore({"st.call.participantIds":A.decomposeId(I).id}).then(function(J){H.addParticipantsByElements(J);H._moveSliderEnd();});};o.prototype.displayStats=function(J,I){var H=this.remoteVideo[J];if(H&&f){H.displayStats(I);}};o.prototype.displayLocalStats=function(H){function I(K){var J=["ssrc="+K.ssrc];if(K.mimeType){J.push(K.mimeType);}if(K.frameHeight&&K.frameWidth){J.push(K.frameHeight+"x"+K.frameWidth);}if(K.bandwidth){J.push(K.bandwidth+" b/s");}return J.join(" ");}if(f){this.debugView.innerHTML=this._myId+"\n"+H.outbound.rtps.map(I).join("\n");}};o.prototype.toggleBadNetwork=function(H){this._toggleState(b.uiState.BAD_NETWORK,H);};o.prototype.toggleMini=function(H){this._toggleLayerSize(H);};o.prototype.setNewMessages=function(H){this._toggleState(b.uiState.MESSAGE,false);if(H&&this.btnMessageTip){this.btnMessageTip.textContent=H;this._showControls();setTimeout(this._toggleState.bind(this,b.uiState.MESSAGE,true),10);}};o.prototype.activateRecord=function(H){this.uiStreaming=new h(H,this.container);this._handlers.startStream=this.uiStreaming.addEventListener(h.events.START_STREAM,this._triggerEvent.bind(this,o.events.START_STREAM));this._handlers.stopStream=this.uiStreaming.addEventListener(h.events.STOP_STREAM,this._triggerEvent.bind(this,o.events.STOP_STREAM));this._handlers.recordInfo=this.uiStreaming.addEventListener(h.events.RECORD_INFO,this._triggerEvent.bind(this,o.events.RECORD_INFO));this.setRecordMovieId();};o.prototype.deactivateRecord=function(){if(this.uiStreaming){this.uiStreaming.deactivate();this._handlers.startStream.dispose();this._handlers.stopStream.dispose();this._handlers.recordInfo.dispose();this.uiStreaming=null;}};o.prototype.setRecordMovieId=function(){if(this.uiStreaming){var H=this._recordInfo&&this._recordInfo.recordMovieId,I=this._recordInfo&&this._recordInfo.initiator;this.uiStreaming.setMovieId(H,I);}};o.prototype.setRecordInfo=function(J){var I=J&&J.recordMovieId,K=J&&J.initiator,H=K===this._myId,L=false;if(J){L=J.recordType==="RECORD";}else{if(this._recordInfo){L=this._recordInfo.recordType==="RECORD";}}this._recordInfo=J;if(I){this._toggleState(L?b.uiState.RECORD:b.uiState.STREAM,true);}else{this._toggleState(b.uiState.RECORD,false);this._toggleState(b.uiState.STREAM,false);}this._toggleState(b.uiState.OWNER,H);if(this.uiStreaming){h.open(L,I,K);}};o.prototype.setRecordPreview=function(I,H){this.uiStreaming&&this.uiStreaming.setPreview(I,H);};o.prototype.lastScreen=function(H,I){this._stopHandleTimer();this._stopCallTimer();if(this.embed){this._toggleState(b.uiWidgetState.CALL_IN_PROGRESS,false);this._toggleState(b.uiWidgetState.FINISHED,true);return;}this._rateConversationId=I;this._clickFullscreen(false);this.uiStreaming&&this.uiStreaming.close();clearTimeout(this._permissionsTimeout);x.debug("Show last screen",{type:H})();this._moveSliderStart();this._toggleState(b.uiState.BAD_NETWORK,false);this._toggleState(b.uiState.FLEX,false);this._toggleState(b.uiState.FLEX_BIG,false);this._toggleState(b.uiState.SAUSAGE,false);this._toggleState(b.uiState.LONG_SAUSAGE,false);this._toggleState(b.uiState.RECORD,false);this._toggleState(b.uiState.STREAM,false);this._toggleState(b.uiState.OWNER,false);if(H===b.hangupType.HUNGUP&&this._needRate){G.log(b.stat.UI_ACTION,"rate");this._toggleState(b.uiState.RATE,true);this._toggleState(b.uiState.ERROR_ACCESS,false);Object.values(this.remoteVideo).forEach(function(J){J.setActive(false);J.setVideoEnabled(false);J.setSrc(null);});}else{this._toggleState(b.uiState.ERROR,true);this._toggleState(b.uiState.RATE,false);this._toggleState(b.uiState.ERROR_ACCESS,false);this._setGlobalStatus(H);Object.values(this.remoteVideo).forEach(function(J){J.setActive(false);J.setVideoEnabled(false);J.setSrc(null);});if(H===b.error.CAMERA_PERMISSION||H===b.error.MIC_PERMISSION){this._toggleState(b.uiState.ERROR_ACCESS,true);}else{if(H===b.error.UNSUPPORTED){this._toggleState(b.uiState.STUB,true);}}}if(H===b.hangupType.BUSY){r.busy();}else{r.drop();}this._clearTitleAndFavicon();this._toggleLayerSize(false);this._toggleState(b.uiState.VOTE,false);this._toggleState(b.uiState.INCOMING,false);this._toggleState(b.uiState.LOCAL,false);this._toggleState(b.uiState.SCREEN,false);this._toggleState(b.uiState.CONNECTING,false);this._toggleState(b.uiState.HINT,false);this._toggleState(b.uiState.LAST,true);};return o;});define("OK/videochat/transport/PerfStatReporter",["OK/videochat/UI"],function(c){var a="videochat-epi";function b(h,e,f){this._previousTimestamp=0;this._renderDropRate=0;this._params=f;this._signaling=e;var g=Object.getPrototypeOf(h).constructor;this._listeners=[h.addEventListener(g.events.REMOTE_DATA_STATS,this._handleStats.bind(this))];var d=c.get();if(d){this._listeners.push(d.addEventListener(c.events.PERFORMANCE_STATISTICS,this._onUIPerformanceStatistics.bind(this)));}}b.prototype={destroy:function(){this._listeners.forEach(function(d){d.dispose();});},getEstimatedPerformanceIndex:function(){try{var d=parseInt(localStorage.getItem(a));return isNaN(d)?0:d;}catch(f){return 0;}},_handleStats:function(g,e){if(!this._params.perfStatReportEnabled){return;}if(!e.inbound||!e.inbound.rtps){return;}var d=e.inbound.rtps.filter(function(h){return h.kind==="video";}).map(function(h){return{framesDecoded:h.framesDecoded||0,framesReceived:h.framesReceived||0};}).reduce(function(i,h){i.framesDecoded+=h.framesDecoded;i.framesReceived+=h.framesReceived;return i;},{framesDecoded:0,framesReceived:0});var f=Date.now();if(this._renderDropRate){d.renderDropRate=this._renderDropRate;}if(this._previousTimestamp+5000>f){return;}if(d.framesDecoded||d._renderDropRate){this._signaling.send("report-perf-stat",{report:d}).then(function(h){localStorage.setItem(a,h.estimatedPerformanceIndex);})["catch"](function(h){});}this._previousTimestamp=f;},_onUIPerformanceStatistics:function(d){if(d.decoded){var e=d.dropped/(d.decoded+d.dropped);var f=0.2;this._renderDropRate=f*e+(1-f)*this._renderDropRate;}}};return b;});define("OK/videochat/transport/ServerTransport",["webrtc/sdp-interop","OK/WebRTCUtils!","OK/videochat/EventEmitter","OK/videochat/Utils","OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/Enums","OK/videochat/Signaling","OK/videochat/MediaSource","OK/videochat/transport/Statistics","OK/videochat/transport/PerfStatReporter"],function(h,c,m,k,l,b,a,e,i,d,g){var j=b.get("OK/videochat/transport/ServerTransport");function f(p,o,n){m.call(this);this._params=p;this._signaling=o;this._mediaSource=n;this._consumer=null;this._producer=null;this._isOpen=false;this._isRestartPrevented=false;this._state={};this._state[f.types.CONSUMER]=f.states.IDLE;this._state[f.types.PRODUCER]=f.states.IDLE;this._statInterval=null;this._statBytes={};this._ssrcMap={};this._listeners=[];this._listeners.push(this._signaling.addEventListener(e.events.NOTIFICATION,this._onSignalingNotification.bind(this)),this._mediaSource.addEventListener(i.events.TRACK_REPLACED,this._onReplacedTrack.bind(this)));this._interop=new h.Interop();this._perfStatReporter=new g(this,o,p);j.debug("Created")();}f.events={REMOTE_TRACK_ADDED:"REMOTE_TRACK_ADDED",REMOTE_STREAM_REMOVED:"REMOTE_STREAM_REMOVED",REMOTE_STREAM_STALL:"REMOTE_STREAM_STALL",REMOTE_DATA_STATS:"REMOTE_DATA_STATS",LOCAL_DATA_STATS:"LOCAL_DATA_STATS",STATE_CHANGED:"STATE_CHANGED"};f.states={IDLE:"IDLE",OPENED:"OPENED",CONNECTING:"CONNECTING",RECONNECTING:"RECONNECTING",CONNECTED:"CONNECTED",CLOSED:"CLOSED",FAILED:"FAILED"};f.statesPriorities={CONNECTED:1,CONNECTING:2,RECONNECTING:3,CLOSED:4,FAILED:5,OPENED:6,IDLE:7};f.types={PRODUCER:"producer",CONSUMER:"consumer"};f.prototype=Object.create(m.prototype);Object.assign(f.prototype,{constructor:f,getState:function(){var o=this._getState(f.types.CONSUMER);var n=this._getState(f.types.PRODUCER);if(f.statesPriorities[o]>f.statesPriorities[n]){return o;}else{return n;}},open:function(){if(this._isOpen){j.debug("Already opened")();return;}this._isOpen=true;j.debug("Open")();if(this._remoteStream){this._remoteStream.getTracks().forEach(function(q){q.stop();});this._remoteStream=null;}var p={};if(k.userAgent.isChromeBased){p.sdpSemantics=this._isUnifiedPlanEnabled()?"unified-plan":"plan-b";}this._producer=new RTCPeerConnection(p,{optional:[{googSuspendBelowMinBitrate:false}]});this._producer.ontrack=this._onAddTrack.bind(this,this._producer,f.types.PRODUCER);this._producer.onremovestream=this._onRemoveStream.bind(this,this._producer,f.types.PRODUCER);this._producer.oniceconnectionstatechange=this._onIceConnectionStateChange.bind(this,this._producer,f.types.PRODUCER);this._producer.onsignalingstatechange=this._onSignalingStateChange.bind(this,this._producer,f.types.PRODUCER);this._consumer=new RTCPeerConnection(p,{optional:[{googSuspendBelowMinBitrate:false}]});this._consumer.ontrack=this._onAddTrack.bind(this,this._consumer,f.types.CONSUMER);this._consumer.onremovestream=this._onRemoveStream.bind(this,this._consumer,f.types.CONSUMER);this._consumer.oniceconnectionstatechange=this._onIceConnectionStateChange.bind(this,this._consumer,f.types.CONSUMER);this._consumer.onsignalingstatechange=this._onSignalingStateChange.bind(this,this._consumer,f.types.CONSUMER);try{var o=this._mediaSource.getStream();o.getTracks().forEach(function(q){this._consumer.addTrack(q,o);}.bind(this));}catch(n){j.error("Unable to add media source tracks",n);l.log(a.stat.ERROR,"addTrack-"+f.types.CONSUMER);this.close(n);}this._allocateConsumer();this._startStatInterval();this._setState(f.states.OPENED,f.types.CONSUMER);this._setState(f.states.OPENED,f.types.PRODUCER);},close:function(n){this._closeConnections();this._listeners.forEach(function(o){o.dispose();});if(n){j.error("Closed",n)();this._setState(f.states.FAILED,f.types.CONSUMER);this._setState(f.states.FAILED,f.types.PRODUCER);}else{j.debug("Closed")();this._setState(f.states.CLOSED,f.types.CONSUMER);this._setState(f.states.CLOSED,f.types.PRODUCER);}},preventRestart:function(){this._isRestartPrevented=true;},allowRestart:function(){this._isRestartPrevented=false;},_closeConnections:function(){this._isOpen=false;this._stopStatInterval();if(this._producer){this._producer.ontrack=null;this._producer.onremovestream=null;this._producer.oniceconnectionstatechange=null;this._producer.onsignalingstatechange=null;this._producer.close();this._producer=null;}if(this._consumer){this._consumer.ontrack=null;this._consumer.onremovestream=null;this._consumer.oniceconnectionstatechange=null;this._consumer.onsignalingstatechange=null;this._consumer.close();this._consumer=null;}},_reconnect:function(){this._closeConnections();this.open();},_updateSSRCMap:function(n){var o=this._ssrcMap;if(n){n.sdp.split("\n").forEach(function(q){var p=/a=ssrc:([0-9]+) label:(audio|video)-([ug]?[\d]+)/.exec(q);if(p){o[p[1]]=p[3];}});}},_setState:function(o,n){if(this._state[n]===o){return;}this._state[n]=o;this._triggerEvent(f.events.STATE_CHANGED,this.getState());},_getState:function(n){return this._state[n]||f.states.IDLE;},_startStatInterval:function(){if(this._statInterval){return;}var n=this;this._statInterval=setInterval(function(){if(!n._producer){n._stopStatInterval();return;}n._collectStat().then(function(o){n._reportStats(o);n._detectStaleTracks(o);});},3000);},_stopStatInterval:function(){if(this._statInterval){clearInterval(this._statInterval);this._statInterval=null;}},_collectStat:function(){var o=this;var p=d.collect(this._producer,this._producerLastStat,this._ssrcMap),n=d.collect(this._consumer,this._consumerLastStat,this._ssrcMap);return Promise.all([p,n]).then(function(s){var q=o._producerLastStat=s[0],r=o._consumerLastStat=s[1];return{producer:q,consumer:r};});},_reportStats:function(r){var p=this;var o=r.producer,q=r.consumer;var s={};o.rtps.forEach(function(t){var u=p._ssrcMap[t.ssrc];if(u){if(!s[u]){s[u]=[];}s[u].push(t);}});var n=Object.keys(s);n.forEach(function(t){p._triggerEvent(f.events.REMOTE_DATA_STATS,t,{inbound:{topology:"SERVER",transport:o.transport,rtps:s[t]},outbound:{topology:"SERVER",transport:q.transport,rtps:q.rtps}});});p._triggerEvent(f.events.LOCAL_DATA_STATS,{outbound:{topology:"SERVER",transport:q.transport,rtps:q.rtps}});},_detectStaleTracks:function(o){var n=this,p=o.producer.rtps;var q={};this._producer.getReceivers().forEach(function(s){var r=s.track.id.match(/audio-([ug]?[\d]+)/);if(!r){return;}q[r[1]]=s.track;});p.forEach(function(t){if(t.kind!=="audio"){return;}var v=n._ssrcMap[t.ssrc],r=q[v];var s=n._statBytes[v],u=s&&t.bytesReceived-s.bytesReceived<=5||false;if(s&&s.stalled!==u&&r){n._triggerEvent(f.events.REMOTE_STREAM_STALL,r,u);}n._statBytes[v]={bytesReceived:t.bytesReceived,stalled:u};});},_allocateConsumer:function(){var o=this;var p={iceRestart:false,offerToReceiveAudio:false,offerToReceiveVideo:false};var n={estimatedPerformanceIndex:this._perfStatReporter.getEstimatedPerformanceIndex()};var q=f.types.CONSUMER;j.debug("["+q+"] create offer")();this._consumer.createOffer(p)["catch"](function(r){j.error("["+q+"] unable to create offer",r)();l.log(a.stat.ERROR,"createOffer-"+q);throw r;}).then(function(r){r.sdp=k.patchSDP(r.sdp,o._params.preferH264,o._params.brokenH264);return r;}).then(function(r){j.debug("["+q+"] created offer",{offer:r})();if(!o._consumer){throw new Error("Interrupt allocation");}return o._consumer.setLocalDescription(r).then(function(){return o._consumer.localDescription;});})["catch"](function(r){j.error("["+q+"] unable to set local offer",r)();l.log(a.stat.ERROR,"setLocalDescription-"+q);throw r;}).then(function(r){j.debug("["+q+"] transmit local offer")();return o._signaling.allocateConsumer(r,n);})["catch"](this.close.bind(this));},_acceptConsumerAnswer:function(o){if(!this._consumer){throw new Error("Interrupt allocation");}var n=f.types.CONSUMER;var p=new RTCSessionDescription({type:"answer",sdp:o});j.debug("["+n+"] set remote answer",{answer:p})();return this._consumer.setRemoteDescription(p)["catch"](function(q){j.error("["+n+"] unable to set remote answer",q)();l.log(a.stat.ERROR,"setRemoteDescription-"+n);throw q;});},_acceptProducer:function(n){var o=this;var p=f.types.PRODUCER;var q=new RTCSessionDescription({type:"offer",sdp:n});if(this._producerOfferIsProcessing){this._producerOffer=n;j.debug("["+p+"] wait until other remote offer is processed")();return;}this._producerOfferIsProcessing=true;if(o._isUnifiedPlanEnabled()){j.debug("["+p+"] alter remote offer to 'unified plan'",{offer:q})();q=o._interop.toUnifiedPlan(q);}j.debug("["+p+"] set remote offer",{offer:q})();this._producer.setRemoteDescription(q)["catch"](function(r){j.error("["+p+"] unable to set remote offer",r)();l.log(a.stat.ERROR,"setRemoteDescription-"+p);throw r;}).then(function(){j.debug("["+p+"] create local answer")();if(!o._producer){throw new Error("Interrupt allocation");}return o._producer.createAnswer()["catch"](function(r){j.error("["+p+"] unable to create answer",r)();l.log(a.stat.ERROR,"createAnswer-"+p);throw r;});}).then(function(r){r.sdp=k.patchSDP(r.sdp,o._params.preferH264,o._params.brokenH264);return r;}).then(function(r){j.debug("["+p+"] set local answer",{answer:r})();if(!o._producer){throw new Error("Interrupt allocation");}return o._producer.setLocalDescription(r)["catch"](function(s){j.error("["+p+"] unable to set local answer",s)();l.log(a.stat.ERROR,"setLocalDescription-"+p);throw s;}).then(function(){return r;});}).then(function(s){var r=s;if(o._isUnifiedPlanEnabled()){j.debug("["+p+"] alter local answer to 'plan b'",{answer:s})();r=o._interop.toPlanB(s);}j.debug("["+p+"] transmit local answer",{answer:r})();o._updateSSRCMap(q);return o._signaling.acceptProducer(r,Object.keys(o._ssrcMap));}).then(function(){j.debug("["+p+"] remote offer has been processed")();o._producerOfferIsProcessing=false;if(o._producerOffer){j.debug("["+p+"] there is other unprocessed remote offer, process it")();var r=o._producerOffer;o._producerOffer=null;return o._acceptProducer(r);}})["catch"](this.close.bind(this));},_onSignalingNotification:function(n){if(!this._isOpen){return;}if(n.notification===e.notifications.PRODUCER_UPDATED){this._acceptProducer(n.description);}else{if(n.notification===e.notifications.CONSUMER_ANSWERED){this._acceptConsumerAnswer(n.description);}}},_onAddTrack:function(n,o,p){j.debug("["+o+"] remote track (added)",{track:p.track})();var q=p.streams[0];if(q){this._triggerEvent(f.events.REMOTE_TRACK_ADDED,k.composeId(q.id,a.idType.USER),q,p.track);}else{j.error("["+o+"] unable to get media stream from track event")();}},_onRemoveStream:function(n,o,p){j.debug("["+o+"] remote stream (removed)",{stream:p.stream})();var q=p.stream.id;if(q){this._triggerEvent(f.events.REMOTE_STREAM_REMOVED,k.composeId(q,a.idType.USER),p.stream);}},_onSignalingStateChange:function(n,o,p){j.debug("["+o+"] signaling state changed",{state:n.signalingState})();},_onIceConnectionStateChange:function(n,o,p){j.debug("["+o+"] ice connection state changed",{state:n.iceConnectionState})();l.log(a.stat.ICE_CONNECTION_STATE,n.iceConnectionState);switch(n.iceConnectionState){case"failed":if(this._isRestartPrevented){this.close(new Error("Ice connection failed"));}else{this._setState(f.states.RECONNECTING,o);this._reconnect();}break;case"checking":var q=this._getState(o);if(q===f.states.IDLE||q===f.states.OPENED){this._setState(f.states.CONNECTING,o);}else{this._setState(f.states.RECONNECTING,o);}break;case"disconnected":if(this._isRestartPrevented){this.close(new Error("Ice connection disconnected"));}else{this._setState(f.states.RECONNECTING,o);}break;case"connected":this._setState(f.states.CONNECTED,o);k.getPeerConnectionHostInfo(n).then(function(r){r&&l.log(a.stat.ICE_CONNECTION_TYPE,r.type);});break;}},_onReplacedTrack:function(o,n){if(this._consumer){this._consumer.getSenders().forEach(function(p){if(p.track.kind===n.kind){p.track.enabled=n.enabled;p.replaceTrack(n)["catch"](function(q){j.error("Unable to replace track",q)();l.log(a.stat.ERROR,"replaceTrack-"+f.types.CONSUMER);});}});}},_isUnifiedPlanEnabled:function(){return this._params.unifiedPlan;}});return f;});define("OK/videochat/transport/StatLogger",["OK/videochat/Tracer"],function(a){var b=a.get("OK/videochat/transport/StatLogger");function c(e){this._connectedAt={};this._previousTimestamp={};this._transport=e;var d=Object.getPrototypeOf(e).constructor;this._listeners=[e.addEventListener(d.events.REMOTE_DATA_STATS,this._handleStats.bind(this)),e.addEventListener(d.events.STATE_CHANGED,this._handleStateChange.bind(this))];this._delays=[{begin:0,end:15000,delay:0},{begin:15000,end:60000,delay:15000},{begin:60000,end:Number.MAX_VALUE,delay:30000}];}c.prototype={destroy:function(){this._listeners.forEach(function(d){d.dispose();});},_handleStats:function(g,e){var f=Date.now(),d=this._previousTimestamp[g]||0;if(d+this._getDelay(g)<f){b.debug("Collected stat for connection with "+g,{stats:e})();this._previousTimestamp[g]=f;}},_getDelay:function(e){var f=Date.now()-(this._connectedAt[e]||0);for(var d=0;d<this._delays.length;d++){if(this._delays[d].begin<f&&f<=this._delays[d].end){return this._delays[d].delay;}}return 0;},_handleStateChange:function(e,d){var f=Object.getPrototypeOf(this._transport).constructor;if(d===f.states.CONNECTED){this._connectedAt[e]=Date.now();}}};return c;});define("OK/videochat/transport/Transport",["OK/videochat/EventEmitter","OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/Signaling","OK/videochat/transport/DirectTransport","OK/videochat/transport/ServerTransport","OK/videochat/transport/StatLogger"],function(i,h,a,c,b,d,g){var f=a.get("OK/videochat/transport/Transport");function e(m,k,j,l){i.call(this);this._signaling=k;this._mediaSource=j;this._params=l;this._topology=m;this._allocated=[];this._opened=[];this._directTransports={};this._serverTransport=null;this._listeners=[];this._dtListeners={};this._stListeners=[];this._states={};this._listeners.push(this._signaling.addEventListener(c.events.NOTIFICATION,this._onSignalingNotification.bind(this)));this._statLogger=new g(this);}e.events={REMOTE_TRACK_ADDED:"REMOTE_TRACK_ADDED",REMOTE_STREAM_REMOVED:"REMOTE_STREAM_REMOVED",REMOTE_STREAM_STALL:"REMOTE_STREAM_STALL",REMOTE_DATA_STATS:"REMOTE_DATA_STATS",LOCAL_DATA_STATS:"LOCAL_DATA_STATS",STATE_CHANGED:"STATE_CHANGED",OPENED:"OPENED"};e.states={IDLE:"IDLE",OPENED:"OPENED",CONNECTING:"CONNECTING",RECONNECTING:"RECONNECTING",CONNECTED:"CONNECTED",CLOSED:"CLOSED",FAILED:"FAILED"};e.topology={DIRECT:"DIRECT",SERVER:"SERVER"};e.prototype=Object.create(i.prototype);Object.assign(e.prototype,{constructor:e,allocate:function(k,j){if(this._allocated.indexOf(k)!==-1){f.warn("The participant ["+k+"] has already had allocated transport")();return;}this._allocated.push(k);if(this._topology===e.topology.DIRECT){this._directTransports[k]=this._createDirectTransport(k,j);}if(this._topology===e.topology.SERVER&&!this._serverTransport){this._serverTransport=this._createServerTransport();}},open:function(k,j){if(this._opened.indexOf(k)!==-1){f.warn("The participant ["+k+"] has already had opened transport")();return;}if(this._allocated.indexOf(k)===-1){f.warn("The participant ["+k+"] has no allocated transport")();return;}this._opened.push(k);if(this._topology===e.topology.DIRECT){if(!this._directTransports[k]){f.warn("Cannot find allocated direct transport for the participant ["+k+"]")();return;}this._directTransports[k].open(j);}if(this._topology===e.topology.SERVER){this._serverTransport.open();this._setState(k,this._convertServerTransportState(this._serverTransport.getState()));}f.debug("The participant ["+k+"] transport opened");},close:function(l){var j=this._allocated.indexOf(l);var k=this._opened.indexOf(l);if(j<0){f.warn("The participant ["+l+"] transport has already deallocated")();}if(this._topology===e.topology.DIRECT){if(!this._directTransports[l]){f.warn("Cannot find allocated direct transport for the participant "+l+"]")();return;}this._directTransports[l].close();delete this._directTransports[l];}if(this._topology===e.topology.SERVER){this._setState(l,e.states.CLOSED);}if(k>=0){this._opened.splice(k,1);}if(j>=0){this._allocated.splice(j,1);}},destroy:function(){var j;this._listeners.forEach(function(k){k.dispose();});for(j in this._dtListeners){this._dtListeners[j].forEach(function(k){k.dispose();});}if(this._stListeners){this._stListeners.forEach(function(k){k.dispose();});}for(j in this._directTransports){this._directTransports[j].close();delete this._directTransports[j];}this._directTransports={};if(this._serverTransport){this._serverTransport.close();this._serverTransport=null;}this._allocated=[];this._opened=[];this._statLogger.destroy();},getState:function(j){return this._states[j];},getTopology:function(){return this._topology;},isAllocated:function(j){return this._allocated.indexOf(j)>=0;},isOpened:function(j){return this._opened.indexOf(j)>=0;},allocated:function(){return this._allocated.slice();},opened:function(){return this._opened.slice();},_setStates:function(j,k){j.forEach(function(l){this._setState(l,k);}.bind(this));},_setState:function(k,j){if(this._states[k]===j){return;}this._states[k]=j;this._triggerEvent(e.events.STATE_CHANGED,k,j);},_onSignalingNotification:function(j){if(j.notification===c.notifications.TOPOLOGY_CHANGED){return this._onTopologyChanged(j);}},_onTopologyChanged:function(k){if(k.topology===this._topology){return;}f.debug("Topology changed "+this._topology+" -> "+k.topology)();this._topology=k.topology;if(this._topology===e.topology.SERVER){if(this._serverTransport){this._serverTransport.allowRestart();}else{this._serverTransport=this._createServerTransport();if(this._opened.length>0){for(var l in this._directTransports){this._directTransports[l].preventRestart();}this._serverTransport.open();}}}if(this._topology===e.topology.DIRECT){var j=(k.offerTo||[]).map(String);if(!this._allocated||this._allocated.length===0){f.warn("Topology changed to DIRECT, but the list of allocated participants is empty")();}if(this._serverTransport){this._serverTransport.preventRestart();}this._allocated.forEach(function(n){var m=j.indexOf(n)>=0;if(this._directTransports[n]){this._directTransports[n].allowRestart();}else{this._directTransports[n]=this._createDirectTransport(n,m);}}.bind(this));this._opened.forEach(function(m){if(this._directTransports[m]){this._directTransports[m].open(null);}else{f.warn("There is opened but not allocated transport ["+m+"]");}}.bind(this));}},_createDirectTransport:function(k,j){var l=new b(k,j,this._signaling,this._mediaSource,this._params);if(this._dtListeners[k]&&this._dtListeners[k].length>0){f.warn("The list of direct listeners for the participant ["+k+"] is not empty")();}this._dtListeners[k]=[];this._dtListeners[k].push(l.addEventListener(b.events.REMOTE_TRACK_ADDED,this._onDirectRemoteTrackAdded.bind(this,k)),l.addEventListener(b.events.REMOTE_STREAM_REMOVED,this._onDirectRemoteStreamRemoved.bind(this,k)),l.addEventListener(b.events.REMOTE_DATA_STATS,this._onDirectRemoteDataStats.bind(this)),l.addEventListener(b.events.LOCAL_DATA_STATS,this._onDirectLocalDataStats.bind(this)),l.addEventListener(b.events.STATE_CHANGED,this._onDirectTransportChanged.bind(this,k)));return l;},_createServerTransport:function(){var j=new d(this._params,this._signaling,this._mediaSource);if(this._stListeners&&this._stListeners.length>0){f.warn("The list of server transport listeners is not empty")();}this._stListeners=[];this._stListeners.push(j.addEventListener(d.events.REMOTE_TRACK_ADDED,this._onServerRemoteTrackAdded.bind(this)),j.addEventListener(d.events.REMOTE_STREAM_REMOVED,this._onServerRemoteStreamRemoved.bind(this)),j.addEventListener(d.events.REMOTE_STREAM_STALL,this._onServerRemoteStreamStall.bind(this)),j.addEventListener(d.events.REMOTE_DATA_STATS,this._onServerRemoteDataStats.bind(this)),j.addEventListener(d.events.LOCAL_DATA_STATS,this._onServerLocalDataStats.bind(this)),j.addEventListener(d.events.STATE_CHANGED,this._onServerTransportChanged.bind(this)));return j;},_releaseAllDirectTransports:function(k){for(var j in this._directTransports){this._releaseDirectTransport(j,k);}},_releaseDirectTransport:function(k,j){if(this._directTransports[k]){if(j){this._directTransports[k].close();}delete this._directTransports[k];}if(this._dtListeners[k]){this._dtListeners[k].forEach(function(l){l.dispose();});}delete this._dtListeners[k];},_releaseServerTransport:function(j){if(this._serverTransport){if(j){this._serverTransport.close();}this._serverTransport=null;}if(this._stListeners){this._stListeners.forEach(function(k){k.dispose();});this._stListeners=null;}},_onDirectTransportChanged:function(m,k){if(k===b.states.CONNECTED){if(this._topology===e.topology.DIRECT){this._releaseServerTransport(true);}}if(k===b.states.CLOSED||k===b.states.FAILED){this._releaseDirectTransport(m,false);if(this._topology===e.topology.DIRECT){var l=this._opened.indexOf(m);if(l>=0){this._opened.splice(l,1);}var j=this._allocated.indexOf(m);if(j>=0){this._allocated.splice(j,1);}}}if(this._topology===e.topology.DIRECT){this._setState(m,this._convertServerTransportState(k));}},_convertServerTransportState:function(j){switch(j){case d.states.IDLE:return e.states.IDLE;case d.states.OPENED:return e.states.OPENED;case d.states.CONNECTED:return e.states.CONNECTED;case d.states.CONNECTING:return e.states.CONNECTING;case d.states.RECONNECTING:return e.states.RECONNECTING;case d.states.CLOSED:return e.states.CLOSED;case d.states.FAILED:return e.states.FAILED;}},_onServerTransportChanged:function(k){var j=this._opened.slice();if(k===d.states.CONNECTED){if(this._topology===e.topology.SERVER){this._releaseAllDirectTransports(true);}}if(k===d.states.CLOSED||k===d.states.FAILED){this._releaseServerTransport(false);if(this._topology===e.topology.SERVER){this._allocated=[];this._opened=[];}}if(this._topology===e.topology.SERVER){this._setStates(j,this._convertDirectTransportState(k));}},_convertDirectTransportState:function(j){switch(j){case b.states.IDLE:return e.states.IDLE;case b.states.OPENED:return e.states.OPENED;case b.states.CONNECTED:return e.states.CONNECTED;case b.states.CONNECTING:return e.states.CONNECTING;case b.states.RECONNECTING:return e.states.RECONNECTING;case b.states.CLOSED:return e.states.CLOSED;case b.states.FAILED:return e.states.FAILED;}},_onServerRemoteStreamStall:function(j,k){this._triggerEvent(e.events.REMOTE_STREAM_STALL,j,k);},_onServerRemoteDataStats:function(k,j){this._triggerEvent(e.events.REMOTE_DATA_STATS,k,j);},_onServerLocalDataStats:function(j){this._triggerEvent(e.events.LOCAL_DATA_STATS,j);},_onDirectRemoteTrackAdded:function(l,k,j){this._triggerEvent(e.events.REMOTE_TRACK_ADDED,l,k,j);},_onDirectRemoteStreamRemoved:function(k,j){this._triggerEvent(e.events.REMOTE_STREAM_REMOVED,k,j);},_onDirectRemoteDataStats:function(k,j){this._triggerEvent(e.events.REMOTE_DATA_STATS,k,j);},_onDirectLocalDataStats:function(j){this._triggerEvent(e.events.LOCAL_DATA_STATS,j);},_onServerRemoteTrackAdded:function(l,k,j){this._triggerEvent(e.events.REMOTE_TRACK_ADDED,l,k,j);},_onServerRemoteStreamRemoved:function(k,j){this._triggerEvent(e.events.REMOTE_STREAM_REMOVED,k,j);}});return e;});define("OK/GroupCallPush",["OK/logger","OK/VideoChatSound"],function(c,e){var d;var b=false;var a=false;return{activate:function(f){d=f.getAttribute("data-audio-url");!b&&this._playSound();a=true;if(b){f.classList.toggle("__disabled",b);f.classList.toggle("iblock-cloud_show",b);}},deactivate:function(){a=false;!b&&this._stopSound();},setCallInProgress:function(f){b=f;a&&(b?this._stopSound():this._playSound());},_playSound:function(){e.incoming(d);},_stopSound:function(){e.stop();}};});define("OK/videochat/VolumeDetector",[],function(){var d=window.AudioContext||window.webkitAudioContext;var c=null;var a=44100;function b(h,f){this._options=Object.assign({smoothing:0.85,minFreq:200,maxFreq:5000},f);try{if(!c){c=new d();}this._analyser=c.createAnalyser();this._analyser.fftSize=1024;this._analyser.smoothingTimeConstant=this._options.smoothing;this._fftBins=new Uint8Array(this._analyser.frequencyBinCount);this._mediaStreamSource=c.createMediaStreamSource(h);this._mediaStreamSource.connect(this._analyser);}catch(g){}}b.prototype._getBins=function(){this._analyser.getByteFrequencyData(this._fftBins);var f=a/this._fftBins.length,g=Math.ceil(this._options.minFreq/f),e=Math.floor(this._options.maxFreq/f);return this._fftBins.subarray(g,e);};b.prototype.getLevel=function(){var e=this._getBins(),f=e.reduce(function(h,g){return h+g;})/e.length;return f/255;};b.prototype.destroy=function(){if(this._mediaStreamSource){this._mediaStreamSource.disconnect();this._mediaStreamSource=null;}if(this._analyser){this._analyser=null;this._fftBins=null;}};return b;});define("OK/videochat/VolumesDetector",["OK/videochat/transport/Transport","OK/videochat/EventEmitter","OK/videochat/VolumeDetector"],function(d,b,c){function a(f,e){b.call(this);this._options=Object.assign({interval:500},e);this._detectors={};this._volumes={};this._interval=null;this._listeners=[f.addEventListener(d.events.REMOTE_TRACK_ADDED,this._onRemoteTrackAdded.bind(this)),f.addEventListener(d.events.REMOTE_STREAM_REMOVED,this._onRemoteStreamRemoved.bind(this))];}a.events={VOLUMES_DETECTED:"VOLUMES_DETECTED"};a.prototype=Object.create(b.prototype);Object.assign(a.prototype,{constructor:a,destroy:function(){clearInterval(this._interval);this._interval=null;this._listeners.forEach(function(f){f.dispose();});for(var e in this._detectors){if(this._detectors.hasOwnProperty(e)){this._detectors[e].destroy();}}this._detectors={};this._volumes={};},_onRemoteTrackAdded:function(g,f,e){if(e.kind!=="audio"){return;}if(this._detectors[g]){this._detectors[g].destroy();}this._detectors[g]=new c(f,this._options);if(!this._interval){this._interval=setInterval(this._collectVolumes.bind(this),this._options.interval);}},_onRemoteStreamRemoved:function(f,e){this._detectors[f].destroy();delete this._detectors[f];delete this._volumes[f];},_collectVolumes:function(){for(var e in this._detectors){if(this._detectors.hasOwnProperty(e)){this._volumes[e]=this._detectors[e].getLevel();}}this._triggerEvent(a.events.VOLUMES_DETECTED,this._volumes);}});return a;});define("OK/videochat/SpeakerDetector",["OK/videochat/EventEmitter","OK/videochat/VolumesDetector"],function(b,a){function c(e,d){b.call(this);this._options=Object.assign({threshold:0.35},d);this._speakerId=null;this._listeners=[e.addEventListener(a.events.VOLUMES_DETECTED,this._onVolumesDetected.bind(this))];}c.events={SPEAKER_CHANGED:"SPEAKER_CHANGED"};c.prototype=Object.create(b.prototype);Object.assign(c.prototype,{constructor:c,destroy:function(){this._listeners.forEach(function(d){d.dispose();});clearTimeout(this._timeout);},_onVolumesDetected:function(h){var e=this,d=0,g=null;Object.keys(h).forEach(function(i){var j=h[i];if(j>d&&j>e._options.threshold){d=j;g=i;}});if(g&&g!==e._speakerId){var f=h.hasOwnProperty(e._speakerId)?h[e._speakerId]:0;if(d>f*2){e._speakerId=g;e._triggerEvent(c.events.SPEAKER_CHANGED,g);}}}});return c;});define("OK/videochat/DebugInfo",["OK/videochat/EventEmitter"],function(a){function b(f,d){a.call(this);this._volumes={};var e=Object.getPrototypeOf(f).constructor;var c=Object.getPrototypeOf(d).constructor;this._listeners=[f.addEventListener(e.events.REMOTE_DATA_STATS,this._onRemoteDataStats.bind(this)),f.addEventListener(e.events.LOCAL_DATA_STATS,this._onLocalDataStats.bind(this)),d.addEventListener(c.events.VOLUMES_DETECTED,this._onVolumesDetected.bind(this))];}b.events={DEBUG_INFO_UPDATED:"DEBUG_INFO_UPDATED",DEBUG_INFO_LOCAL_UPDATED:"DEBUG_INFO_LOCAL_UPDATED",};b.prototype=Object.create(a.prototype);Object.assign(b.prototype,{constructor:b,destroy:function(){this._listeners.forEach(function(c){c.dispose();});},_onRemoteDataStats:function(e,c){if(this._volumes.hasOwnProperty(e)){var d=this._volumes[e];c.inbound.rtps.forEach(function(f){if(f.kind==="audio"){f.volume=d;}});}this._triggerEvent(b.events.DEBUG_INFO_UPDATED,e,c);},_onLocalDataStats:function(c){this._triggerEvent(b.events.DEBUG_INFO_LOCAL_UPDATED,c);},_onVolumesDetected:function(c){this._volumes=c;}});return b;});define("OK/videochat/SpecListener",["OK/videochat/Enums","OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/transport/Transport","OK/videochat/VolumesDetector"],function(f,e,c,g,b){var d=c.get("OK/videochat/SpecListener");function a(k,j,h,i){this._transport=k;this._states={};this._volumes={};this._participants=h;this._params=Object.assign({connectionTimeout:10000,volumeTimeout:10000},i);this._listeners=[k.addEventListener(g.events.STATE_CHANGED,this._onTransportStateChanged.bind(this)),j.addEventListener(b.events.VOLUMES_DETECTED,this._onVolumesDetected.bind(this))];}Object.assign(a.prototype,{destroy:function(){this._listeners.forEach(function(h){h.dispose();});if(this._connectionTimeout){clearTimeout(this._connectionTimeout);}if(this._volumeTimeout){clearTimeout(this._volumeTimeout);}},onChangeRemoteMediaSettings:function(i,h){if(!h.isAudioEnabled){this._volumes[i]=1;}if(h.isAudioEnabled){this._volumes[i]=0;}},_onTransportStateChanged:function(i,h){this._states[i]=h;if(h===g.states.OPENED){if(!this._connectionTimeout){this._connectionTimeout=setTimeout(this._onConnectionTimeout.bind(this),this._params.connectionTimeout);}if(!this._volumeTimeout){this._volumeTimeout=setTimeout(this._onVolumeTimeout.bind(this),this._params.volumeTimeout);}}if(h===g.states.FAILED&&this._connectionTimeout){d.debug("Transport failed, send callSpecError")();e.log(f.stat.CALL_SPEC_ERROR,this._transport.getTopology()+"_CONNECTION_TIMEOUT");}},_onVolumesDetected:function(i){var h=this;Object.keys(i).forEach(function(j){h._volumes[j]=Math.max(i[j],h._volumes[j]||0);});},_onConnectionTimeout:function(){var h=this;function j(k){return k!==g.states.CONNECTED;}function i(){return Object.values(h._states).filter(j).length>0;}if(i()){d.debug("There is not connected transport, send callSpecError")();e.log(f.stat.CALL_SPEC_ERROR,this._transport.getTopology()+"_CONNECTION_TIMEOUT");}this._connectionTimeout=null;},_onVolumeTimeout:function(){var i=this,h=[];Object.keys(i._volumes).forEach(function(l){if(i._volumes[l]>0){return;}var k="UNKNOWN",j=i._participants[l];if(j&&j.platform){k=j.platform;}if(h.indexOf(k)<0){h.push(k);e.log(f.stat.CALL_SPEC_ERROR,i._transport.getTopology()+"_VOLUME_TIMEOUT_"+k);}});if(h.length){d.debug("There is silent participant, send callSpecError")();}this._volumeTimeout=null;}});return a;});define("OK/videochat/Conversation",["OK/WebRTCUtils!","OK/GroupCallPush","OK/utils/vanilla","OK/videochat/Utils","OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/Enums","OK/videochat/Signaling","OK/videochat/MediaSource","OK/videochat/UI","OK/videochat/transport/Transport","OK/videochat/VolumesDetector","OK/videochat/SpeakerDetector","OK/videochat/DebugInfo","OK/videochat/SpecListener"],function(c,n,p,u,x,q,b,k,s,i,w,g,d,t,m){var r=q.get("OK/videochat/Conversation");var h=null;var f=false;var j=null;var a=0.05;window.addEventListener("unload",function(){h&&h.hangup();});function v(y){return Object.assign({id:null,mediaSettings:null,state:null,remoteStream:null,remoteVideoTrack:null,platform:null,clientType:null},y);}function l(D,y,C,z,B){r.debug("Create",{conversationId:D,opponentId:y,opponentType:C,chatId:z,withVideo:B})();var A={"st.call.ft":B?b.callType.CALL_VIDEO:b.callType.CALL_AUDIO};if(D){A["st.call.conversationId"]=D;}if(y){A["st.call.opponentId"]=y;}if(C){A["st.call.opponentType"]=C;}if(z){A["st.call.chatId"]=z;}return p.ajax({url:"/web-api/videochat/call",data:A,dataType:"json"})["catch"](function(E){return Promise.reject(E);}).then(function(E){if(!E.response){return Promise.reject(new Error("Unable to parse response"));}if(E.response.status!==b.callStatus.FEASIBLE){return Promise.reject({feasibility:b.callStatus[E.response.status]||b.callStatus.UNKNOWN_ERROR});}return E.response.conversation;});}function e(A,y,z){r.debug("Conversation: join",{conversationId:A,withVideo:z});return p.ajax({url:"/web-api/videochat/join",data:{"st.call.conversationId":A,"st.call.chatId":y,"st.call.ft":z?b.callType.CALL_VIDEO:b.callType.CALL_AUDIO},dataType:"json"})["catch"](function(B){return Promise.reject(B);}).then(function(B){if(!B.response){return Promise.reject(new Error("Unable to parse response"));}if(!B.response.conversation){return Promise.reject({feasibility:B.response.error&&b.joinError[B.response.error]||b.joinError.UNKNOWN_ERROR});}return B.response.conversation;});}function o(y){this._signaling=null;this._mediaSource=null;this._conversation=null;this._params=y;this._state=o.state.IDLE;this._participantState=b.participant.CALLED;this._outBandwidth={audio:0,video:0,good:true};this._participants={};this._listeners=[];this._timeouts=[];this._embed=false;x.addStatVars(y.stat);x.setBatchInterval(y.loggerBatchInterval);r.debug("Set parameters",{params:y})();}o.current=function(){return h;};o.state={IDLE:"IDLE",ACTIVE:"ACTIVE",CLOSE:"CLOSE"};o.topology={DIRECT:"DIRECT",SERVER:"SERVER"};o.prototype={onStart:function(C,y,B,A,D){var z=this;if(f){r.warn("Conversation: there is already running activation")();return;}f=true;z._embed=!C;z._createMediaSource();z._mediaSource.request(D).then(function(){var E=z._mediaSource.getMediaSettings().isVideoEnabled;return l(C,y,B,A,E);}).then(function(E){z._createSignaling(E);return Promise.all([Promise.resolve(E),z._signaling.connect()]);}).then(function(F){var G=F[0],E=F[1];return z._setConversation(G,E);}).then(this._registerParticipants.bind(this)).then(this._allocateTransport.bind(this)).then(this._createVolumeDetector.bind(this)).then(this._createSpeakerDetector.bind(this)).then(this._createDebugInfo.bind(this)).then(this._createSpecListener.bind(this)).then(function(E){if(!i.get()){z._signaling.hangup(b.hangupType.CANCELED);return Promise.reject({hangup:b.hangupType.CANCELED});}if(A){x.log(b.stat.OUTGOING_MULTIPARTY_CALL,F?"video":"audio");}else{x.log(b.stat.OUTGOING_CALL,F?"video":"audio");}var F=z._mediaSource.getMediaSettings().isVideoEnabled;r.debug("Outgoing call",{opponentId:y,chatId:A,withVideo:F})();i.get().setLocalVideo(z._mediaSource.getStream(),z._mediaSource.getMediaSettings());i.get().setStartTime(E.acceptTime);z._toggleJoinAvailability();z._changeFeatureSet();z._changeNeedRate();z._setRecordInfo(E.recordInfo);z._participantState=b.participant.ACCEPTED;h=z;if(!E.concurrent){for(var G in z._participants){i.get().outgoing(G);}}else{x.log(b.stat.ACCEPT_CONCURRENT,F?"video":"audio");r.debug("Concurrent call",{conversationId:E.conversationId})();z.accept(F);}return z;}).then(function(E){if(B===b.idType.GROUP){z._applyGroupSettings(y);}return E;}).then(function(E){f=false;return E;})["catch"](function(E){f=false;r.error("Unable to start conversation",E)();z.close(E);});},onJoin:function(A,z,B){var y=this;if(f){r.warn("Conversation: there is already running activation")();return;}f=true;y._createMediaSource();y._mediaSource.request(B).then(function(){var C=y._mediaSource.getMediaSettings().isVideoEnabled;return e(A,z,C);}).then(function(C){y._createSignaling(C);return Promise.all([Promise.resolve(C),y._signaling.connect()]);}).then(function(D){var E=D[0],C=D[1];return y._setConversation(E,C);}).then(this._registerParticipants.bind(this)).then(this._allocateTransport.bind(this)).then(this._createVolumeDetector.bind(this)).then(this._createSpeakerDetector.bind(this)).then(this._createDebugInfo.bind(this)).then(this._createSpecListener.bind(this)).then(function(D){if(!i.get()){y._signaling.hangup(b.hangupType.CANCELED);return Promise.reject({hangup:b.hangupType.CANCELED});}var E=y._mediaSource.getMediaSettings().isVideoEnabled;x.log(b.stat.JOIN_CONVERSATION,E?"video":"audio");r.debug("Joining conversation",{conversationId:A,withVideo:E})();i.get().setLocalVideo(y._mediaSource.getStream(),y._mediaSource.getMediaSettings());i.get().setStartTime(D.acceptTime);y._toggleJoinAvailability();y._changeFeatureSet();y._changeNeedRate();y._setRecordInfo(D.recordInfo);y._state=o.state.ACTIVE;y._participantState=b.participant.ACCEPTED;y._changeFeatureSet();for(var F in y._participants){i.get().outgoing(F);var C=y._participants[F];if(C.state===b.participant.CALLED||C.state===b.participant.ACCEPTED){if(!y._transport.isAllocated(C.id)){y._transport.allocate(C.id,false);}}if(C.state===b.participant.ACCEPTED){y._transport.open(C.id,null);}}h=y;return y;}).then(function(C){f=false;return C;})["catch"](function(C){f=false;r.error("Unable to join conversation",C)();y.close(C);});},onPush:function(A,y){var z=this;if(f){r.warn("Conversation: there is already running activation")();return;}f=true;this._createSignaling(A);this._createMediaSource();z._signaling.connect().then(function(B){if(h&&h._participantState===b.participant.ACCEPTED){r.debug("Push rejected (busy)")();x.log(b.stat.PUSH,"busy");z._signaling.hangup(b.hangupType.BUSY);return Promise.reject({hangup:b.hangupType.BUSY});}if(h){h.destroy();h=null;}return z._setConversation(A,B);}).then(function(B){var C=B.participants.find(function(D){return D.state===b.participant.CALLED&&String(D.id)===String(B.userId)&&String(D.idType)===String(B.entityType);});if(!C){r.debug("Push rejected (there is an active call)")();x.log(b.stat.PUSH,"rejected");return Promise.reject({hangup:b.hangupType.REJECTED});}return B;}).then(function(B){return y||!i.get()?B:i.close().then(function(){return B;});}).then(this._registerParticipants.bind(this)).then(this._allocateTransport.bind(this)).then(this._createVolumeDetector.bind(this)).then(this._createSpeakerDetector.bind(this)).then(this._createDebugInfo.bind(this)).then(this._createSpecListener.bind(this)).then(function(B){if(y&&!i.get()){z._signaling.hangup(b.hangupType.CANCELED);return Promise.reject({hangup:b.hangupType.CANCELED});}if(y){z.accept(B.video&&c.hasCamera());i.get().setLocalVideo(z._mediaSource.getStream(),z._mediaSource.getMediaSettings());i.get().setStartTime(B.acceptTime);}x.log(b.stat.PUSH,"accepted");x.log(b.stat.ACCEPTED_OUTGOING,B.video?"video":"audio");h=z;return y?Promise.resolve():i.open(B.conversationId,B.chatId,B.opponentId,z.getParticipantsList(),B.video&&c.hasCamera(),true);}).then(function(){f=false;})["catch"](function(B){f=false;r.error("Unable to handle inbound call push",B)();z.close(B);});},bindUI:function(){this._listeners.push(i.get().addEventListener(i.events.ACCEPT,this.accept.bind(this)),i.get().addEventListener(i.events.DECLINE,this.decline.bind(this)),i.get().addEventListener(i.events.HANGUP,this.hangup.bind(this)),i.get().addEventListener(i.events.ADD_PARTICIPANT,this.addParticipant.bind(this)),i.get().addEventListener(i.events.REMOVE_PARTICIPANT,this.removeParticipant.bind(this)),i.get().addEventListener(i.events.CHANGE_DEVICE,this._onChangeDevice.bind(this)),i.get().addEventListener(i.events.TOGGLE_VIDEO,this._onToggleVideo.bind(this)),i.get().addEventListener(i.events.TOGGLE_AUDIO,this._onToggleAudio.bind(this)),i.get().addEventListener(i.events.CHANGE_PRIORITIES,this._onChangePriorities.bind(this)),i.get().addEventListener(i.events.START_STREAM,this._onStartStream.bind(this)),i.get().addEventListener(i.events.STOP_STREAM,this._onStopStream.bind(this)),i.get().addEventListener(i.events.RECORD_INFO,this._onRecordInfo.bind(this)));if(this._conversation&&this._conversation.direction===b.callDirection.INCOMING){i.get().incoming();}this._subscribeChatMessages();return this;},_setConversation:function(z,y){this._conversation=Object.assign(z,{userId:z.userId,entityType:z.entityType,compositeUserId:u.composeId(z.userId,z.entityType),participants:y.participants||[],topology:y.topology||w.topology.DIRECT,features:y.features||[],participantsLimit:y.participantsLimit||30,acceptTime:y.acceptTime,recordInfo:y.recordInfo,needRate:false});x.setChatId(z.conversationId);n.setCallInProgress(true);this._changeFeatureSet();this._logDevices();return this._conversation;},_createMediaSource:function(){this._mediaSource=new s(this._params);this._listeners.push(this._mediaSource.addEventListener(s.events.SOURCE_CHANGED,this._onLocalMediaStreamChanged.bind(this)));},_createSignaling:function(y){this._signaling=new k(y.endpoint,this._params);this._listeners.push(this._signaling.addEventListener(k.events.NOTIFICATION,this._onSignalingNotification.bind(this)),this._signaling.addEventListener(k.events.FAILED,this._onSignalingFailed.bind(this)));},_registerParticipants:function(y){y.participants.forEach(function(z){var A=u.composeParticipantId(z);if(String(z.id)===y.userId&&z.idType===y.entityType){return;}if(z.state===b.participant.HUNGUP||z.state===b.participant.REJECTED){this._deferredRemoveParticipant(z,b.hangupType.HUNGUP);return;}this._participants[A]=v({id:A,mediaSettings:z.mediaSettings,state:z.state});}.bind(this));return y;},_allocateTransport:function(A){this._transport=new w(A.topology,this._signaling,this._mediaSource,Object.assign({},this._params,{iceServers:A.iceServers}));this._listeners.push(this._transport.addEventListener(w.events.STATE_CHANGED,this._onTransportStateChanged.bind(this)),this._transport.addEventListener(w.events.REMOTE_TRACK_ADDED,this._onRemoteTrackAdded.bind(this)),this._transport.addEventListener(w.events.REMOTE_STREAM_REMOVED,this._onRemoteStreamRemoved.bind(this)),this._transport.addEventListener(w.events.REMOTE_STREAM_STALL,this._onRemoteStreamStall.bind(this)));var z=A.direction===b.callDirection.OUTGOING&&!A.concurrent;for(var B in this._participants){var y=this._participants[B];if(y.state===b.participant.ACCEPTED||y.state===b.participant.CALLED){this._transport.allocate(y.id,z);}}return A;},_createVolumeDetector:function(y){if(!this._embed){this._volumesDetector=new g(this._transport,this._params.voiceParams);}return y;},_createSpeakerDetector:function(y){if(!this._embed){this._speakerDetector=new d(this._volumesDetector,this._params.voiceParams);this._listeners.push(this._speakerDetector.addEventListener(d.events.SPEAKER_CHANGED,this._onSpeakerChanged.bind(this)));}return y;},_createDebugInfo:function(y){if(!this._embed){this._debugInfo=new t(this._transport,this._volumesDetector);this._listeners.push(this._debugInfo.addEventListener(t.events.DEBUG_INFO_UPDATED,this._onDebugInfoUpdate.bind(this)),this._debugInfo.addEventListener(t.events.DEBUG_INFO_LOCAL_UPDATED,this._onDebugInfoLocalUpdate.bind(this)));}return y;},_createSpecListener:function(y){if(!this._embed){this._specListener=new m(this._transport,this._volumesDetector,this._participants,this._params.specListenerParams);}return y;},_logDevices:function(){var y=c.getCameras().length,z=c.getMicrophones().length;r.debug("Cameras: "+y+(c.hasCameraPermission()?"":"")+", Microphones: "+z+(c.hasMicrophonePermission()?"":""))();x.log(b.stat.DEVICES,y+"_"+z);},accept:function(z){x.log(b.stat.ACCEPT_INCOMING,z?"video":"audio");r.debug("Accept incoming call",{withVideo:z})();var y=this;this._mediaSource.request(z).then(function(){return y._signaling.acceptCall(y._mediaSource.getMediaSettings());}).then(function(){i.get().accepted();i.get().setLocalVideo(y._mediaSource.getStream(),y._mediaSource.getMediaSettings());i.get().setStartTime(y._conversation.acceptTime);y._toggleJoinAvailability();y._changeFeatureSet();y._changeNeedRate();y._setRecordInfo(y._conversation.recordInfo);y._state=o.state.ACTIVE;y._participantState=b.participant.ACCEPTED;y._changeFeatureSet();for(var B in y._participants){var A=y._participants[B];if(A.state===b.participant.CALLED||A.state===b.participant.ACCEPTED){if(!y._transport.isAllocated(A.id)){y._transport.allocate(A.id,true);}}if(A.state===b.participant.ACCEPTED){y._transport.open(A.id,null);}}})["catch"](function(A){r.error("Unable to accept call",A)();y.close(A);});},decline:function(){r.debug("Decline incoming call")();x.log(b.stat.DECLINE_INCOMING,this._mediaSource.getMediaSettings().isVideoEnabled?"video":"audio");this._participantState=b.participant.HUNGUP;if(this._signaling){this._signaling.hangup(b.hangupType.REJECTED);}this.close({hangup:b.hangupType.REJECTED});},hangup:function(){r.debug("Hangup")();var y=this._state===o.state.ACTIVE?b.hangupType.HUNGUP:b.hangupType.CANCELED;x.log(b.stat.HANGUP,y);if(this._signaling){this._signaling.hangup(y);this.close({hangup:y});}else{i.get()&&i.close();}},addParticipant:function(y){this._signaling.addParticipant(y).then(function(A){var z=null;if(A.type==="error"){if(A.error==="call-unfeasible"){z=A.status;}else{z="unknown";}}this._onAddParticipant(y,z);}.bind(this));},getParticipantsList:function(){var y=[];Object.values(this._participants).forEach(function(z){if(z.state!==b.participant.HUNGUP&&z.state!==b.participant.REJECTED){y.push(u.decomposeId(z.id).id);}});return y.sort(function(A,z){return this._conversation.opponentId===z?1:0;}.bind(this));},removeParticipant:function(y){this._signaling.removeParticipant(y).then(this._onRemoveParticipant.bind(this,y));},close:function(A){r.debug("Close conversation",{reason:A})();if(A.access||A.feasibility){x.log(b.stat.ERROR,A.access||A.feasibility);}if(A instanceof Error||A.access){this._signaling&&this._signaling.hangup(b.hangupType.FAILED);}if(A instanceof Error||this._params.reportOnClose){r.report();}if(A.hangup===b.hangupType.CANCELED||(A.hangup===b.hangupType.REJECTED&&!A.remote)){this.destroy();return;}if(A.hangup===b.hangupType.HUNGUP&&A.remote&&this._participantState===b.participant.CALLED){this.destroy();return;}if(A.hangup===b.hangupType.MISSED&&!A.remote){this.destroy();return;}n.setCallInProgress(false);if(A.hangup===b.hangupType.BUSY&&!A.remote){this._cleanupSignaling();this._cleanupMediaSource();return;}this._state=o.state.CLOSE;this._participantState=b.participant.HUNGUP;this._changeFeatureSet();this._cleanupMediaSource();this._cleanupParticipants();this._cleanupTransport();this._cleanupVolumeDetector();this._cleanupSpeakerDetector();this._cleanupDebugInfo();this._cleanupSpecListener();this._cleanupSignaling();var y=A.hangup||A.access||A.feasibility||b.error.UNKNOWN,z=this._conversation&&this._conversation.conversationId;i.get()&&i.get().lastScreen(y,z);},destroy:function(){r.debug("Destroy conversation",{conversationId:this._conversation&&this._conversation.conversationId})();this._cleanupMediaSource();this._cleanupParticipants();this._cleanupTransport();this._cleanupVolumeDetector();this._cleanupSpeakerDetector();this._cleanupDebugInfo();this._cleanupSpecListener();this._cleanupSignaling();this._unsubscribeChatMessages();this._cleanupListeners();this._cleanupTimeouts();h=null;i.get()&&i.close();n.setCallInProgress(false);},_deferredRemoveParticipant:function(y,z){i.get()&&i.get().setStatus(y.id,z);this._timeouts.push(setTimeout(function(A){if(y.state!==b.participant.CALLED&&y.state!==b.participant.ACCEPTED&&A._state!==o.state.CLOSE){i.get()&&i.get().removeRemoteVideo(y.id);delete A._participants[y.id];}},this._params.hideLeftParticipantDelay,this));},_cleanupTimeouts:function(){this._timeouts.forEach(function(y){clearTimeout(y);});this._timeouts=[];},_cleanupListeners:function(){this._listeners.forEach(function(y){y.dispose();});},_cleanupMediaSource:function(){if(this._mediaSource){this._mediaSource.destroy();this._mediaSource=null;}},_cleanupParticipants:function(){Object.values(this._participants).forEach(function(y){if(y.remoteStream){y.remoteStream.getTracks().forEach(function(z){z.stop();});}}.bind(this));this._participants={};},_cleanupTransport:function(){if(this._transport){this._transport.destroy();this._transport=null;}},_cleanupVolumeDetector:function(){if(this._speakerDetector){this._speakerDetector.destroy();this._speakerDetector=null;}},_cleanupSpeakerDetector:function(){if(this._volumesDetector){this._volumesDetector.destroy();this._volumesDetector=null;}},_cleanupDebugInfo:function(){if(this._debugInfo){this._debugInfo.destroy();this._debugInfo=null;}},_cleanupSpecListener:function(){if(this._specListener){this._specListener.destroy();this._specListener=null;}},_cleanupSignaling:function(){if(this._signaling){this._signaling.close();this._signaling=null;}},_onAddParticipant:function(B,A){r.debug("Add new participant ["+B+"]")();var z=this;var y=this._participants[B];if(y&&(y.state===b.participant.ACCEPTED||y.state===b.participant.CALLED)){r.warn("Participant ["+y.id+":"+y.state+"] is already in conversation")();return;}if(!y){this._participants[B]=v({id:B});y=this._participants[B];}i.get().addParticipant(y.id).then(function(){if(A){y.state=b.participant.HUNGUP;z._deferredRemoveParticipant(y,A);}else{y.state=b.participant.CALLED;this._transport.allocate(y.id,true);}}.bind(this));},_onRemoveParticipant:function(z){r.debug("Remove participant ["+z+"]")();var y=this._participants[z];if(!y){r.warn("Participant ["+z+"] isn't in conversation")();return;}this._transport.close(y.id);},_onChangeDevice:function(y){if(this._mediaSource){this._mediaSource.changeDevice(y);}},_onToggleVideo:function(y){if(this._mediaSource){this._mediaSource.toggleVideo(y);}},_onToggleAudio:function(y){if(this._mediaSource){this._mediaSource.toggleAudio(y);}},_onChangePriorities:function(y){if(Object.keys(y).length>1){this._signaling.send("change-streams-priorities",{typedPriorities:y})["catch"](function(){});}},_onStartStream:function(z){var y=this;this._signaling.startStream(z).then(function(A){if(A.error){y._setRecordInfo();}});},_onStopStream:function(){var y=this;this._signaling.stopStream().then(function(z){if(z.error){y._setRecordInfo();}});},_onRecordInfo:function(){this._signaling.getRecordStatus().then(function(y){i.get()&&i.get().setRecordPreview(y.recordMoviePreviewUrl,y.recordMovieId);});},_onLocalMediaStreamChanged:function(y){r.debug("Local media stream changed",y.mediaSettings)();i.get().updateLocalVideo(y.mediaSettings,y.kind);this._signaling.changeMediaSettings(y.mediaSettings);},_changeRemoteMediaSettings:function(A,z){r.debug("Remote media settings changed ["+A+"]",z)();var y=this._participants[A];if(!y){return;}y.mediaSettings=z;if(y.remoteStream&&y.remoteVideoTrack&&z.isVideoEnabled){y.remoteStream.addTrack(y.remoteVideoTrack);y.remoteVideoTrack=null;}if(i.get()&&this._state===o.state.ACTIVE){i.get().changeRemoteMediaSettings(A,z);}if(this._specListener){this._specListener.onChangeRemoteMediaSettings(A,z);}},_onSignalingNotification:function(y){switch(y.notification){case k.notifications.ACCEPTED_CALL:return this._onAcceptedCall(y);case k.notifications.HUNGUP:return this._onHungup(y);case k.notifications.PARTICIPANT_ADDED:return this._onAddedParticipant(y);case k.notifications.PARTICIPANT_JOINED:return this._onJoinedParticipant(y);case k.notifications.CLOSED_CONVERSATION:return this._onClosedConversation(y);case k.notifications.MEDIA_SETTINGS_CHANGED:return this._onMediaSettingsChanged(y);case k.notifications.RATE_CALL_DATA:return this._onNeedRate();case k.notifications.FEATURE_SET_CHANGED:return this._onFeatureSetChanged(y);case k.notifications.MULTIPARTY_CHAT_CREATED:return this._onMultipartyChatCreated(y);case k.notifications.FORCE_MEDIA_SETTINGS_CHANGE:return this._onForceMediaSettingsChange(y);case k.notifications.REGISTERED_PEER:return this._onPeerRegistered(y);case k.notifications.RECORD_STARTED:return this._onRecordStarted(y);case k.notifications.RECORD_STOPPED:return this._onRecordStopped(y);}},_onSignalingFailed:function(y){r.error("Signaling failed",y)();this.close(y);},_onAcceptedCall:function(A){var B=u.composeMessageId(A),z=u.getPeerIdString(A.peerId);r.debug("Participant accepted call ["+B+"]")();if(B===this._conversation.compositeUserId){i.close();return;}var y=this._participants[B];if(!y){this._participants[B]=v({id:B,mediaSettings:A.mediaSettings});y=this._participants[B];}y.state=b.participant.ACCEPTED;if(this._conversation.direction===b.callDirection.OUTGOING&&this._state===o.state.IDLE){this._state=o.state.ACTIVE;this._changeFeatureSet();}if(this._state===o.state.ACTIVE){this._transport.open(y.id,z);}this._changeRemoteMediaSettings(B,A.mediaSettings);},_onHungup:function(A){var B=u.composeMessageId(A);r.debug("Participant hungup ["+B+"]",{reason:A.reason})();var z=this;if(A.reason===b.hangupType.FAILED){r.report();}if(this._conversation.compositeUserId===B){this.close({hangup:A.reason});return;}var y=this._participants[B];if(!y){r.warn("Participant ["+B+"] isn't in conversation")();return;}this._transport.close(B);y.state=A.reason===b.hangupType.REJECTED?b.participant.REJECTED:b.participant.HUNGUP;if(this._state===o.state.IDLE||this._state===o.state.ACTIVE){z._deferredRemoveParticipant(y,A.reason);}},_onAddedParticipant:function(z){var A=u.composeMessageId(z);r.debug("Participant added ["+A+"]")();var y=this._participants[A];if(y&&y.state!==b.participant.HUNGUP&&y.state!==b.participant.REJECTED){r.debug("Participant ["+A+"] is already in conversation and is active")();return;}if(!y){this._participants[A]=v({id:A});y=this._participants[A];}y.state=b.participant.CALLED;i.get().addParticipant(A).then(function(){if(this._state===o.state.ACTIVE){this._transport.allocate(y.id,true);}if(y.remoteStream&&i.get()){i.get().setRemoteVideo(y.id,y.remoteStream);}}.bind(this));},_onJoinedParticipant:function(z){var A=u.composeMessageId(z);r.debug("Participant joined ["+A+"]")();var y=this._participants[A];if(y&&y.state===b.participant.ACCEPTED){r.debug("Participant ["+A+"] is already in conversation and is active")();return;}if(!y){this._participants[A]=v({id:A,mediaSettings:z.mediaSettings});y=this._participants[A];}if(this._conversation.direction===b.callDirection.OUTGOING&&this._state===o.state.IDLE){this._state=o.state.ACTIVE;this._changeFeatureSet();}y.state=b.participant.ACCEPTED;i.get().addParticipant(A).then(function(){if(this._state===o.state.ACTIVE){this._transport.allocate(y.id,true);this._transport.open(y.id,null);}if(y.remoteStream&&i.get()){i.get().setRemoteVideo(y.id,y.remoteStream);}this._changeRemoteMediaSettings(A,z.mediaSettings);}.bind(this));},_onClosedConversation:function(y){this._toggleJoinAvailability();this.close({hangup:y.reason,remote:true});},_onMediaSettingsChanged:function(y){var z=u.composeMessageId(y);this._changeRemoteMediaSettings(z,y.mediaSettings);},_onNeedRate:function(){this._conversation.needRate=true;this._changeNeedRate();},_onFeatureSetChanged:function(y){this._conversation.features=y.features;this._changeFeatureSet();},_onMultipartyChatCreated:function(y){this._conversation.chatId=y.chatId;this._toggleJoinAvailability();},_onForceMediaSettingsChange:function(z){var y=this._mediaSource.getMediaSettings();if(y.isAudioEnabled!==z.mediaSettings.isAudioEnabled){this._mediaSource.toggleAudio(z.mediaSettings.isAudioEnabled);}if(y.isVideoEnabled!==z.mediaSettings.isVideoEnabled){this._mediaSource.toggleVideo(z.mediaSettings.isVideoEnabled);}},_onPeerRegistered:function(y){var z=u.composeMessageId(y);if(this._participants[z]){this._participants[z].clientType=y.clientType;this._participants[z].platform=y.platform;}},_onRecordStarted:function(y){this._conversation.recordInfo=y.recordInfo;this._setRecordInfo(y.recordInfo);},_onRecordStopped:function(){this._setRecordInfo();},_setRecordInfo:function(y){i.get()&&i.get().setRecordInfo(y||null);},_changeFeatureSet:function(){var z=i.get();if(!z||!this._conversation){return;}var y=this._state===o.state.ACTIVE,B=this._conversation.features.indexOf(b.features.ADD_PARTICIPANT)>=0,A=this._conversation.participantsLimit;z.onCallStateChanged(y,B,A);},_changeNeedRate:function(){var y=i.get();if(y&&this._conversation.needRate){y.needRate();}},_applyGroupSettings:function(y){this._signaling.send("get-group-settings",{groupId:y}).then(function(z){if(z.settings){var A=i.get();A&&A.applyGroupSettings(z.settings);}})["catch"](function(){});},_onSpeakerChanged:function(y){i.get()&&i.get().setSpeaker(y);},_onTransportStateChanged:function(A,z){var y=this._participants[A];if(!y){r.warn("Participant "+A+" isn't in conversation")();return;}r.debug("Transport state for participant "+A+" has changed: "+z)();if(z===w.states.CONNECTED){i.get().connected(A);}if(z===w.states.CONNECTING){i.get().connecting(A);}if(z===w.states.RECONNECTING){i.get().reconnect(A);}if(z===w.states.FAILED){if(this._transport.allocated().length===0){this._signaling.hangup(b.hangupType.FAILED);this.close(new Error("Transport failed"));}else{}}if(z===w.states.CLOSED){}},_onRemoteTrackAdded:function(B,A,z){r.debug("Remote track added on the participant ["+B+"]",{kind:z&&z.kind})();var y=this._participants[B];if(!y){r.warn("Conversation: track not added - unknown participant ["+B+"]")();return;}if(y.remoteStream!==A){y.remoteStream=A;i.get().setRemoteVideo(B,A);}if(y.mediaSettings){if(z&&!y.mediaSettings.isVideoEnabled&&z.kind==="video"){y.remoteVideoTrack=z;y.remoteStream.removeTrack(z);}this._changeRemoteMediaSettings(B,y.mediaSettings);}},_onRemoteStreamRemoved:function(B,A){r.debug("Remote stream removed on the participant ["+B+"]")();var z=this._participants[B],y=this;if(!z){r.warn("Stream remove on unknown participant ["+B+"]")();return;}z.remoteStream=null;y._deferredRemoveParticipant(z,b.hangupType.HUNGUP);},_onRemoteStreamStall:function(y,z){Object.values(this._participants).forEach(function(A){if(A.remoteStream){A.remoteStream.getAudioTracks().forEach(function(B){if(B.id===y.id){if(z){i.get().reconnect(A.id);}else{i.get().connected(A.id);}}});}});},_checkBadNetwork:function(D){var z=false,y=true,C={audio:{down:this._params.badConnectionAudioBitrate*(1-a),up:this._params.badConnectionAudioBitrate*(1+a),last:this._outBandwidth.audio,current:0},video:{down:this._params.badConnectionVideoBitrate*(1-a),up:this._params.badConnectionVideoBitrate*(1+a),last:this._outBandwidth.video,current:0}};for(var B=0;B<D.length;B++){var A=D[B];if(!A.bandwidth||!A.kind){continue;}if(C.hasOwnProperty(A.kind)){var E=C[A.kind];this._outBandwidth[A.kind]=E.current=A.bandwidth;if(E.current<E.down&&E.last&&E.last<E.down){z=true;}if(E.current<=E.up&&E.last&&E.last<=E.up){y=false;}}}if(z&&this._outBandwidth.good){i.get().toggleBadNetwork(true);this._outBandwidth.good=false;}else{if(y&&!this._outBandwidth.good){i.get().toggleBadNetwork(false);this._outBandwidth.good=true;}}},_onDebugInfoUpdate:function(z,y){i.get().displayStats(z,y);},_onDebugInfoLocalUpdate:function(y){this._checkBadNetwork(y.outbound.rtps);i.get().displayLocalStats(y);},_toggleJoinAvailability:function(){var z=!!this._conversation.chatId&&this._state!==o.state.CLOSE,y=this._conversation.chatId;if(i.get()){r.debug("Toggle join availability",{available:z,chatId:y})();i.get().toggleJoinAvailability(z,y);}},_subscribeChatMessages:function(){var y=this;function z(C){if(!C.updatedConversations||!y._conversation){return;}var B=y._conversation.chatId,A=y._conversation.opponentId,D;if(B){D="CHAT_"+B;}else{if(A){D="PRIVATE_"+A;}}if(!D){return;}if(C.updatedConversations&&C.updatedConversations[D]){i.get()&&i.get().setNewMessages(C.updatedConversations[D].newCommentsCount);}if(C.convInfoUpdates&&C.convInfoUpdates[D]){if(C.convInfoUpdates[D].hasCall===false){y._toggleJoinAvailability();}}}if(require.defined("OK/messages/MessagesPushController")||!require.defined("OK/messages2/push")){require(["OK/messages/MessagesPushController"],function(A){j=A.register({name:"videoChatLayer",priority:A.priority.low,applyNews:z});});}else{require(["OK/messages2/push"],function(A){j=A.subscribe(z);});}},_unsubscribeChatMessages:function(){if(j){j();j=null;}}};return o;});define("OK/videochat/Chat",["OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/UI","OK/videochat/Conversation","OK/videochat/Enums"],function(d,a,e,c,f){var b=a.get("OK/videochat/Chat");return{onPush:function(h){b.debug("Push received",{msg:h})();try{new c(h.params).onPush(h.conversation,false);}catch(g){b.error(g.message,g)();b.report();}},activateUI:function(j){var l=j.getAttribute("data-conversation-id"),q=j.getAttribute("data-opponent-id"),n=j.getAttribute("data-opponent-type"),k=j.getAttribute("data-chat-id"),h=JSON.parse(j.getAttribute("data-params")),g=JSON.parse(j.getAttribute("data-conversation")),p=j.getAttribute("data-direction"),i=j.getAttribute("data-video")==="true";b.debug("Activate ui",{conversationId:l,opponentId:q,opponentType:n,chatId:k,params:h,conversation:g,direction:p,withVideo:i});try{var m=c.current();if(m&&p!==f.callDirection.INCOMING){b.warn("Chat: there is already active conversation: "+m)();return;}if(p===f.callDirection.INCOMING){if(g){m=new c(h);}if(!e.get()){e.set(new e(j,m._params));}m.bindUI();g&&m.onPush(g,true);}else{if(p===f.callDirection.OUTGOING){m=new c(h);if(!e.get()){e.set(new e(j,h));m.bindUI();}m.onStart(l,q,n,k,i);}else{if(p===f.callDirection.JOINING){m=new c(h);if(!e.get()){e.set(new e(j,h));m.bindUI();}m.onJoin(l,k,i);}else{b.error("Chat: unexpected value for direction: "+p)();}}}}catch(o){b.error(o.message,o)();b.report();}},deactivateUI:function(){if(e.get()){e.get().destroy();e.set(null);}if(c.current()){c.current().destroy();}d.addStatVars({referer:null});},activateRecordUI:function(g){if(e.get()){e.get().activateRecord(g);}},deactivateRecordUI:function(g){if(e.get()){e.get().deactivateRecord(g);}},sendReport:function(){return b.report();}};});define("OK/videochat/EmbedChat",["OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/UI","OK/videochat/Conversation","OK/videochat/Enums"],function(d,a,f,c,h){var b=a.get("OK/videochat/EmbedChat");function e(){if(c.current()){c.current().hangup();if(f.get()){f.get().clickHangup();f.get().destroy();f.set(null);}d.addStatVars({referer:null});}}function g(){try{e();var j=document.querySelector(".call-widget"),i=j.getAttribute("data-opponent-id"),n=j.getAttribute("data-opponent-type"),o=JSON.parse(j.getAttribute("data-params")),m=j.getAttribute("data-video")==="true";b.debug("startConversation",{opponentId:i,opponentType:n,params:o,withVideo:m});var l=new c(o);if(!f.get()){f.set(new f(j,o));}l.onStart(null,i,n,null,m);}catch(k){b.error(k.message,k)();e();b.report();}}return{activate:function(){document.querySelector(".call-widget_call-btn").addEventListener("click",g);document.querySelector(".call-widget_decline-btn").addEventListener("click",e);}};});define("OK/videochat/CallerBlockConfirm",["OK/utils/dom"],function(b){function a(h){var f=h.target.previousElementSibling,g=f&&f.getAttribute("data-linkClass"),j=g&&OK.hookModel.getHookById("AltGroupCallHistory"),c=j&&b.byClass(j.element,g);if(c){for(var d=c.length-1;d>-1;--d){c[d].classList.add("invisible");}}}return{activate:function(c){c.nextElementSibling.addEventListener("click",a);},deactivate:function(c){c.nextElementSibling.removeEventListener("click",a);}};});define("b/videochat",["OK/videochat/flash/VideoChat","OK/videochat/flash/FlashDriver","OK/videochat/flash/VideoChatIntegration","OK/videochat/transport/DirectTransport","OK/videochat/transport/ServerTransport","OK/videochat/transport/Transport","OK/videochat/transport/Statistics","OK/videochat/transport/StatLogger","OK/videochat/EventEmitter","OK/videochat/Capturer","OK/videochat/Chat","OK/videochat/EmbedChat","OK/videochat/Conversation","OK/videochat/Enums","OK/videochat/Logger","OK/videochat/Tracer","OK/videochat/UIRemoteVideo","OK/videochat/UIStreaming","OK/videochat/VolumeDetector","OK/videochat/MediaSource","OK/videochat/Signaling","OK/videochat/UI","OK/videochat/CallerBlockConfirm","OK/videochat/Utils"],{});