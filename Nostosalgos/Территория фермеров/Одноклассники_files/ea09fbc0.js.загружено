define(["jquery","OK/utils/utils","OK/logger","OK/StickerOnSmileSuggester","OK/utils/dom","OK/utils/vanilla"],function(g,A,D,b,y,u){var z,s,k,e,E,p=false,x="data-code",q="mouseenter.suggestOnSmiles",d="PostcardsSearch_field_query",B="__hidden",j=33;var l=(function(){if(window.getSelection){return function(G){var I=window.getSelection();I.removeAllRanges();for(var H=0,F=G.length;H<F;++H){I.addRange(G[H]);}};}else{if(document.selection&&document.selection.createRange){return function(F){if(F){F.select();}};}}})();var r=(function(){if(window.getSelection){return function(){var I=window.getSelection(),G=[];if(I.rangeCount){for(var H=0,F=I.rangeCount;H<F;++H){G.push(I.getRangeAt(H));}}return G;};}else{if(document.selection&&document.selection.createRange){return function(){var F=document.selection;return(F.type.toLowerCase()!=="none")?F.createRange():null;};}}})();var m=(function(){if(window.getSelection){return function(J){var F,L=window.getSelection();var I=typeof J==="string"?document.createTextNode(J):J;if(L.getRangeAt&&L.rangeCount){var K=" ",M=L.anchorNode&&L.anchorNode.nodeType===3&&L.anchorNode.textContent.indexOf(K,this.length-K.length)!==-1,H=document.createTextNode(K),G=H.cloneNode(false);F=L.getRangeAt(0);F.deleteContents();F.insertNode(H);F.insertNode(I);if(L.anchorOffset!==0&&!M){F.insertNode(G);}F.setStart(I,0);window.setTimeout(function(){F=document.createRange();F.setStartAfter(I);F.collapse(true);L.removeAllRanges();L.addRange(F);},0);}};}else{if(document.selection&&document.selection.createRange){return function(G){var F=document.selection.createRange();if(typeof G==="string"){F.text=G;}else{F.pasteHTML(G.outerHTML);}};}}})();var n=function(H){if(H&&H.indexOf("#u")===0){var G=/[a-fA-F0-9]+/g,F=H.match(G);return F&&F[0];}return H;},c=function(G,J,I){G=n(G);var H=o.instance&&o.instance.emojiarea.options.stickerSource();var F;if(o.instance&&typeof o.instance.emojiarea.options.friendId!=="undefined"){F=o.instance.emojiarea.options.friendId();}A.ajax({url:"/dk?cmd=PopLayer",data:{"st.layer.cmd":"PopLayerPaymentWizardOuter","st.layer.srv":I,"st.layer.t2nd":"off","st.layer.redirect":"","st.layer.stFrId":F,"st.layer.stCode":G,"st.layer.stPlace":H,"st.layer.stSection":"main","st.layer.stJsCb":"sendStickerCb","st.layer.origin":"34"}}).done(function(L,K,M){A.updateBlockModelCallback(L,K,M);s=J;});},f=function(F,G){F=n(F);A.ajax({url:"/dk?cmd=PopLayer",data:{"st.layer.cmd":"StickersVitrine","st.layer.code":F}}).done(function(I,H,J){A.updateBlockModelCallback(I,H,J);s=G;});},v=function(G){var H="StickerSuggester",F=G.parents(".js-smile-st-suggest"),I;if(F.size()){D.success(H,"sticker",n(G.attr(x)));I=F.parents(".comments_smiles_i").find(".emoji").attr("alt");D.success(H,"smile",I);}},i=function(G){var I=o.instance.emojiarea.menu.$menu,F=I.userSmilesServicePurchased,H=I.userSmilesServiceCheckTime<(Date.now()-o.instance.checkServiceTimeout);if(F&&!H){return;}A.ajax({url:"/dk?cmd=UserSmile&action=service"}).done(function(K,O,M){var J;try{J=JSON.parse(K.replace(/<!--/ig,"").replace(/-->/ig,""));}catch(L){D.success("ta","emojiDef","smilesCheckParse");}var N=J&&J.available;if(!N&&G){c(undefined,undefined,"19");}I.userSmilesServiceCheckTime=Date.now();I.userSmilesServicePurchased=N;}).fail(function(J,L,K){D.success("ta","emojiDef","smilesCheck");});},h=function(F){E=F;o.instance.setCurrent(F);},a=function(H,G){if(H&&G){var F=y.getParentsAttrValue(H,"data-sticker-place",G);return F?{stickerPlace:F}:null;}return null;};var C={defaults:{menu:g("#hook_Block_Smiles"),button:g(""),onShow:g.noop,onHide:g.noop,postFunction:null,commentsWrapperEl:null,scrollingContainer:window,emojiOnly:false,stickerSuggester:null,needStickerOnSmileSuggester:false,postcardsEnabled:false,direction:"top-left bottom-left",onSuggestSend:g.noop,hoverDelay:600}};g.fn.emojiarea=function(F){var G=0;try{F=g.extend({},C.defaults,F);G=1;return this.each(function(){g(this).data("emojiarea",new t(g(this),F));});}catch(H){D.success("messagesLayer","e.emojiarea_"+G);}};g.fn.emojiareaOff=function(){return this.each(function(){var F=g(this).data("emojiarea");if(F){F.destroy();}g(this).removeData("emojiarea");});};var t=function(J,G){var F=this,H=0;try{this.options=G;this.$textarea=J;this.$editor=J;H=1;this.$editor.on("blur keyup paste",function(){return F.onChange.apply(F,arguments);});H=2;try{H=20;if(OK.util.isGecko()){H=21;if(document.queryCommandSupported&&document.queryCommandSupported("enableObjectResizing")){H=22;this.$editor.on("mousedown focus",function(){H=23;document.execCommand("enableObjectResizing",false,false);});H=24;this.$editor.on("blur",function(){H=25;document.execCommand("enableObjectResizing",true,true);});}}}catch(I){D.success("messagesLayer","e.objectResizing_"+H);}H=6;this.setup();H=7;this.$button.on("mousedown",function(){H=8;if(F.hasFocus){H=8;F.selection=r();}});H=9;this.$textarea.on("change mouseup keyup",function(){if(F.hasFocus){H=10;F.selection=r();}});}catch(I){D.success("messagesLayer","e.emojiareaWYS_"+H);}};t.prototype={setup:function(){var G=0;try{var F=this;G=1;F.hasFocus=this.$editor.is(":focus");G=2;this.$editor.on("focus",function(){G=3;F.hasFocus=true;});G=4;this.$editor.on("blur",function(){G=5;F.hasFocus=false;});G=6;this.setupButton();}catch(H){D.success("messagesLayer","e.emojiareaSetup_"+G);}},destroy:function(){g(this.options.commentsWrapperEl).off();g(this.options.stickerSuggester).off();this.$editor.off();this.$button.off();},setupButton:function(){var K=0;try{var G=this,L=this.$button=this.options.button,J,I=L.hasClass("js-comments_smiles_hover"),F,H;L.isAjaxMenu=!!L.attr("data-ajax-menu");K=1;G.menu=new o(G);K=2;J=function(N){if(!G.menu.visible){G.menu.show(G);}else{if(N){G.menu.hide();}}};K=3;L.click(function(N){J(!I);D.success("discussions.emojiButton",false);N.preventDefault();N.stopPropagation();}).mouseover(function(){if(I){clearTimeout(H);F=setTimeout(function(){J(false);D.success("discussions.emojiButton",false);},G.options.hoverDelay);}});K=4;if(I){L.mouseout(function(){clearTimeout(F);H=setTimeout(function(){G.menu.hide();},300);});}L.showRecentGifts=!!L.attr("data-show-gifs");G.menu.setupExternalSticker(G);}catch(M){D.success("messagesLayer","e.emojiareaButton_"+K);}},hideMenu:function(){this.menu.hide();},onChange:function(){var F=this;setTimeout(function(){F.$textarea.trigger("change").trigger("textchange").trigger("autosize.resize");},1);},insert:function(H){var F=this,K=H.hasClass("usmile __sticker");o.instance.logRecent(H,K);if(K){F.sendSticker(H[0]);v(H);D.success("ta","sticker");return;}var J=H.attr("alt");if(J&&J.indexOf("#u")===0){var M=n(J),L=o.instance.isFree(M);if(!L){i(true);}var G=L?M:null;D.success("ta","userSmile",G);}else{D.success("ta","sml",J);}H=H.clone();if(H[0].attachEvent){H[0].attachEvent("onresizestart",function(N){N.returnValue=false;},false);}if(window.getSelection){this.$editor.trigger("focus");}else{this.$editor[0].focus();}if(this.selection){l(this.selection);}try{m(H[0]);}catch(I){}o.instance.addRecent(H.attr("alt"),false);this.options.smileInserted&&this.options.smileInserted();this.onChange();},send:function(H,J){var F=this.options.postFunction,I=J?J.stickerPlace:null,G=J?J.isSmile:false;if(F===null){OK.editor.el.bridge.send(H);}else{F({content:H,stickerPlace:I,isSticker:!G});}},sendSticker:function(I,H){var G=this,J=I.getAttribute(x),F=o.instance.isBuySets,L=a(I,H),K=function(){G.send(J,L);};e=function(M){if(F&&M!=j){f(J,K);}else{c(J,K,M);}};K();o.instance.addRecent(J,true);G.menu.hide();},sendLiveSticker:function(H,G){var F=this,I=H.getAttribute(x),J=a(H,G);k=function(){c(I,function(){D.success("ta","pcard.send.payed",I);F.send(I,J);},"22");};D.success("ta","pcard.send",I);F.send(I,J);F.menu.hide();}};var o=function(G){if(typeof o.instance==="object"){return o.instance;}var F=this;if(G.$button.isAjaxMenu||G.options.menu.length==0){A.ajax({url:"/dk?cmd=Smiles",timeout:10000},3).fail(function(){D.success("ta","emojiDef","ajaxfail");F.setupMenu(G);}).done(function(I,H,J){if(I){F.setupMenu(G,g(I));}else{D.success("ta","emojiDef","nodata");F.setupMenu(G);}});}else{F.setupMenu(G);}return this;};o.prototype={setupMenu:function(I,H){var F=this;this.itemsCache={};this.visible=false;this.emojiarea=I;this.emojiarea.menu=this;this.tabOpenListeners=[];if(!this.emojiarea.options.menu.length&&H==null){D.success("ta","emojiDef","noblock");return;}var G=H||this.emojiarea.options.menu.contents();F.freeSmiles=[];F.checkServiceTimeout=G.data("check-service-timeout");F.isBuySets=G.attr("data-buy-sets")==="true";F.$menu=G.children();if(!F.$menu.size()||!F.emojiarea.$button.size()){D.success("ta","emojiDef","init-e-"+(!F.$menu.size()?"m":"b"));}this.recents={cnt:null,isStickersCnt:false,smilesLimit:G.attr("data-max-recents-sm"),stickersLimit:G.attr("data-max-recents-st"),postponed:[]};F.$menu.on("mousedown click",function(J){if(J.target.id!==d){J.stopPropagation();J.preventDefault();}else{J.stopPropagation();}});F.$menu.on("click",".usmile, .emoji",function(){D.success("ta","emoji");F.emojiarea.insert(g(this));});F.$menu.on("click",".live-sticker",function(){D.success("ta","live-sticker");F.emojiarea.sendLiveSticker(this,F.$menu[0]);});F.$menu.on("click",".js-all-user-smiles",function(){var J=this.getAttribute("data-url");if(J){navigateOnUrlFromJS(J);}});F.$menu.on("click",".js-sticker_play",function(K){K.stopPropagation();K.preventDefault();var J=this;require(["OK/messages/StickerOverlays"],function(L){L.play(J);});});z=function(J){if(require.defined("OK/messages2/app")&&require("OK/messages2/layer").isOpen()){require("OK/messages2/app").insertSmile(J.alt);}else{var L=g("#collection_nav_id_user_smiles .comments_smiles_lst",F.$menu),K=g(".comments_smiles_i:not(.__text)",L).first().clone();K.html(J);L.prepend(K);F.emojiarea.insert(g(J));}};F.$menu.on("click",".js-vitrine",function(L){var K=L.target,J;h(F.emojiarea);while(K){J=K.href;if(J){window.navigateOnUrlFromJS(J);break;}K=K.parentNode;}});require(["OK/emojiScroll","OK/utils/throttle"],function(K,L){var J=F.$menu.get(0);var M;if(J){M=new K();F.emojiScroll=M;J.addEventListener("click",function(O){var N=O.target;if(N.classList.contains("__next")){M.nextRow(O.target,J);}else{if(N.classList.contains("__prev")){M.prevRow(O.target,J);}else{if(N.classList.contains("comments_smiles_tabs_i")){M.resetOffsets();}else{if(N.classList.contains("comments_smiles_nav_a")){M.jumpToSet(N.getAttribute("href"));}else{while(N&&N!=O.currentTarget&&!N.classList.contains("comments_smiles_nav_a")){N=N.parentNode;}if(N&&N!=O.currentTarget){M.jumpToSet(N.getAttribute("href"));}}}}}});J.addEventListener("scroll",L(30,function(N){if(N.target.classList.contains("js-emoji-scroll")){M.switchOnScroll(N.target,J);}}),true);}});F.$onlyMsgTabs=F.getTab(".js-only-msg");F.$noCacheContainers=g(".js-no-cache-cnt",F.$menu);require(["OK/tabs"],function(){var J={loadingClass:"__loading",useHref:true,onLoadFinish:function(K){var L=g(".js-free-ids-info",K).attr("data-free-ids");if(L){F.updateFreeIds(L.split(","));}if(F.visible){OK.loader.execRequire("OK/capture",function(M){M.activate(K[0]);});}},onTabOpened:function(){var N=F.$menu[0].querySelector(".js-tabs-c.__current"),K=N&&N.querySelector("#collection_nav_id_recent_smiles .comments_smiles_lst"),O=N&&N.querySelector("#collection_nav_id_recent_stickers .comments_smiles_lst"),L=F.recents;L.cnt=K||O;L.isStickersCnt=!!O;if(O&&L.postponed.length>0){L.postponed.forEach(function(P){o.instance.addRecent(P,true);});L.postponed=[];}F.activatePostcardsSearch(N);for(var M=0;M<F.tabOpenListeners.length;++M){F.tabOpenListeners[M].call();}}};F.tabs=F.$menu.tabs(J);});OK.stickerVitrineCallback=function(){var J=F.getTab(".__stickers");F.$menu.tabs&&F.$menu.tabs.reloadTab(J);F.emojiScroll&&F.emojiScroll.resetOffsets();};o.instance=this;i(false);},isFree:function(F){return g.inArray(F,this.freeSmiles)>-1;},addTabOpenListener:function(F){this.tabOpenListeners.push(F);},removeTabOpenListener:function(G){var F=this.tabOpenListeners.indexOf(G);if(F>=0){this.tabOpenListeners.splice(F,1);}},updateFreeIds:function(F){if(F&&F.length>0){this.freeSmiles=this.freeSmiles.concat(F);}},getTab:function(F){return g(".js-tabs-t"+F,this.$menu);},openTab:function(G,F){D.success("ta","emojitab",F);this.show(G);this.getTab(F).click();},activatePostcardsSearch:function(H){var G=this;G.postcardsSearchEl=document.getElementById(d);if(G.postcardsSearchEl){G.postcardsSearchEl.focus();var F=y.firstByClass(H,"js-postcard-tags");if(F){F.addEventListener("click",function(J){var I=J.target;if(I.classList.contains("js-tag")){G.changePostcardsQuery(I.innerHTML);}});}}},changePostcardsQuery:function(F){this.postcardsSearchEl.value=F;u.trigger(this.postcardsSearchEl,"keyup");},hide:function(){if(this.emojiarea){this.emojiarea.$button.removeClass("__active");this.emojiarea.$button.off("mousedown.emoji");this.emojiarea.options.onHide.call(this);}g(document.body).off("mousedown.emoji2");this.$menu.removeClass("__bottom");this.visible=false;OK.loader.use(["OKCustomJs"],function(){OK.Layers.remove("emoji");});this.detachMenu();},show:function(af){this.emojiarea=af;var T=this,K=af.options,Y=g(document.body),aa=af.$button,N=T.$menu;T.attachMenu(af);T.emojiScroll&&T.emojiScroll.init();if(af){N.removeClass("__bottom");N.removeClass("__right");aa.addClass("__active");var O=g(K.scrollingContainer),U=N.height(),F=N.width(),W=aa.offset(),V=W?W.left+aa.width():0,S=W?W.top+aa.height():0,M=O.offset(),X=M?M.top:0,Q=M?M.left:0,ac=O.height(),Z=O.width(),J=K.direction,H=J?J.split(" "):[],I=32,R={value:-1000000,direction:["top","left"]};for(var ab=0;ab<H.length;ab++){var ad=H[ab].split("-"),G=ad[0],P=ad.length===2?ad[1]:"left",ag,L;if(G==="top"){ag=S-I-U-X;if(ag>=0){ag=1;}}else{ag=X+ac-(S+U+I);if(ag>=0){ag=1;}}if(P==="left"){L=V-I-F-Q;if(L>=0){L=1;}}else{L=Q+Z-(V+F+I);if(L>=0){L=1;}}var ae=((ag<0||L<0)?-1:1)*Math.abs(ag*L);if(ae>R.value){R={value:ae,direction:[G,P]};}}if(R.direction[0]==="bottom"){N.addClass("__bottom");}if(R.direction[1]==="right"){N.addClass("__right");}}aa.on("mousedown.emoji",function(ah){ah.stopPropagation();});Y.on("mousedown.emoji",".okArtSurpriseWrapper, #PopLayerSelectSmilesWrapper",function(ah){ah.stopPropagation();});Y.on("mousedown.emoji2",function(){T.hide();});T.visible=true;K.onShow.call(this);OK.loader.use(["OKCustomJs"],function(){OK.Layers.register("emoji",T.hide.bind(T),null,false,function(ah){if((ah.which===9||ah.which===13)&&!ah.metaKey&&!ah.altKey&&!ah.shiftKey){T.hide();}});});T.preloadTab();},preloadTab:function(){var G=this.$menu.tabs.getActiveTab(),I=G.length>0,H=I&&G.hasClass("__emoji"),F=I&&G.hasClass("js-no-cache");if(this.emojiarea.options.emojiOnly){if(!H){this.$menu.tabs.activateTab(".__emoji");}}else{if(!I||H){this.$menu.tabs.activateFirstTab();}else{if(F){this.$menu.tabs.reloadTab(G);}}}},activateSuggester:function(){var F=this.$menu,G=this.emojiarea,H;if(G.options.needStickerOnSmileSuggester){if(!F.suggester){H=g(".js-smile-st-suggest")[0];if(H){F.suggester=new b(H);}}if(F.suggester){F.on(q,".comments_smiles_i",function(){var J=g(".emoji",this)[0],I;if(J){clearTimeout(I);I=setTimeout(function(){F.suggester.suggestOnSmile(J);},F.suggester.getDelay());}});}}},toggleRecentGifs:function(){var G=this.$menu,H=this.emojiarea,I=H.$button.showRecentGifts,F="invisible";if(typeof G.$recentGifs==="undefined"){G.$recentGifs=G.find("#collection_nav_id_recent_gifs");G.$recentGifsTab=G.find(".comments_smiles_nav_ic.ic_recent_gifs").closest(".comments_smiles_nav_i");}if(G.$recentGifs.size()>0){G.$recentGifs.toggleClass("comments_smiles_set",I).toggleClass(F,!I);G.$recentGifsTab.toggleClass("comments_smiles_nav_i",I).toggleClass(F,!I);if(I&&p){A.ajax({url:"/dk?cmd=RecentGifs"}).done(function(K,J,L){if(K){var M=G.$recentGifs.children(".stub-empty, .comments_smiles_lst");M.html(K);OK.hookModel.captureBlockHook(OK.hookModel.getNearestBlockHookId(M[0]),M[0]);p=false;}});}}},attachMenu:function(){this.$menu.toggleClass("__emoji",this.emojiarea.options.emojiOnly);if(!g.contains(this.emojiarea.$button[0],this.$menu[0])){this.$menu.appendTo(this.emojiarea.$button);this.togglePostcardsTab();if(this.$menu.$currentTab){this.$menu.$currentTab.scrollTop(this.$menu.$currentTab.data("scroll"));this.$menu.$currentTab.removeData();}var F=this.$menu[0];OK.loader.execRequire("OK/capture",function(G){G.activate(F);});}this.activateSuggester();this.toggleRecentGifs();},detachMenu:function(){var F=this,G=F.$menu;G.$currentTab=G.find(".js-tabs-c.__current .comments_smiles_cnt");G.$currentTab.data("scroll",G.$currentTab.scrollTop());G.off(q,".comments_smiles_i");OK.loader.execRequire("OK/capture",function(H){H.deactivate(G[0]);F.$noCacheContainers.empty();G.detach();});},togglePostcardsTab:function(){var G=this.emojiarea.options.postcardsEnabled,F=!G&&!this.$onlyMsgTabs.hasClass(B);this.$onlyMsgTabs.toggleClass(B,!G);if(F){this.$menu.$currentTab=null;this.openTab(this.emojiarea,".__stickers");}},setupExternalSticker:function(L){var K,J={emojiarea:L},G=L.options.commentsWrapperEl,H=L.options.stickerSuggester;if(G){K=g(G);K.on("click",".js-hello-sticker",J,function(P){P.stopPropagation();var N=this,O=P.data.emojiarea,M=y.getParentsAttrValue(N,"data-sticker-place",G),Q=M?{stickerPlace:M}:null;D.success("ta","helloSticker",n(N.getAttribute(x)));if(N.classList.contains("live-sticker")){O.sendLiveSticker(N,G);}else{O.sendSticker(N,Q);}});K.on("click",".js-action-sticker",J,function(N){var M=this;N.data.emojiarea.sendSticker(M);});if(H){g(H.element).on("click",".__sticker, .live-sticker",J,function(O){var M=this,N=O.data.emojiarea;D.success("ta","stickerSuggest",n(M.getAttribute(x)));if(M.classList.contains("live-sticker")){N.sendLiveSticker(M);}else{N.sendSticker(M);}if(H.isClearOnStickerSend){N.options.onSuggestSend();}H.hide();});}K.on("click",".js-save-current-emojiarea",function(){h(L);});var F=K.find(".js-ta-smiles"),I=F.attr("data-send-on-click");F.on("click","img",function(){var M=this;if(I){L.send(M.alt,{isSmile:true});}else{h(L);z(M);}});}},getItem:function(F){var G=this.itemsCache[F];if(!G){G=g(".comments_smiles_i",this.$menu).eq(F);this.itemsCache[F]=G;}return G;},addRecent:function(F,L){var N=this,K=N.recents,H=g(K.cnt),G=L===K.isStickersCnt,J=L?K.stickersLimit:K.smilesLimit,O,I,M;if(K.cnt&&G){I=L?"div["+x+'="'+F+'"]':'img[alt="'+F+'"]';O=N.$menu.find(I).first();if(O.closest(H).length===0){O=O.closest("li").clone();O.find(".iblock-cloud").remove();O.prependTo(H);M=H.children();if(J<M.size()){M.last().remove();}}}else{if(L){K.postponed.push(F);}}},logRecent:function(L,M){var I=this,J=I.recents,K=J.cnt,F=g(K),H=M===J.isStickersCnt,G=M?"recent-sticker":"recent-smile";if(K&&H&&L.closest(F).length){D.success("ta",G,L.closest(".comments_smiles_i").index()+1);}},setCurrent:function(F){this.emojiarea=F;}};function w(F){D.success("ta","userSmileLayer");z(this);OK.Layers.unregisterLast("smile");}return{addSmile:function(F){D.success("ta","addSmileExt");z(F);},deferedSend:function(){if(s){s.call();s=null;D.success("ta","paymentCbCall");}},addMoneyAndSendSticker:function(){if(k){k.call();k=null;D.success("ta","paymentAndSendingCbCall");}},callStickerSetLayer:function(F){if(e){e.call(this,F);e=null;D.success("ta","stickerSetLayerCallback");}},registerExternalStickers:function(){g(document.body).off("click.ext-sticker").on("click.ext-sticker",".js-ext-sticker",function(){var F=this;if(require.defined("OK/messages2/app")&&require("OK/messages2/layer").isOpen()){var G=F.getAttribute(x);D.success("ta","extSticker");OK.Layers.unregisterLast();require("OK/messages2/app").sendSticker(G);}else{if(E){D.success("ta","extSticker");OK.Layers.unregisterLast();E.sendSticker(F);h(null);}else{D.success("ta","noExtSticker");}}});},activateUserSmilesSelect:function(F){F.addEventListener("click",w);},deactivateUserSmilesSelect:function(F){F.removeEventListener("click",w);},setNeedRecentGifsUpdate:function(){p=true;},showPaymentWizard:function(F,G){c(F,G,"22");}};});