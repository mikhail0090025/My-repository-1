define(["OK/utils/utils","OK/utils/dom","OK/UserClientCache","OK/logger","OK/NewsFetchCoordinator","OK/SortedLinkedList","PTS/friendstream.client"],function(u,r,k,y,a,w,x){function d(A){this.element=A;this.actorId=parseInt(A.getAttribute("data-aid"),10);this.position=parseInt(A.getAttribute("data-pos")||0,10);}d.prototype={getTime:function(){if(this.time){return this.time;}return this.time=new Date(parseInt(this.element.getAttribute("data-time"),10));},isOfflineEvent:function(){if(this.isOffline){return this.isOffline;}return this.isOffline=this.element.getAttribute("data-offline")==="true";},compareTo:function(A){return this.position-A.position;}};function c(A){this.items=[];this.maxSize=A;}c.prototype={append:function(B){var A=1;if(this.items.length===this.maxSize){A=0;this.items.shift();}this.items[this.items.length]=B;return A;},drain:function(){var A=this.items.length;while(this.items.length>0){var B=this.items.shift();m.insert(B);}return A;}};function q(A){this.element=A;this.count=0;}q.prototype={update:function(D){if(!this.initialized){this.element.addEventListener("click",this.click.bind(this));this.initialized=true;}this.count+=D;var C=OK.util.plurals(this.count);var B="collapsed.count."+C;r.firstByClass(this.element,"online-fr_new-actions-notification").innerHTML=x[B];var A=r.firstByClass(this.element,"counterText");if(A!==undefined){A.innerText=this.count.toString();}if(this.count>0){this.show();}else{this.hide();}},click:function(B){var A=g.drain();y.success("friendStream","expand",""+A);B.preventDefault();},reset:function(){this.update(-this.count);},hide:function(){this.element.classList.remove("__update");OK.showOnlineUsers.doResize();},show:function(){this.element.classList.add("__update");OK.showOnlineUsers.doResize();}};var f=25,n=u.deferred(),z=false,j={},o={},t=new w(),v,e=new q(document.getElementById("friendstream-collapsed")),l=document.getElementById("online-fr_block"),s=new c(f);var p={accept:function(C,A,B){if(B){C.insert(A);}else{e.update(s.append(A));}},drain:function(){e.reset();return s.drain();},enable:function(){},disable:function(){}};var h={showPreviewTimer:undefined,temporary:[],accept:function(C,A,B){if(!B){this.temporary.push(A);e.update(s.append(A));}C.insert(A);this.preview(1,5000);},drain:function(){},onHover:function(){var A=p.drain();y.success("friendStream","expand.hover",""+A);h.removeTemporary();l.classList.add("__hover");r.one(l,"mouseleave",function(){l.classList.remove("__hover");});},enable:function(){l.addEventListener("mouseenter",this.onHover);},disable:function(){l.removeEventListener("mouseenter",this.onHover);h.removeTemporary();},removeTemporary:function(){while(this.temporary.length>0){r.remove(this.temporary.shift());}},preview:function(C,B){var A=this;if(this.showPreviewTimer){clearInterval(this.showPreviewTimer);}this.showPreviewTimer=setInterval(function(){if(OK.Layers.isAnyLayerOpened()){return;}var D=r.firstByClass(document,"online-fr_list");var E=document.getElementById("hook_Block_UserTODO");D.style.maxHeight="64px";l.style.maxHeight=(E.clientHeight+110)+"px";setTimeout(function(){if(l&&D){D.style.maxHeight="";l.style.maxHeight="";}},B);clearInterval(A.showPreviewTimer);},100);}};var g=p;function i(A,E){var D=o[E];if(D){var B=D.element.nextSibling;while(B){b(B,-1);B=B.nextSibling;}A.remove(D);var C=t.find(function(F){return F.actorId===E;});if(C){C.remove();}}}function b(A,C){var B=A.getAttribute("data-l");if(B){if(B.indexOf("position,")>-1){A.setAttribute("data-l",B.replace(/position,(\d+)/,function(D,E){return"position,"+(parseInt(E,10)+C);}));}else{A.setAttribute("data-l",B+",position,0");}}}var m={activate:function(A){f=parseInt(A.getAttribute("data-max"),10);v=OK.hookModel.getNearestBlockHookId(A);n.resolve(A);A.addEventListener("mouseenter",function(){z=true;});A.addEventListener("mouseleave",function(){z=false;});a.addBlock("FSC");OK.loader.use(["OKCustomJs","nativeHooks"],function(){OK.showOnlineUsers.doResize();});OK.onload.addCallback(this.toggleState);},add:function(A){if(t.getSize()===f){this.removeEarliest();}var B=new d(A);j[B.actorId]=(j[B.actorId]||0)+1;if(B.isOfflineEvent()){o[B.actorId]=B;}return t.add(B);},removeEarliest:function(){var B=t.getTail();var A=B.value;this.remove(A);return t.remove(B);},remove:function(A){r.remove(A.element);j[A.actorId]=j[A.actorId]-1;if(A.isOfflineEvent()){delete o[A.actorId];}},setNewContent:function(D){var A=this;var B=document.createElement("div");B.innerHTML=D;var C=OK.util.parseJSON(B.firstChild.innerHTML);var E=Array.prototype.slice.call(B.childNodes,1);if(!C.isPush){y.success("friendStream","setNewContent","not-push");}n.promise.then(function(){y.success("friendStream","setNewContent","push");var K=C.users;for(var I in K){if(K.hasOwnProperty(I)){var F=K[I];k.add(parseInt(I,10),F.onlineStatus);}}if(E.length>0){document.getElementById("online-fr_block").classList.add("__has-friends");}for(var H=E.length-1;H>=0;H--){var G=E[H];var J=G.getAttribute("data-important")==="true";g.accept(A,G,J);}});},insert:function(A){n.promise.then(function(D){var E=parseInt(A.getAttribute("data-aid"),10),B=A.getAttribute("data-online")==="true";i(m,E);if(B&&j[E]>0){y.success("friendStream","setNewContent","skipped");}else{if(!document.hidden){A.classList.add("__push");}D.insertBefore(A,D.firstChild);var C=A.nextSibling;while(C){b(C,+1);C=C.nextSibling;}OK.hookModel.captureBlockHook(v,A);if(document.hidden){OK.showOnlineUsers.doResize();}y.success("friendStream","setNewContent","appended");}});},toggleState:function(){g.disable();g=OK.util.is4ColumnActive()?p:h;g.enable();}};return m;});