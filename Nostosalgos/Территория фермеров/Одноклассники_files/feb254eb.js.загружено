define(["OK/utils/utils","OK/utils/dom","OK/autofocus"],function(a,g,h){function c(i){return i.input.value.trim()!==i.previous;}function b(i){i.wrapper.classList.add("search-input_searching");}function e(i,j){if(!(j||c(i))){return;}i.previous=i.input.value.trim();if(i.timer){clearTimeout(i.timer);}b(i);i.timer=setTimeout(i.onChange.bind(i),i.timeout);}function d(o,j){var n=j.substring(Math.max(0,j.indexOf("?")+1)).split("&");for(var k=0;k<n.length;k++){var m=n[k];var l=m.indexOf(o+"=");if(l===0){return m.substr(o.length+1);}}return"";}var f=function(){this.loading=false;};f.prototype={onFinish:function(){this.wrapper.classList.remove("search-input_searching");},onChange:function(){var l={};l[this.input.name]=this.input.value.trim();if(this.dynamicParamsNames){for(var k=0;k<this.dynamicParamsNames.length;k++){var m=this.dynamicParamsNames[k];if(this.input.hasAttribute(m)){l[m]=this.input.getAttribute(m);}}}if(this.request&&this.cancelRequests){this.request.xhr.abort();}this.request=a.ajax({type:"GET",url:this.url,data:l}).done(function(o,i,p){this.onFinish();a.updateBlockModelCallback(o,i,p);this.input.dispatchEvent(new CustomEvent("searchEnd",{bubbles:true}));}.bind(this));if(d("st.cmd",this.url)=="altGroupAdvertsPage"&&d("st.search",this.url)=="on"){var j=OK.historyManager.getState();var n="/search";if(j.indexOf(n,j.length-n.length)==-1){if(j[j.length-1]=="/"){j=j.slice(0,-1);}if(d("st.selection",this.url)==""){j=j.replace(/\/[0-9]+$/,"");}OK.historyManager.pushState(j+n);}}},clear:function(){this.input.value="";this.previous="";this.wrapper.classList.remove("search-input_active");this.toggleNeighbours(true);b(this);this.onChange();var j=this.wrapper.querySelector(".js-search-parameters:not(.js-grid)");if(j){j.classList.add("invisible");}if(this.advertsBack){var i=this.wrapper.querySelector(".js-search-parameters.js-grid");i.classList.remove("invisible");}},isEmpty:function(){return this.input.value.trim().length===0;},handleEvent:function(j){var i=j.type;if(i==="click"){this.clear();return;}else{if(i==="keydown"){switch(j.which){case 13:e(this,true);break;case 27:if(this.isEmpty()){this.input.blur();}else{this.clear();}j.stopPropagation();break;}}else{e(this,false);}}if(this.isEmpty()){this.wrapper.classList.remove("search-input_active");this.toggleNeighbours(true);}else{this.wrapper.classList.add("search-input_active");this.toggleNeighbours(false);}},toggleNeighbours:function(j){var i=this.hideOnSearchClass;if(this.hideOnSearchEls){this.hideOnSearchEls.forEach(function(k){k.classList.toggle(i,!j);});}},activate:function(j){var l;this.input=j;this.previous=this.input.value.trim();this.wrapper=j.parentNode.parentNode;this.url=j.getAttribute("data-url");this.cancelRequests=j.getAttribute("data-cancel-requests")==="true";this.timeout=parseInt(j.getAttribute("data-searchtimeout"),10);this.advertsBack=j.getAttribute("data-adverts-back")==="true";var m=j.getAttribute("data-dynamic_params_names");if(m){this.dynamicParamsNames=m.split(",").filter(function(n){return n.length>0;});}j.addEventListener("keydown",this,false);j.addEventListener("keyup",this,false);j.addEventListener("keypress",this,false);j.addEventListener("paste",this,false);l=this.wrapper.getElementsByClassName("ic_close-g");if(l.length===1){this.close=l[0];this.close.addEventListener("click",this,false);}var i=g.parent(j,"js-hide-on-search-wr");if(i){this.hideOnSearchEls=g.byClass(i,"js-hide-on-search");this.hideOnSearchClass=j.getAttribute("data-hide-on-search-class")||"anim_shrink";}var k=j.getAttribute("data-autofocus")==="true";if(k){h.activate(j);}},deactivate:function(i){i.removeEventListener("keydown",this,false);i.removeEventListener("keyup",this,false);i.removeEventListener("keypress",this,false);i.removeEventListener("paste",this,false);if(this.close){this.close.removeEventListener("click",this,false);}}};return f;});