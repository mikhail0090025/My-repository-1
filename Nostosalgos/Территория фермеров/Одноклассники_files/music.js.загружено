define("OK/endorphin-loader",["OK/utils/vanilla"],function(k){var n={};return{getAppElement:m,activate:e,upgrade:p};function o(r){if(!r){return Promise.reject("Endorphin application name should be set!");}return k.ajax({url:"/web-api/endorphin/element?app="+encodeURIComponent(r),dataType:"json"}).then(function(s){return s.response?s.response:Promise.reject("Settings for app '"+r+"' is empty!");});}function m(s,r){return o(s).then(function(t){return a(t.endorphinLibUrl,t.endorphinUrl,r).then(function(){return document.createElement(t.tagName);});});}function g(r){var s=h(r);switch(s){case"js":return c(r);case"css":return i(r);}}function h(r){var s=r.split("/").pop().split("?").shift();return s.indexOf(".")<1?"":s.split(".").pop();}function c(s){var r=document.createElement("script");r.src=s;r.async=true;return r;}function i(r){var s=document.createElement("link");s.rel="stylesheet";s.type="text/css";s.href=r;return s;}function b(r){return new Promise(function(u,t){var s=g(r);s.addEventListener("load",function(){u(s);});s.addEventListener("error",function(){t(s);});document.head.appendChild(s);});}function a(t,s,r){return Promise.all([j(t),l(r)]).then(function(){return b(d(s));}).then(function(){return b(f(s));});}function f(r){if(r.endsWith(".js")){return r;}return r+".js";}function d(r){if(r.endsWith(".css")){return r;}return r+".css";}function q(r,s,u){var t=n[r];if(!t){return r+":key";}return t.getLMsg(s,u);}function j(r){return b(f(r)).then(function(s){var t=defineComponent.BaseComponent.prototype,u=t._init;t._init=function(){u.call(this);this.renderer.methods.pts=q;};return Promise.resolve(s);});}function l(r){if(!r){return Promise.resolve({});}if(n[r]){return Promise.resolve(n[r]);}return new Promise(function(t,s){require(["OK/pts!"+r],function(u){if(r){n[r]=u;}t(u);},s);});}function p(r){if(customElements&&customElements.version&&customElements.upgrade){customElements.upgrade(r);}}function e(t){if(!t){return Promise.reject("element is not provided");}var s=t.getAttribute("data-endorphin");var u=t.getAttribute("data-endorphin-lib");var r=t.getAttribute("data-pts-pkg");if(!s||!u){return Promise.reject("endorphin module or library path not valid");}return a(u,s,r).then(function(){p(t);return Promise.resolve(t);});}});define("OK/music2/app",["OK/endorphin-loader"],function(a){var d=null,c={},b=document.getElementById("music_layer");return{activate:function(){if(!d){var e=this;d=new Promise(function(g,f){a.activate(b).then(function(){a.upgrade(document.getElementById("music_mini_player"));},f);e.on("app-initialized",function(){g(b);});});}return d;},setSection:function(e){this.activate().then(function(f){f.setSection(e);});},play:function(e){this.activate().then(function(f){f.play(e);});},pause:function(){this.activate().then(function(e){e.pause();});},togglePlaying:function(){var e=this.getCurrentTrack();if(e){if(e.playing){this.pause();}else{this.play();}}},loadMyTracks:function(){return this.activate().then(function(e){return e.service.loadMyTracks();});},searchTracks:function(e){return this.activate().then(function(f){return f.service.searchTracks(e);});},addTrack:function(f,e){return this.activate().then(function(g){return g.service.addTrack(f,e);});},getCurrentTrack:function(){return b.currentTrack;},setNewEvent:function(e){if(b.setNewEvent){b.setNewEvent(e);}else{if(e.type==="STATUS"){this.emit("counter-update",{count:e.payload.subscriptionsUpdates,small:e.payload.hasNewActivity});}}},on:function(f,e){if(!c[f]){c[f]=[];b.addEventListener(f,this);}c[f].push(e);},off:function(g,f){var h=c[g],e;if(h){if(!f){c[g]=null;b.removeEventListener(g,this);}else{e=h.indexOf(f);if(e>-1){h.splice(e,1);}if(h.length===0){c[g]=null;b.removeEventListener(g,this);}}}},emit:function(f,e){var g=c[f];if(g){g.forEach(function(h){if(h.handleEvent){h.handleEvent.call(h,e);}else{h.call(b,e);}});}},handleEvent:function(e){this.emit(e.type,e.detail);}};});define("OK/music2/history",[],function(){var g="/",b=[["%20","+"],["%2F","%252F"],["%5C","%255C"]];function c(j){var i=["/music"];if(j.name!=="vitrine"){i.push(j.name);if(j.id){i.push(j.id);}if(j.tab&&j.name!=="profile"){i.push(j.tab);}if(j.query){i.push(f(j.query));}}return i.join("/");}function a(k,j,i){return k.split(j).join(i);}function f(i){var j=encodeURIComponent(i);b.forEach(function(k){j=a(j,k[0],k[1]);});return j;}function h(i){if(!i){return i;}b.forEach(function(j){i=a(i,j[1],j[0]);});return decodeURIComponent(i);}function d(j){if(j){var i=j&&j.indexOf("?");if(j&&i>0){j=j.substr(0,i);}}return j;}function e(i){if(i.length===4){return{name:i[1],tab:i[2],query:h(i[3])};}else{return{name:i[1],tab:"tracks",query:h(i[2])};}}return{restore:function(){OK.historyManager.pushState(g);},isMusicState:function(i){i=i||OK.historyManager.getState();return i.indexOf("/music")===0;},pushState:function(k){var j=OK.historyManager.getState(),i=typeof k==="string"?k:c(k);if(j===i){return;}if(!this.isMusicState(j)){g=j;}OK.historyManager.pushState(i);},getSection:function(i){i=i||OK.historyManager.getState();var k=i.substr(1),j=k.split("/").filter(Boolean);if(j.length<=1||j[0]!=="music"){return{name:"vitrine"};}else{if(j.length===2){return{name:j[1]};}else{if(j[1]==="search"){return e(j);}else{return{name:j[1],id:d(j[2])};}}}},buildPath:c};});define("OK/music2/preloader",[],function(){var f;var c;var e;var g;var n;var p=false;var m=1000;var k=48;var i=4;function a(q){return{start:0,end:(Math.PI*2)*q};}function d(q){return{start:2*Math.PI*q,end:2*Math.PI};}function j(q){return q<0.5?2*q*q:-1+((4-(2*q))*q);}function o(){var q=Math.min((Date.now()-e)/m,1);var r=g(j(q));c.clearRect(0,0,k*2,k*2);c.beginPath();c.arc(k,k,k-i,r.start,r.end);c.stroke();if(q<1){n=requestAnimationFrame(o);}else{h();}}function h(){g=g===a?d:a;e=Date.now();n=requestAnimationFrame(o);}function b(){if(p){return;}var q=document.getElementById("music-preloader");f=document.createElement("canvas");f.width=k*2;f.height=k*2;f.style.width=k+"px";f.style.height=k+"px";q.appendChild(f);c=f.getContext("2d");c.lineCap="round";c.lineWidth=i*2;c.strokeStyle="#f9912f";p=true;h();}function l(){p=true;if(f){cancelAnimationFrame(n);f.parentElement.removeChild(f);f=null;}}return{start:b,stop:l};});define("OK/music2/layer",["OK/logger","OK/music2/app","OK/music2/history","OK/music2/preloader","OK/ToolbarGrowl","OK/utils/utils"],function(r,f,g,l,m,n){var d="music_app",a="toolbar_nav_a__audio__active",o="invisible",k=document.getElementById("music_toolbar_button"),p=document.getElementById("music_layer"),b=document.getElementById("music_layer_wrapper"),e=document.getElementById("mainContainer");p.addEventListener("click",function(s){s.stopPropagation();});function j(){return OK.Layers&&OK.Layers.isLayerOpened(d);}function i(){g.restore();k.classList.remove(a);b.classList.add(o);p.setAttribute("hidden","true");OK.Layers.remove(d);OK.Layers.onLayerHidden();}function q(s){if(s){p.setSection(g.getSection(s));g.pushState(s);}}function h(s){r.success("music","start","open");m.destroyByLayerId(d);if(j()){q(s);return Promise.resolve();}OK.Layers.unregisterAll();p.removeAttribute("hidden");k.classList.add(a);b.classList.remove(o);OK.Layers.onLayerShown();OK.Layers.register(d,i);l.start();return f.activate().then(function(t){r.success("music","start","activated");l.stop();if(s){q(s);}else{var u=t.section;if(u&&u.name){g.pushState(t.section);}else{u=g.getSection();t.setSection(u);g.pushState(t.section);}}},function(t){r.clob("musicclob.error",t.stack,"music-start","activate");});}function c(s){p.setAttribute("theme",s);p.parentElement.classList.remove("__dark","__light");p.parentElement.classList.add("__"+s);n.ajax({url:"/web-api/music/theme?name="+s});}return{isOpen:j,open:h,close:function(){if(j()){i();}},setTheme:c};});define("OK/music2/global",["OK/logger","OK/music2/app","OK/music2/layer","OK/utils/dom","OK/utils/vanilla","OK/music2/history"],function(j,b,e,c,g,f){b.on("show-subscription-layer",function(){g.ajax({url:"/dk",data:{cmd:"PopLayer","st.layer.cmd":"PopLayerPaymentWizardOuter","st.layer.origin":41,"st.layer.srv":26,"st.layer.stJsCb":"ms2"}}).then(function(k){return g.updateBlockModelCallback(k);});});b.on("share-track",function(l){var m,k;if(typeof l==="object"){m=l.id;k=l.target;}else{m=l;k="Messages";}g.ajax({url:"/dk",data:{cmd:"PopLayerOver","st.layer.cmd":"PopLayerReshare","st.layer.xpostType":k,"st.layer.refId1":m,"st.layer.type":13}}).then(function(n){return g.updateBlockModelCallback(n);});});b.on("share-playlist",function(k){g.ajax({url:"/dk",data:{cmd:"PopLayerOver","st.layer.cmd":"PopLayerReshare","st.layer.xpostType":k.target||"Feed","st.layer.refId1":k.id,"st.layer.refIdStr":k.type||"playlist","st.layer.type":14}}).then(function(l){return g.updateBlockModelCallback(l);});});b.on("show-mediatopic-layer",function(l){var m=l.mediatopicId;var k=l.mediatopicOwner;require(["OK/MediaLayer"],function(n){n.showTopicInLayer(m,k);});});b.on("send-present",function(l){var k={cmd:"PopLayer","st.layer.cmd":"PopLayerSendPresentSelectFriendComposite",};if(typeof l==="number"){k["st.layer.trackId"]=l;}else{k["st.layer.trackId"]=l.trackId;if(l.presentId){k["st.layer.gfPresent"]=l.presentId;}}g.ajax({url:"/dk",data:k}).then(function(m){return g.updateBlockModelCallback(m);});});b.on("buy-track",function(k){g.ajax({url:"/dk",data:{cmd:"PopLayer","st.layer.cmd":"PopLayerPaymentWizardOuter","st.layer.appId":90280448,"st.layer.timestamp":Date.now(),"st.layer.appCode":k.id,"st.layer.appName":k.name,"st.layer.currency":"RUR","st.layer.appPrice":k.price,"st.layer.callback":true,"st.layer.srv":22,"st.layer.appCardOnly":"off"}}).then(function(l){return g.updateBlockModelCallback(l);});});b.on("open-portal-link",function(k){if(e.isOpen()){OK.Layers.unregisterAll();}window.navigateOnUrlFromJS(k);});b.on("open-section",function(k){f.pushState(k);});function d(l){if(l){for(var k=0;k<6;k++){var m=l.getAttribute("data-query");if(m){return m;}l=l.parentNode;}}return"";}function i(o,m,l){var k=b.getCurrentTrack(),n;if(k&&k.ctx&&k.ctx.indexOf(m)===0&&o==k.id){b.togglePlaying();j.success("musicusage",n?"playTrack":"pauseTrack",l);return true;}return false;}function h(o,n,l,k,m){if(i(o,l,k)){return;}var p=["custom",l,n||o];if(m){p.push(m);}b.play({tid:o,qid:p.join(":")});j.success("musicusage","playTrackList",k);}function a(k){j.success("musicusage","deprecated",k);}window.odklMusic={playFeedTrack:function(m,k,l){a("playFeedTrack");h(m,d(l),"feed","",k);},playPortalTrack:function(o,n,m,l){var k=n==="musicGifts"?"gifts":l==="messaging"||l==="formaddpl"?l:"unknown";h(o,d(m)||o,k,l);},playMediatopic:function(n,k){var l=d(k);var m=new Function("return "+l)();h(n,m.trackIds,"mediastatus",m.location);},playArtistTrack:function(l,m,k){if(i(m,"artist:"+l)){return;}b.play({tid:m,qid:"artist:"+l,index:Number(k)});j.success("search.usage","playTrack","bmArtist");},playAlbumTrack:function(l,m,k){if(i(m,"album:"+l)){return;}b.play({tid:m,qid:"album:"+l,index:Number(k)});j.success("search.usage","playTrack","bmAlbum");},playSearchTrack:function(p,m,n,l){var k="okSearch",o=n.getAttribute("data-query");if(i(p,"search_tracks",k)){return;}b.play({tid:Number(p),qid:"search:"+o,index:Number(l)});j.success("musicusage","playTrackList",k);},_pMS:function(l,k){},addTrack:function(n,m,l,k){if(m.hasAttribute("selected")){return;}b.addTrack(n,k).then(function(){j.success("musicusage","addTrackFromFeed",l);m.classList.remove("ic_plus");m.classList.add("ic_added_w");m.setAttribute("selected","true");});},addPortalTrack:function(m,l,k){b.addTrack(m,k).then(function(){var n=c.parent(l,"mus-tr_hld");n.classList.add("__added");n.classList.add("__pr-l");l.parentNode.removeChild(l);j.success("search.usage","clickOnTrackKlass");});},playingTrack:function(){var k=b.getCurrentTrack();return k&&k.playing?String(k.id):"";}};return window.odklMusic;});define("OK/music2/mini-player",["module","OK/music2/app","OK/music2/layer"],function(d,e,h){var c="__hidden",b="invisible",k=null,i=Number(d.config().showTimeout)||300,f=Number(d.config().hideTimeout)||300,a=false;function j(l){clearTimeout(k);if(!a&&!h.isOpen()&&e.getCurrentTrack()){k=setTimeout(function(){e.activate().then(function(){if(!a&&!h.isOpen()){l.classList.remove(b);l.offsetHeight;l.classList.remove(c);a=true;}});},i);}}function g(l){clearTimeout(k);if(a){k=setTimeout(function(){if(a){l.classList.add(c);a=false;}},f);}}return{activate:function(m){var n=m.parentElement,l=m.firstChild;OK.loader.use("OKCustomJs",function(){OK.Layers.subscribe("music_app",function(o){if(o){g(m);}});});l.addEventListener("click",function(o){o.stopPropagation();});l.addEventListener("open-current-section",function(){var o={name:"current"};h.open();e.setSection(o);});n.addEventListener("mouseenter",function(){j(m);});n.addEventListener("mouseleave",function(){g(m);});n.addEventListener("transitionend",function(o){if(o.target.classList.contains(c)){m.classList.add(b);}});}};});define("OK/music2/toolbar-button",["OK/music2/app","OK/music2/layer","OK/ToolbarBubble","OK/music2/global"],function(d,b,c){var a=c.wrap("counter_ToolbarMusic");d.on("counter-update",function(e){a.update(e.count);if(!e.count&&e.small&&!b.isOpen()){a.showSmall();}else{a.resetCustomIcon();}});d.on("reset-activity-bubble",function(){a.resetCustomIcon();});return{activate:function(e){e.addEventListener("click",function(f){f.stopPropagation();if(b.isOpen()){b.close();}else{b.open();}});if(e.getAttribute("data-short-link")){b.open();}}};});define("OK/music2/play-button",["OK/music2/app","OK/music2/layer"],function(b,a){return{activate:function(c){b.on("current-track-changed",function(d){c.classList.toggle("toolbar_music-play__active",!!(d&&d.playing));});c.addEventListener("click",function(d){d.stopPropagation();if(b.getCurrentTrack()){b.togglePlaying();}else{a.open();}});}};});define("OK/music2/push",["module","OK/logger","OK/music2/app","OK/NewsFetchCoordinator","OK/utils/vanilla"],function(c,b,f,d,e){function a(){var g=(c.config().timeout||10*60)*1000;if(g<0){b.success("music","polling","zero-timeout");return;}setTimeout(function(){b.success("music","polling","request");e.ajax({url:"/web-api/music/status",dataType:"json"}).then(function(h){f.setNewEvent({type:"STATUS",payload:h.response});b.success("music","polling","request-success");a();})["catch"](function(){b.success("music","polling","request-error");a();});},g);}return{activate:function(){a();f.on("app-initialized",function(){d.addBlock("MP");});},setNewContent:function(g){OK.util.parseJsonCorrected(g).events.forEach(function(h){f.setNewEvent(h);});}};});define("OK/music2/theme",["OK/music2/layer"],function(b){function a(){var c=(window.CSS&&window.CSS.supports.bind(window.CSS))||(window.supportsCSS);return !!c&&c("color","var(--primary)");}return{activate:function(d){if(a()){var c=d.getAttribute("data-id");d.addEventListener("click",function(){c=c==="dark"?"light":"dark";b.setTheme(c);});d.classList.remove("invisible");}}};});define("OK/music2/last-played-portlet",["OK/logger","OK/music2/app","OK/music2/history"],function(c,f,e){function d(g){return{name:"search",tab:"tracks",query:g};}function a(g){var h=g.masterArtistId;if(h>0){return{name:"artist",id:h};}else{return d(g.ensemble);}}function b(){}b.prototype={activate:function(g){this.element=g;this.titleElement=this.element.parentElement.querySelector(".js-title");this.artistElement=this.element.parentElement.querySelector(".js-artist");this.trackId=g.getAttribute("data-track-id");this.playlistId=g.getAttribute("data-playlist-id");this.playlistType=g.getAttribute("data-playlist-type");this.playing=false;f.on("current-track-changed",this);g.addEventListener("click",this);this.handleChangedTrack(f.getCurrentTrack());},deactivate:function(g){g.removeEventListener("click",this);f.off("current-track-changed",this);},handleEvent:function(g){if(g.type==="click"){this.handleClick();}else{this.handleChangedTrack(g);}},handleClick:function(){var g=f.getCurrentTrack();if(g&&String(g.id)===String(this.trackId)){if(g.playing){f.pause();c.success("musicusage","pauseTrack","last-played-portlet");}else{f.play();c.success("musicusage","resumeTrack","last-played-portlet");}}else{f.play({tid:this.trackId,qid:"last-played-status:"+this.playlistType+(this.playlistId?":"+this.playlistId:"")});c.success("musicusage","playTrack","last-played-portlet");}},handleChangedTrack:function(g){if(!g){return;}if(this.trackId!==g.id){this.trackId=g.id;this.playlistId=null;this.playlistType=null;this.element.style.backgroundImage='url("'+g.imageUrl+'")';this.titleElement.innerText=g.name;this.titleElement.setAttribute("href",e.buildPath(d(g.name)));this.artistElement.innerText=g.ensemble;this.artistElement.setAttribute("href",e.buildPath(a(g)));}if(this.playing!==!!g.playing){this.playing=!!g.playing;this.element.classList.toggle("m_portal_track_pause",this.playing);}}};return b;});define("OK/music2/last-played-growl",["OK/logger","OK/music2/app","OK/music2/layer"],function(a,c,b){return{activate:function(d){this.trackId=d.getAttribute("data-track-id");this.playlistId=d.getAttribute("data-playlist-id");this.playlistType=d.getAttribute("data-playlist-type");d.addEventListener("click",this);},deactivate:function(d){d.removeEventListener("click",this);},handleEvent:function(d){d.stopPropagation();a.success("music.usage","growlPlay",this.playlistType);c.play({tid:this.trackId,qid:"last-played-status:"+this.playlistType+(this.playlistId?":"+this.playlistId:"")});b.open().then(function(){c.setSection({name:"current"});});}};});define("OK/music2/growl-close",["OK/utils/vanilla"],function(b){function a(){}a.prototype={activate:function(c){this.type=c.getAttribute("data-type");c.addEventListener("click",this);},deactivate:function(c){c.removeEventListener("click",this);},handleEvent:function(){b.ajax({url:"/web-api/music/markActionHide?type="+this.type});}};return a;});define("b/music2",["OK/music2/app","OK/music2/global","OK/music2/history","OK/music2/layer","OK/music2/mini-player","OK/music2/toolbar-button","OK/music2/play-button","OK/music2/push","OK/music2/preloader","OK/music2/theme","OK/music2/last-played-portlet","OK/music2/last-played-growl","OK/music2/growl-close"],{});