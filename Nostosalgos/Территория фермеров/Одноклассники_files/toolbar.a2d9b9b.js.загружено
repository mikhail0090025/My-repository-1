var BannerSet=function(){function t(t,i){this._roll=t,this._banners=i}return t.prototype.chooseBanner=function(){for(var t,i=Math.random()*this._roll,e=0,n=0;!t&&n<this._banners.length;n++){var o=this._banners[n];i>=e&&i<e+o.weight&&(t=o),e+=o.weight}if(!t)throw new Error("Failed to choose banner.");return t},t}(),BannerToolbar=function(){function t(){this._params,this._stage,this._config,this._view,this._onConfigLoaded=this._onConfigLoaded.bind(this),this._updateStage=this._updateStage.bind(this)}return t.prototype.init=function(t){this._params=t,this._stage=new createjs.Stage("toolbarCanvas");var i=document.getElementById("toolbarCanvas");i.addEventListener("mouseout",function(t){this._view&&(this._view.clearHighlights(),this._stage.update())}),this._loadConfig()},t.prototype._loadConfig=function(){var t=this._params.configURL;Utils.loadJSON(t,this._onConfigLoaded)},t.prototype._onConfigLoaded=function(t){this._config=new ToolbarConfig(t),this._view=new ToolbarView(this._config),this._view.addEventListener("update",this._updateStage),this._view.initView(),this._stage.addChild(this._view),this._stage.enableMouseOver(15),this._stage.update()},t.prototype._updateStage=function(){this._stage.update()},t}(),BannerView=function(){function t(t,i,e,n,o,s){this.imageURL=t,this._gameCode=o,this._verticaKey=s,this.weight=i,this.link=e,this.imageID=n,this.button=null,this.onBitmapLoaded=this.onBitmapLoaded.bind(this),this.onClick=this.onClick.bind(this),this._bitmap=new createjs.Bitmap(t),this._bitmap.image.onload=this.onBitmapLoaded,this.Container_constructor(),this.addChild(this._bitmap)}return createjs.extend(t,createjs.Container),t.prototype.onBitmapLoaded=function(){this.button=new Button(this,!0),this.button.addEventListener("click",this.onClick)},t.prototype.onClick=function(){Utils.sendStat(this.imageID,this._gameCode,this._verticaKey,"top");var t=Parameters.instance.linkTarget;window.open(this.link,t)},createjs.promote(t,"Container"),t}(),Button=function(){function t(t,i){this._bounds=null,this._highlightWithGlow=i,this.view=t,this.dispatchEvent=this.dispatchEvent.bind(this),this._onOver=this._onOver.bind(this),this._onOut=this._onOut.bind(this),this.createHitArea()}var i=new createjs.ColorFilter(1.1,1.1,1.1),e=new createjs.Shadow("#FFFF00",0,0,10);return t.prototype.createHitArea=function(){var t=this.view.getBounds(),i=new createjs.Shape;i.graphics.beginFill("#ff0000"),i.graphics.drawRect(0,0,t.width,t.height),this.view.hitArea=i,this.view.addEventListener("click",this.dispatchEvent),this.view.addEventListener("mouseover",this._onOver),this.view.addEventListener("mouseout",this._onOut)},t.prototype.cacheImage=function(){if(this._bounds)return!0;var t=this.view.getBounds();return t?(this._bounds=t,this.view.cache(0,0,t.width,t.height),!0):!1},t.prototype.higlight=function(){this.cacheImage()&&(this._highlightWithGlow===!0?this.view.shadow=e:this.view.filters=[i],this.view.updateCache(),this.view.stage&&(this.view.stage.cursor="pointer"))},t.prototype.clearHiglight=function(){this.cacheImage()&&(this._highlightWithGlow===!0?this.view.shadow=null:this.view.filters=[],this.view.updateCache(),this.view.stage&&(this.view.stage.cursor=null))},t.prototype._onOver=function(t){this.higlight(),this.view.dispatchEvent(new createjs.Event("update",!0))},t.prototype._onOut=function(t){this.clearHiglight(),this.view.dispatchEvent(new createjs.Event("update",!0))},createjs.EventDispatcher.initialize(t.prototype),t}();Initializer.initHTML5Banner=function(t){document.getElementById("toolbarCanvas").style.display="block";var i=new BannerToolbar;i.init(t)};var ToolbarConfig=function(){function t(t){this.staticURL=t.static_url,this.logoUrl=this.staticURL+t.logo_url,this.rotationTime=t.rotation_time,this.sets=[];var i=t.sets;i.forEach(function(t){var i=t.banners.map(function(t){return new BannerView(this.staticURL+t.image,t.weight,t.link,t.id,t.code,t.vertica_key)}.bind(this));this.sets.push(new BannerSet(t.roll,i))}.bind(this))}return t}(),ToolbarSlotContainer=function(){function t(t,i){this._index=0,this._slots=[],this._onLeftClick=this._onLeftClick.bind(this),this._onRightClick=this._onRightClick.bind(this),t.addEventListener("click",this._onLeftClick),i.addEventListener("click",this._onRightClick),this.Container_constructor()}var i=5;return createjs.extend(t,createjs.Container),t.prototype.rotateSlots=function(){this._slots.forEach(function(t){t.rotate()}),this.dispatchEvent(new createjs.Event("update",!0))},t.prototype.addSlot=function(t){this.addChild(t),this._slots.push(t)},t.prototype._onLeftClick=function(t){this._index--,this.redraw()},t.prototype._onRightClick=function(t){this._index++,this.redraw()},t.prototype.redraw=function(){var t=0,e=this.parent._config.sets.length;i>e&&(t=i-e,e!=this._slots.length&&this._slots.splice(-t,i));var n=this._slots.length;this._index>=n?this._index=0:this._index<0&&(this._index=n-1);for(var o=[],s=0;i-t>s;s++){var a=s+this._index;a>=n&&(a-=n),o.push(this._slots[a])}if(i>e)for(var h=0;t>h;h++){origSet=this.parent._config.sets[(h+this._index)%e];for(var r=[],s=0;s<origSet._banners.length;s++){var c=origSet._banners[s];r.push(new BannerView(c.imageURL,c.weight,c.link,c.id))}var l=new BannerSet(origSet._roll,r);x=new ToolbarSlotView(l),this.addSlot(x),o.push(x),x.rotate()}for(this._slots.forEach(function(t){-1==o.indexOf(t)?t.visible=!1:t.visible=!0}),s=0;i>s;s++){var d=o[s];d.x=233+101*s,d.y=5}this.dispatchEvent(new createjs.Event("update",!0))},t.prototype.clearHiglights=function(){this._slots.forEach(function(t){t.clearHiglight()})},createjs.promote(t,"Container"),t}(),ToolbarSlotView=function(){function t(t){this._bannerSet=t,this._currentBanner=null,this.Container_constructor()}return createjs.extend(t,createjs.Container),t.prototype.rotate=function(){var t=this._bannerSet.chooseBanner();t!=this._currentBanner&&(this._currentBanner&&this.removeChild(this._currentBanner),this.addChild(t),this._currentBanner=t)},t.prototype.clearHiglight=function(){this._currentBanner&&this._currentBanner.button&&this._currentBanner.button.clearHiglight()},createjs.promote(t,"Container"),t}(),ToolbarView=function(){function t(t){this._config=t,this._sqlogo,this._logo,this._buttonLeft,this._buttonRight,this._background,this._slotsContainer,this.updateStage=this.updateStage.bind(this),this.rotateSlots=this.rotateSlots.bind(this),this.Container_constructor()}return createjs.extend(t,createjs.Container),t.prototype.initView=function(){if(null!=Parameters.instance.backgroundColor){this._background=new createjs.Shape;var t="#"+Parameters.instance.backgroundColor;this._background.graphics.beginFill(t),this._background.graphics.drawRect(0,0,760,60),this._background.graphics.endFill()}else this._background=new createjs.Bitmap(document.getElementById("Background")),this._background.x=1,this._background.y=1;this._sqlogo=new createjs.Bitmap(document.getElementById("SQLogo")),this._leftButton=new Button(new createjs.Bitmap(document.getElementById("Button"))),this._rightButton=new Button(new createjs.Bitmap(document.getElementById("Button"))),this._slotsContainer=new ToolbarSlotContainer(this._leftButton,this._rightButton),this._leftButton.view.x=208,this._leftButton.view.y=13,this._rightButton.view.x=755,this._rightButton.view.y=13,this._rightButton.view.scaleX=-1,this._sqlogo.x=2,this._sqlogo.y=2;var i=new createjs.Shape;i.graphics.beginFill("#ff0000"),i.graphics.drawRect(0,0,760,60),this._background.hitArea=i,this.addChild(this._background),this.addChild(this._slotsContainer),this.addChild(this._sqlogo),this.addChild(this._leftButton.view),this.addChild(this._rightButton.view),this.loadGameLogo(),this.loadBanners(),this.updateStage(),this.rotateSlots()},t.prototype.updateStage=function(t){this.dispatchEvent(new createjs.Event("update"),!0)},t.prototype.loadGameLogo=function(){var t=new createjs.Bitmap(this._config.logoUrl);t.x=2,t.y=2,t.image.onload=function(){this._logo=new Button(t),this._logo.addEventListener("click",function(){window.open("http://socialquantum.ru")}),this.removeChild(this._sqlogo),this._sqlogo=null,this.updateStage()}.bind(this),this.addChild(t)},t.prototype.loadBanners=function(){for(var t=0;t<this._config.sets.length;t++){var i=this._config.sets[t],e=new ToolbarSlotView(i);this._slotsContainer.addSlot(e)}this._slotsContainer.redraw()},t.prototype.rotateSlots=function(){this._slotsContainer.rotateSlots(),setTimeout(this.rotateSlots,this._config.rotationTime)},t.prototype.clearHighlights=function(){this._leftButton&&this._leftButton.clearHiglight(),this._rightButton&&this._rightButton.clearHiglight(),this._logo&&this._logo.clearHiglight(),this._slotsContainer&&this._slotsContainer.clearHiglights()},createjs.promote(t,"Container"),t}();
//# sourceMappingURL=toolbar.js.map